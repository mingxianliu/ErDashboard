<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新本地快取</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4>更新成員資料快取</h4>
            </div>
            <div class="card-body">
                <p>點擊下面的按鈕來更新本地快取中的成員資料：</p>

                <button class="btn btn-success mb-3" onclick="updateCache()">
                    更新快取並重新載入
                </button>

                <button class="btn btn-warning mb-3" onclick="clearCache()">
                    清除所有快取
                </button>

                <div id="status"></div>

                <div id="memberList" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script>
        async function updateCache() {
            try {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = '<div class="alert alert-info">正在載入新資料...</div>';

                // 載入最新的 team-members.json
                const response = await fetch('config/team-members.json?v=' + Date.now());
                const data = await response.json();

                // 儲存到 localStorage
                localStorage.setItem('cachedTeamMembers', JSON.stringify(data));

                // 清除舊的臨時變更
                localStorage.removeItem('teamMemberChanges');

                statusDiv.innerHTML = '<div class="alert alert-success">快取已更新！正在重新載入...</div>';

                // 顯示成員列表
                displayMembers(data.members);

                // 3秒後跳轉回主頁
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                document.getElementById('status').innerHTML =
                    `<div class="alert alert-danger">更新失敗：${error.message}</div>`;
            }
        }

        function clearCache() {
            localStorage.removeItem('cachedTeamMembers');
            localStorage.removeItem('teamMemberChanges');
            localStorage.removeItem('cachedProjectAssignments');
            localStorage.removeItem('projectAssignmentChanges');

            document.getElementById('status').innerHTML =
                '<div class="alert alert-success">所有快取已清除！正在重新載入...</div>';

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        function displayMembers(members) {
            const memberList = document.getElementById('memberList');
            let html = '<h5>成員列表（已更新）：</h5><ul class="list-group">';

            for (const [id, member] of Object.entries(members)) {
                html += `<li class="list-group-item">${id}: ${member.name}</li>`;
            }

            html += '</ul>';
            memberList.innerHTML = html;
        }

        // 頁面載入時自動更新
        window.addEventListener('DOMContentLoaded', () => {
            updateCache();
        });
    </script>
</body>
</html>