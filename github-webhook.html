<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Webhook æ¥æ”¶å™¨</title>
    <!-- è‡ªå‹•é‡æ–°æ•´ç†æ¯ 3 ç§’æª¢æŸ¥ä¸€æ¬¡ -->
    <meta http-equiv="refresh" content="3">
</head>
<body>
    <h3>GitHub Webhook æ¥æ”¶å™¨</h3>
    <div id="status">ç­‰å¾…æ¥æ”¶...</div>

    <script>
    console.log('=== Webhook é é¢è¼‰å…¥ ===');
    console.log('URL:', window.location.href);
    console.log('è¼‰å…¥æ™‚é–“:', new Date().toISOString());

    // å¾ URL åƒæ•¸æ¥æ”¶ GitHub Actions çš„é€šçŸ¥
    const params = new URLSearchParams(window.location.search);
    const action = params.get('action');
    const project = params.get('project');
    const branch = params.get('branch');
    const author = params.get('author');

    console.log('åƒæ•¸:', { action, project, branch, author });

    if (action && project) {
        const statusDiv = document.getElementById('status');

        // å„²å­˜äº‹ä»¶åˆ° localStorage
        const event = {
            action: action,
            project: project,
            branch: branch || 'unknown',
            author: author || 'unknown',
            timestamp: new Date().toISOString()
        };

        console.log('è™•ç†äº‹ä»¶:', event);

        // å„²å­˜å¾…æ¸¬è©¦ç‹€æ…‹
        if (action === 'push') {
            let pendingTests = JSON.parse(localStorage.getItem('pending-tests') || '{}');
            pendingTests[project] = {
                status: true,
                branch: branch,
                author: author,
                timestamp: event.timestamp
            };
            localStorage.setItem('pending-tests', JSON.stringify(pendingTests));
            console.log('å·²å„²å­˜ pending-tests:', pendingTests);

            statusDiv.innerHTML = `âœ“ å·²æ¨™è¨˜ ${project} å¾…æ¸¬è©¦<br>åˆ†æ”¯: ${branch}<br>ä½œè€…: ${author}<br>æ™‚é–“: ${event.timestamp}<br><br>é é¢å°‡è‡ªå‹•é‡æ•´æª¢æŸ¥æ›´æ–°...`;

        } else if (action === 'merge') {
            // æ¸…é™¤æ‰€æœ‰å¾…æ¸¬è©¦æ¨™è¨˜
            localStorage.setItem('pending-tests', '{}');
            console.log('å·²æ¸…é™¤æ‰€æœ‰å¾…æ¸¬è©¦æ¨™è¨˜');

            statusDiv.innerHTML = `âœ“ å·²æ¸…é™¤æ‰€æœ‰å¾…æ¸¬è©¦æ¨™è¨˜<br>åˆä½µåˆ°: ${branch}<br><br>é é¢å°‡è‡ªå‹•é‡æ•´æª¢æŸ¥æ›´æ–°...`;
        }

        // é€šçŸ¥ä¸»é é¢
        localStorage.setItem('github-webhook-event', JSON.stringify(event));
        console.log('å·²è¨­å®š github-webhook-event:', event);

        // å¼·åˆ¶è§¸ç™¼ storage äº‹ä»¶
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'github-webhook-event',
            newValue: JSON.stringify(event)
        }));

        // è¨­å®šä¸€å€‹æ¨™è¨˜è¡¨ç¤ºå·²è™•ç†é
        localStorage.setItem('webhook-processed-' + Date.now(), JSON.stringify(event));

        console.log('âœ“ äº‹ä»¶è™•ç†å®Œæˆï¼Œç­‰å¾…é é¢é‡æ•´...');
    } else {
        console.log('ç¼ºå°‘å¿…è¦åƒæ•¸');
        document.getElementById('status').innerHTML = 'ç¼ºå°‘å¿…è¦åƒæ•¸: action=' + action + ', project=' + project + '<br><br>é é¢å°‡ç¹¼çºŒç›£è½...';
    }

    // æª¢æŸ¥æ˜¯å¦æœ‰æœªè™•ç†çš„å¾…æ¸¬è©¦é …ç›®
    const pendingTests = JSON.parse(localStorage.getItem('pending-tests') || '{}');
    console.log('ç›®å‰çš„å¾…æ¸¬è©¦é …ç›®:', pendingTests);

    if (Object.keys(pendingTests).length > 0) {
        document.getElementById('status').innerHTML += '<br><br>ğŸ“Š ç›®å‰å¾…æ¸¬è©¦å°ˆæ¡ˆ: ' + Object.keys(pendingTests).join(', ');
    }
    </script>
</body>
</html>