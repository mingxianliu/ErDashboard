<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Webhook 接收器</title>
</head>
<body>
    <h3>GitHub Webhook 接收器</h3>
    <div id="status">等待接收...</div>
    
    <script>
    console.log('=== Webhook 頁面載入 ===');
    console.log('URL:', window.location.href);

    // 從 URL 參數接收 GitHub Actions 的通知
    const params = new URLSearchParams(window.location.search);
    const action = params.get('action');
    const project = params.get('project');
    const branch = params.get('branch');
    const author = params.get('author');

    console.log('參數:', { action, project, branch, author });

    if (action && project) {
        const statusDiv = document.getElementById('status');

        // 儲存事件到 localStorage
        const event = {
            action: action,
            project: project,
            branch: branch || 'unknown',
            author: author || 'unknown',
            timestamp: new Date().toISOString()
        };

        console.log('處理事件:', event);

        // 儲存待測試狀態
        if (action === 'push') {
            let pendingTests = JSON.parse(localStorage.getItem('pending-tests') || '{}');
            pendingTests[project] = {
                status: true,
                branch: branch,
                author: author,
                timestamp: event.timestamp
            };
            localStorage.setItem('pending-tests', JSON.stringify(pendingTests));
            console.log('已儲存 pending-tests:', pendingTests);

            statusDiv.innerHTML = `✓ 已標記 ${project} 待測試<br>分支: ${branch}<br>作者: ${author}<br>時間: ${event.timestamp}`;

        } else if (action === 'merge') {
            // 清除所有待測試標記
            localStorage.setItem('pending-tests', '{}');
            console.log('已清除所有待測試標記');

            statusDiv.innerHTML = `✓ 已清除所有待測試標記<br>合併到: ${branch}`;
        }

        // 通知主頁面
        localStorage.setItem('github-webhook-event', JSON.stringify(event));
        console.log('已設定 github-webhook-event:', event);

        // 強制觸發 storage 事件
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'github-webhook-event',
            newValue: JSON.stringify(event)
        }));

        // 5秒後自動關閉（延長時間方便檢查）
        setTimeout(() => {
            console.log('準備關閉視窗');
            window.close();
        }, 5000);
    } else {
        console.log('缺少必要參數');
        document.getElementById('status').innerHTML = '缺少必要參數: action=' + action + ', project=' + project;
    }
    </script>
</body>
</html>