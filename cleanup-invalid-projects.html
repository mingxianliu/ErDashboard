<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>清理無效專案</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h4>清理無效專案數據</h4>
            </div>
            <div class="card-body">
                <p>點擊按鈕清理無效的專案 ID（如 "123"）：</p>

                <button class="btn btn-warning mb-3" onclick="cleanupInvalidProjects()">
                    清理無效專案
                </button>

                <div id="status"></div>
                <div id="projectList" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="js/google-drive-api.js?v=20250918t"></script>
    <script src="js/team-data-manager.js?v=20250918u"></script>
    <script>
        async function cleanupInvalidProjects() {
            try {
                const statusDiv = document.getElementById('status');
                statusDiv.innerHTML = '<div class="alert alert-info">正在清理無效專案...</div>';

                // 載入當前數據
                const dataManager = new TeamDataManager();
                await dataManager.init();

                // 獲取所有專案
                const assignments = dataManager.getAllAssignments();
                console.log('當前專案:', Object.keys(assignments));

                // 有效專案列表
                const validProjects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy', 'SyncBC-Monorepo', 'iFMS-frontend'];

                // 找出無效專案
                const invalidProjects = Object.keys(assignments).filter(id => !validProjects.includes(id));
                console.log('無效專案:', invalidProjects);

                if (invalidProjects.length === 0) {
                    statusDiv.innerHTML = '<div class="alert alert-success">沒有發現無效專案</div>';
                    return;
                }

                // 移除無效專案
                invalidProjects.forEach(id => {
                    delete assignments[id];
                    console.log('已移除無效專案:', id);
                });

                // 儲存清理後的資料
                await dataManager.saveLocalChanges();

                statusDiv.innerHTML = `<div class="alert alert-success">已清理 ${invalidProjects.length} 個無效專案: ${invalidProjects.join(', ')}</div>`;

                // 顯示剩餘專案
                displayProjects(Object.keys(assignments));

                // 3秒後重新載入
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);

            } catch (error) {
                document.getElementById('status').innerHTML =
                    `<div class="alert alert-danger">清理失敗：${error.message}</div>`;
            }
        }

        function displayProjects(projects) {
            const projectList = document.getElementById('projectList');
            let html = '<h5>剩餘有效專案：</h5><ul class="list-group">';

            projects.forEach(id => {
                html += `<li class="list-group-item">${id}</li>`;
            });

            html += '</ul>';
            projectList.innerHTML = html;
        }
    </script>
</body>
</html>