<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ‰‹å‹•å®‰å…¨åŒæ­¥</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel=\"stylesheet\">
</head>
<body>
    <div class="container my-5">
        <h1>æ‰‹å‹•å®‰å…¨åŒæ­¥å·¥å…·</h1>
        <div class="alert alert-warning">
            <strong>æ³¨æ„ï¼š</strong>è‡ªå‹•åŒæ­¥å·²è¢«ç¦ç”¨ä»¥é˜²æ­¢è³‡æ–™éºå¤±ã€‚è«‹ä½¿ç”¨æ­¤å·¥å…·é€²è¡Œå®‰å…¨çš„æ‰‹å‹•åŒæ­¥ã€‚
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>1. è³‡æ–™æª¢æŸ¥</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" id="checkDataBtn">æª¢æŸ¥ç•¶å‰è³‡æ–™ç‹€æ…‹</button>
                <div id="dataStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>2. å®‰å…¨åŒæ­¥</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" id="syncBtn" disabled>åŒæ­¥åˆ° Google Drive</button>
                <div id="syncStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>3. æ¢å¾©è‡ªå‹•åŠŸèƒ½</h5>
            </div>
            <div class="card-body">
                <p>å¦‚æœç¢ºèªåŒæ­¥æ­£å¸¸ï¼Œå¯ä»¥æ¢å¾©è‡ªå‹•åŠŸèƒ½ï¼š</p>
                <button class="btn btn-warning" id="restoreAutoBtn">æ¢å¾©è‡ªå‹•åŒæ­¥åŠŸèƒ½</button>
                <div id="restoreStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="js/google-drive-api.js"></script>
    <script src="js/team-data-manager.js"></script>
    <script>
        let currentData = null;
        let isDataValid = false;

        document.getElementById('checkDataBtn').addEventListener('click', checkData);
        document.getElementById('syncBtn').addEventListener('click', syncData);
        document.getElementById('restoreAutoBtn').addEventListener('click', restoreAuto);

        async function checkData() {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>æª¢æŸ¥ä¸­...';

            try {
                // è¼‰å…¥æœ¬åœ°è³‡æ–™
                const assignments = JSON.parse(localStorage.getItem('teamAssignments') || '{}');

                if (!assignments || Object.keys(assignments).length === 0) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">âŒ æ²’æœ‰æ‰¾åˆ°æœ¬åœ°è³‡æ–™</div>';
                    return;
                }

                const projectCount = Object.keys(assignments).length;
                let projectsWithNotes = 0;
                let projectDetails = [];

                Object.keys(assignments).forEach(projectId => {
                    const project = assignments[projectId];
                    const hasNotes = project.notes && project.notes.length > 0;
                    const memberCount = project.members ? Object.keys(project.members).length : 0;

                    if (hasNotes) projectsWithNotes++;

                    projectDetails.push({
                        id: projectId,
                        name: project.projectName || projectId,
                        hasNotes: hasNotes,
                        memberCount: memberCount,
                        status: project.status || 'unknown'
                    });
                });

                // è³‡æ–™é©—è­‰
                isDataValid = projectCount >= 7 && projectsWithNotes > 0;

                let html = `
                    <div class="alert ${isDataValid ? 'alert-success' : 'alert-warning'}">
                        <h6>è³‡æ–™çµ±è¨ˆï¼š</h6>
                        <ul class="mb-0">
                            <li>å°ˆæ¡ˆæ•¸é‡: ${projectCount}</li>
                            <li>æœ‰å°ˆæ¡ˆå‚™è¨»çš„å°ˆæ¡ˆ: ${projectsWithNotes}</li>
                            <li>è³‡æ–™ç‹€æ…‹: ${isDataValid ? 'âœ… å®‰å…¨' : 'âš ï¸ ä¸å®Œæ•´'}</li>
                        </ul>
                    </div>
                    <div class="mt-3">
                        <h6>å°ˆæ¡ˆè©³æƒ…ï¼š</h6>
                        <div class="row">
                `;

                projectDetails.forEach(project => {
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="card card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><strong>${project.name}</strong></span>
                                    <div>
                                        ${project.hasNotes ? 'ğŸ“' : 'âŒ'}
                                        <small class="text-muted">${project.memberCount} æˆå“¡</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                statusDiv.innerHTML = html;

                // æº–å‚™åŒæ­¥è³‡æ–™
                currentData = {
                    assignments: assignments,
                    constraints: {},
                    statistics: {
                        totalProjects: projectCount,
                        projectsWithNotes: projectsWithNotes
                    }
                };

                document.getElementById('syncBtn').disabled = !isDataValid;

            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">âŒ æª¢æŸ¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function syncData() {
            if (!isDataValid || !currentData) {
                alert('è³‡æ–™æœªé€šéé©—è­‰ï¼Œç„¡æ³•åŒæ­¥');
                return;
            }

            const statusDiv = document.getElementById('syncStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>åŒæ­¥ä¸­...';

            try {
                // æš«æ™‚ç§»é™¤ä¿è­·ä»¥å…è¨±æ‰‹å‹•åŒæ­¥
                const originalSaveFile = window.googleDriveAPI.saveFile;

                await originalSaveFile.call(window.googleDriveAPI, 'project-assignments.json', currentData);

                statusDiv.innerHTML = '<div class="alert alert-success">âœ… åŒæ­¥æˆåŠŸï¼</div>';

            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">âŒ åŒæ­¥å¤±æ•—: ${error.message}</div>`;
            }
        }

        async function restoreAuto() {
            const statusDiv = document.getElementById('restoreStatus');

            if (confirm('ç¢ºå®šè¦æ¢å¾©è‡ªå‹•åŒæ­¥åŠŸèƒ½å—ï¼Ÿ\n\né€™å°‡ç§»é™¤æ‰€æœ‰ä¿è­·æ©Ÿåˆ¶ã€‚')) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h6>æ¢å¾©æ­¥é©Ÿï¼š</h6>
                        <ol>
                            <li>ç§»é™¤ protect-project-assignments.js è¼‰å…¥</li>
                            <li>æ¢å¾© team-data-manager.js çš„è‡ªå‹• Push</li>
                            <li>æ¢å¾© index.html çš„ beforeunload å’Œ pendingPush</li>
                            <li>é‡æ–°è¼‰å…¥é é¢</li>
                        </ol>
                        <p><strong>è«‹é€šçŸ¥é–‹ç™¼è€…åŸ·è¡Œé€™äº›æ­¥é©Ÿã€‚</strong></p>
                    </div>
                `;
            }
        }

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æª¢æŸ¥è³‡æ–™
        window.addEventListener('load', () => {
            setTimeout(checkData, 1000);
        });
    </script>
</body>
</html>