<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>手動安全同步</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel=\"stylesheet\">
</head>
<body>
    <div class="container my-5">
        <h1>手動安全同步工具</h1>
        <div class="alert alert-warning">
            <strong>注意：</strong>自動同步已被禁用以防止資料遺失。請使用此工具進行安全的手動同步。
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>1. 資料檢查</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" id="checkDataBtn">檢查當前資料狀態</button>
                <div id="dataStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h5>2. 安全同步</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" id="syncBtn" disabled>同步到 Google Drive</button>
                <div id="syncStatus" class="mt-3"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>3. 恢復自動功能</h5>
            </div>
            <div class="card-body">
                <p>如果確認同步正常，可以恢復自動功能：</p>
                <button class="btn btn-warning" id="restoreAutoBtn">恢復自動同步功能</button>
                <div id="restoreStatus" class="mt-3"></div>
            </div>
        </div>
    </div>

    <script src="js/google-drive-api.js"></script>
    <script src="js/team-data-manager.js"></script>
    <script>
        let currentData = null;
        let isDataValid = false;

        document.getElementById('checkDataBtn').addEventListener('click', checkData);
        document.getElementById('syncBtn').addEventListener('click', syncData);
        document.getElementById('restoreAutoBtn').addEventListener('click', restoreAuto);

        async function checkData() {
            const statusDiv = document.getElementById('dataStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>檢查中...';

            try {
                // 載入本地資料
                const assignments = JSON.parse(localStorage.getItem('teamAssignments') || '{}');

                if (!assignments || Object.keys(assignments).length === 0) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">❌ 沒有找到本地資料</div>';
                    return;
                }

                const projectCount = Object.keys(assignments).length;
                let projectsWithNotes = 0;
                let projectDetails = [];

                Object.keys(assignments).forEach(projectId => {
                    const project = assignments[projectId];
                    const hasNotes = project.notes && project.notes.length > 0;
                    const memberCount = project.members ? Object.keys(project.members).length : 0;

                    if (hasNotes) projectsWithNotes++;

                    projectDetails.push({
                        id: projectId,
                        name: project.projectName || projectId,
                        hasNotes: hasNotes,
                        memberCount: memberCount,
                        status: project.status || 'unknown'
                    });
                });

                // 資料驗證
                isDataValid = projectCount >= 7 && projectsWithNotes > 0;

                let html = `
                    <div class="alert ${isDataValid ? 'alert-success' : 'alert-warning'}">
                        <h6>資料統計：</h6>
                        <ul class="mb-0">
                            <li>專案數量: ${projectCount}</li>
                            <li>有專案備註的專案: ${projectsWithNotes}</li>
                            <li>資料狀態: ${isDataValid ? '✅ 安全' : '⚠️ 不完整'}</li>
                        </ul>
                    </div>
                    <div class="mt-3">
                        <h6>專案詳情：</h6>
                        <div class="row">
                `;

                projectDetails.forEach(project => {
                    html += `
                        <div class="col-md-6 mb-2">
                            <div class="card card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span><strong>${project.name}</strong></span>
                                    <div>
                                        ${project.hasNotes ? '📝' : '❌'}
                                        <small class="text-muted">${project.memberCount} 成員</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div></div>';
                statusDiv.innerHTML = html;

                // 準備同步資料
                currentData = {
                    assignments: assignments,
                    constraints: {},
                    statistics: {
                        totalProjects: projectCount,
                        projectsWithNotes: projectsWithNotes
                    }
                };

                document.getElementById('syncBtn').disabled = !isDataValid;

            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">❌ 檢查失敗: ${error.message}</div>`;
            }
        }

        async function syncData() {
            if (!isDataValid || !currentData) {
                alert('資料未通過驗證，無法同步');
                return;
            }

            const statusDiv = document.getElementById('syncStatus');
            statusDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>同步中...';

            try {
                // 暫時移除保護以允許手動同步
                const originalSaveFile = window.googleDriveAPI.saveFile;

                await originalSaveFile.call(window.googleDriveAPI, 'project-assignments.json', currentData);

                statusDiv.innerHTML = '<div class="alert alert-success">✅ 同步成功！</div>';

            } catch (error) {
                statusDiv.innerHTML = `<div class="alert alert-danger">❌ 同步失敗: ${error.message}</div>`;
            }
        }

        async function restoreAuto() {
            const statusDiv = document.getElementById('restoreStatus');

            if (confirm('確定要恢復自動同步功能嗎？\n\n這將移除所有保護機制。')) {
                statusDiv.innerHTML = `
                    <div class="alert alert-info">
                        <h6>恢復步驟：</h6>
                        <ol>
                            <li>移除 protect-project-assignments.js 載入</li>
                            <li>恢復 team-data-manager.js 的自動 Push</li>
                            <li>恢復 index.html 的 beforeunload 和 pendingPush</li>
                            <li>重新載入頁面</li>
                        </ol>
                        <p><strong>請通知開發者執行這些步驟。</strong></p>
                    </div>
                `;
            }
        }

        // 頁面載入時自動檢查資料
        window.addEventListener('load', () => {
            setTimeout(checkData, 1000);
        });
    </script>
</body>
</html>