name: æ¥æ”¶ PR å‚™è¨»è«‹æ±‚

on:
  repository_dispatch:
    types: [pr-note]

jobs:
  submit-pr-note:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ErDashboard
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: æå– PR è³‡è¨Š
      id: pr_info
      run: |
        echo "PROJECT_NAME=${{ github.event.client_payload.project_name }}" >> $GITHUB_OUTPUT
        echo "GITHUB_USER=${{ github.event.client_payload.github_user }}" >> $GITHUB_OUTPUT
        echo "PR_TITLE=${{ github.event.client_payload.pr_title }}" >> $GITHUB_OUTPUT
        echo "PR_NUMBER=${{ github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
        echo "REPO_NAME=${{ github.event.client_payload.repo_name }}" >> $GITHUB_OUTPUT

    - name: å»ºç«‹è§’è‰²å‚™è¨»
      run: |
        PROJECT_NAME="${{ steps.pr_info.outputs.PROJECT_NAME }}"
        GITHUB_USER="${{ steps.pr_info.outputs.GITHUB_USER }}"
        PR_TITLE="${{ steps.pr_info.outputs.PR_TITLE }}"
        PR_NUMBER="${{ steps.pr_info.outputs.PR_NUMBER }}"
        REPO_NAME="${{ steps.pr_info.outputs.REPO_NAME }}"

        echo "ğŸš€ è‡ªå‹•æäº¤ PR å‚™è¨»:"
        echo "å°ˆæ¡ˆ: ${PROJECT_NAME}"
        echo "å€‰åº«: ${REPO_NAME}"
        echo "é–‹ç™¼è€…: ${GITHUB_USER}"
        echo "PR: #${PR_NUMBER} ${PR_TITLE}"

        # ä½¿ç”¨ PR å‚™è¨»è…³æœ¬
        node scripts/submit-pr-note.js "${PROJECT_NAME}" "${GITHUB_USER}" "${PR_TITLE}" "${PR_NUMBER}"

    - name: æ¨é€çµæœ
      run: |
        git config user.name "PR AutoBot"
        git config user.email "pr-autobot@erdashboard"

        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
          exit 0
        fi

        git push
        echo "âœ… PR å‚™è¨»å·²è‡ªå‹•æäº¤ï¼"