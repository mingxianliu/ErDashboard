name: æ¥æ”¶ PR å‚™è¨»è«‹æ±‚

on:
  repository_dispatch:
    types: [pr-note, dev-note]

permissions:
  contents: write

jobs:
  submit-pr-note:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout ErDashboard
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: æå–äº‹ä»¶è³‡è¨Š
      id: event_info
      run: |
        echo "PROJECT_NAME=${{ github.event.client_payload.project_name }}" >> $GITHUB_OUTPUT
        echo "GITHUB_USER=${{ github.event.client_payload.github_user }}" >> $GITHUB_OUTPUT
        echo "EVENT_TYPE=${{ github.event.client_payload.event_type }}" >> $GITHUB_OUTPUT
        echo "TITLE=${{ github.event.client_payload.title || github.event.client_payload.pr_title }}" >> $GITHUB_OUTPUT
        echo "NUMBER=${{ github.event.client_payload.number || github.event.client_payload.pr_number }}" >> $GITHUB_OUTPUT
        echo "REPO_NAME=${{ github.event.client_payload.repo_name }}" >> $GITHUB_OUTPUT
        echo "URL=${{ github.event.client_payload.url || github.event.client_payload.pr_url }}" >> $GITHUB_OUTPUT

    - name: å»ºç«‹é–‹ç™¼å‚™è¨»
      run: |
        PROJECT_NAME="${{ steps.event_info.outputs.PROJECT_NAME }}"
        GITHUB_USER="${{ steps.event_info.outputs.GITHUB_USER }}"
        EVENT_TYPE="${{ steps.event_info.outputs.EVENT_TYPE }}"
        TITLE="${{ steps.event_info.outputs.TITLE }}"
        NUMBER="${{ steps.event_info.outputs.NUMBER }}"
        REPO_NAME="${{ steps.event_info.outputs.REPO_NAME }}"

        echo "ğŸš€ è‡ªå‹•æäº¤é–‹ç™¼å‚™è¨»:"
        echo "å°ˆæ¡ˆ: ${PROJECT_NAME}"
        echo "å€‰åº«: ${REPO_NAME}"
        echo "é–‹ç™¼è€…: ${GITHUB_USER}"
        echo "é¡å‹: ${EVENT_TYPE}"
        echo "å…§å®¹: ${TITLE}"

        # ä½¿ç”¨é–‹ç™¼å‚™è¨»è…³æœ¬
        node scripts/submit-dev-note.js "${PROJECT_NAME}" "${GITHUB_USER}" "${EVENT_TYPE}" "${TITLE}" "${NUMBER}"

    - name: æ¨é€çµæœ
      run: |
        git config user.name "PR AutoBot"
        git config user.email "pr-autobot@erdashboard"

        # æ·»åŠ æ‰€æœ‰è®Šæ›´åˆ°æš«å­˜å€
        git add .

        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
          exit 0
        fi

        git commit -m "è‡ªå‹•å‚™è¨»: ${{ steps.event_info.outputs.PROJECT_NAME }} - ${{ steps.event_info.outputs.TITLE }}"

        # è™•ç†ä¸¦ç™¼æ¨é€è¡çª
        git pull --rebase || echo "âš ï¸ pull å¤±æ•—ï¼Œå˜—è©¦ç›´æ¥æ¨é€"
        git push
        echo "âœ… PR å‚™è¨»å·²è‡ªå‹•æäº¤ï¼"