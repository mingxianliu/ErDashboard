# ğŸ¤– PR è‡ªå‹•å‚™è¨»åˆ° ErDashboard
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. è¤‡è£½æ­¤æª”æ¡ˆåˆ°ä½ çš„å°ˆæ¡ˆ .github/workflows/ è³‡æ–™å¤¾
# 2. æ ¹æ“šéœ€è¦ä¿®æ”¹ PROJECT_NAME çš„å°æ‡‰é‚è¼¯
# 3. è¨­å®š ERDASHBOARD_TOKEN secret (å¯é¸ï¼Œç”¨æ–¼èªè­‰)

name: è‡ªå‹•æäº¤ PR å‚™è¨»åˆ° ErDashboard

on:
  pull_request:
    types: [opened, ready_for_review]

jobs:
  notify-erdashboard:
    runs-on: ubuntu-latest

    steps:
    - name: è¨­å®šå°ˆæ¡ˆåç¨±
      id: project
      run: |
        REPO_NAME="${{ github.event.repository.name }}"

        # è‡ªå‹•å°æ‡‰å°ˆæ¡ˆåç¨±
        case "${REPO_NAME}" in
          *[Cc]ore*) PROJECT_NAME="ErCore" ;;
          *[Nn]exus*) PROJECT_NAME="ErNexus" ;;
          *[Ss]hield*) PROJECT_NAME="ErShield" ;;
          *[Tt]idy*) PROJECT_NAME="ErTidy" ;;
          *EZOOM*|*ezoom*) PROJECT_NAME="EZOOM" ;;
          *[Ii][Ff][Mm][Ss]*) PROJECT_NAME="iFMS-Frontend" ;;
          *[Ss]ync*) PROJECT_NAME="SyncBC-Monorepo" ;;
          *) PROJECT_NAME="${REPO_NAME}" ;;  # é è¨­ä½¿ç”¨å€‰åº«åç¨±
        esac

        echo "PROJECT_NAME=${PROJECT_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… æª¢æ¸¬åˆ°å°ˆæ¡ˆ: ${PROJECT_NAME}"

    - name: è§¸ç™¼ ErDashboard è‡ªå‹•å‚™è¨»
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: mingxianliu/ErDashboard
        event-type: pr-note
        client-payload: |
          {
            "project_name": "${{ steps.project.outputs.PROJECT_NAME }}",
            "github_user": "${{ github.event.pull_request.user.login }}",
            "pr_title": "${{ github.event.pull_request.title }}",
            "pr_number": "${{ github.event.pull_request.number }}",
            "repo_name": "${{ github.event.repository.name }}",
            "pr_url": "${{ github.event.pull_request.html_url }}"
          }

    - name: å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸš€ å·²è§¸ç™¼ ErDashboard è‡ªå‹•å‚™è¨»ï¼š"
        echo "   å°ˆæ¡ˆ: ${{ steps.project.outputs.PROJECT_NAME }}"
        echo "   é–‹ç™¼è€…: ${{ github.event.pull_request.user.login }}"
        echo "   PR: #${{ github.event.pull_request.number }} ${{ github.event.pull_request.title }}"
        echo "âœ… ErDashboard å°‡è‡ªå‹•å»ºç«‹è§’è‰²å‚™è¨»ï¼"