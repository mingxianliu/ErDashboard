# ğŸ¤– PR è‡ªå‹•å‚™è¨»åˆ° ErDashboard
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. è¤‡è£½æ­¤æª”æ¡ˆåˆ°ä½ çš„å°ˆæ¡ˆ .github/workflows/ è³‡æ–™å¤¾
# 2. æ ¹æ“šéœ€è¦ä¿®æ”¹ PROJECT_NAME çš„å°æ‡‰é‚è¼¯
# 3. è¨­å®š ERDASHBOARD_TOKEN secret (å¯é¸ï¼Œç”¨æ–¼èªè­‰)

name: è‡ªå‹•æäº¤ PR å‚™è¨»åˆ° ErDashboard

on:
  pull_request:
    types: [opened, ready_for_review, closed]
  push:
    branches: [main, master, develop]
    # ç•¶ç›´æ¥æ¨é€åˆ°ä¸»è¦åˆ†æ”¯æ™‚ä¹Ÿè§¸ç™¼

jobs:
  notify-erdashboard:
    runs-on: ubuntu-latest

    steps:
    - name: è¨­å®šå°ˆæ¡ˆåç¨±
      id: project
      run: |
        REPO_NAME="${{ github.event.repository.name }}"

        # è‡ªå‹•å°æ‡‰å°ˆæ¡ˆåç¨±
        case "${REPO_NAME}" in
          *[Cc]ore*) PROJECT_NAME="ErCore" ;;
          *[Nn]exus*) PROJECT_NAME="ErNexus" ;;
          *[Ss]hield*) PROJECT_NAME="ErShield" ;;
          *[Tt]idy*) PROJECT_NAME="ErTidy" ;;
          *EZOOM*|*ezoom*) PROJECT_NAME="EZOOM" ;;
          *[Ii][Ff][Mm][Ss]*) PROJECT_NAME="iFMS-Frontend" ;;
          *[Ss]ync*) PROJECT_NAME="SyncBC-Monorepo" ;;
          *) PROJECT_NAME="${REPO_NAME}" ;;  # é è¨­ä½¿ç”¨å€‰åº«åç¨±
        esac

        echo "PROJECT_NAME=${PROJECT_NAME}" >> $GITHUB_OUTPUT
        echo "âœ… æª¢æ¸¬åˆ°å°ˆæ¡ˆ: ${PROJECT_NAME}"

    - name: åˆ†æäº‹ä»¶é¡å‹å’Œå…§å®¹
      id: event_info
      run: |
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # PR äº‹ä»¶
          if [[ "${{ github.event.action }}" == "closed" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            EVENT_TYPE="merge"
            TITLE="Merged: ${{ github.event.pull_request.title }}"
            USER="${{ github.event.pull_request.user.login }}"
            NUMBER="${{ github.event.pull_request.number }}"
            URL="${{ github.event.pull_request.html_url }}"
          else
            EVENT_TYPE="pr"
            TITLE="${{ github.event.pull_request.title }}"
            USER="${{ github.event.pull_request.user.login }}"
            NUMBER="${{ github.event.pull_request.number }}"
            URL="${{ github.event.pull_request.html_url }}"
          fi
        else
          # Push äº‹ä»¶
          EVENT_TYPE="push"
          COMMIT_MSG="$(echo '${{ github.event.head_commit.message }}' | head -n1)"

          # æª¢æŸ¥æ˜¯å¦ç‚º feat commit
          if [[ "${COMMIT_MSG}" =~ ^feat.* ]]; then
            EVENT_TYPE="feat"
            TITLE="${COMMIT_MSG}"
          else
            TITLE="${COMMIT_MSG}"
          fi

          USER="${{ github.event.pusher.name }}"
          NUMBER="${{ github.sha }}"
          URL="${{ github.event.head_commit.url }}"
        fi

        echo "EVENT_TYPE=${EVENT_TYPE}" >> $GITHUB_OUTPUT
        echo "TITLE=${TITLE}" >> $GITHUB_OUTPUT
        echo "USER=${USER}" >> $GITHUB_OUTPUT
        echo "NUMBER=${NUMBER}" >> $GITHUB_OUTPUT
        echo "URL=${URL}" >> $GITHUB_OUTPUT

    - name: è§¸ç™¼ ErDashboard è‡ªå‹•å‚™è¨»
      uses: peter-evans/repository-dispatch@v2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        repository: mingxianliu/ErDashboard
        event-type: dev-note
        client-payload: |
          {
            "project_name": "${{ steps.project.outputs.PROJECT_NAME }}",
            "github_user": "${{ steps.event_info.outputs.USER }}",
            "event_type": "${{ steps.event_info.outputs.EVENT_TYPE }}",
            "title": "${{ steps.event_info.outputs.TITLE }}",
            "number": "${{ steps.event_info.outputs.NUMBER }}",
            "repo_name": "${{ github.event.repository.name }}",
            "url": "${{ steps.event_info.outputs.URL }}"
          }

    - name: å®Œæˆé€šçŸ¥
      run: |
        echo "ğŸš€ å·²è§¸ç™¼ ErDashboard è‡ªå‹•å‚™è¨»ï¼š"
        echo "   å°ˆæ¡ˆ: ${{ steps.project.outputs.PROJECT_NAME }}"
        echo "   é–‹ç™¼è€…: ${{ steps.event_info.outputs.USER }}"
        echo "   é¡å‹: ${{ steps.event_info.outputs.EVENT_TYPE }}"
        echo "   å…§å®¹: ${{ steps.event_info.outputs.TITLE }}"
        echo "âœ… ErDashboard å°‡è‡ªå‹•å»ºç«‹è§’è‰²å‚™è¨»ï¼"