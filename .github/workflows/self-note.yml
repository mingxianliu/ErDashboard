name: ErDashboard è‡ªå‹•å‚™è¨»

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  self-note:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: å»ºç«‹é–‹ç™¼å‚™è¨»
      run: |
        # æå– commit è³‡è¨Š
        COMMIT_MESSAGE="${{ github.event.head_commit.message }}"
        COMMIT_AUTHOR="${{ github.event.head_commit.author.username }}"
        COMMIT_SHA="${{ github.sha }}"

        # æå–ç¬¬ä¸€è¡Œä½œç‚ºæ¨™é¡Œ
        TITLE=$(echo "$COMMIT_MESSAGE" | head -n1)

        echo "ğŸ“ å»ºç«‹ ErDashboard è‡ªå‹•å‚™è¨»"
        echo "ä½œè€…: $COMMIT_AUTHOR"
        echo "æ¨™é¡Œ: $TITLE"
        echo "SHA: $COMMIT_SHA"

        # ä½¿ç”¨é–‹ç™¼å‚™è¨»è…³æœ¬
        node scripts/submit-dev-note.js "ErDashboard" "$COMMIT_AUTHOR" "push" "$TITLE" "$COMMIT_SHA"

    - name: æ¨é€å‚™è¨»
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"

        # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
        if git diff --quiet && git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
          exit 0
        fi

        # æ·»åŠ æ‰€æœ‰ role-notes è®Šæ›´
        git add role-notes/

        if git diff --staged --quiet; then
          echo "æ²’æœ‰è®Šæ›´éœ€è¦æ¨é€"
          exit 0
        fi

        git commit -m "auto-note: ${{ github.event.head_commit.author.username }} - ${TITLE:0:50}"
        git push

        echo "âœ… è‡ªå‹•å‚™è¨»å·²æäº¤ï¼"