<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard 設定</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fc;
        }
        .settings-container {
            max-width: 800px;
            margin: 50px auto;
        }
        .card {
            border: none;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, .15);
        }
        .token-input {
            font-family: monospace;
        }
        .success-message {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container settings-container">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Dashboard 設定
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h6 class="fw-bold mb-3">監控範圍設定</h6>
                    
                    <div class="alert alert-success">
                        <i class="fas fa-globe me-2"></i>
                        <strong>最簡單選擇：只監控公開 Repositories</strong>
                        <br><small>不需要設定任何 Token，完全沒有權限風險！</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="monitorScope" id="publicOnly" value="public" checked>
                        <label class="form-check-label" for="publicOnly">
                            <strong>只監控公開 repositories</strong>
                            <br><small class="text-muted">✅ 不需要 Token ✅ 完全安全 ✅ 適合 README 追蹤</small>
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" name="monitorScope" id="includePrivate" value="private">
                        <label class="form-check-label" for="includePrivate">
                            <strong>包含私有 repositories</strong>
                            <br><small class="text-muted">⚠️ 需要設定 GitHub Token</small>
                        </label>
                    </div>
                    
                    <div id="tokenSection" class="d-none">
                        <h6 class="fw-bold mb-3">GitHub Personal Access Token</h6>
                        <p class="text-muted">
                            若要監控私有 Repository，請設定您的 GitHub Personal Access Token。
                            <a href="https://github.com/settings/tokens/new" target="_blank" class="text-decoration-none">
                                <i class="fas fa-external-link-alt"></i> 建立新 Token
                            </a>
                        </p>
                    
                    <div class="mb-3">
                        <label for="tokenInput" class="form-label">Personal Access Token</label>
                        <div class="input-group">
                            <input type="password" class="form-control token-input" id="tokenInput" 
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
                            <button class="btn btn-outline-secondary" type="button" id="toggleToken">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Token 將安全地儲存在瀏覽器的 localStorage 中，不會傳送到任何伺服器。
                        </div>
                    </div>

                    <div class="mb-3">
                        <button class="btn btn-primary" id="saveToken">
                            <i class="fas fa-save me-2"></i>儲存 Token
                        </button>
                        <button class="btn btn-danger ms-2" id="clearToken">
                            <i class="fas fa-trash me-2"></i>清除 Token
                        </button>
                        <button class="btn btn-secondary ms-2" id="testToken">
                            <i class="fas fa-check-circle me-2"></i>測試連線
                        </button>
                    </div>

                    <div class="alert alert-success success-message" id="successMessage" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="successText">Token 已成功儲存！</span>
                    </div>

                    <div class="alert alert-danger d-none" id="errorMessage" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="errorText">發生錯誤</span>
                    </div>
                </div>

                <hr>

                <div class="mb-4">
                    <h6 class="fw-bold mb-3">Token 權限要求</h6>
                    <p class="text-muted">請確保您的 Token 具有以下權限：</p>
                    <ul class="list-group">
                        <li class="list-group-item">
                            <i class="fas fa-check text-success me-2"></i>
                            <strong>repo</strong> - 存取私有 repositories
                            <br><small class="text-muted">⚠️ 這會給予讀取所有私有 repo 的權限</small>
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-times text-danger me-2"></i>
                            <strong class="text-decoration-line-through">read:user</strong> - 不需要
                            <br><small class="text-muted">Dashboard 不需要使用者資訊</small>
                        </li>
                        <li class="list-group-item">
                            <i class="fas fa-times text-danger me-2"></i>
                            <strong class="text-decoration-line-through">read:org</strong> - 不需要（除非監控組織 repos）
                            <br><small class="text-muted">只有監控組織專案時才需要</small>
                        </li>
                    </ul>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>最安全做法：</strong> 只勾選 <code>repo</code> 權限即可！
                    </div>
                    </div> <!-- 結束 tokenSection -->
                </div>

                <div class="mb-4">
                    <h6 class="fw-bold mb-3 text-warning">
                        <i class="fas fa-shield-alt me-2"></i>Token 安全建議
                    </h6>
                    <div class="alert alert-warning">
                        <ul class="mb-0">
                            <li><strong>設定 Token 過期時間</strong> - 建議 30-90 天</li>
                            <li><strong>只給必要權限</strong> - 僅勾選 repo 權限</li>
                            <li><strong>定期更換</strong> - 定期重新產生新 Token</li>
                            <li><strong>私密保管</strong> - 不要分享或存放在不安全的地方</li>
                        </ul>
                    </div>
                    <a href="https://github.com/settings/tokens" target="_blank" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-external-link-alt me-2"></i>管理現有 Tokens
                    </a>
                </div>

                <div class="text-center">
                    <a href="index.html" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>返回 Dashboard
                    </a>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>監控的 Repository
                </h6>
            </div>
            <div class="card-body">
                <p class="text-muted">目前設定監控以下 Repository Pattern：</p>
                <div id="repoList" class="list-group">
                    <!-- 動態載入 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 載入現有的 token
        document.addEventListener('DOMContentLoaded', function() {
            // 處理監控範圍選擇
            const publicOnlyRadio = document.getElementById('publicOnly');
            const includePrivateRadio = document.getElementById('includePrivate');
            const tokenSection = document.getElementById('tokenSection');
            
            // 檢查現有設定
            const hasToken = localStorage.getItem('PD_TOKEN');
            if (hasToken) {
                includePrivateRadio.checked = true;
                tokenSection.classList.remove('d-none');
            }
            
            // 切換事件
            publicOnlyRadio.addEventListener('change', function() {
                if (this.checked) {
                    tokenSection.classList.add('d-none');
                    localStorage.removeItem('PD_TOKEN');
                }
            });
            
            includePrivateRadio.addEventListener('change', function() {
                if (this.checked) {
                    tokenSection.classList.remove('d-none');
                }
            });
            
            const existingToken = localStorage.getItem('PD_TOKEN');
            if (existingToken) {
                // 顯示遮罩版本的 token
                document.getElementById('tokenInput').value = '*'.repeat(Math.min(existingToken.length, 40));
                document.getElementById('tokenInput').dataset.actualToken = existingToken;
            }

            // 載入 repository 設定
            loadRepoConfig();
        });

        // 切換顯示/隱藏 token
        document.getElementById('toggleToken').addEventListener('click', function() {
            const input = document.getElementById('tokenInput');
            const icon = this.querySelector('i');
            const actualToken = input.dataset.actualToken;
            
            if (input.type === 'password') {
                input.type = 'text';
                if (actualToken) {
                    input.value = actualToken;
                }
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                if (actualToken) {
                    input.value = '*'.repeat(Math.min(actualToken.length, 40));
                }
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        });

        // 儲存 token
        document.getElementById('saveToken').addEventListener('click', function() {
            const input = document.getElementById('tokenInput');
            let token = input.value.trim();
            
            // 如果是遮罩的 token，使用實際的 token
            if (token.startsWith('*') && input.dataset.actualToken) {
                token = input.dataset.actualToken;
            }
            
            if (!token || token.startsWith('*')) {
                showError('請輸入有效的 Token');
                return;
            }

            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showError('Token 格式不正確，應以 ghp_ 或 github_pat_ 開頭');
                return;
            }

            localStorage.setItem('PD_TOKEN', token);
            
            // 儲存後立即遮罩顯示
            input.value = '*'.repeat(Math.min(token.length, 40));
            input.dataset.actualToken = token;
            input.type = 'password';
            document.querySelector('#toggleToken i').classList.replace('fa-eye-slash', 'fa-eye');
            
            showSuccess('Token 已成功儲存並隱藏！');
        });

        // 清除 token
        document.getElementById('clearToken').addEventListener('click', function() {
            if (confirm('確定要清除儲存的 Token 嗎？')) {
                localStorage.removeItem('PD_TOKEN');
                document.getElementById('tokenInput').value = '';
                showSuccess('Token 已清除！');
            }
        });

        // 測試 token
        document.getElementById('testToken').addEventListener('click', async function() {
            const input = document.getElementById('tokenInput');
            let token = input.value.trim();
            
            // 如果是遮罩的 token，使用實際的 token
            if (token.startsWith('*') && input.dataset.actualToken) {
                token = input.dataset.actualToken;
            }
            
            if (!token || token.startsWith('*')) {
                showError('請先輸入 Token');
                return;
            }

            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>測試中...';

            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const user = await response.json();
                    showSuccess(`連線成功！已驗證身份：${user.login}`);
                } else {
                    showError(`連線失敗：${response.status} ${response.statusText}`);
                }
            } catch (error) {
                showError(`連線失敗：${error.message}`);
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-check-circle me-2"></i>測試連線';
            }
        });

        // 載入 repository 設定
        async function loadRepoConfig() {
            try {
                const response = await fetch('js/config.js');
                const text = await response.text();
                
                // 簡單解析 CONFIG 物件
                const match = text.match(/repositories:\s*\[([\s\S]*?)\]/);
                if (match) {
                    const repoList = document.getElementById('repoList');
                    repoList.innerHTML = `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-0">Er 專案群</h6>
                                    <small class="text-muted">Owner: mingxianliu | Pattern: Er*</small>
                                </div>
                                <span class="badge bg-primary">自動展開</span>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('載入設定失敗:', error);
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            const errorDiv = document.getElementById('errorMessage');
            
            document.getElementById('successText').textContent = message;
            successDiv.style.display = 'block';
            errorDiv.classList.add('d-none');
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const successDiv = document.getElementById('successMessage');
            const errorDiv = document.getElementById('errorMessage');
            
            document.getElementById('errorText').textContent = message;
            errorDiv.classList.remove('d-none');
            successDiv.style.display = 'none';
            
            setTimeout(() => {
                errorDiv.classList.add('d-none');
            }, 5000);
        }
    </script>
</body>
</html>