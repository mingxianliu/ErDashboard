<!DOCTYPE html>
<html>
<head>
    <title>ä¿®å¾©è§’è‰²è³‡æ–™</title>
</head>
<body>
    <h1>ä¿®å¾©è§’è‰²è³‡æ–™</h1>
    <button onclick="fixRoles()">ä¿®å¾©è§’è‰²</button>
    <div id="status"></div>

    <script src="js/google-drive-api.js?v=20250923a"></script>

    <script>
        function log(message) {
            document.getElementById('status').innerHTML += message + '<br>';
            console.log(message);
        }

        async function fixRoles() {
            try {
                log('ğŸ”§ é–‹å§‹ä¿®å¾©è§’è‰²è³‡æ–™...');

                // åˆå§‹åŒ– Google Drive API
                if (!window.googleDriveAPI) {
                    log('âŒ Google Drive API æœªè¼‰å…¥');
                    return;
                }

                if (!window.googleDriveAPI.isAuthenticated) {
                    log('ğŸ” éœ€è¦ç™»å…¥ Google Drive...');
                    const loginSuccess = await window.googleDriveAPI.signIn();
                    if (!loginSuccess) {
                        log('âŒ ç™»å…¥å¤±æ•—');
                        return;
                    }
                }

                // è¼‰å…¥æ­£ç¢ºçš„æœ¬åœ°è³‡æ–™
                log('ğŸ“ è¼‰å…¥æœ¬åœ°æ­£ç¢ºè³‡æ–™...');
                const response = await fetch('config/project-assignments.json');
                const correctData = await response.json();

                log('âœ… æœ¬åœ°è³‡æ–™è¼‰å…¥æˆåŠŸ');
                log('ğŸ“Š å°ˆæ¡ˆæ•¸é‡: ' + Object.keys(correctData.assignments).length);

                // æª¢æŸ¥è§’è‰²
                for (const [projectId, project] of Object.entries(correctData.assignments)) {
                    if (project.members) {
                        for (const [memberId, member] of Object.entries(project.members)) {
                            log(`${projectId} -> ${member.memberName}: ${member.role}`);
                        }
                    }
                }

                // å¼·åˆ¶ä¸Šå‚³åˆ° Google Drive
                log('â˜ï¸ ä¸Šå‚³åˆ° Google Drive...');
                await window.googleDriveAPI.saveFile('project-assignments.json', correctData, 'assignments');

                log('âœ… ä¿®å¾©å®Œæˆï¼è«‹é‡æ–°è¼‰å…¥ä¸»é é¢');

                // æ¸…é™¤ç€è¦½å™¨å¿«å–
                localStorage.removeItem('teamAssignments');
                localStorage.removeItem('cachedTeamMembers');
                localStorage.removeItem('teamMemberChanges');
                localStorage.removeItem('teamGroupChanges');

                log('ğŸ§¹ å·²æ¸…é™¤å¿«å–');

            } catch (error) {
                log('âŒ ä¿®å¾©å¤±æ•—: ' + error.message);
                console.error(error);
            }
        }
    </script>
</body>
</html>