<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§ç›£è¦–ç³»çµ±ä¿®å¾©å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; line-height: 1.6; }
        button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; border-radius: 4px; }
        .btn-danger { background: #dc3545; color: white; border: none; border-radius: 4px; }
        #result { margin-top: 20px; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ æ™ºæ…§ç›£è¦–ç³»çµ±ä¿®å¾©å·¥å…·</h1>
    <p>ä¿®å¾©ã€Œæ™ºæ…§ç›£è¦–ç³»çµ±ã€ç©ºé …ç›®ï¼ˆåœ˜éšŠæˆå“¡(0)ï¼‰å•é¡Œ</p>

    <div>
        <button id="checkBtn" class="btn-primary">ğŸ” æª¢æŸ¥æ•¸æ“šç‹€æ…‹</button>
        <button id="fixLocalBtn" class="btn-danger">ğŸ—‘ï¸ åˆªé™¤æœ¬åœ°æ•¸æ“š</button>
        <button id="fixGlobalBtn" class="btn-danger">ğŸ—‘ï¸ åˆªé™¤å…¨å±€æ•¸æ“š</button>
        <button id="reloadBtn" class="btn-primary">ğŸ”„ é‡æ–°è¼‰å…¥ Dashboard</button>
    </div>

    <div id="result"></div>

    <script>
    const resultDiv = document.getElementById('result');

    // æª¢æŸ¥æ•¸æ“šç‹€æ…‹
    document.getElementById('checkBtn').addEventListener('click', function() {
        try {
            let info = '<h3>ğŸ“Š æ•¸æ“šæª¢æŸ¥çµæœ</h3>';

            // 1. æª¢æŸ¥æ‰€æœ‰ localStorage éµ
            const allKeys = Object.keys(localStorage);
            info += `<h4>localStorage éµ (${allKeys.length}å€‹):</h4>`;
            info += `<p>${allKeys.join(', ')}</p>`;

            // 2. æª¢æŸ¥å¯èƒ½åŒ…å«é …ç›®æ•¸æ“šçš„éµ
            const dataKeys = allKeys.filter(key =>
                key.includes('team') || key.includes('project') || key.includes('assignment')
            );

            dataKeys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        info += `<h4>${key}:</h4>`;

                        if (typeof parsed === 'object' && parsed !== null) {
                            const keys = Object.keys(parsed);
                            info += `<p>åŒ…å« ${keys.length} å€‹éµ: ${keys.join(', ')}</p>`;

                            // æª¢æŸ¥æ˜¯å¦åŒ…å«æ™ºæ…§ç›£è¦–ç³»çµ±
                            if (keys.includes('æ™ºæ…§ç›£è¦–ç³»çµ±')) {
                                info += `<p style="color: red;">âš ï¸ æ‰¾åˆ°ã€Œæ™ºæ…§ç›£è¦–ç³»çµ±ã€ï¼</p>`;
                            }

                            // é¡¯ç¤ºå‰500å­—ç¬¦
                            info += `<pre>${JSON.stringify(parsed, null, 2).substring(0, 500)}...</pre>`;
                        }
                    } catch (e) {
                        info += `<p>${key}: è§£æå¤±æ•— - ${e.message}</p>`;
                    }
                }
            });

            // 3. æª¢æŸ¥å…¨å±€ TeamDataManager
            if (window.opener && window.opener.globalTeamDataManager) {
                try {
                    const teamManager = window.opener.globalTeamDataManager;
                    const projects = teamManager.getAllProjects();
                    info += `<h4>globalTeamDataManager:</h4>`;
                    info += `<p>æ‰¾åˆ° ${Object.keys(projects).length} å€‹é …ç›®</p>`;

                    Object.keys(projects).forEach(project => {
                        const memberCount = Object.keys(projects[project].members || {}).length;
                        const highlight = project === 'æ™ºæ…§ç›£è¦–ç³»çµ±' ? ' style="color: red; font-weight: bold;"' : '';
                        info += `<p${highlight}>â€¢ ${project}: ${memberCount} å€‹æˆå“¡</p>`;
                    });
                } catch (e) {
                    info += `<p>globalTeamDataManager è¨ªå•å¤±æ•—: ${e.message}</p>`;
                }
            } else {
                info += `<p>globalTeamDataManager ä¸å¯ç”¨</p>`;
            }

            resultDiv.innerHTML = info;
            resultDiv.className = 'info';

        } catch (error) {
            resultDiv.innerHTML = `âŒ æª¢æŸ¥å¤±æ•—: ${error.message}`;
            resultDiv.className = 'error';
        }
    });

    // ä¿®å¾©æœ¬åœ°æ•¸æ“š
    document.getElementById('fixLocalBtn').addEventListener('click', function() {
        try {
            let fixed = false;
            let results = [];

            // æª¢æŸ¥ä¸¦ä¿®å¾©æ‰€æœ‰å¯èƒ½çš„ localStorage æ•¸æ“š
            Object.keys(localStorage).forEach(key => {
                try {
                    const data = localStorage.getItem(key);
                    if (data) {
                        const parsed = JSON.parse(data);

                        if (typeof parsed === 'object' && parsed !== null) {
                            // æª¢æŸ¥ä¸¦åˆªé™¤æ™ºæ…§ç›£è¦–ç³»çµ±
                            if (parsed['æ™ºæ…§ç›£è¦–ç³»çµ±']) {
                                delete parsed['æ™ºæ…§ç›£è¦–ç³»çµ±'];
                                localStorage.setItem(key, JSON.stringify(parsed));
                                results.push(`âœ… å·²å¾ ${key} ä¸­åˆªé™¤æ™ºæ…§ç›£è¦–ç³»çµ±`);
                                fixed = true;
                            }

                            // æª¢æŸ¥ assignments çµæ§‹
                            if (parsed.assignments && parsed.assignments['æ™ºæ…§ç›£è¦–ç³»çµ±']) {
                                delete parsed.assignments['æ™ºæ…§ç›£è¦–ç³»çµ±'];
                                localStorage.setItem(key, JSON.stringify(parsed));
                                results.push(`âœ… å·²å¾ ${key}.assignments ä¸­åˆªé™¤æ™ºæ…§ç›£è¦–ç³»çµ±`);
                                fixed = true;
                            }
                        }
                    }
                } catch (e) {
                    // å¿½ç•¥ç„¡æ³•è§£æçš„æ•¸æ“š
                }
            });

            if (fixed) {
                resultDiv.innerHTML = `<h3>ğŸ‰ æœ¬åœ°ä¿®å¾©å®Œæˆ</h3>${results.join('<br>')}`;
                resultDiv.className = 'success';
            } else {
                resultDiv.innerHTML = `âš ï¸ åœ¨æœ¬åœ°æ•¸æ“šä¸­æœªæ‰¾åˆ°æ™ºæ…§ç›£è¦–ç³»çµ±é …ç›®`;
                resultDiv.className = 'warning';
            }

        } catch (error) {
            resultDiv.innerHTML = `âŒ æœ¬åœ°ä¿®å¾©å¤±æ•—: ${error.message}`;
            resultDiv.className = 'error';
        }
    });

    // ä¿®å¾©å…¨å±€æ•¸æ“š
    document.getElementById('fixGlobalBtn').addEventListener('click', async function() {
        try {
            if (window.opener && window.opener.globalTeamDataManager) {
                const teamManager = window.opener.globalTeamDataManager;

                // ç²å–æ‰€æœ‰é …ç›®
                const projects = teamManager.getAllProjects();

                if (projects['æ™ºæ…§ç›£è¦–ç³»çµ±']) {
                    // åˆªé™¤æ™ºæ…§ç›£è¦–ç³»çµ±é …ç›®
                    delete projects['æ™ºæ…§ç›£è¦–ç³»çµ±'];

                    // å¦‚æœæœ‰ removeProject æ–¹æ³•
                    if (typeof teamManager.removeProject === 'function') {
                        await teamManager.removeProject('æ™ºæ…§ç›£è¦–ç³»çµ±');
                    }

                    // ä¿å­˜è®Šæ›´
                    if (typeof teamManager.saveLocalChanges === 'function') {
                        await teamManager.saveLocalChanges();
                    }

                    resultDiv.innerHTML = `âœ… å·²å¾ globalTeamDataManager ä¸­åˆªé™¤æ™ºæ…§ç›£è¦–ç³»çµ±ï¼`;
                    resultDiv.className = 'success';

                    // 3ç§’å¾Œé‡æ–°è¼‰å…¥ä¸»é é¢
                    setTimeout(() => {
                        if (window.opener) {
                            window.opener.location.reload();
                        }
                    }, 3000);

                } else {
                    resultDiv.innerHTML = `âš ï¸ åœ¨ globalTeamDataManager ä¸­æœªæ‰¾åˆ°æ™ºæ…§ç›£è¦–ç³»çµ±é …ç›®`;
                    resultDiv.className = 'warning';
                }

            } else {
                resultDiv.innerHTML = `âŒ ç„¡æ³•è¨ªå• globalTeamDataManagerï¼Œè«‹ç¢ºä¿å¾ Dashboard ä¸»é é¢é–‹å•Ÿæ­¤å·¥å…·`;
                resultDiv.className = 'error';
            }

        } catch (error) {
            resultDiv.innerHTML = `âŒ å…¨å±€ä¿®å¾©å¤±æ•—: ${error.message}`;
            resultDiv.className = 'error';
        }
    });

    // é‡æ–°è¼‰å…¥ Dashboard
    document.getElementById('reloadBtn').addEventListener('click', function() {
        if (window.opener) {
            window.opener.location.reload();
            window.close();
        } else {
            window.location.href = 'https://mingxianliu.github.io/ErDashboard/';
        }
    });

    // è‡ªå‹•æª¢æŸ¥ç‹€æ…‹
    setTimeout(() => {
        document.getElementById('checkBtn').click();
    }, 500);
    </script>
</body>
</html>