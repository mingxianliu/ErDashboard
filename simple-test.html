<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive 簡單測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 10px 5px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🔧 Google Drive API 測試</h1>
    <div id="status">準備中...</div>

    <div id="buttons" style="display: none;">
        <button onclick="testSignIn()">🔐 測試登入</button>
        <button onclick="testFileAccess()">📁 測試檔案存取</button>
    </div>

    <div id="results"></div>

    <!-- 使用 Google 官方的 API 載入器 -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let accessToken = null;

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            document.getElementById('results').appendChild(div);
        }

        async function initializeGapi() {
            try {
                document.getElementById('status').textContent = '正在初始化 Google API...';

                await new Promise((resolve, reject) => {
                    gapi.load('client', {
                        callback: resolve,
                        onerror: reject
                    });
                });

                await gapi.client.init({
                    discoveryDocs: [DISCOVERY_DOC],
                });

                // 使用 Google Identity Services (新版 OAuth)
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (response) => {
                        if (response.access_token) {
                            accessToken = response.access_token;
                            log('✅ 登入成功！', 'success');
                            log(`🔑 取得 Access Token: ${response.access_token.substring(0, 20)}...`, 'info');
                        } else {
                            log('❌ 登入失敗', 'error');
                        }
                    },
                });

                document.getElementById('status').textContent = '✅ 初始化完成';
                document.getElementById('buttons').style.display = 'block';
                log('✅ Google API 初始化成功', 'success');

            } catch (error) {
                document.getElementById('status').textContent = '❌ 初始化失敗';
                log(`❌ 初始化錯誤: ${error.message || error}`, 'error');

                // 檢查是否需要載入新版 Google Identity Services
                if (!window.google || !window.google.accounts) {
                    log('📥 載入 Google Identity Services...', 'info');
                    loadGoogleIdentityServices();
                }
            }
        }

        function loadGoogleIdentityServices() {
            const script = document.createElement('script');
            script.src = 'https://accounts.google.com/gsi/client';
            script.onload = () => {
                log('✅ Google Identity Services 載入完成', 'success');
                initializeGapi();
            };
            script.onerror = () => {
                log('❌ 無法載入 Google Identity Services', 'error');
            };
            document.head.appendChild(script);
        }

        function testSignIn() {
            log('🔐 開始登入測試...');
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                log('❌ Token client 未初始化', 'error');
            }
        }

        async function testFileAccess() {
            if (!accessToken) {
                log('❌ 請先登入', 'error');
                return;
            }

            log('📁 測試 Google Drive 檔案存取...');

            try {
                const response = await fetch(
                    'https://www.googleapis.com/drive/v3/files?q=parents in "YOUR_FOLDER_ID_HERE"&pageSize=10',
                    {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    log(`✅ 成功存取 Google Drive！找到 ${data.files.length} 個檔案`, 'success');

                    if (data.files.length > 0) {
                        log('📄 檔案列表:', 'info');
                        data.files.forEach((file, index) => {
                            log(`   ${index + 1}. ${file.name} (${new Date(file.modifiedTime).toLocaleString()})`, 'info');
                        });
                    } else {
                        log('📭 資料夾目前是空的', 'info');
                    }

                    // 測試檔案上傳
                    await testFileUpload();

                } else {
                    const errorData = await response.text();
                    log(`❌ API 呼叫失敗: ${response.status} ${response.statusText}`, 'error');
                    log(`📝 錯誤詳情: ${errorData}`, 'error');
                }

            } catch (error) {
                log(`❌ 檔案存取錯誤: ${error.message}`, 'error');
            }
        }

        async function testFileUpload() {
            log('📤 測試檔案上傳...');

            const testData = {
                version: "1.0",
                type: "test",
                lastSync: new Date().toISOString(),
                data: {
                    message: "ErDashboard Google Drive 整合測試",
                    timestamp: Date.now(),
                    success: true
                }
            };

            const fileContent = JSON.stringify(testData, null, 2);
            const fileName = `ErDashboard_Test_${new Date().toISOString().split('T')[0]}_${Date.now()}.json`;

            const metadata = {
                name: fileName,
                parents: ['YOUR_FOLDER_ID_HERE'],
                mimeType: 'application/json'
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', new Blob([fileContent], {type: 'application/json'}));

            try {
                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`✅ 檔案上傳成功！檔案 ID: ${result.id}`, 'success');
                    log(`📁 檔案名稱: ${fileName}`, 'success');
                    log('🎉 Google Drive 整合測試完全成功！', 'success');
                } else {
                    const errorData = await response.text();
                    log(`❌ 檔案上傳失敗: ${response.status} ${response.statusText}`, 'error');
                    log(`📝 錯誤詳情: ${errorData}`, 'error');
                }

            } catch (error) {
                log(`❌ 上傳錯誤: ${error.message}`, 'error');
            }
        }

        // 頁面載入後開始初始化
        window.addEventListener('load', () => {
            log('🚀 開始 Google Drive API 測試', 'info');
            log(`📍 測試網址: ${window.location.href}`, 'info');

            // 先檢查是否已載入 Google Identity Services
            if (window.google && window.google.accounts) {
                initializeGapi();
            } else {
                loadGoogleIdentityServices();
            }
        });
    </script>

    <!-- 載入 Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</body>
</html>