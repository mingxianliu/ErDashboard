<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth è¨­å®šè¨ºæ–·</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f0f0f0; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <h2>ğŸ”§ OAuth è¨­å®šè¨ºæ–·å·¥å…·</h2>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            results.appendChild(div);
        }

        async function diagnose() {
            log('ğŸš€ é–‹å§‹ OAuth è¨ºæ–·...');

            // æª¢æŸ¥ç•¶å‰ URL
            log(`ğŸ“ ç•¶å‰ç¶²å€: ${window.location.href}`);
            log(`ğŸ“ ä¾†æº (Origin): ${window.location.origin}`);

            // æª¢æŸ¥ Client ID
            const CLIENT_ID = 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com';
            log(`ğŸ”‘ Client ID: ${CLIENT_ID}`);

            // è¼‰å…¥ Google API
            log('ğŸ“¥ è¼‰å…¥ Google API...');

            try {
                // è¼‰å…¥ Google API è…³æœ¬
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://apis.google.com/js/api.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('ç„¡æ³•è¼‰å…¥ Google API'));
                    document.head.appendChild(script);
                });

                log('âœ… Google API è…³æœ¬è¼‰å…¥æˆåŠŸ', 'success');

                // åˆå§‹åŒ– GAPI
                await new Promise((resolve) => {
                    gapi.load('auth2', resolve);
                });

                log('âœ… GAPI auth2 æ¨¡çµ„è¼‰å…¥æˆåŠŸ', 'success');

                // å˜—è©¦åˆå§‹åŒ– OAuth
                log('ğŸ” å˜—è©¦åˆå§‹åŒ– OAuth...');

                const authInstance = await gapi.auth2.init({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/drive.file'
                });

                log('âœ… OAuth åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                log(`ğŸ”’ æ˜¯å¦å·²ç™»å…¥: ${authInstance.isSignedIn.get()}`, 'info');

                // å¦‚æœæœªç™»å…¥ï¼Œæä¾›ç™»å…¥æŒ‰éˆ•
                if (!authInstance.isSignedIn.get()) {
                    const button = document.createElement('button');
                    button.textContent = 'ğŸš€ æ¸¬è©¦ç™»å…¥ Google Drive';
                    button.style.cssText = 'margin: 20px 0; padding: 10px 20px; font-size: 16px; cursor: pointer;';
                    button.onclick = async () => {
                        try {
                            log('ğŸ” å˜—è©¦ç™»å…¥...');
                            const user = await authInstance.signIn();
                            log('âœ… ç™»å…¥æˆåŠŸï¼', 'success');
                            log(`ğŸ‘¤ ä½¿ç”¨è€…: ${user.getBasicProfile().getEmail()}`, 'success');

                            // æ¸¬è©¦ Drive API
                            testDriveAPI(user.getAuthResponse().access_token);
                        } catch (error) {
                            log(`âŒ ç™»å…¥å¤±æ•—: ${error.message}`, 'error');
                        }
                    };
                    results.appendChild(button);
                }

            } catch (error) {
                log(`âŒ éŒ¯èª¤: ${error}`, 'error');
                console.error('å®Œæ•´éŒ¯èª¤ç‰©ä»¶:', error);

                // å®‰å…¨çš„å­—ä¸²æª¢æŸ¥
                const errorMsg = error && error.message ? error.message : String(error);
                const errorDetails = error && error.details ? error.details : '';

                log(`ğŸ“ éŒ¯èª¤è©³æƒ…: ${errorMsg}`, 'info');
                if (errorDetails) {
                    log(`ğŸ“ é¡å¤–è©³æƒ…: ${errorDetails}`, 'info');
                }

                // æä¾›å…·é«”çš„è§£æ±ºå»ºè­°
                if (errorMsg.includes('Invalid origin') ||
                    errorMsg.includes('Not a valid origin') ||
                    errorMsg.includes('idpiframe_initialization_failed')) {

                    log('ğŸ’¡ OAuth è¨­å®šå•é¡Œ - è§£æ±ºæ–¹æ¡ˆ:', 'warning');
                    log('1. å‰å¾€ Google Cloud Console', 'warning');
                    log('2. é¸æ“‡æ‚¨çš„å°ˆæ¡ˆ', 'warning');
                    log('3. å‰å¾€ API å’Œæœå‹™ > æ†‘è­‰', 'warning');
                    log('4. ç·¨è¼¯æ‚¨çš„ OAuth 2.0 ç”¨æˆ¶ç«¯ ID', 'warning');
                    log('5. åœ¨ã€Œæˆæ¬Šçš„ JavaScript ä¾†æºã€ä¸­ç¢ºèªæœ‰:', 'warning');
                    log(`   ${window.location.origin}`, 'warning');
                    log('6. å„²å­˜è¨­å®šä¸¦ç­‰å¾… 5-10 åˆ†é˜ç”Ÿæ•ˆ', 'warning');
                } else if (errorMsg.includes('popup') || errorMsg.includes('blocked')) {
                    log('ğŸ’¡ å½ˆå‡ºè¦–çª—è¢«å°é– - è§£æ±ºæ–¹æ¡ˆ:', 'warning');
                    log('1. å…è¨±ç€è¦½å™¨å½ˆå‡ºè¦–çª—', 'warning');
                    log('2. æª¢æŸ¥ç€è¦½å™¨è¨­å®š', 'warning');
                } else {
                    log('ğŸ’¡ æœªçŸ¥éŒ¯èª¤ - é€šç”¨è§£æ±ºæ–¹æ¡ˆ:', 'warning');
                    log('1. æª¢æŸ¥ç¶²è·¯é€£ç·š', 'warning');
                    log('2. ç¢ºèª Google Drive API å·²å•Ÿç”¨', 'warning');
                    log('3. æª¢æŸ¥ Client ID è¨­å®š', 'warning');
                }
            }
        }

        async function testDriveAPI(accessToken) {
            log('ğŸ“ æ¸¬è©¦ Google Drive API...');

            try {
                const response = await fetch('https://www.googleapis.com/drive/v3/files?q=parents in "YOUR_FOLDER_ID_HERE"', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Drive API æ¸¬è©¦æˆåŠŸï¼è³‡æ–™å¤¾ä¸­æœ‰ ${data.files.length} å€‹æª”æ¡ˆ`, 'success');

                    if (data.files.length > 0) {
                        log('ğŸ“„ æœ€è¿‘çš„æª”æ¡ˆ:', 'info');
                        data.files.slice(0, 3).forEach(file => {
                            log(`   - ${file.name}`, 'info');
                        });
                    }
                } else {
                    log(`âŒ Drive API æ¸¬è©¦å¤±æ•—: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ Drive API éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // è‡ªå‹•é–‹å§‹è¨ºæ–·
        diagnose();
    </script>
</body>
</html>