<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>研發記錄簿 - 任務編組系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="研發記錄簿 - 記錄開發過程中的重要事項">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-clipboard-list me-2"></i>
                研發記錄簿
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">載入中...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="同步到 Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="從 Google Drive 拉取">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 重新載入
                </button>
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='index.html'">
                    <i class="fas fa-home"></i> 返回首頁
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- 私鑰驗證 -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>需要登入
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">請先登入 ErDashboard 系統才能使用研發記錄簿。</p>
                    <button class="btn btn-primary" onclick="window.location.href='index.html'">
                        <i class="fas fa-home me-2"></i>回到首頁登入
                    </button>
                </div>
            </div>
        </div>

        <!-- 功能分頁 -->
        <ul class="nav nav-tabs" id="devLogTabs" role="tablist" style="display: none;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="global-tab" data-bs-toggle="tab" data-bs-target="#global" type="button" role="tab">
                    <i class="fas fa-globe me-2"></i>總體記錄
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button" role="tab">
                    <i class="fas fa-folder-open me-2"></i>專案記錄
                </button>
            </li>
        </ul>

        <div class="tab-content" id="devLogTabContent" style="display: none;">

            <!-- 總體記錄 -->
            <div class="tab-pane fade show active" id="global" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-globe me-2"></i>總體研發記錄
                                </h5>
                                <div>
                                    <button class="btn btn-danger btn-sm" id="clearGlobalBtn" title="清空所有總體記錄">
                                        <i class="fas fa-trash-alt"></i> 清空
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 新增記錄表單 -->
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <textarea class="form-control" id="globalLogInput" rows="3"
                                                      placeholder="輸入新的研發記錄內容..."></textarea>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" id="addGlobalLogBtn">
                                                <i class="fas fa-plus"></i> 新增記錄
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 記錄列表 -->
                                <div id="globalLogsList">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                                        <p class="mt-2">載入中...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 專案記錄 -->
            <div class="tab-pane fade" id="projects" role="tabpanel">
                <div class="row mt-4">
                    <div class="col-12">

                        <!-- 專案選擇 -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-6">
                                        <label class="form-label">選擇專案：</label>
                                        <select class="form-select" id="projectSelect">
                                            <option value="">選擇要查看的專案</option>
                                            <!-- 動態載入專案選項 -->
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-info btn-sm" id="refreshProjectsBtn">
                                                <i class="fas fa-sync-alt"></i> 重新載入專案
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 專案記錄內容 -->
                        <div class="card" id="projectLogCard" style="display: none;">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-folder-open me-2"></i>
                                    <span id="currentProjectName">專案記錄</span>
                                </h5>
                                <div>
                                    <button class="btn btn-danger btn-sm" id="clearProjectBtn" title="清空此專案的所有記錄">
                                        <i class="fas fa-trash-alt"></i> 清空
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <!-- 新增記錄表單 -->
                                <div class="mb-4">
                                    <div class="row">
                                        <div class="col-md-10">
                                            <textarea class="form-control" id="projectLogInput" rows="3"
                                                      placeholder="輸入新的專案記錄內容..."></textarea>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-primary w-100" id="addProjectLogBtn">
                                                <i class="fas fa-plus"></i> 新增記錄
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- 記錄列表 -->
                                <div id="projectLogsList">
                                    <div class="text-center text-muted">
                                        <p>請先選擇專案</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- 刪除確認模態框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">確認刪除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="deleteMessage">確定要刪除這筆記錄嗎？</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">確認刪除</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // 嘗試載入 config.js
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('⚠️ config.js 未找到，將使用手動設定模式');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250923a"></script>
    <script src="js/team-data-manager.js?v=20250918u"></script>
    <script src="js/dev-log.js?v=20250923c"></script>
    <script src="js/dev-log-ui.js?v=20250923f"></script>
    <script>
        // 初始化研發記錄簿
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('📋 開始載入研發記錄簿...');

                // 檢查認證狀態
                const hasAuth = sessionStorage.getItem('KEY_AUTHENTICATED');
                const hasGDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');

                if (!hasAuth || !hasGDriveConfig) {
                    console.log('⚠️ 未登入，顯示登入提示');
                    document.getElementById('keyAuthentication').style.display = 'block';
                    return;
                }

                // 等待所有腳本載入
                console.log('🔄 等待腳本載入...');
                await new Promise(resolve => {
                    if (window.DevLogUI && window.DevLogManager && window.TeamDataManager && window.googleDriveAPI) {
                        console.log('✅ 所有腳本已載入');
                        resolve();
                    } else {
                        let checkCount = 0;
                        const checkInterval = setInterval(() => {
                            checkCount++;
                            console.log(`⏳ 檢查腳本載入狀態... (${checkCount}/50)`, {
                                DevLogUI: !!window.DevLogUI,
                                DevLogManager: !!window.DevLogManager,
                                TeamDataManager: !!window.TeamDataManager,
                                googleDriveAPI: !!window.googleDriveAPI
                            });

                            if (window.DevLogUI && window.DevLogManager && window.TeamDataManager && window.googleDriveAPI) {
                                clearInterval(checkInterval);
                                console.log('✅ 所有腳本已載入');
                                resolve();
                            } else if (checkCount > 50) { // 5秒超時
                                clearInterval(checkInterval);
                                console.error('❌ 腳本載入超時');
                                resolve();
                            }
                        }, 100);
                    }
                });

                // 初始化 devLogManager
                if (!window.devLogManager) {
                    console.log('🔄 初始化 DevLogManager...');
                    window.devLogManager = new DevLogManager();
                }

                // 初始化 devLogUI
                if (!window.devLogUI) {
                    console.log('🔄 初始化 DevLogUI...');
                    window.devLogUI = new DevLogUI();
                }

                // 啟動 UI
                console.log('🚀 啟動 DevLogUI...');
                await window.devLogUI.init();

                console.log('✅ 研發記錄簿初始化完成');

            } catch (error) {
                console.error('❌ 研發記錄簿初始化失敗:', error);

                // 檢查是否是認證問題
                if (error.message.includes('Google Drive') || error.message.includes('認證') || error.message.includes('登入')) {
                    document.getElementById('keyAuthentication').style.display = 'block';
                    document.getElementById('keyAuthentication').innerHTML = `
                        <div class="card mx-auto" style="max-width: 600px;">
                            <div class="card-header bg-warning text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>需要重新登入
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">您的登入狀態已過期或無效，請回到首頁重新登入。</p>
                                <p class="text-danger small">錯誤訊息：${error.message}</p>
                                <button class="btn btn-primary" onclick="window.location.href='index.html'">
                                    <i class="fas fa-home me-2"></i>回到首頁登入
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    // 其他錯誤
                    document.getElementById('keyAuthentication').style.display = 'block';
                    document.getElementById('keyAuthentication').innerHTML = `
                        <div class="card mx-auto" style="max-width: 600px;">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-exclamation-triangle me-2"></i>載入失敗
                                </h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">研發記錄簿載入失敗，請嘗試以下解決方案：</p>
                                <p class="text-danger small">錯誤訊息：${error.message}</p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="window.location.reload()">
                                        <i class="fas fa-sync-alt me-2"></i>重新整理頁面
                                    </button>
                                    <button class="btn btn-secondary" onclick="window.location.href='index.html'">
                                        <i class="fas fa-home me-2"></i>回到首頁
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>