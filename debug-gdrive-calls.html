<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Google Drive èª¿ç”¨ç›£æ§</title>
</head>
<body>
    <h1>Google Drive API èª¿ç”¨ç›£æ§</h1>
    <div id="logs"></div>

    <script src="js/google-drive-api.js"></script>
    <script>
        const logsDiv = document.getElementById('logs');
        const originalCalls = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);

            const logElement = document.createElement('div');
            logElement.style.margin = '5px 0';
            logElement.style.padding = '5px';
            logElement.style.borderLeft = '3px solid #007bff';
            logElement.style.backgroundColor = '#f8f9fa';
            logElement.textContent = logEntry;

            logsDiv.insertBefore(logElement, logsDiv.firstChild);
        }

        // æ””æˆªæ‰€æœ‰ Google Drive API èª¿ç”¨
        function interceptGoogleDriveAPI() {
            if (window.googleDriveAPI) {
                // æ””æˆª saveFile
                if (window.googleDriveAPI.saveFile) {
                    const originalSaveFile = window.googleDriveAPI.saveFile;
                    window.googleDriveAPI.saveFile = function(filename, data, type) {
                        log(`ğŸš¨ INTERCEPTED saveFile: ${filename}`);

                        // æª¢æŸ¥æ˜¯å¦æ˜¯ project-assignments.json
                        if (filename === 'project-assignments.json') {
                            log(`ğŸ“‹ ä¿å­˜ project-assignments.json - æª¢æŸ¥è³‡æ–™ï¼š`);

                            if (data && data.assignments) {
                                const projectCount = Object.keys(data.assignments).length;
                                log(`  - å°ˆæ¡ˆæ•¸é‡: ${projectCount}`);

                                // æª¢æŸ¥å°ˆæ¡ˆå‚™è¨»
                                let hasNotes = false;
                                Object.keys(data.assignments).forEach(projectId => {
                                    if (data.assignments[projectId].notes) {
                                        hasNotes = true;
                                        log(`  - ${projectId}: æœ‰å°ˆæ¡ˆå‚™è¨»`);
                                    } else {
                                        log(`  - ${projectId}: ç„¡å°ˆæ¡ˆå‚™è¨» âŒ`);
                                    }
                                });

                                if (!hasNotes) {
                                    log(`ğŸš« è­¦å‘Šï¼šæ²’æœ‰ä»»ä½•å°ˆæ¡ˆå‚™è¨»ï¼é˜»æ­¢ä¸Šå‚³ï¼`);
                                    const stack = new Error().stack;
                                    log(`ğŸ“ èª¿ç”¨å †ç–Š: ${stack}`);
                                    return Promise.reject('è¢«é˜»æ­¢ï¼šè³‡æ–™ä¸åŒ…å«å°ˆæ¡ˆå‚™è¨»');
                                }
                            }
                        }

                        return originalSaveFile.call(this, filename, data, type);
                    };
                }

                // æ””æˆª loadFile
                if (window.googleDriveAPI.loadFile) {
                    const originalLoadFile = window.googleDriveAPI.loadFile;
                    window.googleDriveAPI.loadFile = function(filename) {
                        log(`ğŸ“¥ INTERCEPTED loadFile: ${filename}`);
                        return originalLoadFile.call(this, filename);
                    };
                }

                log('âœ… Google Drive API æ””æˆªå™¨å·²å®‰è£');
            } else {
                log('âš ï¸ Google Drive API å°šæœªè¼‰å…¥ï¼Œ3ç§’å¾Œé‡è©¦...');
                setTimeout(interceptGoogleDriveAPI, 3000);
            }
        }

        // é–‹å§‹ç›£æ§
        log('ğŸ” é–‹å§‹ç›£æ§ Google Drive API èª¿ç”¨');
        interceptGoogleDriveAPI();

        // æ¯10ç§’æª¢æŸ¥ä¸€æ¬¡
        setInterval(() => {
            if (window.googleDriveAPI && !window.googleDriveAPI._intercepted) {
                log('ğŸ”„ é‡æ–°å®‰è£æ””æˆªå™¨');
                interceptGoogleDriveAPI();
                window.googleDriveAPI._intercepted = true;
            }
        }, 10000);
    </script>
</body>
</html>