<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多專案進度監控中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918m" rel="stylesheet">
    <meta name="description" content="基於 Markdown 檔案的專案進度監控儀表板">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                多專案進度監控中心
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">載入中...</span>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 重新載入
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> 團隊管理
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- 私鑰驗證 -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>私鑰驗證
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">此 Dashboard 需要私鑰驗證才能查看專案資料。請匯入您的私鑰：</p>
                    
                    <div class="mb-3">
                        <label class="form-label">匯入私鑰 (PEM 格式)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="8" 
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">私鑰僅在瀏覽器中使用，不會傳送到任何伺服器</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>驗證並進入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>從檔案匯入
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">私鑰驗證失敗</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        私鑰驗證成功！正在載入 Dashboard...
                    </div>
                </div>
            </div>
        </div>

        <!-- 載入狀態 -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <div class="mt-3">正在載入專案資料...</div>
        </div>

        <!-- 統計卡片 -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- 動態載入 -->
        </div>


        <!-- 專案列表 -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- 動態載入 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918m"></script>
    <script src="js/markdown-reader.js?v=20250918m"></script>
    <script src="js/team-management.js?v=20250918m"></script>
    <script src="js/markdown-dashboard.js?v=20250918m"></script>
    <script>
        // 嚴格的認證檢查 - 無繞過機制
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // 確保未認證時完全隱藏所有資料
                document.getElementById('keyAuthentication').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // 禁止初始化 Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // 如果已認證，顯示登出按鈕
            showMainDashboard();
            // 檢查 session 是否過期
            checkSessionTimeout();
            return true;
        }
        
        // 私鑰驗證功能
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');
            
            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = '請輸入私鑰';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';
            
            try {
                // 使用 Web Crypto API 驗證私鑰
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // 設定登入狀態和時間戳
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());
                    
                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();
                        // 啟動新的 Markdown Dashboard
                        window.markdownDashboard = new MarkdownProjectDashboard();
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = '私鑰驗證失敗，請確認私鑰正確';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `驗證錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>驗證並進入';
            }
        });
        
        // 從檔案匯入私鑰
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // 顯示主 Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
        }
        
        // 登出功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('確定要登出嗎？登出後需要重新匯入私鑰。')) {
                // 清除認證狀態
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // 隱藏登出按鈕和團隊管理按鈕
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';

                // 顯示認證介面
                document.getElementById('keyAuthentication').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // 清空私鑰輸入欄
                document.getElementById('privateKeyInput').value = '';
                
                // 隱藏成功/錯誤訊息
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('用戶已登出，需要重新認證');
            }
        });
        
        // 檢查 Session 超時（30分鐘）
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            
            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30分鐘
                
                if (sessionAge > timeout) {
                    alert('會話已過期，請重新登入');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // 每分鐘檢查一次 session
        setInterval(checkSessionTimeout, 60000);

        // 重新載入功能
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });

        // 團隊管理功能
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            if (window.teamManagement) {
                window.teamManagement.openTeamManagementDashboard();
            }
        });

        // 啟動 Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // 檢查是否已通過私鑰驗證
            if (!checkAuthentication()) {
                // 未驗證禁止初始化 Dashboard
                return;
            }
            // 僅在已驗證時初始化 Dashboard
            try {
                console.log('開始初始化 Markdown Dashboard...');
                window.markdownDashboard = new MarkdownProjectDashboard();
            } catch (error) {
                console.error('Dashboard 初始化失敗:', error);
            }
        });
    </script>
</body>
</html>