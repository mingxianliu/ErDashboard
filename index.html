<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多專案進度監控中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918p" rel="stylesheet">
    <meta name="description" content="基於 Markdown 檔案的專案進度監控儀表板">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                多專案進度監控中心
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">載入中...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="同步本地檔案到 Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="從 Google Drive 拉取最新資料到本地">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 重新載入
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> 團隊管理
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- 私鑰驗證 -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>私鑰驗證
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">此 Dashboard 需要 Google Drive 設定和私鑰才能使用。請依序匯入：</p>

                    <!-- Google Drive 設定區域 -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive 設定 (JSON 格式)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "您的-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "YOUR_FOLDER_ID_HERE",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API 設定，僅在瀏覽器中使用</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. 匯入私鑰 (PEM 格式)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">私鑰僅在瀏覽器中使用，不會傳送到任何伺服器</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>驗證並進入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>從檔案匯入
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">私鑰驗證失敗</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        私鑰驗證成功！正在載入 Dashboard...
                    </div>
                </div>
            </div>
        </div>

        <!-- 載入狀態 -->
        <div id="loadingSpinner" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">載入中...</span>
            </div>
            <div class="mt-3">正在載入專案資料...</div>
        </div>

        <!-- 統計卡片 -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- 動態載入 -->
        </div>


        <!-- 專案列表 -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- 動態載入 -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250918p"></script>
    <script>
        // 嘗試載入 config.js (本地版本)，如果失敗則忽略 (線上版本)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('⚠️ config.js 未找到，將使用手動設定模式');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250918t"></script>
    <script src="js/team-data-manager.js?v=20250918u"></script>
    <script src="js/team-statistics.js?v=20250918u"></script>
    <script src="js/team-ui-components.js?v=20250918u"></script>
    <script src="js/team-management-main.js?v=20250918u"></script>
    <script src="js/markdown-dashboard.js?v=20250918p"></script>
    <script>
        // 嚴格的認證檢查 - 無繞過機制
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // 確保未認證時完全隱藏所有資料
                document.getElementById('keyAuthentication').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // 禁止初始化 Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // 如果已認證，顯示登出按鈕
            showMainDashboard();
            // 檢查 session 是否過期
            checkSessionTimeout();
            return true;
        }
        
        // 私鑰驗證功能
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // 驗證 Google Drive 設定
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = '請輸入 Google Drive 設定';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('設定格式不完整');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive 設定格式錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = '請輸入私鑰';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';
            
            try {
                // 使用 Web Crypto API 驗證私鑰
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // 儲存 Google Drive 設定到 sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // 設定登入狀態和時間戳
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();
                        // 啟動新的 Markdown Dashboard
                        window.markdownDashboard = new MarkdownProjectDashboard();
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = '私鑰驗證失敗，請確認私鑰正確';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `驗證錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>驗證並進入';
            }
        });
        
        // 從檔案匯入私鑰
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // 顯示主 Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';
        }
        
        // 登出功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('確定要登出嗎？登出後需要重新匯入私鑰。')) {
                // 清除認證狀態
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // 隱藏登出按鈕和團隊管理按鈕
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';

                // 顯示認證介面
                document.getElementById('keyAuthentication').style.display = 'block';
                document.getElementById('loadingSpinner').style.display = 'none';
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // 清空私鑰輸入欄
                document.getElementById('privateKeyInput').value = '';
                
                // 隱藏成功/錯誤訊息
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('用戶已登出，需要重新認證');
            }
        });
        
        // 檢查 Session 超時（30分鐘）
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            
            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30分鐘
                
                if (sessionAge > timeout) {
                    alert('會話已過期，請重新登入');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // 每分鐘檢查一次 session
        setInterval(checkSessionTimeout, 60000);

        // 重新載入功能
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });

        // Push 功能 (上傳到雲端)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // 更新按鈕狀態
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI || !window.googleDriveAPI.isAuthenticated) {
                    throw new Error('Google Drive 未登入，請先登入');
                }

                await pushLocalFilesToGoogleDrive();

                // 成功訊息
                showSyncToast('推送成功', '本地檔案已推送到 Google Drive', 'success');

            } catch (error) {
                console.error('同步失敗:', error);
                showSyncToast('同步失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull 功能 (從雲端下載)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // 更新按鈕狀態
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下載中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI || !window.googleDriveAPI.isAuthenticated) {
                    throw new Error('Google Drive 未登入，請先登入');
                }

                await pullFilesFromGoogleDrive();

                // 成功訊息
                showSyncToast('拉取成功', '已從 Google Drive 拉取最新資料', 'success');

                // 建議重新載入頁面
                setTimeout(() => {
                    if (confirm('資料已更新，是否重新載入頁面以顯示最新內容？')) {
                        location.reload();
                    }
                }, 1000);

            } catch (error) {
                console.error('拉取失敗:', error);
                showSyncToast('拉取失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // 推送本地檔案到 Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    console.log(`🔄 同步檔案: ${filePath}`);

                    // 讀取本地檔案
                    const response = await fetch(filePath + '?v=' + Date.now());
                    if (!response.ok) {
                        throw new Error(`無法讀取 ${filePath}: ${response.statusText}`);
                    }

                    const fileContent = await response.text();
                    const fileName = filePath.split('/').pop();

                    // 上傳到 Google Drive
                    await window.googleDriveAPI.saveFile(fileName, fileContent);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: '同步成功'
                    });

                    console.log(`✅ ${fileName} 同步完成`);

                } catch (error) {
                    console.error(`❌ ${filePath} 同步失敗:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 同步專案狀態檔案 (如果存在)
            await syncProjectStatusFiles();

            // 記錄同步結果
            logSyncResults(syncResults);

            return syncResults;
        }

        // 從 Google Drive 拉取檔案到本地
        async function pullFilesFromGoogleDrive() {
            const filesToPull = [
                'team-members.json',
                'project-assignments.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {
                    console.log(`🔄 從 Google Drive 拉取檔案: ${fileName}`);

                    // 從 Google Drive 下載檔案
                    const fileContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!fileContent) {
                        throw new Error(`Google Drive 中找不到 ${fileName}`);
                    }

                    // 驗證 JSON 格式
                    try {
                        JSON.parse(fileContent);
                    } catch (parseError) {
                        throw new Error(`${fileName} 格式錯誤: ${parseError.message}`);
                    }

                    // 儲存到 localStorage（模擬下載到本地）
                    const storageKey = fileName === 'team-members.json' ? 'cachedTeamMembers' : 'cachedProjectAssignments';
                    localStorage.setItem(storageKey, fileContent);

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: '拉取成功'
                    });

                    console.log(`✅ ${fileName} 拉取完成`);

                } catch (error) {
                    console.error(`❌ ${fileName} 拉取失敗:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 記錄拉取結果
            logPullResults(pullResults);

            return pullResults;
        }

        // 同步專案狀態檔案
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // 這裡可以讀取 project-status 資料夾中的檔案
                    // 由於瀏覽器安全限制，我們先記錄到 localStorage
                    console.log(`📊 檢查專案 ${project} 狀態檔案`);
                } catch (error) {
                    console.log(`⚠️ 專案 ${project} 無狀態檔案`);
                }
            }
        }

        // 顯示同步通知
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>剛才</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // 創建 toast 容器 (如果不存在)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // 添加並顯示 toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // 記錄推送結果
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('📝 推送記錄已保存:', syncLog);
        }

        // 記錄拉取結果
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('📝 拉取記錄已保存:', pullLog);
        }

        // 團隊管理功能
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            if (window.teamManagement) {
                window.teamManagement.openTeamManagementDashboard();
            }
        });

        // 啟動 Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // 檢查是否已通過私鑰驗證
            if (!checkAuthentication()) {
                // 未驗證禁止初始化 Dashboard
                return;
            }
            // 僅在已驗證時初始化 Dashboard
            try {
                console.log('開始初始化 Markdown Dashboard...');

                // 初始化團隊資料管理器
                if (!window.teamDataManager) {
                    window.teamDataManager = new TeamDataManager();
                    window.teamDataManager.init().catch(error => {
                        console.log('團隊資料管理器初始化失敗 (可能未登入 Google Drive):', error.message);
                    });
                }

                window.markdownDashboard = new MarkdownProjectDashboard();
            } catch (error) {
                console.error('Dashboard 初始化失敗:', error);
            }
        });
    </script>
</body>
</html>