<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任務編組系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="基於 Markdown 檔案的專案進度監控儀表板">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                任務編組系統
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">載入中...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="同步本地檔案到 Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="從 Google Drive 拉取最新資料到本地">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-warning btn-sm me-2" id="syncRoleNotesBtn" style="display: none;" title="手動同步角色備註">
                    <i class="fas fa-comment-dots"></i> 同步備註
                </button>
                <button class="btn btn-danger btn-sm me-2" id="fixRolesBtn" style="display: none;" title="修復角色資料">
                    <i class="fas fa-tools"></i> 修復角色
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 重新載入
                </button>
                <button class="btn btn-secondary btn-sm me-2" id="gdriveSetupBtn" title="設定 Google Drive 整合">
                    <i class="fab fa-google-drive"></i> 雲端設定
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> 團隊管理
                </button>
                <button class="btn btn-info btn-sm me-2" id="devLogBtn" style="display: none;" title="研發記錄簿">
                    <i class="fas fa-clipboard-list"></i> 研發記錄簿
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- 私鑰驗證 -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>私鑰驗證
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">此 Dashboard 需要 Google Drive 設定和私鑰才能使用。請依序匯入：</p>

                    <!-- Google Drive 設定區域 -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive 設定 (JSON 格式)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "您的-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "您的-google-drive-資料夾-id",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API 設定，僅在瀏覽器中使用</small>
                        <div class="mt-2">
                            <a href="setup-gdrive.html" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-google-drive me-1"></i>使用圖形化設定界面
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. 匯入私鑰 (PEM 格式)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">私鑰僅在瀏覽器中使用，不會傳送到任何伺服器</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>驗證並進入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>從檔案匯入
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">私鑰驗證失敗</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        私鑰驗證成功！正在載入 Dashboard...
                    </div>
                </div>
            </div>
        </div>


        <!-- 統計卡片 -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- 動態載入的統計內容會插入這裡 -->
        </div>

        <!-- 專案列表 -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- 動態載入的專案內容會插入這裡 -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // 嘗試載入 config.js (本地版本)，如果失敗則忽略 (線上版本)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('⚠️ config.js 未找到，將使用手動設定模式');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250923b-1758618068"></script>
    <script src="js/team-data-manager.js?v=20250923d-1758618068" onerror="console.error('❌ 載入 team-data-manager.js 失敗')"></script>
    <script src="js/team-statistics.js?v=20250918u" onerror="console.error('❌ 載入 team-statistics.js 失敗')"></script>
    <script src="js/team-ui-components.js?v=20250920k" onerror="console.error('❌ 載入 team-ui-components.js 失敗')"></script>
    <script src="js/team-management-main.js?v=20250920e" onerror="console.error('❌ 載入 team-management-main.js 失敗')"></script>
    <script src="js/dev-log.js?v=20250923a" onerror="console.error('❌ 載入 dev-log.js 失敗')"></script>
    <script src="js/markdown-dashboard-simple.js?v=20250920b"></script>
    <script>
        // 使用 TeamDataManager 載入資料
        // 設為全域函數以便其他視窗可以呼叫
        window.loadDataDirectly = async function loadDataDirectly() {
            try {
                // 等待 Google Drive API 準備好
                if (window.googleDriveAPI) {
                    let waitCount = 0;
                    while (!window.googleDriveAPI.isReady() && waitCount < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        waitCount++;
                    }

                    // 檢查並嘗試 Google Drive 自動登入
                    if (window.googleDriveAPI.isReady() && !window.googleDriveAPI.isSignedIn()) {
                        try {
                            const loginSuccess = await window.googleDriveAPI.signIn();
                            if (loginSuccess) {
                            } else {
                            }
                        } catch (loginError) {
                            console.log('❌ Google Drive 自動登入錯誤:', loginError);
                        }
                    } else if (!window.googleDriveAPI.isReady()) {
                    }
                }

                // 確保 TeamDataManager 存在
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager 未載入');
                }

                // 使用或創建全域 TeamDataManager
                let teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;
                } else {
                    // 檢查是否需要重新初始化（避免覆蓋剛同步的資料）
                    if (!teamDataManager.isReady()) {
                        await teamDataManager.init();
                    } else {
                    }
                }

                // 載入任務範本資料（如果還沒載入）
                if (!window.taskTemplatesData) {
                    try {
                        // 1. 優先從本地快取載入
                        const cachedTemplates = localStorage.getItem('cachedTaskTemplates');
                        if (cachedTemplates) {
                            window.taskTemplatesData = JSON.parse(cachedTemplates);
                        } else {
                            // 2. 從本地檔案載入
                            const templateResponse = await fetch('config/task-templates.json?v=' + Date.now());
                            if (templateResponse.ok) {
                                window.taskTemplatesData = await templateResponse.json();
                                // 儲存到快取
                                localStorage.setItem('cachedTaskTemplates', JSON.stringify(window.taskTemplatesData));
                            }
                        }
                    } catch (templateError) {
                        console.warn('載入任務範本失敗:', templateError);
                        window.taskTemplatesData = { taskTemplates: {} };
                    }
                }

                // 從 TeamDataManager 獲取資料
                let assignments = teamDataManager.getAllAssignments();

                // 如果 teamDataManager 沒有資料，嘗試從 localStorage 或 config 載入
                if (!assignments || Object.keys(assignments).length === 0) {
                    console.log('🔄 teamDataManager 資料為空，嘗試其他資料來源...');

                    // 嘗試從 localStorage
                    const localData = localStorage.getItem('project-assignments');
                    if (localData) {
                        try {
                            const parsed = JSON.parse(localData);
                            if (parsed.assignments) {
                                assignments = parsed.assignments;
                                console.log('✅ 從 localStorage 載入資料');
                            }
                        } catch (e) {
                            console.error('❌ localStorage 資料解析失敗:', e);
                        }
                    }

                    // 如果還是沒有資料，嘗試從 config 載入
                    if (!assignments || Object.keys(assignments).length === 0) {
                        try {
                            const response = await fetch('config/project-assignments.json');
                            if (response.ok) {
                                const data = await response.json();
                                if (data.assignments) {
                                    assignments = data.assignments;
                                    console.log('✅ 從 config 檔案載入資料');
                                }
                            }
                        } catch (e) {
                            console.error('❌ config 檔案載入失敗:', e);
                        }
                    }
                }

                // 如果沒有資料，使用空物件
                if (!assignments) {
                    assignments = {};
                }

                // 確保所有成員都有必要的欄位
                Object.values(assignments).forEach(project => {
                    if (project.members) {
                        Object.values(project.members).forEach(member => {
                            if (member.isExecuting === undefined || member.isExecuting === null) {
                                member.isExecuting = false; // 預設為未執行
                            }
                            if (!member.personalNotes) {
                                member.personalNotes = []; // 初始化個人備註陣列
                            }
                        });
                    }
                });

                // 前端渲染資料已準備完成

                const summaryCards = document.getElementById('summaryCards');
                const projectsList = document.getElementById('projectsList');

                if (assignments && Object.keys(assignments).length > 0) {
                    const projects = Object.keys(assignments).map(projectId => ({
                        ...assignments[projectId],
                        projectId: projectId
                    }));

                    // 顯示統計
                    if (summaryCards) {
                        summaryCards.innerHTML = `
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.length}</div>
                                                <div>總專案數</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-project-diagram"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.filter(p => p.status === 'active').length}</div>
                                                <div>進行中專案</div>
                                                <small class="text-white-50">暫停: <span class="badge bg-warning text-dark">${projects.filter(p => p.status === 'paused').length}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-rocket"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-info text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size}</div>
                                                <div>總成員數</div>
                                                <small class="text-white-50">執行中: <span id="executingCount" class="badge bg-success">${Object.values(assignments).reduce((sum, p) => sum + Object.values(p.members || {}).filter(m => m.isExecuting === true).length, 0)}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-users"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-warning text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${Math.round(projects.reduce((sum, p) => sum + p.progress, 0) / projects.length)}%</div>
                                                <div>平均進度</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        summaryCards.style.display = 'flex';
                    }

                    // 顯示專案列表
                    if (projectsList) {
                        let html = '';

                        projects.forEach(project => {
                            const memberCount = Object.keys(project.members || {}).length;

                            // 生成成員列表
                            let membersHtml = '';
                            if (project.members && Object.keys(project.members).length > 0) {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">團隊成員(${memberCount}):</h6>
                                            <span class="badge bg-${
                                                project.status === 'active' ? 'success' :
                                                project.status === 'paused' ? 'warning' :
                                                project.status === 'completed' ? 'secondary' : 'info'
                                            }">${
                                                project.status === 'active' ? '進行中' :
                                                project.status === 'paused' ? '暫停' :
                                                project.status === 'completed' ? '已完成' :
                                                project.status || '未知狀態'
                                            }</span>
                                        </div>
                                `;
                                Object.values(project.members).forEach(member => {
                                    // 從實際成員資料取得名稱
                                    const allMembers = teamDataManager.getAllMembers() || {};
                                    const memberName = allMembers[member.memberId]?.name || member.memberId;
                                    const roleColors = {
                                        'frontend': '#007bff',
                                        'backend': '#28a745',
                                        'fullstack': '#ffc107',
                                        'testing': '#dc3545',
                                        '前端': '#007bff',
                                        '後端': '#28a745',
                                        '全端': '#ffc107',
                                        '測試': '#dc3545'
                                    };
                                    const roleColor = roleColors[member.role] || '#6c757d';

                                    // 角色文字轉換
                                    const roleTranslation = {
                                        'frontend': '前端',
                                        'backend': '後端',
                                        'fullstack': '全端',
                                        'testing': '測試'
                                    };
                                    const displayRole = roleTranslation[member.role] || member.role;

                                    // 根據組別設定背景色
                                    const memberGroup = member.memberId.split('-')[0]; // A, B, C
                                    const groupColors = {
                                        'A': '#e3f2fd', // 淺藍
                                        'B': '#e8f5e8', // 淺綠
                                        'C': '#fff3e0'  // 淺橙
                                    };
                                    const groupBgColor = groupColors[memberGroup] || '#f8f9fa';

                                    membersHtml += `
                                        <div class="position-relative p-3 mb-2 border rounded"
                                             style="background-color: ${groupBgColor}; height: 85px; overflow: hidden;">
                                            <div class="d-flex align-items-center h-100" style="padding-right: 90px;">
                                                <div class="d-flex flex-column align-items-center me-3">
                                                    <input class="form-check-input mb-1" type="checkbox"
                                                           id="executing-${project.projectId}-${member.memberId}"
                                                           onchange="toggleMemberExecution('${project.projectId}', '${member.memberId}', this.checked)"
                                                           ${member.isExecuting ? 'checked' : ''}
                                                           data-project="${project.projectId}" data-member="${member.memberId}">
                                                    ${member.isExecuting ? '<i class="fas fa-play-circle text-success" title="執行中"></i>' : ''}
                                                </div>
                                                <div class="d-flex flex-column me-3" style="min-width: 80px; max-width: 120px;">
                                                    <div class="fw-bold mb-1 ${member.isExecuting ? 'text-success' : ''} text-truncate" title="${memberName}">${memberName}</div>
                                                    <small class="text-muted text-truncate" title="${member.memberId}">${member.memberId}</small>
                                                </div>
                                                <div class="d-flex align-items-center flex-grow-1 justify-content-end">
                                                    <span class="badge px-3 py-2 me-3" style="background-color: ${roleColor}; font-size: 0.85em;">
                                                        ${displayRole}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                                <div class="d-grid gap-1" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 80px; height: 64px;">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCard('${project.projectId}', '${member.memberId}')" title="編輯任務小卡">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="editPersonalNotes('${project.projectId}', '${member.memberId}')" title="角色備註">
                                                    <i class="fas fa-sticky-note"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="changeMember('${project.projectId}', '${member.memberId}')" title="變更成員">
                                                    <i class="fas fa-user-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="showMemberInfo('${project.projectId}', '${member.memberId}')" title="成員資訊">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                membersHtml += '</div>';
                            } else {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">團隊成員(0):</h6>
                                            <span class="badge bg-${
                                                project.status === 'active' ? 'success' :
                                                project.status === 'paused' ? 'warning' :
                                                project.status === 'completed' ? 'secondary' : 'info'
                                            }">${
                                                project.status === 'active' ? '進行中' :
                                                project.status === 'paused' ? '暫停' :
                                                project.status === 'completed' ? '已完成' :
                                                project.status || '未知狀態'
                                            }</span>
                                        </div>
                                        <small class="text-muted">尚未分配成員</small>
                                    </div>
                                `;
                            }

                            html += `
                                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                                    <div class="card mb-3" style="height: 420px;">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title text-truncate me-2" title="${project.projectName}">${project.projectName}</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="editProjectProgress('${project.projectId}')" title="調整進度">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar d-flex align-items-center justify-content-center" style="width: ${project.progress}%">
                                                    <span class="fw-bold">${project.progress}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                ${membersHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        projectsList.innerHTML = html;

                        // 添加事件監聽器作為備份（以防 onchange 屬性失效）
                        document.querySelectorAll('input[type="checkbox"][id^="executing-"]').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                const projectId = this.getAttribute('data-project');
                                const memberId = this.getAttribute('data-member');
                                toggleMemberExecution(projectId, memberId, this.checked);
                            });
                        });
                        projectsList.style.display = 'flex';
                    }
                } else {
                    console.warn('⚠️ 資料格式不正確或沒有 assignments');
                }
            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">載入失敗: ' + error.message + '</div>';
            }
        }

        // 編輯專案成員任務小卡
        async function editProjectMember(projectId, memberId) {
            try {

                // 使用 TeamDataManager 載入專案資料
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager 未載入');
                }

                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`找不到專案: ${projectId}`);
                }

                const member = project.members[memberId];

                if (!member) {
                    alert('找不到成員資料');
                    return;
                }

                // 從 teamDataManager 取得實際的成員名稱
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // 從 TeamDataManager 載入任務範本
                let taskTemplate = '';
                try {
                    // TeamDataManager 應該已經載入了任務範本資料
                    if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                        const template = window.taskTemplatesData.taskTemplates[member.role];
                        if (template) {
                            taskTemplate = template.content;
                        }
                    }
                } catch (templateError) {
                    console.warn('載入任務範本失敗:', templateError);
                }

                // 生成任務小卡內容（正確格式）
                const taskCardContent = `你現在的角色是「${project.projectName}」的「${member.role}」，代號是「${memberName}」，開發的branch 是「${memberName}」，若無則create，請依循下列的任務指引：\n\n${taskTemplate}`;

                // 直接編輯任務小卡（不再需要選擇模態框）
                editTaskCard(projectId, memberId);

            } catch (error) {
                console.error('編輯任務小卡失敗:', error);
                alert('編輯任務小卡失敗: ' + error.message);
            }
        }

        // 編輯任務小卡
        async function editTaskCard(projectId, memberId) {
            try {

                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`找不到專案: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`找不到成員: ${memberId}`);
                }

                // 移除硬編碼的成員名稱映射，改用實際資料
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // 獲取任務範本
                let taskTemplate = '';
                if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                    const template = window.taskTemplatesData.taskTemplates[member.role];
                    if (template) {
                        taskTemplate = template.content;
                    }
                }

                // 建立預設範本內容
                const defaultTaskContent = `你現在的角色是「${project.projectName}」的「${member.role}」，代號是「${memberName}」，開發的branch 是「${memberName}」，若無則create，請依循下列的任務指引：\n\n${taskTemplate}`;

                // 儲存範本資料供恢復預設功能使用
                window.currentTaskCardTemplate = {
                    projectId: projectId,
                    memberId: memberId,
                    defaultContent: defaultTaskContent
                };

                // 檢查是否有已儲存的任務小卡內容
                let taskCardContent;
                const taskCard = assignments[projectId].members[memberId].taskCard;
                if (taskCard && taskCard.content) {
                    // 使用已儲存的內容
                    taskCardContent = taskCard.content;
                } else {
                    // 使用預設範本
                    taskCardContent = defaultTaskContent;
                }

                // 產生專案備註歷程 HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">專案備註歷程</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // 產生角色備註 HTML
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">角色備註</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">角色備註</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>尚無角色備註記錄</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 產生任務小卡歷程記錄 HTML（如果有的話）
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">任務小卡歷程</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="清空所有歷程">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="刪除此記錄">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">查看內容</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> 恢復此版本
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 產生角色變更歷程 HTML
                let memberHistoryHtml = '';
                try {
                    if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                        memberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                    } else {
                        // 備用方案：直接從資料中生成
                        const memberHistory = project.memberHistory || [];
                        if (memberHistory.length > 0) {
                            const actionLabels = {
                                'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>成員加入',
                                'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>成員移除',
                                'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>角色變更'
                            };

                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">角色變更歷程</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="清空所有歷程">
                                            <i class="fas fa-trash"></i> 清空
                                        </button>
                                    </div>
                                    <div class="card" style="max-height: 400px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${memberHistory.slice().reverse().map((entry, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div class="small">
                                                            ${actionLabels[entry.action] || entry.action}
                                                            <strong>${entry.memberName}</strong>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-1">
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                            <button class="btn btn-sm btn-outline-secondary p-1" onclick="if(window.teamManagement) window.teamManagement.editHistoryOperator('${projectId}', '${entry.timestamp}')" title="編輯操作者">
                                                                <i class="fas fa-edit" style="font-size: 8px;"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="ps-3">
                                                        ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                        ${entry.oldRole && entry.newRole ? `
                                                            <div class="mt-1">
                                                                <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                <i class="fas fa-arrow-right mx-1 small"></i>
                                                                <span class="badge bg-success small">${entry.newRole}</span>
                                                            </div>
                                                        ` : ''}
                                                        ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        <div class="mt-1">
                                                            <small class="text-success">操作者: ${entry.operator || '系統管理員'}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">角色變更歷程</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="清空所有歷程">
                                            <i class="fas fa-trash"></i> 清空
                                        </button>
                                    </div>
                                    <div class="card">
                                        <div class="card-body p-2 text-center text-muted">
                                            <small>尚無成員變更記錄</small>
                                        </div>
                                    </div>
                                    <hr class="my-4">
                                    <div class="usage-guide bg-light p-3 rounded">
                                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>角色備註提交 - 小卡版</h6>
                                        <div class="mb-3">
                                            <strong>使用時機：</strong><br>
                                            1. 在各自目前在開發專案（如：ErCore/ErNexus/ErShield/ErTidy）發PR後<br>
                                            2. 來ErDashboard執行角色備註腳本
                                        </div>
                                        <div class="mb-3">
                                            <strong>操作步驟：</strong><br>
                                            1. 開啟終端機<br>
                                            2. cd 到/GitHub/ErDashboard 資料夾<br>
                                            3. 執行指令：
                                        </div>
                                        <div class="bg-dark text-light p-2 rounded mb-3">
                                            <code>node scripts/submit-note.js 專案名稱 名稱 "備註"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>範例：</strong><br>
                                            <code>node scripts/submit-note.js ErCore KlauderA "• 完成登入API • 修復bug"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>規則：</strong><br>
                                            • 必須條列格式 (•、1.、-)<br>
                                            • 最多50字<br>
                                            • 要具體明確
                                        </div>
                                        <div class="mb-3">
                                            <strong>在各自目前在開發專案：</strong><br>
                                            如：ErCore, ErNexus, ErShield, ErTidy
                                        </div>
                                        <div class="text-success">
                                            <strong>提交後自動同步到個人歷程，並回到本來的專案/branch！</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.warn('生成角色變更歷程時發生錯誤:', error);
                    memberHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">角色變更歷程</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="if(window.teamManagement) window.teamManagement.clearMemberHistory('${projectId}')" title="清空所有歷程">
                                    <i class="fas fa-trash"></i> 清空
                                </button>
                            </div>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>載入歷程時發生錯誤</small>
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="usage-guide bg-light p-3 rounded">
                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>📝 角色備註提交 - 小卡版</h6>
                                <div class="mb-3">
                                    <strong>📤 使用時機：</strong><br>
                                    🔸 在各自專案（ErCore/ErNexus/ErShield/ErTidy）發PR後<br>
                                    🔸 來ErDashboard執行角色備註腳本
                                </div>
                                <div class="mb-3">
                                    🔸 開啟終端機<br>
                                    🔸 cd 到/GitHub/ErDashboard 資料夾<br>
                                    🔸 執行指令：
                                </div>
                                <div class="bg-dark text-light p-2 rounded mb-3">
                                    <code>node scripts/submit-note.js 專案 姓名 "備註"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>📋 範例：</strong><br>
                                    <code>node scripts/submit-note.js ErCore 張小明 "• 完成登入API • 修復bug"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>✅ 規則：</strong><br>
                                    • 必須條列格式 (•、1.、-)<br>
                                    • 最多50字<br>
                                    • 要具體明確
                                </div>
                                <div class="mb-3">
                                    <strong>🎯 專案：</strong>ErCore, ErNexus, ErShield, ErTidy
                                </div>
                                <div class="text-success">
                                    <strong>💡 提交後自動同步到個人歷程！</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 顯示任務小卡編輯模態框
                const taskModalHtml = `
                    <div class="modal fade" id="taskCardModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">任務小卡編輯 - ${memberName}，「${project.projectName}」專案的「${member.role}」</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label for="taskContent" class="form-label">任務小卡內容</label>
                                                <textarea class="form-control" id="taskContent" rows="20" style="min-height: 500px;">${taskCardContent}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-2">
                                            ${projectNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${personalNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${taskHistoryHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${memberHistoryHtml}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="copyTaskCard()">
                                        <i class="fas fa-copy"></i> 複製
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="saveTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> 儲存
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="restoreDefaultTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-undo"></i> 恢復預設
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldTaskModal = document.getElementById('taskCardModal');
                if (oldTaskModal) oldTaskModal.remove();
                document.body.insertAdjacentHTML('beforeend', taskModalHtml);

                const taskModal = new bootstrap.Modal(document.getElementById('taskCardModal'));
                taskModal.show();

            } catch (error) {
                console.error('編輯任務小卡失敗:', error);
                alert('編輯任務小卡失敗: ' + error.message);
            }
        }

        // 編輯專案進度
        async function editProjectProgress(projectId) {
            try {

                // 載入專案資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                // 設定當前專案資料供其他函數使用
                window.currentProject = project;
                window.currentProjectId = projectId;

                // 顯示進度編輯模態框
                const progressModalHtml = `
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">編輯專案進度 - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <label for="projectProgress" class="form-label fw-bold">專案進度</label>
                                        <div class="progress-container">
                                            <div class="progress mb-3" style="height: 20px; border-radius: 10px; background-color: #e9ecef;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                     id="progressBar"
                                                     role="progressbar"
                                                     style="width: ${project.progress}%; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 10px;"
                                                     aria-valuenow="${project.progress}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <input type="range" class="form-range progress-slider" id="projectProgress" min="0" max="100" value="${project.progress}" oninput="updateProgressDisplay(this.value)">
                                            <div class="text-center mt-2">
                                                <span id="progressDisplay" class="badge bg-primary fs-6 px-3 py-2" style="border-radius: 20px;">${project.progress}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectNotes" class="form-label">專案備註</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newNote" rows="3" placeholder="輸入新的備註..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addNote()">
                                                <i class="fas fa-plus"></i> 新增備註
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllNotes()">
                                                <i class="fas fa-trash"></i> 清除所有備註
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="notesList">
                                                ${formatNotes(project.notes || '')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveProjectProgress('${projectId}')">
                                        <i class="fas fa-save"></i> 儲存
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldProgressModal = document.getElementById('progressModal');
                if (oldProgressModal) oldProgressModal.remove();
                document.body.insertAdjacentHTML('beforeend', progressModalHtml);

                const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();

            } catch (error) {
                console.error('編輯專案進度失敗:', error);
                alert('編輯專案進度失敗: ' + error.message);
            }
        }

        // 更新進度顯示
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = value + '%';
                progressBar.setAttribute('aria-valuenow', value);

                // 動態改變進度條顏色
                let gradient;
                if (value < 30) {
                    gradient = 'linear-gradient(45deg, #dc3545, #c82333)'; // 紅色
                } else if (value < 70) {
                    gradient = 'linear-gradient(45deg, #ffc107, #e0a800)'; // 黃色
                } else {
                    gradient = 'linear-gradient(45deg, #28a745, #1e7e34)'; // 綠色
                }
                progressBar.style.background = gradient;
            }
        }

        // 格式化備註顯示
        function formatNotes(notes) {
            if (!notes) return '<p class="text-muted m-0">尚無備註</p>';

            // 如果 notes 已經是陣列（物件），直接處理
            if (Array.isArray(notes)) {
                if (notes.length > 0) {
                    return notes.map((note, index) =>
                        `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-bold small text-muted">${note.timestamp}</div>
                                <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="刪除此備註">
                                    <i class="fas fa-times" style="font-size: 10px;"></i>
                                </button>
                            </div>
                            <div>${note.content}</div>
                        </div>`
                    ).join('');
                }
                return '<p class="text-muted m-0">尚無備註</p>';
            }

            // 如果是字串，嘗試解析 JSON
            if (typeof notes === 'string') {
                try {
                    const notesList = JSON.parse(notes);
                    if (Array.isArray(notesList) && notesList.length > 0) {
                        return notesList.map((note, index) =>
                            `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="fw-bold small text-muted">${note.timestamp}</div>
                                    <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="刪除此備註">
                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                    </button>
                                </div>
                                <div>${note.content}</div>
                            </div>`
                        ).join('');
                    }
                } catch (e) {
                    // 如果不是 JSON 格式，當作舊格式的純文字
                    if (notes.trim()) {
                        return `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                    <div class="fw-bold small text-muted">舊備註</div>
                                    <div>${notes}</div>
                                </div>`;
                    }
                }
            }

            return '<p class="text-muted m-0">尚無備註</p>';
        }

        // 新增備註
        async function addNote() {
            const newNoteInput = document.getElementById('newNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('請輸入備註內容');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                author: 'KopylotA', // ErNexus 專案的 testing 角色
                type: 'note'
            };

            // 獲取現有備註
            let existingNotes = [];
            try {
                const currentProject = getCurrentProject();
                if (currentProject && currentProject.notes) {
                    existingNotes = JSON.parse(currentProject.notes);
                }
            } catch (e) {
                // 如果解析失敗，建立新陣列
                existingNotes = [];
            }

            if (!Array.isArray(existingNotes)) {
                existingNotes = [];
            }

            // 新增到陣列開頭（最新的在上面）
            existingNotes.unshift(newNote);

            // 立即儲存到 TeamDataManager
            try {
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[window.currentProjectId]) {
                    assignments[window.currentProjectId].notes = JSON.stringify(existingNotes);
                    assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    // 更新當前專案資料
                    window.currentProject.notes = JSON.stringify(existingNotes);
                }
            } catch (error) {
                console.error('儲存備註失敗:', error);
                alert('儲存備註失敗: ' + error.message);
                return;
            }

            // 更新顯示
            updateNotesDisplay(existingNotes);

            // 清空輸入框
            newNoteInput.value = '';
        }

        // 清除所有備註
        async function clearAllNotes() {
            if (confirm('確定要清除所有備註嗎？此操作無法復原。')) {
                try {
                    // 立即儲存到 TeamDataManager
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();

                    if (assignments[window.currentProjectId]) {
                        assignments[window.currentProjectId].notes = JSON.stringify([]);
                        assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        // 更新當前專案資料
                        window.currentProject.notes = JSON.stringify([]);
                    }

                    // 更新顯示
                    updateNotesDisplay([]);
                } catch (error) {
                    console.error('清除備註失敗:', error);
                    alert('清除備註失敗: ' + error.message);
                }
            }
        }

        // 更新備註顯示
        function updateNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('notesList');
            if (notesList.length === 0) {
                notesListDiv.innerHTML = '<p class="text-muted m-0">尚無備註</p>';

                // 同時清除任務小卡中的專案備註歷程顯示
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = '';
                }
            } else {
                notesListDiv.innerHTML = notesList.map(note =>
                    `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <div>${note.content}</div>
                    </div>`
                ).join('');

                // 同時更新任務小卡中的專案備註歷程顯示
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    const updatedProjectNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">專案備註歷程</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${notesList.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === notesList.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || 'System'}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div>${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                }
            }
        }

        // 獲取當前專案（輔助函數）
        function getCurrentProject() {
            // 這個函數需要在模態框開啟時設定當前專案資料
            return window.currentProject || null;
        }

        // 儲存專案進度
        async function saveProjectProgress(projectId) {
            try {
                const progress = parseInt(document.getElementById('projectProgress').value);

                // 獲取當前備註列表
                const notesListDiv = document.getElementById('notesList');
                let notesList = [];

                // 從顯示的備註中提取資料
                const noteElements = notesListDiv.querySelectorAll('.border-start');
                noteElements.forEach(element => {
                    const timestamp = element.querySelector('.text-muted').textContent;
                    const content = element.querySelector('div:last-child').textContent;
                    if (timestamp !== '尚無備註') {
                        notesList.push({ timestamp, content });
                    }
                });

                // 使用全域的團隊資料管理器，確保與歷程記錄同步
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                }
                const assignments = teamDataManager.getAllAssignments();

                // 更新專案進度和備註
                if (assignments[projectId]) {
                    assignments[projectId].progress = progress;
                    assignments[projectId].notes = JSON.stringify(notesList);
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    alert(`專案進度已更新為 ${progress}%\n備註已儲存 (共 ${notesList.length} 筆)`);
                } else {
                    throw new Error('找不到指定的專案');
                }

                // 關閉模態框
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) progressModal.hide();

                // 發送localStorage更新信號確保即時更新
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'progressUpdate'
                }));

                // 回到首頁
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);

            } catch (error) {
                console.error('儲存專案進度失敗:', error);
                alert('儲存專案進度失敗: ' + error.message);
            }
        }

        // 變更成員
        async function changeMember(projectId, memberId) {
            try {

                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const members = teamDataManager.getAllMembers();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`找不到專案: ${projectId}`);
                }

                const currentMember = project.members[memberId];
                if (!currentMember) {
                    throw new Error(`找不到成員: ${memberId}`);
                }

                // 生成可用成員選項
                let memberOptions = '';
                Object.values(members).forEach(member => {
                    const memberIdToCheck = member.memberId || member.id;
                    const memberName = member.memberName || member.name;
                    const selected = memberIdToCheck === memberId ? 'selected' : '';
                    memberOptions += `<option value="${memberIdToCheck}" ${selected}>${memberName} (${memberIdToCheck})</option>`;
                });

                // 顯示成員變更模態框
                const memberModalHtml = `
                    <div class="modal fade" id="memberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">變更成員 - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newMember" class="form-label">選擇新成員</label>
                                        <select class="form-select" id="newMember">
                                            ${memberOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberRole" class="form-label">角色</label>
                                        <select class="form-select" id="memberRole">
                                            <option value="frontend" ${currentMember.role === 'frontend' ? 'selected' : ''}>前端開發</option>
                                            <option value="backend" ${currentMember.role === 'backend' ? 'selected' : ''}>後端開發</option>
                                            <option value="fullstack" ${currentMember.role === 'fullstack' ? 'selected' : ''}>全端開發</option>
                                            <option value="testing" ${currentMember.role === 'testing' ? 'selected' : ''}>測試部署</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveMemberChange('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> 儲存變更
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberModal = document.getElementById('memberModal');
                if (oldMemberModal) oldMemberModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberModalHtml);

                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();

            } catch (error) {
                console.error('變更成員失敗:', error);
                alert('變更成員失敗: ' + error.message);
            }
        }

        // 切換成員執行狀態
        async function toggleMemberExecution(projectId, memberId, isChecked) {
            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();

                // 更新成員執行狀態
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    assignments[projectId].members[memberId].isExecuting = isChecked;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    // 視覺回饋
                    const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                    const memberCard = checkbox ? checkbox.closest('.border.rounded') : null;
                    const memberNameDiv = memberCard ? memberCard.querySelector('.fw-bold') : null;

                    if (memberNameDiv && memberCard) {
                        if (isChecked) {
                            memberNameDiv.classList.add('text-success');
                            memberCard.style.borderLeft = '3px solid #28a745';
                            showSyncToast('狀態更新', `${memberId} 已開始執行任務`, 'success');
                        } else {
                            memberNameDiv.classList.remove('text-success');
                            memberCard.style.borderLeft = '';
                            showSyncToast('狀態更新', `${memberId} 已停止執行任務`, 'info');
                        }
                    } else {
                        console.warn('無法找到成員卡片元素進行視覺更新');
                        // 仍然顯示狀態訊息
                        if (isChecked) {
                            showSyncToast('狀態更新', `${memberId} 已開始執行任務`, 'success');
                        } else {
                            showSyncToast('狀態更新', `${memberId} 已停止執行任務`, 'info');
                        }
                    }

                    // 更新統計資訊
                    updateExecutionStatistics();

                } else {
                    throw new Error('找不到指定的專案或成員');
                }

            } catch (error) {
                console.error('更新執行狀態失敗:', error);
                alert('更新執行狀態失敗: ' + error.message);

                // 恢復 checkbox 狀態
                const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
            }
        }

        // 更新執行統計資訊
        function updateExecutionStatistics() {
            try {
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    console.warn('TeamDataManager 未初始化');
                    return;
                }
                const assignments = teamDataManager.getAllAssignments();

                let executingCount = 0;
                Object.values(assignments).forEach(project => {
                    Object.values(project.members || {}).forEach(member => {
                        if (member.isExecuting === true) {
                            executingCount++;
                        }
                    });
                });

                // 更新頁面上的統計顯示
                const executingBadge = document.getElementById('executingCount');
                if (executingBadge) {
                    executingBadge.textContent = executingCount;
                }
            } catch (error) {
                console.error('更新統計失敗:', error);
            }
        }

        // 編輯角色備註
        async function editPersonalNotes(projectId, memberId) {
            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`找不到專案: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`找不到成員: ${memberId}`);
                }

                // 從實際成員資料取得名稱
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // 設定當前資料供其他函數使用
                window.currentPersonalNotes = {
                    projectId: projectId,
                    memberId: memberId,
                    member: member,
                    memberName: memberName
                };

                // 格式化角色備註顯示
                const personalNotes = member.personalNotes || [];
                const notesHtml = formatPersonalNotes(personalNotes);

                // 顯示個人備註編輯模態框
                const personalNotesModalHtml = `
                    <div class="modal fade" id="personalNotesModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">角色備註 - ${memberName} (${project.projectName})</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newPersonalNote" class="form-label">新增角色備註</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newPersonalNote" rows="3" placeholder="記錄開發歷程、學習筆記、遇到的問題等..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addPersonalNote()">
                                                <i class="fas fa-plus"></i> 新增備註
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllPersonalNotes()">
                                                <i class="fas fa-trash"></i> 清除所有備註
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="personalNotesList">
                                                ${notesHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldPersonalNotesModal = document.getElementById('personalNotesModal');
                if (oldPersonalNotesModal) oldPersonalNotesModal.remove();
                document.body.insertAdjacentHTML('beforeend', personalNotesModalHtml);

                const personalNotesModal = new bootstrap.Modal(document.getElementById('personalNotesModal'));
                personalNotesModal.show();

            } catch (error) {
                console.error('編輯個人備註失敗:', error);
                alert('編輯個人備註失敗: ' + error.message);
            }
        }

        // 格式化角色備註顯示
        function formatPersonalNotes(notes) {
            if (!notes || !Array.isArray(notes) || notes.length === 0) {
                return '<p class="text-muted m-0">尚無角色備註</p>';
            }

            return notes.map((note, index) =>
                `<div class="mb-2 p-2 border-start border-info border-3 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <button class="btn btn-sm btn-outline-danger p-1" onclick="deletePersonalNote(${index})" title="刪除此備註">
                            <i class="fas fa-times" style="font-size: 10px;"></i>
                        </button>
                    </div>
                    <div>${note.content}</div>
                </div>`
            ).join('');
        }

        // 新增角色備註
        async function addPersonalNote() {
            const newNoteInput = document.getElementById('newPersonalNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('請輸入備註內容');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                created: new Date().toISOString()
            };

            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    // 初始化個人備註陣列
                    if (!assignments[currentData.projectId].members[currentData.memberId].personalNotes) {
                        assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    }

                    // 新增到陣列開頭（最新的在上面）
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes.unshift(newNote);
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    // 更新顯示
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    updatePersonalNotesDisplay(personalNotes);

                    // 清空輸入框
                    newNoteInput.value = '';

                    showSyncToast('備註已新增', '角色備註已儲存', 'success');
                }
            } catch (error) {
                console.error('新增角色備註失敗:', error);
                alert('新增角色備註失敗: ' + error.message);
            }
        }

        // 刪除角色備註
        async function deletePersonalNote(index) {
            if (!confirm('確定要刪除此角色備註嗎？')) {
                return;
            }

            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    if (personalNotes && personalNotes[index]) {
                        // 刪除指定的備註
                        personalNotes.splice(index, 1);
                        assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        // 更新顯示
                        updatePersonalNotesDisplay(personalNotes);

                        showSyncToast('備註已刪除', '角色備註已移除', 'info');
                    }
                }
            } catch (error) {
                console.error('刪除個人備註失敗:', error);
                alert('刪除個人備註失敗: ' + error.message);
            }
        }

        // 清除所有角色備註
        async function clearAllPersonalNotes() {
            if (!confirm('確定要清除所有角色備註嗎？此操作無法復原。')) {
                return;
            }

            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    // 更新顯示
                    updatePersonalNotesDisplay([]);

                    showSyncToast('備註已清除', '所有角色備註已清除', 'info');
                }
            } catch (error) {
                console.error('清除個人備註失敗:', error);
                alert('清除個人備註失敗: ' + error.message);
            }
        }

        // 刪除專案備註
        window.deleteProjectNote = async function(index) {
            if (!confirm('確定要刪除此專案備註嗎？')) {
                return;
            }

            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentProjectId = window.currentProjectId;

                if (assignments[currentProjectId]) {
                    let notesList = [];
                    if (assignments[currentProjectId].notes) {
                        try {
                            notesList = JSON.parse(assignments[currentProjectId].notes);
                        } catch (e) {
                            // 如果解析失敗，將舊格式轉換為陣列格式
                            notesList = [{
                                timestamp: '舊備註',
                                content: assignments[currentProjectId].notes,
                                author: 'System'
                            }];
                        }
                    }

                    if (notesList[index]) {
                        // 刪除指定的備註
                        notesList.splice(index, 1);
                        assignments[currentProjectId].notes = JSON.stringify(notesList);
                        assignments[currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        // 更新專案進度彈窗中的顯示
                        const notesListDiv = document.getElementById('notesList');
                        if (notesListDiv) {
                            notesListDiv.innerHTML = formatNotes(assignments[currentProjectId].notes);
                        }

                        // 更新任務小卡中的專案備註歷程顯示
                        const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                        if (projectNotesColumn) {
                            let updatedProjectNotesHtml = '';
                            if (assignments[currentProjectId].notes) {
                                try {
                                    const projectNotes = JSON.parse(assignments[currentProjectId].notes);
                                    if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                                        updatedProjectNotesHtml = `
                                            <div class="mb-3">
                                                <label class="form-label">專案備註歷程</label>
                                                <div class="card" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="card-body p-2">
                                                        ${projectNotes.map((note, index) => `
                                                            <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                                    <small class="text-muted">${note.author || 'System'}</small>
                                                                    <small class="text-muted">${note.timestamp}</small>
                                                                </div>
                                                                <div>${note.content}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                } catch (e) {
                                    // 解析失敗時顯示空白
                                    updatedProjectNotesHtml = '';
                                }
                            }
                            projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                        }

                        showSyncToast('備註已刪除', '專案備註已移除', 'info');
                    }
                }
            } catch (error) {
                console.error('刪除專案備註失敗:', error);
                alert('刪除專案備註失敗: ' + error.message);
            }
        }

        // 更新角色備註顯示
        function updatePersonalNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('personalNotesList');
            if (notesListDiv) {
                notesListDiv.innerHTML = formatPersonalNotes(notesList);
            }
        }

        // 顯示成員資訊
        function showMemberInfo(projectId, memberId) {
            try {
                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }

                const assignments = teamDataManager.getAllAssignments();
                const allMembers = teamDataManager.getAllMembers();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const memberInfo = allMembers[memberId];

                if (!project || !member) {
                    throw new Error('找不到指定的專案或成員');
                }

                const memberName = memberInfo?.name || memberId;
                const personalNotesCount = (member.personalNotes || []).length;
                const taskCardCount = Object.keys(member.taskCard || {}).length;

                // 顯示成員資訊模態框
                const memberInfoModalHtml = `
                    <div class="modal fade" id="memberInfoModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">成員資訊 - ${memberName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-user me-2"></i>基本資訊</h6>
                                            <p class="mb-1"><strong>成員 ID：</strong>${memberId}</p>
                                            <p class="mb-1"><strong>成員名稱：</strong>${memberName}</p>
                                            <p class="mb-1"><strong>專案角色：</strong><span class="badge bg-primary">${member.role}</span></p>
                                            <p class="mb-0"><strong>執行狀態：</strong>
                                                ${member.isExecuting ?
                                                    '<span class="badge bg-success">執行中</span>' :
                                                    '<span class="badge bg-secondary">未執行</span>'
                                                }
                                            </p>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-chart-bar me-2"></i>活動統計</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-primary">${personalNotesCount}</div>
                                                        <small class="text-muted">角色備註</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-success">${taskCardCount}</div>
                                                        <small class="text-muted">任務小卡</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-project-diagram me-2"></i>專案資訊</h6>
                                            <p class="mb-1"><strong>專案名稱：</strong>${project.projectName}</p>
                                            <p class="mb-1"><strong>專案狀態：</strong>
                                                <span class="badge bg-${
                                                    project.status === 'active' ? 'success' :
                                                    project.status === 'paused' ? 'warning' :
                                                    project.status === 'completed' ? 'secondary' : 'info'
                                                }">${
                                                    project.status === 'active' ? '進行中' :
                                                    project.status === 'paused' ? '暫停' :
                                                    project.status === 'completed' ? '已完成' :
                                                    project.status || '未知狀態'
                                                }</span>
                                            </p>
                                            <p class="mb-0"><strong>最後更新：</strong>${project.lastUpdated || '未知'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberInfoModal = document.getElementById('memberInfoModal');
                if (oldMemberInfoModal) oldMemberInfoModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberInfoModalHtml);

                const memberInfoModal = new bootstrap.Modal(document.getElementById('memberInfoModal'));
                memberInfoModal.show();

            } catch (error) {
                console.error('顯示成員資訊失敗:', error);
                alert('顯示成員資訊失敗: ' + error.message);
            }
        }

        // 儲存成員變更
        async function saveMemberChange(projectId, oldMemberId) {
            try {
                const newMemberId = document.getElementById('newMember').value;
                const newRole = document.getElementById('memberRole').value;

                // 使用全域的團隊資料管理器，確保與歷程記錄同步
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                }
                const assignments = teamDataManager.getAllAssignments();

                // 檢查新成員是否已經在當前專案中（避免重複）
                if (assignments[projectId].members && assignments[projectId].members[newMemberId] && newMemberId !== oldMemberId) {
                    alert(`${newMemberId} 已經在此專案中！\n一個專案內不能有重複的成員。`);
                    return;
                }

                // 取得舊成員資料
                const oldMemberData = assignments[projectId].members[oldMemberId];
                const oldRole = oldMemberData?.role;

                if (newMemberId !== oldMemberId) {
                    // 檢查新成員是否真的不同（避免重複切換的問題）
                    console.log('成員變更檢查:', {
                        oldMemberId,
                        newMemberId,
                        currentMembers: Object.keys(assignments[projectId].members)
                    });

                    // 如果更換成員，刪除舊成員
                    delete assignments[projectId].members[oldMemberId];

                    // 新增新成員，保留任務小卡和個人備註等資料
                    assignments[projectId].members[newMemberId] = {
                        memberId: newMemberId,
                        role: newRole,
                        taskCard: oldMemberData.taskCard || {},
                        personalNotes: oldMemberData.personalNotes || [], // 複製個人備註
                        isExecuting: false // 新成員預設為未執行狀態
                    };

                    // 記錄角色變更歷程 - 成員移除
                    if (window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // 取得真實成員姓名
                        const oldMemberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;
                        const newMemberName = window.teamDataManager.getAllMembers()[newMemberId]?.name || newMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_removed',
                            memberId: oldMemberId,
                            memberName: oldMemberName,
                            role: oldRole,
                            details: `成員從專案中移除`
                        });

                        // 記錄角色變更歷程 - 成員加入
                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_assigned',
                            memberId: newMemberId,
                            memberName: newMemberName,
                            role: newRole,
                            details: `新成員加入專案`
                        });
                    }
                } else {
                    // 如果只是更改角色
                    assignments[projectId].members[oldMemberId].role = newRole;

                    // 記錄角色變更歷程
                    if (oldRole !== newRole && window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // 取得真實成員姓名
                        const memberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'role_changed',
                            memberId: oldMemberId,
                            memberName: memberName,
                            oldRole: oldRole,
                            newRole: newRole,
                            details: `角色從 ${oldRole} 變更為 ${newRole}`
                        });
                    }
                }

                // 更新專案的最後更新時間
                assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                // 儲存變更
                await teamDataManager.saveLocalChanges();

                alert(`成員已從 ${oldMemberId} 變更為 ${newMemberId}\n角色: ${newRole}`);

                // 關閉模態框
                const memberModal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                if (memberModal) memberModal.hide();

                // 立即重新載入頁面資料
                await loadDataDirectly();

                // 發送localStorage更新信號確保即時更新
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'memberChange'
                }));

            } catch (error) {
                console.error('儲存成員變更失敗:', error);
                alert('儲存成員變更失敗: ' + error.message);
            }
        }

        // 儲存任務小卡內容
        async function saveTaskCard(projectId, memberId) {
            try {
                const taskContent = document.getElementById('taskContent').value;

                if (!taskContent.trim()) {
                    alert('任務小卡內容不能為空');
                    return;
                }

                // 使用全域 TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager 未初始化');
                }
                const assignments = teamDataManager.getAllAssignments();

                // 更新任務小卡內容
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    if (!assignments[projectId].members[memberId].taskCard) {
                        assignments[projectId].members[memberId].taskCard = {};
                    }

                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    const currentTime = new Date().toISOString();

                    // 如果內容有變更，保存到歷程中
                    if (taskCard.content && taskCard.content !== taskContent) {
                        if (!taskCard.history) {
                            taskCard.history = [];
                        }

                        // 添加歷程記錄
                        taskCard.history.push({
                            timestamp: taskCard.lastUpdated || currentTime,
                            content: taskCard.content,
                            note: '內容更新',
                            author: 'KopylotA', // ErNexus 專案的 testing 角色
                            version: `v${(taskCard.history.length + 1).toString().padStart(2, '0')}`
                        });

                        // 保留最近20筆歷程記錄
                        if (taskCard.history.length > 20) {
                            taskCard.history = taskCard.history.slice(-20);
                        }
                    }

                    taskCard.content = taskContent;
                    taskCard.lastUpdated = currentTime;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    alert('任務小卡已成功儲存！');

                    // 關閉模態框
                    const taskModal = bootstrap.Modal.getInstance(document.getElementById('taskCardModal'));
                    if (taskModal) {
                        taskModal.hide();
                    }

                    // 重新載入首頁資料
                    loadDataDirectly();

                } else {
                    throw new Error('找不到指定的專案或成員');
                }

            } catch (error) {
                console.error('儲存任務小卡失敗:', error);
                alert('儲存任務小卡失敗: ' + error.message);
            }
        }

        // 複製任務小卡內容
        async function copyTaskCard() {
            try {
                const taskContent = document.getElementById('taskContent').value;

                // 獲取專案備註歷程
                let projectNotesText = '';
                try {
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();
                    const currentProject = assignments[window.currentTaskCardTemplate?.projectId];

                    if (currentProject && currentProject.notes) {
                        const projectNotes = JSON.parse(currentProject.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesText = '\n\n=== 專案備註歷程 ===\n' +
                                projectNotes.map(note =>
                                    `${note.timestamp} [${note.author || 'System'}]: ${note.content}`
                                ).join('\n') + '\n';
                        }
                    }
                } catch (e) {
                }

                const textToCopy = taskContent + projectNotesText;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // 視覺回饋
                    const buttons = document.querySelectorAll('button[onclick="copyTaskCard()"]');
                    const button = buttons[0]; // 取得複製按鈕
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> 已複製';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-success');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，請手動複製內容');
                });
            } catch (error) {
                console.error('複製任務小卡失敗:', error);
                alert('複製失敗，請手動複製內容');
            }
        }

        // 恢復歷史版本內容
        function restoreHistoryVersion(timestamp, content) {
            try {
                if (confirm('確定要恢復此歷史版本嗎？目前的編輯內容將被覆蓋。')) {
                    // 將歷史內容填入文字區域
                    document.getElementById('taskContent').value = content;


                    alert('已恢復歷史版本內容，請記得儲存變更。');
                }
            } catch (error) {
                console.error('恢復歷史版本失敗:', error);
                alert('恢復歷史版本失敗: ' + error.message);
            }
        }

        // 更新任務小卡 modal 內容（不重新創建 modal）
        async function updateTaskCardModal(projectId, memberId) {
            try {
                // 重新載入專案資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const taskCard = member.taskCard;

                // 重新生成專案備註歷程 HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">專案備註歷程</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // 重新生成任務小卡歷程記錄 HTML
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">任務小卡歷程</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="清空所有歷程">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="刪除此記錄">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">查看內容</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> 恢復此版本
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <label class="form-label">任務小卡歷程</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>尚無歷程記錄</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 重新生成角色備註 HTML
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">角色備註</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">角色備註</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>尚無角色備註記錄</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // 更新現有 modal 中的專案備註歷程、角色備註、任務小卡歷程和角色變更歷程欄位
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                const personalNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(3)');
                const taskHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(4)');
                const memberHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(5)');

                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = projectNotesHtml;
                }
                if (personalNotesColumn) {
                    personalNotesColumn.innerHTML = personalNotesHtml;
                }
                if (taskHistoryColumn) {
                    taskHistoryColumn.innerHTML = taskHistoryHtml;
                }
                if (memberHistoryColumn) {
                    // 重新生成角色變更歷程
                    let updatedMemberHistoryHtml = '';
                    try {
                        if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                            updatedMemberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                        } else {
                            const currentProject = teamDataManager.getAllAssignments()[projectId];
                            const memberHistory = currentProject?.memberHistory || [];
                            if (memberHistory.length > 0) {
                                const actionLabels = {
                                    'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>成員加入',
                                    'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>成員移除',
                                    'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>角色變更'
                                };

                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">角色變更歷程</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="清空所有歷程">
                                                <i class="fas fa-trash"></i> 清空
                                            </button>
                                        </div>
                                        <div class="card" style="max-height: 400px; overflow-y: auto;">
                                            <div class="card-body p-2">
                                                ${memberHistory.slice().reverse().map((entry, index) => `
                                                    <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <div class="small">
                                                                ${actionLabels[entry.action] || entry.action}
                                                                <strong>${entry.memberName}</strong>
                                                            </div>
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                        </div>
                                                        <div class="ps-3">
                                                            ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                            ${entry.oldRole && entry.newRole ? `
                                                                <div class="mt-1">
                                                                    <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                    <i class="fas fa-arrow-right mx-1 small"></i>
                                                                    <span class="badge bg-success small">${entry.newRole}</span>
                                                                </div>
                                                            ` : ''}
                                                            ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">角色變更歷程</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="清空所有歷程">
                                                <i class="fas fa-trash"></i> 清空
                                            </button>
                                        </div>
                                        <div class="card">
                                            <div class="card-body p-2 text-center text-muted">
                                                <small>尚無成員變更記錄</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.warn('更新角色變更歷程時發生錯誤:', error);
                        updatedMemberHistoryHtml = `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">角色變更歷程</label>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="清空所有歷程">
                                        <i class="fas fa-trash"></i> 清空
                                    </button>
                                </div>
                                <div class="card">
                                    <div class="card-body p-2 text-center text-muted">
                                        <small>載入歷程時發生錯誤</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    memberHistoryColumn.innerHTML = updatedMemberHistoryHtml;
                }

            } catch (error) {
                console.error('更新任務小卡 modal 內容失敗:', error);
            }
        }

        // 刪除單筆任務小卡歷程記錄
        async function deleteTaskHistoryItem(projectId, memberId, timestamp) {
            try {
                if (!confirm('確定要刪除此歷程記錄嗎？')) {
                    return;
                }

                // 載入團隊資料管理器
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard && taskCard.history) {
                        // 移除指定時間戳的歷程記錄
                        taskCard.history = taskCard.history.filter(record => record.timestamp !== timestamp);

                        // 重新編號版本
                        taskCard.history.forEach((record, index) => {
                            record.version = `v${(index + 1).toString().padStart(2, '0')}`;
                        });

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        alert('歷程記錄已刪除');

                        // 更新現有 modal 的內容而不重新創建
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('刪除歷程記錄失敗:', error);
                alert('刪除歷程記錄失敗: ' + error.message);
            }
        }

        // 清空所有任務小卡歷程記錄
        async function clearTaskHistory(projectId, memberId) {
            try {
                if (!confirm('確定要清空所有任務小卡歷程記錄嗎？此操作無法復原。')) {
                    return;
                }

                // 載入團隊資料管理器
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard) {
                        // 清空歷程記錄
                        taskCard.history = [];

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        alert('所有歷程記錄已清空');

                        // 更新現有 modal 的內容而不重新創建
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('清空歷程記錄失敗:', error);
                alert('清空歷程記錄失敗: ' + error.message);
            }
        }

        // 清空所有角色變更歷程記錄
        async function clearMemberHistory(projectId) {
            try {
                if (!confirm('確定要清空所有角色變更歷程記錄嗎？此操作無法復原。')) {
                    return;
                }
                // 載入團隊資料管理器
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                if (teamDataManager.assignments[projectId]) {
                    // 直接修改 assignments 內部資料
                    teamDataManager.assignments[projectId].memberHistory = [];
                    teamDataManager.assignments[projectId].lastUpdated = new Date().toISOString();

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();
                    alert('所有角色變更歷程記錄已清空');

                    // 如果任務小卡模態框已開啟，需要重新載入內容
                    const taskCardModal = document.getElementById('taskCardModal');
                    if (taskCardModal && taskCardModal.classList.contains('show')) {
                        // 重新載入頁面以更新所有顯示
                        window.location.reload();
                    }
                }
            } catch (error) {
                console.error('清空角色變更歷程失敗:', error);
                alert('清空角色變更歷程失敗: ' + error.message);
            }
        }

        // 恢復預設任務小卡內容
        function restoreDefaultTaskCard(projectId, memberId) {
            try {
                if (!window.currentTaskCardTemplate ||
                    window.currentTaskCardTemplate.projectId !== projectId ||
                    window.currentTaskCardTemplate.memberId !== memberId) {
                    alert('無法取得預設範本資料');
                    return;
                }

                // 確認是否要恢復預設
                if (confirm('確定要恢復預設範本嗎？此操作將清除目前的編輯內容。')) {
                    // 將預設內容填入文字區域
                    document.getElementById('taskContent').value = window.currentTaskCardTemplate.defaultContent;


                    // 視覺回饋
                    const buttons = document.querySelectorAll(`button[onclick*="restoreDefaultTaskCard"]`);
                    const button = buttons[0]; // 取得恢復預設按鈕
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> 已恢復';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-warning');
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('恢復預設任務小卡失敗:', error);
                alert('恢復預設失敗: ' + error.message);
            }
        }

        // 頁面載入時直接執行（延遲一下等認證通過）
        window.addEventListener('DOMContentLoaded', () => {
            // 添加專案備註刪除按鈕的事件委託
            document.addEventListener('click', function(event) {
                if (event.target.closest('.delete-project-note-btn')) {
                    const button = event.target.closest('.delete-project-note-btn');
                    const index = parseInt(button.getAttribute('data-index'));
                    if (!isNaN(index)) {
                        window.deleteProjectNote(index);
                    }
                }
            });

            // 等待更長時間確保 Google Drive API 完全初始化
            setTimeout(() => {
                // 只有在認證通過後才載入
                const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
                if (isAuthenticated) {
                    loadDataDirectly();
                }
            }, 2000);
        });

        // 嚴格的認證檢查 - 無繞過機制
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // 確保未認證時完全隱藏所有資料
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner 已移除
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // 禁止初始化 Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // 如果已認證，顯示登出按鈕
            showMainDashboard();
            // 檢查 session 是否過期
            checkSessionTimeout();
            return true;
        }
        
        // 私鑰驗證功能
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // 驗證 Google Drive 設定
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = '請輸入 Google Drive 設定';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('設定格式不完整');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive 設定格式錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = '請輸入私鑰';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';
            
            try {
                // 使用 Web Crypto API 驗證私鑰
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // 儲存 Google Drive 設定到 sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // 設定登入狀態和時間戳
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();

                        // 直接載入資料
                        loadDataDirectly();

                        // 啟動新的 Markdown Dashboard
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        } else {
                            console.error('MarkdownProjectDashboard 類別未定義');
                        }
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = '私鑰驗證失敗，請確認私鑰正確';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `驗證錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>驗證並進入';
            }
        });
        
        // 從檔案匯入私鑰
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // 顯示主 Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('devLogBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';
            // 同步備註功能已整合到重新載入按鈕
            // document.getElementById('syncRoleNotesBtn').style.display = 'inline-block';
            document.getElementById('fixRolesBtn').style.display = 'inline-block';

            // 直接載入資料
            setTimeout(loadDataDirectly, 500);
        }
        
        // 登出功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('確定要登出嗎？登出後需要重新匯入私鑰。')) {
                // 清除認證狀態
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // 隱藏登出按鈕和團隊管理按鈕
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('devLogBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';
                document.getElementById('fixRolesBtn').style.display = 'none';

                // 顯示認證介面
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner 已移除
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // 清空私鑰輸入欄
                document.getElementById('privateKeyInput').value = '';
                
                // 隱藏成功/錯誤訊息
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('用戶已登出，需要重新認證');
            }
        });
        
        // 檢查 Session 超時（30分鐘）
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';

            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30分鐘

                if (sessionAge > timeout) {
                    alert('會話已過期，請重新登入');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // 每分鐘檢查一次 session
        setInterval(checkSessionTimeout, 60000);

        // 重新載入功能（整合同步）
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            const refreshBtn = this;
            const originalText = refreshBtn.innerHTML;

            try {
                // 更新按鈕狀態
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';

                // 執行同步任務
                if (window.googleDriveAPI) {
                    // 1. 同步角色備註
                    try {
                        await window.googleDriveAPI.syncRoleNotesFromGitHub();
                        console.log('✅ 角色備註同步完成');
                    } catch (error) {
                        console.error('角色備註同步失敗:', error);
                    }

                    // 2. 從 Google Drive 拉取資料
                    if (window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn()) {
                        try {
                            await pullFilesFromGoogleDrive();
                            console.log('✅ Google Drive 資料同步完成');
                        } catch (error) {
                            console.error('Google Drive 同步失敗:', error);
                        }
                    }
                }

                // 稍等一下讓同步完成
                setTimeout(() => {
                    location.reload();
                }, 500);

            } catch (error) {
                console.error('同步過程發生錯誤:', error);
                // 即使失敗也重新載入
                location.reload();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        });

        // 修復角色按鈕
        document.getElementById('fixRolesBtn').addEventListener('click', async function() {
            const fixBtn = this;
            const originalText = fixBtn.innerHTML;

            try {
                fixBtn.disabled = true;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 修復中...';

                // 確保 Google Drive API 已登入
                if (!window.googleDriveAPI || !window.googleDriveAPI.isAuthenticated) {
                    alert('❌ 需要先登入 Google Drive');
                    return;
                }

                // 載入正確的本地資料
                console.log('📁 載入本地正確資料...');
                const response = await fetch('config/project-assignments.json');
                const correctData = await response.json();

                console.log('✅ 本地資料載入成功');
                console.log('📊 專案數量: ' + Object.keys(correctData.assignments).length);

                // 檢查角色
                for (const [projectId, project] of Object.entries(correctData.assignments)) {
                    if (project.members) {
                        for (const [memberId, member] of Object.entries(project.members)) {
                            console.log(`${projectId} -> ${member.memberName}: ${member.role}`);
                        }
                    }
                }

                // 強制上傳到 Google Drive
                console.log('☁️ 上傳到 Google Drive...');
                await window.googleDriveAPI.saveFile('project-assignments.json', correctData, 'assignments');

                // 清除瀏覽器快取
                localStorage.removeItem('teamAssignments');
                localStorage.removeItem('cachedTeamMembers');
                localStorage.removeItem('teamMemberChanges');
                localStorage.removeItem('teamGroupChanges');

                console.log('🧹 已清除快取');
                alert('✅ 修復完成！頁面將重新載入');

                // 重新載入頁面
                setTimeout(() => window.location.reload(), 1000);

            } catch (error) {
                console.error('❌ 修復失敗:', error);
                alert('❌ 修復失敗: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = originalText;
            }
        });

        // Google Drive 設定按鈕
        document.getElementById('gdriveSetupBtn').addEventListener('click', function() {
            window.open('setup-gdrive.html', '_blank');
        });

        // Push 功能 (上傳到雲端)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // 更新按鈕狀態
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API 未載入');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // 自動觸發登入
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
                    showSyncToast('需要登入', '正在開啟 Google Drive 登入...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive 登入失敗或被取消');
                        }
                        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';
                    } catch (loginError) {
                        console.error('❌ 登入過程發生錯誤:', loginError);
                        throw new Error('Google Drive 登入失敗: ' + loginError.message);
                    }
                }

                await pushLocalFilesToGoogleDrive();

                // 成功訊息
                showSyncToast('推送成功', '本地檔案已推送到 Google Drive', 'success');

            } catch (error) {
                console.error('同步失敗:', error);
                showSyncToast('同步失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull 功能 (從雲端下載)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // 更新按鈕狀態
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下載中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API 未載入');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // 自動觸發登入
                    pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
                    showSyncToast('需要登入', '正在開啟 Google Drive 登入...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive 登入失敗或被取消');
                        }
                        pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下載中...';
                    } catch (loginError) {
                        console.error('❌ 登入過程發生錯誤:', loginError);
                        throw new Error('Google Drive 登入失敗: ' + loginError.message);
                    }
                }

                await pullFilesFromGoogleDrive();

                // 清除記憶體中的資料以強制重新載入
                window.taskTemplatesData = null;

                // 保存當前本地變更，然後重新初始化 TeamDataManager
                if (window.globalTeamDataManager) {

                    // 先保存當前的assignments到localStorage作為備份
                    const currentAssignments = window.globalTeamDataManager.getAllAssignments();
                    if (currentAssignments && Object.keys(currentAssignments).length > 0) {
                        localStorage.setItem('teamAssignments_backup', JSON.stringify(currentAssignments));
                        console.log('💾 當前狀態已備份');
                    }

                    // 清除現有資料
                    window.globalTeamDataManager = null;
                    window.teamDataManager = null;

                    // 重新創建並初始化
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;

                    // 清除備份，避免干擾
                    localStorage.removeItem('teamAssignments_backup');
                    console.log('🧹 已清除備份資料');
                }

                // 成功訊息
                showSyncToast('拉取成功', '已從 Google Drive 拉取最新資料', 'success');

                // 自動重新載入資料（不需要重新整理頁面）
                setTimeout(async () => {
                    try {
                        await loadDataDirectly();
                        showSyncToast('更新完成', '頁面資料已更新', 'success');
                    } catch (error) {
                        console.error('重新載入資料失敗:', error);
                        if (confirm('自動更新失敗，是否手動重新載入頁面？')) {
                            location.reload();
                        }
                    }
                }, 500);

            } catch (error) {
                console.error('拉取失敗:', error);
                showSyncToast('拉取失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // 手動同步角色備註
        document.getElementById('syncRoleNotesBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // 更新按鈕狀態
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 同步中...';

                showSyncToast('開始同步', '正在從 GitHub 同步角色備註...', 'info');

                // 檢查 Google Drive API
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API 未載入');
                }

                // 執行角色備註同步
                await window.googleDriveAPI.syncRoleNotesFromGitHub();

                showSyncToast('同步完成', '角色備註已成功同步！', 'success');

                // 1秒後自動重新載入頁面
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('角色備註同步失敗:', error);
                showSyncToast('同步失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // 推送本地檔案到 Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json',
                'config/task-templates.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    const fileName = filePath.split('/').pop();
                    let fileContent;

                    // 根據檔案類型選擇資料來源
                    if (fileName === 'team-members.json') {
                        // 使用全域 TeamDataManager 中的資料
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager 未初始化');
                        }
                        const teamConfig = teamDataManager.teamConfig;
                        fileContent = JSON.stringify(teamConfig, null, 2);
                    } else if (fileName === 'project-assignments.json') {
                        // 使用全域 TeamDataManager 中的分配資料
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager 未初始化');
                        }
                        const assignments = teamDataManager.getAllAssignments();
                        const constraints = teamDataManager.constraints;
                        const assignmentData = {
                            assignments: assignments,
                            constraints: constraints,
                            statistics: {
                                totalAssignments: Object.values(assignments).reduce((sum, project) => sum + Object.keys(project.members || {}).length, 0),
                                activeProjects: Object.values(assignments).filter(p => p.status === 'active').length,
                                completedProjects: Object.values(assignments).filter(p => p.status === 'completed').length,
                                membersInUse: new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size,
                                availableMembers: Object.keys(teamDataManager.getAllMembers()).length - new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size
                            }
                        };
                        fileContent = JSON.stringify(assignmentData, null, 2);
                    } else if (fileName === 'task-templates.json') {
                        // 使用記憶體中的任務範本資料
                        if (window.taskTemplatesData) {
                            fileContent = JSON.stringify(window.taskTemplatesData, null, 2);
                        } else {
                            // 如果記憶體中沒有，讀取本地檔案
                            const response = await fetch(filePath + '?v=' + Date.now());
                            if (!response.ok) {
                                throw new Error(`無法讀取 ${filePath}: ${response.statusText}`);
                            }
                            fileContent = await response.text();
                        }
                    } else {
                        // 其他檔案直接讀取本地檔案
                        const response = await fetch(filePath + '?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`無法讀取 ${filePath}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    }

                    // 解析 JSON 字串為物件後上傳到 Google Drive
                    let dataToSave;
                    try {
                        dataToSave = JSON.parse(fileContent);
                    } catch (parseError) {
                        throw new Error(`${fileName} JSON 解析失敗: ${parseError.message}`);
                    }

                    await window.googleDriveAPI.saveFile(fileName, dataToSave);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: '同步成功'
                    });


                } catch (error) {
                    console.error(`❌ ${filePath} 同步失敗:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 同步專案狀態檔案 (如果存在)
            await syncProjectStatusFiles();

            // 記錄同步結果
            logSyncResults(syncResults);

            return syncResults;
        }

        // 從 Google Drive 拉取檔案到本地
        async function pullFilesFromGoogleDrive() {
            // Pull 前先備份本地的 memberHistory
            const backupMemberHistory = {};
            try {
                const currentAssignments = window.teamDataManager.getAllAssignments();
                Object.keys(currentAssignments).forEach(projectId => {
                    if (currentAssignments[projectId].memberHistory) {
                        backupMemberHistory[projectId] = [...currentAssignments[projectId].memberHistory];
                    }
                });
            } catch (e) {
            }

            const filesToPull = [
                'team-members.json',
                'project-assignments.json',
                'task-templates.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {

                    // 從 Google Drive 下載檔案
                    const wrappedContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!wrappedContent) {
                        console.log(`⚠️ ${fileName} 無法從 Google Drive 載入（可能是 API 未準備或檔案不存在）`);
                        pullResults.push({
                            fileName: fileName,
                            success: false,
                            error: 'Google Drive API 未準備或檔案不存在'
                        });
                        continue;
                    }

                    // 提取實際資料
                    let actualData = wrappedContent.data || wrappedContent;

                    // 如果 data 是字串，需要解析成物件
                    if (typeof actualData === 'string') {
                        try {
                            actualData = JSON.parse(actualData);
                        } catch (parseError) {
                            throw new Error(`${fileName} JSON 解析失敗: ${parseError.message}`);
                        }
                    }

                    // 驗證資料格式
                    if (!actualData || typeof actualData !== 'object') {
                        throw new Error(`${fileName} 資料格式錯誤`);
                    }

                    // 儲存到 localStorage（模擬下載到本地）
                    let storageKey;
                    if (fileName === 'team-members.json') {
                        storageKey = 'cachedTeamMembers';
                    } else if (fileName === 'project-assignments.json') {
                        storageKey = 'cachedProjectAssignments';
                    } else if (fileName === 'task-templates.json') {
                        storageKey = 'cachedTaskTemplates';
                    }

                    if (storageKey) {
                        localStorage.setItem(storageKey, JSON.stringify(actualData));

                        // 特別處理 project-assignments.json：深度合併到 teamAssignments
                        if (fileName === 'project-assignments.json' && actualData.assignments) {
                            // 顯示從 Google Drive 拉取到的 ErShield 資料
                            const erShieldFromCloud = actualData.assignments.ErShield;
                            if (erShieldFromCloud) {
                                const cloudMemberHistoryCount = erShieldFromCloud.memberHistory?.length || 0;
                                if (cloudMemberHistoryCount > 0) {
                                    console.log('🔍 Google Drive 中的 ErShield memberHistory:', erShieldFromCloud.memberHistory);
                                }
                            }
                            // 取得當前本地狀態作為備份
                            const currentLocalState = localStorage.getItem('teamAssignments');
                            let mergedAssignments = actualData.assignments;

                            if (currentLocalState) {
                                try {
                                    const localAssignments = JSON.parse(currentLocalState);

                                    // 深度合併：雲端資料優先，Pull 後以雲端為準
                                    Object.keys(mergedAssignments).forEach(projectId => {
                                        const localProject = localAssignments[projectId];

                                        // Pull 操作以雲端資料為準，不恢復本地 memberHistory
                                        // (memberHistory 已經從雲端正確載入)

                                        if (mergedAssignments[projectId].members) {
                                            Object.keys(mergedAssignments[projectId].members).forEach(memberId => {
                                                const cloudMember = mergedAssignments[projectId].members[memberId];
                                                const localMember = localAssignments[projectId]?.members?.[memberId];

                                                // 以雲端資料為準，合併 personalNotes
                                                if (localMember && localMember.personalNotes && localMember.personalNotes.length > 0) {
                                                    // 保留本地的角色備註
                                                    cloudMember.personalNotes = localMember.personalNotes;
                                                }
                                            });
                                        }
                                    });
                                } catch (parseError) {
                                    console.warn('⚠️ 本地狀態解析失敗，使用雲端資料:', parseError);
                                }
                            }

                            localStorage.setItem('teamAssignments', JSON.stringify(mergedAssignments));
                        }
                    }

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: '拉取成功'
                    });


                } catch (error) {
                    console.error(`❌ ${fileName} 拉取失敗:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 記錄拉取結果
            logPullResults(pullResults);

            // 顯示拉取後的 memberHistory 數量
            try {
                const assignments = window.teamDataManager.getAllAssignments();
                Object.keys(assignments).forEach(projectId => {
                    const memberHistoryCount = assignments[projectId].memberHistory?.length || 0;
                });
            } catch (e) {
                console.warn('⚠️ 無法顯示 memberHistory 數量:', e);
            }

            // 只有成功拉取到檔案時才重新載入頁面
            const successfulPulls = pullResults.filter(result => result.success);
            if (successfulPulls.length > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }

            return pullResults;
        }

        // 同步專案狀態檔案
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // 這裡可以讀取 project-status 資料夾中的檔案
                    // 由於瀏覽器安全限制，我們先記錄到 localStorage
                } catch (error) {
                }
            }
        }

        // 顯示同步通知
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>剛才</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // 創建 toast 容器 (如果不存在)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // 添加並顯示 toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // 記錄推送結果
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // 記錄拉取結果
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // 簡化版團隊管理
        function showSimpleTeamManagement() {
            console.log('📋 顯示簡化版團隊管理界面');

            const modalHtml = `
                <div class="modal fade" id="simpleTeamModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">團隊管理 (簡化版)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <h6>⚠️ 團隊管理系統載入問題</h6>
                                    <p>完整的團隊管理系統未能正確載入。這可能是由於以下原因之一：</p>
                                    <ul>
                                        <li>JavaScript 檔案載入失敗</li>
                                        <li>瀏覽器快取問題</li>
                                        <li>網路連線問題</li>
                                    </ul>
                                </div>

                                <h6>解決方案：</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="fas fa-sync-alt me-2"></i>重新載入頁面
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.open('setup-gdrive.html', '_blank')">
                                        <i class="fab fa-google-drive me-2"></i>設定 Google Drive
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearBrowserCache()">
                                        <i class="fas fa-trash me-2"></i>清除瀏覽器快取
                                    </button>
                                </div>

                                <hr>

                                <h6>當前資料狀態：</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">專案資料</h6>
                                                <p class="card-text">
                                                    已載入專案: <span id="simpleProjectCount">-</span><br>
                                                    資料管理器狀態: <span id="simpleDataManagerStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">系統狀態</h6>
                                                <p class="card-text">
                                                    TeamDataManager: <span id="simpleTDMStatus">-</span><br>
                                                    TeamManagement: <span id="simpleTMStatus">-</span><br>
                                                    Google Drive: <span id="simpleGDStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // 移除舊的模態框
            const existingModal = document.getElementById('simpleTeamModal');
            if (existingModal) {
                existingModal.remove();
            }

            // 添加新的模態框
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // 更新狀態信息
            updateSimpleTeamModalStatus();

            // 顯示模態框
            const modal = new bootstrap.Modal(document.getElementById('simpleTeamModal'));
            modal.show();
        }

        function updateSimpleTeamModalStatus() {
            // 更新專案數量
            const projectCount = window.teamDataManager ?
                Object.keys(window.teamDataManager.getAllAssignments()).length :
                'N/A';
            document.getElementById('simpleProjectCount').textContent = projectCount;

            // 更新資料管理器狀態
            const dataManagerStatus = window.teamDataManager ?
                (window.teamDataManager.isInitialized ? '已初始化' : '未初始化') :
                '不存在';
            document.getElementById('simpleDataManagerStatus').textContent = dataManagerStatus;

            // 更新系統狀態
            document.getElementById('simpleTDMStatus').textContent =
                window.TeamDataManager ? '✅ 已載入' : '❌ 未載入';
            document.getElementById('simpleTMStatus').textContent =
                window.TeamManagement ? '✅ 已載入' : '❌ 未載入';

            // 更新 Google Drive 狀態
            const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
            const googleDriveStatus = googleDriveConfig ?
                (window.googleDriveAPI && window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn() ?
                    '✅ 已登入' : '⚠️ 已設定未登入') :
                '❌ 未設定';
            document.getElementById('simpleGDStatus').textContent = googleDriveStatus;
        }

        function clearBrowserCache() {
            if (confirm('這將清除瀏覽器快取並重新載入頁面。確定要繼續嗎？')) {
                // 清除 localStorage
                localStorage.clear();
                // 清除 sessionStorage（但保留認證狀態和 Google Drive 設定）
                const auth = sessionStorage.getItem('KEY_AUTHENTICATED');
                const loginTime = sessionStorage.getItem('LOGIN_TIME');
                const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
                sessionStorage.clear();
                if (auth) sessionStorage.setItem('KEY_AUTHENTICATED', auth);
                if (loginTime) sessionStorage.setItem('LOGIN_TIME', loginTime);
                if (googleDriveConfig) sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', googleDriveConfig);

                // 重新載入頁面，添加時間戳避免快取
                window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
            }
        }

        // 團隊管理功能
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            console.log('🎯 團隊管理按鈕被點擊');
            console.log('🔍 檢查相關物件存在狀態:');
            console.log('- window.teamManagement:', !!window.teamManagement);
            console.log('- window.TeamDataManager:', !!window.TeamDataManager);
            console.log('- window.TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- bootstrap.Modal:', !!window.bootstrap?.Modal);

            // 如果 teamManagement 不存在，嘗試創建備用實例
            if (!window.teamManagement) {
                console.log('⚠️ teamManagement 實例不存在，嘗試創建備用實例...');

                if (!window.TeamManagement) {
                    console.error('❌ TeamManagement 類別不存在，使用簡化版團隊管理');
                    // 創建簡化版團隊管理
                    showSimpleTeamManagement();
                    return;
                }

                try {
                    window.teamManagement = new window.TeamManagement();
                } catch (error) {
                    console.error('❌ 創建備用實例失敗:', error);
                    alert('無法創建團隊管理系統: ' + error.message);
                    return;
                }
            }

            console.log('✅ teamManagement 實例存在');
            console.log('- dataManager:', !!window.teamManagement.dataManager);
            console.log('- uiComponents:', !!window.teamManagement.uiComponents);

            try {
                // 檢查 dataManager 是否已初始化
                if (window.teamManagement.dataManager && !window.teamManagement.dataManager.isInitialized) {
                    console.log('⚠️ dataManager 未初始化，嘗試初始化...');
                    window.teamManagement.dataManager.init().then(() => {
                        window.teamManagement.openTeamManagementDashboard();
                    }).catch(error => {
                        console.error('❌ dataManager 初始化失敗:', error);
                        alert('資料管理器初始化失敗: ' + error.message);
                    });
                } else {
                    console.log('✅ dataManager 已準備，直接開啟團隊管理');
                    window.teamManagement.openTeamManagementDashboard();
                }
            } catch (error) {
                console.error('❌ 開啟團隊管理失敗:', error);
                console.error('錯誤堆疊:', error.stack);
                alert('開啟團隊管理失敗: ' + error.message);
            }
        });

        // 研發記錄簿功能
        document.getElementById('devLogBtn').addEventListener('click', function() {
            console.log('📋 研發記錄簿按鈕被點擊');
            window.location.href = 'dev-log.html';
        });

        // 啟動 Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('📋 DOMContentLoaded 觸發，檢查類別載入狀態:');
            console.log('- TeamDataManager:', !!window.TeamDataManager);
            console.log('- TeamStatistics:', !!window.TeamStatistics);
            console.log('- TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- TeamManagement:', !!window.TeamManagement);
            console.log('- teamManagement 實例:', !!window.teamManagement);

            // 檢查是否已通過私鑰驗證
            if (!checkAuthentication()) {
                // 未驗證禁止初始化 Dashboard
                return;
            }
            // 僅在已驗證時初始化 Dashboard
            try {

                // 初始化團隊資料管理器
                if (!window.teamDataManager) {
                    // 建立全域單例
                    if (!window.globalTeamDataManager) {
                        window.globalTeamDataManager = new TeamDataManager();
                        await window.globalTeamDataManager.init();
                    }
                    window.teamDataManager = window.globalTeamDataManager;
                }

                // 自動執行 Pull 操作（登入後自動同步最新資料）
                if (window.googleDriveAPI && window.googleDriveAPI.isAuthenticated) {
                    try {
                        await pullFilesFromGoogleDrive();

                        // 設定定時自動 Push（每5分鐘）
                        if (!window.autoPushInterval) {
                            window.autoPushInterval = setInterval(async () => {
                                try {
                                    if (window.teamDataManager) {
                                        await window.teamDataManager.saveLocalChanges();
                                    }
                                } catch (error) {
                                    console.warn('⚠️ 定時 Push 失敗:', error);
                                }
                            }, 5 * 60 * 1000); // 每5分鐘
                        }

                        // 當頁面即將關閉時，自動 Push
                        if (!window.beforeUnloadListener) {
                            window.beforeUnloadListener = true;
                            window.addEventListener('beforeunload', (event) => {
                                if (window.teamDataManager) {
                                    // 同步儲存（注意：beforeunload 中 async 可能不可靠）
                                    try {
                                        const data = JSON.stringify({
                                            assignments: window.teamDataManager.getAllAssignments(),
                                            constraints: {}
                                        });
                                        localStorage.setItem('pendingPush', data);
                                        console.log('💾 頁面關閉前已儲存待同步資料');
                                    } catch (e) {
                                        console.error('儲存失敗:', e);
                                    }
                                }
                            });
                        }

                        // 頁面載入時檢查是否有待同步的資料
                        const pendingPush = localStorage.getItem('pendingPush');
                        if (pendingPush) {
                            try {
                                const data = JSON.parse(pendingPush);
                                await window.googleDriveAPI.saveFile('project-assignments.json', data);
                                localStorage.removeItem('pendingPush');
                            } catch (e) {
                                console.error('同步待處理資料失敗:', e);
                            }
                        }

                    } catch (error) {
                        console.warn('⚠️ 自動同步失敗，使用本地資料:', error);
                    }
                } else {
                    console.log('ℹ️ Google Drive 未登入，使用本地資料');
                }

                // 立即初始化 Dashboard，讓它自己等待 teamDataManager
                if (typeof MarkdownProjectDashboard !== 'undefined') {
                    window.markdownDashboard = new MarkdownProjectDashboard();
                } else {
                    console.error('MarkdownProjectDashboard 類別未定義，等待載入...');
                    // 延遲重試
                    setTimeout(() => {
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        }
                    }, 500);
                }

                // 監聽團隊資料變更事件
                document.addEventListener('teamDataChanged', async (event) => {
                    console.log('🔄 收到團隊資料變更事件:', event.detail);
                    try {
                        if (typeof loadDataDirectly === 'function') {
                            await loadDataDirectly();
                            console.log('✅ 首頁資料已重新載入');
                        } else {
                            console.warn('⚠️ loadDataDirectly 函數不存在');
                        }
                    } catch (error) {
                        console.error('❌ 重新載入首頁資料失敗:', error);
                    }
                });

                // 監聽 localStorage 變更 (跨視窗通信)
                window.addEventListener('storage', async (event) => {
                    if (event.key === 'teamUpdateSignal' && event.newValue) {
                        try {
                            const signal = JSON.parse(event.newValue);
                            console.log('🔄 收到 localStorage 更新信號:', signal);

                            if (signal.action === 'teamDataUpdate') {
                                console.log('🔄 執行首頁資料重新載入...');
                                await window.loadDataDirectly();
                                console.log('✅ 首頁資料已通過 localStorage 重新載入');
                            }
                        } catch (error) {
                            console.error('❌ localStorage 更新信號處理失敗:', error);
                        }
                    }
                });

                // 監聽 localStorage 變更 (同視窗內的手動檢查)
                setInterval(() => {
                    try {
                        const signal = localStorage.getItem('teamUpdateSignal');
                        if (signal) {
                            const updateData = JSON.parse(signal);
                            const now = Date.now();
                            // 如果信號是最近1秒內的，執行更新
                            if (now - updateData.timestamp < 1000) {
                                console.log('🔄 檢測到更新信號，執行重新載入...');
                                window.loadDataDirectly();
                                localStorage.removeItem('teamUpdateSignal');
                            }
                        }
                    } catch (e) {
                        // 忽略解析錯誤
                    }
                }, 500);

            } catch (error) {
                console.error('Dashboard 初始化失敗:', error);
            }
        });
    </script>
</body>
</html>