<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任務編組系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="基於 Markdown 檔案的專案進度監控儀表板">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                任務編組系統
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">載入中...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="同步本地檔案到 Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="從 Google Drive 拉取最新資料到本地">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> 重新載入
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> 團隊管理
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> 登出
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- 私鑰驗證 -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>私鑰驗證
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">此 Dashboard 需要 Google Drive 設定和私鑰才能使用。請依序匯入：</p>

                    <!-- Google Drive 設定區域 -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive 設定 (JSON 格式)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "您的-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "YOUR_FOLDER_ID_HERE",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API 設定，僅在瀏覽器中使用</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. 匯入私鑰 (PEM 格式)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">私鑰僅在瀏覽器中使用，不會傳送到任何伺服器</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>驗證並進入
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>從檔案匯入
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">私鑰驗證失敗</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        私鑰驗證成功！正在載入 Dashboard...
                    </div>
                </div>
            </div>
        </div>


        <!-- 統計卡片 -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- 動態載入的統計內容會插入這裡 -->
        </div>

        <!-- 專案列表 -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- 動態載入的專案內容會插入這裡 -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // 嘗試載入 config.js (本地版本)，如果失敗則忽略 (線上版本)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('⚠️ config.js 未找到，將使用手動設定模式');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250918t"></script>
    <script src="js/team-data-manager.js?v=20250918u"></script>
    <script src="js/team-statistics.js?v=20250918u"></script>
    <script src="js/team-ui-components.js?v=20250920k"></script>
    <script src="js/team-management-main.js?v=20250920e"></script>
    <script src="js/markdown-dashboard-simple.js?v=20250920b"></script>
    <script>
        // 使用 TeamDataManager 載入資料
        async function loadDataDirectly() {
            console.log('🚀 使用 TeamDataManager 載入資料...');
            try {
                // 確保 TeamDataManager 存在
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager 未載入');
                }

                // 初始化 TeamDataManager
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                // 載入任務範本資料（如果還沒載入）
                if (!window.taskTemplatesData) {
                    try {
                        // 1. 優先從本地快取載入
                        const cachedTemplates = localStorage.getItem('cachedTaskTemplates');
                        if (cachedTemplates) {
                            window.taskTemplatesData = JSON.parse(cachedTemplates);
                            console.log('✅ 從快取載入任務範本:', Object.keys(window.taskTemplatesData.taskTemplates || {}));
                        } else {
                            // 2. 從本地檔案載入
                            const templateResponse = await fetch('config/task-templates.json?v=' + Date.now());
                            if (templateResponse.ok) {
                                window.taskTemplatesData = await templateResponse.json();
                                console.log('✅ 從本地檔案載入任務範本:', Object.keys(window.taskTemplatesData.taskTemplates || {}));
                                // 儲存到快取
                                localStorage.setItem('cachedTaskTemplates', JSON.stringify(window.taskTemplatesData));
                            }
                        }
                    } catch (templateError) {
                        console.warn('載入任務範本失敗:', templateError);
                        window.taskTemplatesData = { taskTemplates: {} };
                    }
                }

                // 從 TeamDataManager 獲取資料
                const assignments = teamDataManager.getAllAssignments();
                console.log('📊 從 TeamDataManager 載入的資料:', assignments);

                const summaryCards = document.getElementById('summaryCards');
                const projectsList = document.getElementById('projectsList');

                if (assignments && Object.keys(assignments).length > 0) {
                    const projects = Object.values(assignments);
                    console.log('✅ 專案數量:', projects.length);

                    // 顯示統計
                    if (summaryCards) {
                        summaryCards.innerHTML = `
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">總專案數</h5>
                                        <h2>${projects.length}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">進行中</h5>
                                        <h2>${projects.filter(p => p.status === 'active').length}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">總參與成員數</h5>
                                        <h2>${new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">平均進度</h5>
                                        <h2>${Math.round(projects.reduce((sum, p) => sum + p.progress, 0) / projects.length)}%</h2>
                                    </div>
                                </div>
                            </div>
                        `;
                        summaryCards.style.display = 'flex';
                    }

                    // 顯示專案列表
                    if (projectsList) {
                        console.log('📝 開始生成專案列表 HTML...');
                        let html = '';

                        projects.forEach(project => {
                            console.log('專案:', project.projectName);
                            const memberCount = Object.keys(project.members || {}).length;

                            // 生成成員列表
                            let membersHtml = '';
                            if (project.members && Object.keys(project.members).length > 0) {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">團隊成員(${memberCount}):</h6>
                                            <span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status === 'active' ? '進行中' : '已完成'}</span>
                                        </div>
                                `;
                                Object.values(project.members).forEach(member => {
                                    const memberNames = {
                                        'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                                        'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                                        'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                                        'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                                        'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                                        'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                                    };
                                    const memberName = memberNames[member.memberId] || member.memberId;
                                    const roleColors = {
                                        'frontend': '#007bff',
                                        'backend': '#28a745',
                                        'fullstack': '#ffc107',
                                        'testing': '#dc3545'
                                    };
                                    const roleColor = roleColors[member.role] || '#6c757d';

                                    // 根據組別設定背景色
                                    const memberGroup = member.memberId.split('-')[0]; // A, B, C
                                    const groupColors = {
                                        'A': '#e3f2fd', // 淺藍
                                        'B': '#e8f5e8', // 淺綠
                                        'C': '#fff3e0'  // 淺橙
                                    };
                                    const groupBgColor = groupColors[memberGroup] || '#f8f9fa';

                                    membersHtml += `
                                        <div class="d-flex justify-content-between align-items-center p-3 mb-2 border rounded"
                                             style="background-color: ${groupBgColor};">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <div class="d-flex flex-column me-3" style="min-width: 80px;">
                                                    <div class="fw-bold mb-1">${memberName}</div>
                                                    <small class="text-muted">${member.memberId}</small>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-end flex-grow-1 me-3">
                                                    <span class="badge px-3 py-2" style="background-color: ${roleColor}; font-size: 0.85em;">
                                                        ${member.role}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCard('${project.projectId}', '${member.memberId}')" title="編輯任務小卡">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="changeMember('${project.projectId}', '${member.memberId}')" title="變更成員">
                                                    <i class="fas fa-user-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                });
                                membersHtml += '</div>';
                            } else {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">團隊成員(0):</h6>
                                            <span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status === 'active' ? '進行中' : '已完成'}</span>
                                        </div>
                                        <small class="text-muted">尚未分配成員</small>
                                    </div>
                                `;
                            }

                            html += `
                                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                                    <div class="card mb-3" style="height: 420px;">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title text-truncate me-2" title="${project.projectName}">${project.projectName}</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="editProjectProgress('${project.projectId}')" title="調整進度">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar d-flex align-items-center justify-content-center" style="width: ${project.progress}%">
                                                    <span class="fw-bold">${project.progress}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                ${membersHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        console.log('🎨 設置專案列表 HTML...');
                        projectsList.innerHTML = html;
                        projectsList.style.display = 'flex';
                        console.log('✅ 專案列表設置完成並顯示');
                    }
                } else {
                    console.warn('⚠️ 資料格式不正確或沒有 assignments');
                }
            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">載入失敗: ' + error.message + '</div>';
            }
        }

        // 編輯專案成員任務小卡
        async function editProjectMember(projectId, memberId) {
            try {
                console.log('🔧 開始編輯任務小卡:', projectId, memberId);

                // 使用 TeamDataManager 載入專案資料
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager 未載入');
                }

                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`找不到專案: ${projectId}`);
                }

                const member = project.members[memberId];

                if (!member) {
                    alert('找不到成員資料');
                    return;
                }

                // 成員名稱映射
                const memberNames = {
                    'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                    'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                    'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                    'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                    'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                    'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                };
                const memberName = memberNames[memberId] || memberId;

                // 從 TeamDataManager 載入任務範本
                let taskTemplate = '';
                try {
                    // TeamDataManager 應該已經載入了任務範本資料
                    if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                        const template = window.taskTemplatesData.taskTemplates[member.role];
                        if (template) {
                            taskTemplate = template.content;
                        }
                    }
                } catch (templateError) {
                    console.warn('載入任務範本失敗:', templateError);
                }

                // 生成任務小卡內容（正確格式）
                const taskCardContent = `你現在的角色是「${project.projectName}」的「${member.role}」，代號是「${memberName}」，開發的branch 是「${memberName}」，若無則create，請依循下列的任務指引：\n\n${taskTemplate}`;

                // 直接編輯任務小卡（不再需要選擇模態框）
                editTaskCard(projectId, memberId);

            } catch (error) {
                console.error('編輯任務小卡失敗:', error);
                alert('編輯任務小卡失敗: ' + error.message);
            }
        }

        // 編輯任務小卡
        async function editTaskCard(projectId, memberId) {
            try {

                // 重新載入專案資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];
                const member = project.members[memberId];

                const memberNames = {
                    'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                    'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                    'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                    'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                    'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                    'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                };
                const memberName = memberNames[memberId] || memberId;

                // 獲取任務範本
                let taskTemplate = '';
                if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                    const template = window.taskTemplatesData.taskTemplates[member.role];
                    if (template) {
                        taskTemplate = template.content;
                    }
                }

                const taskCardContent = `你現在的角色是「${project.projectName}」的「${member.role}」，代號是「${memberName}」，開發的branch 是「${memberName}」，若無則create，請依循下列的任務指引：\n\n${taskTemplate}`;

                // 顯示任務小卡編輯模態框
                const taskModalHtml = `
                    <div class="modal fade" id="taskCardModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">任務小卡編輯 - ${memberName}，「${project.projectName}」專案的「${member.role}」</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="taskContent" class="form-label">任務小卡內容</label>
                                        <textarea class="form-control" id="taskContent" rows="20" style="min-height: 500px;">${taskCardContent}</textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="copyTaskCard()">
                                        <i class="fas fa-copy"></i> 複製
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldTaskModal = document.getElementById('taskCardModal');
                if (oldTaskModal) oldTaskModal.remove();
                document.body.insertAdjacentHTML('beforeend', taskModalHtml);

                const taskModal = new bootstrap.Modal(document.getElementById('taskCardModal'));
                taskModal.show();

            } catch (error) {
                console.error('編輯任務小卡失敗:', error);
                alert('編輯任務小卡失敗: ' + error.message);
            }
        }

        // 編輯專案進度
        async function editProjectProgress(projectId) {
            try {

                // 載入專案資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                // 設定當前專案資料供其他函數使用
                window.currentProject = project;
                window.currentProjectId = projectId;

                // 顯示進度編輯模態框
                const progressModalHtml = `
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">編輯專案進度 - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="projectProgress" class="form-label">專案進度 (%)</label>
                                        <input type="range" class="form-range" id="projectProgress" min="0" max="100" value="${project.progress}" oninput="updateProgressDisplay(this.value)">
                                        <div class="text-center">
                                            <span id="progressDisplay" class="badge bg-primary">${project.progress}%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectNotes" class="form-label">專案備註</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newNote" rows="3" placeholder="輸入新的備註..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addNote()">
                                                <i class="fas fa-plus"></i> 新增備註
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllNotes()">
                                                <i class="fas fa-trash"></i> 清除所有備註
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="notesList">
                                                ${formatNotes(project.notes || '')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveProjectProgress('${projectId}')">
                                        <i class="fas fa-save"></i> 儲存
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldProgressModal = document.getElementById('progressModal');
                if (oldProgressModal) oldProgressModal.remove();
                document.body.insertAdjacentHTML('beforeend', progressModalHtml);

                const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();

            } catch (error) {
                console.error('編輯專案進度失敗:', error);
                alert('編輯專案進度失敗: ' + error.message);
            }
        }

        // 更新進度顯示
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
        }

        // 格式化備註顯示
        function formatNotes(notes) {
            if (!notes) return '<p class="text-muted m-0">尚無備註</p>';

            try {
                const notesList = JSON.parse(notes);
                if (Array.isArray(notesList) && notesList.length > 0) {
                    return notesList.map(note =>
                        `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                            <div class="fw-bold small text-muted">${note.timestamp}</div>
                            <div>${note.content}</div>
                        </div>`
                    ).join('');
                }
            } catch (e) {
                // 如果不是 JSON 格式，當作舊格式的純文字
                if (notes.trim()) {
                    return `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                <div class="fw-bold small text-muted">舊備註</div>
                                <div>${notes}</div>
                            </div>`;
                }
            }
            return '<p class="text-muted m-0">尚無備註</p>';
        }

        // 新增備註
        async function addNote() {
            const newNoteInput = document.getElementById('newNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('請輸入備註內容');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent
            };

            // 獲取現有備註
            let existingNotes = [];
            try {
                const currentProject = getCurrentProject();
                if (currentProject && currentProject.notes) {
                    existingNotes = JSON.parse(currentProject.notes);
                }
            } catch (e) {
                // 如果解析失敗，建立新陣列
                existingNotes = [];
            }

            if (!Array.isArray(existingNotes)) {
                existingNotes = [];
            }

            // 新增到陣列開頭（最新的在上面）
            existingNotes.unshift(newNote);

            // 立即儲存到 TeamDataManager
            try {
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[window.currentProjectId]) {
                    assignments[window.currentProjectId].notes = JSON.stringify(existingNotes);
                    assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    // 更新當前專案資料
                    window.currentProject.notes = JSON.stringify(existingNotes);
                }
            } catch (error) {
                console.error('儲存備註失敗:', error);
                alert('儲存備註失敗: ' + error.message);
                return;
            }

            // 更新顯示
            updateNotesDisplay(existingNotes);

            // 清空輸入框
            newNoteInput.value = '';
        }

        // 清除所有備註
        async function clearAllNotes() {
            if (confirm('確定要清除所有備註嗎？此操作無法復原。')) {
                try {
                    // 立即儲存到 TeamDataManager
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();

                    if (assignments[window.currentProjectId]) {
                        assignments[window.currentProjectId].notes = JSON.stringify([]);
                        assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // 儲存變更
                        await teamDataManager.saveLocalChanges();

                        // 更新當前專案資料
                        window.currentProject.notes = JSON.stringify([]);
                    }

                    // 更新顯示
                    updateNotesDisplay([]);
                } catch (error) {
                    console.error('清除備註失敗:', error);
                    alert('清除備註失敗: ' + error.message);
                }
            }
        }

        // 更新備註顯示
        function updateNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('notesList');
            if (notesList.length === 0) {
                notesListDiv.innerHTML = '<p class="text-muted m-0">尚無備註</p>';
            } else {
                notesListDiv.innerHTML = notesList.map(note =>
                    `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <div>${note.content}</div>
                    </div>`
                ).join('');
            }
        }

        // 獲取當前專案（輔助函數）
        function getCurrentProject() {
            // 這個函數需要在模態框開啟時設定當前專案資料
            return window.currentProject || null;
        }

        // 儲存專案進度
        async function saveProjectProgress(projectId) {
            try {
                const progress = parseInt(document.getElementById('projectProgress').value);

                // 獲取當前備註列表
                const notesListDiv = document.getElementById('notesList');
                let notesList = [];

                // 從顯示的備註中提取資料
                const noteElements = notesListDiv.querySelectorAll('.border-start');
                noteElements.forEach(element => {
                    const timestamp = element.querySelector('.text-muted').textContent;
                    const content = element.querySelector('div:last-child').textContent;
                    if (timestamp !== '尚無備註') {
                        notesList.push({ timestamp, content });
                    }
                });

                // 使用 TeamDataManager 更新資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                // 更新專案進度和備註
                if (assignments[projectId]) {
                    assignments[projectId].progress = progress;
                    assignments[projectId].notes = JSON.stringify(notesList);
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                    // 儲存變更
                    await teamDataManager.saveLocalChanges();

                    alert(`專案進度已更新為 ${progress}%\n備註已儲存 (共 ${notesList.length} 筆)`);
                } else {
                    throw new Error('找不到指定的專案');
                }

                // 關閉模態框
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) progressModal.hide();

                // 重新載入頁面資料
                setTimeout(() => {
                    loadDataDirectly();
                }, 500);

            } catch (error) {
                console.error('儲存專案進度失敗:', error);
                alert('儲存專案進度失敗: ' + error.message);
            }
        }

        // 變更成員
        async function changeMember(projectId, memberId) {
            try {

                // 載入團隊成員資料
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const members = teamDataManager.getAllMembers();
                const project = assignments[projectId];
                const currentMember = project.members[memberId];

                // 生成可用成員選項
                let memberOptions = '';
                Object.values(members).forEach(member => {
                    const selected = member.id === memberId ? 'selected' : '';
                    memberOptions += `<option value="${member.id}" ${selected}>${member.name} (${member.id})</option>`;
                });

                // 顯示成員變更模態框
                const memberModalHtml = `
                    <div class="modal fade" id="memberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">變更成員 - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newMember" class="form-label">選擇新成員</label>
                                        <select class="form-select" id="newMember">
                                            ${memberOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberRole" class="form-label">角色</label>
                                        <select class="form-select" id="memberRole">
                                            <option value="frontend" ${currentMember.role === 'frontend' ? 'selected' : ''}>前端開發</option>
                                            <option value="backend" ${currentMember.role === 'backend' ? 'selected' : ''}>後端開發</option>
                                            <option value="fullstack" ${currentMember.role === 'fullstack' ? 'selected' : ''}>全端開發</option>
                                            <option value="testing" ${currentMember.role === 'testing' ? 'selected' : ''}>測試部署</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveMemberChange('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> 儲存變更
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberModal = document.getElementById('memberModal');
                if (oldMemberModal) oldMemberModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberModalHtml);

                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();

            } catch (error) {
                console.error('變更成員失敗:', error);
                alert('變更成員失敗: ' + error.message);
            }
        }

        // 儲存成員變更
        async function saveMemberChange(projectId, oldMemberId) {
            try {
                const newMemberId = document.getElementById('newMember').value;
                const newRole = document.getElementById('memberRole').value;

                // 這裡應該要呼叫 TeamDataManager 的方法來儲存變更
                // 暫時先顯示成功訊息
                alert(`成員已從 ${oldMemberId} 變更為 ${newMemberId}\n角色: ${newRole}`);

                // 關閉模態框
                const memberModal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                if (memberModal) memberModal.hide();

                // 重新載入頁面資料
                loadDataDirectly();

            } catch (error) {
                console.error('儲存成員變更失敗:', error);
                alert('儲存成員變更失敗: ' + error.message);
            }
        }

        // 複製任務小卡內容
        function copyTaskCard() {
            try {
                const taskContent = document.getElementById('taskContent').value;
                const textToCopy = taskContent;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // 視覺回饋
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> 已複製';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-info');

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-info');
                        button.classList.add('btn-success');
                    }, 2000);
                }).catch(err => {
                    console.error('複製失敗:', err);
                    alert('複製失敗，請手動複製內容');
                });
            } catch (error) {
                console.error('複製任務小卡失敗:', error);
                alert('複製失敗，請手動複製內容');
            }
        }

        // 頁面載入時直接執行（延遲一下等認證通過）
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // 只有在認證通過後才載入
                const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
                if (isAuthenticated) {
                    loadDataDirectly();
                }
            }, 1000);
        });

        // 嚴格的認證檢查 - 無繞過機制
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // 確保未認證時完全隱藏所有資料
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner 已移除
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // 禁止初始化 Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // 如果已認證，顯示登出按鈕
            showMainDashboard();
            // 檢查 session 是否過期
            checkSessionTimeout();
            return true;
        }
        
        // 私鑰驗證功能
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // 驗證 Google Drive 設定
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = '請輸入 Google Drive 設定';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('設定格式不完整');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive 設定格式錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = '請輸入私鑰';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>驗證中...';
            
            try {
                // 使用 Web Crypto API 驗證私鑰
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // 儲存 Google Drive 設定到 sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // 設定登入狀態和時間戳
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();

                        // 直接載入資料
                        loadDataDirectly();

                        // 啟動新的 Markdown Dashboard
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        } else {
                            console.error('MarkdownProjectDashboard 類別未定義');
                        }
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = '私鑰驗證失敗，請確認私鑰正確';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `驗證錯誤：${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>驗證並進入';
            }
        });
        
        // 從檔案匯入私鑰
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // 顯示主 Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';

            // 直接載入資料
            setTimeout(loadDataDirectly, 500);
        }
        
        // 登出功能
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('確定要登出嗎？登出後需要重新匯入私鑰。')) {
                // 清除認證狀態
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // 隱藏登出按鈕和團隊管理按鈕
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';

                // 顯示認證介面
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner 已移除
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // 清空私鑰輸入欄
                document.getElementById('privateKeyInput').value = '';
                
                // 隱藏成功/錯誤訊息
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('用戶已登出，需要重新認證');
            }
        });
        
        // 檢查 Session 超時（30分鐘）
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            
            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30分鐘
                
                if (sessionAge > timeout) {
                    alert('會話已過期，請重新登入');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // 每分鐘檢查一次 session
        setInterval(checkSessionTimeout, 60000);

        // 重新載入功能
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });

        // Push 功能 (上傳到雲端)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // 更新按鈕狀態
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API 未載入');
                }

                if (!window.googleDriveAPI.isAuthenticated) {
                    console.log('🔐 Google Drive 未登入，開始自動登入流程...');
                    // 自動觸發登入
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
                    showSyncToast('需要登入', '正在開啟 Google Drive 登入...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        console.log('🔐 登入結果:', loginSuccess);
                        if (!loginSuccess) {
                            throw new Error('Google Drive 登入失敗或被取消');
                        }
                        console.log('✅ Google Drive 登入成功，繼續推送操作');
                        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 上傳中...';
                    } catch (loginError) {
                        console.error('❌ 登入過程發生錯誤:', loginError);
                        throw new Error('Google Drive 登入失敗: ' + loginError.message);
                    }
                }

                await pushLocalFilesToGoogleDrive();

                // 成功訊息
                showSyncToast('推送成功', '本地檔案已推送到 Google Drive', 'success');

            } catch (error) {
                console.error('同步失敗:', error);
                showSyncToast('同步失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull 功能 (從雲端下載)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // 更新按鈕狀態
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下載中...';

                // 檢查 Google Drive 連線
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API 未載入');
                }

                if (!window.googleDriveAPI.isAuthenticated) {
                    console.log('🔐 Google Drive 未登入，開始自動登入流程...');
                    // 自動觸發登入
                    pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登入中...';
                    showSyncToast('需要登入', '正在開啟 Google Drive 登入...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        console.log('🔐 登入結果:', loginSuccess);
                        if (!loginSuccess) {
                            throw new Error('Google Drive 登入失敗或被取消');
                        }
                        console.log('✅ Google Drive 登入成功，繼續拉取操作');
                        pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 下載中...';
                    } catch (loginError) {
                        console.error('❌ 登入過程發生錯誤:', loginError);
                        throw new Error('Google Drive 登入失敗: ' + loginError.message);
                    }
                }

                await pullFilesFromGoogleDrive();

                // 清除記憶體中的資料以強制重新載入
                window.taskTemplatesData = null;

                // 成功訊息
                showSyncToast('拉取成功', '已從 Google Drive 拉取最新資料', 'success');

                // 建議重新載入頁面
                setTimeout(() => {
                    if (confirm('資料已更新，是否重新載入頁面以顯示最新內容？')) {
                        location.reload();
                    }
                }, 1000);

            } catch (error) {
                console.error('拉取失敗:', error);
                showSyncToast('拉取失敗', error.message, 'error');
            } finally {
                // 恢復按鈕狀態
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // 推送本地檔案到 Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json',
                'config/task-templates.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    console.log(`🔄 同步檔案: ${filePath}`);
                    const fileName = filePath.split('/').pop();
                    let fileContent;

                    // 根據檔案類型選擇資料來源
                    if (fileName === 'team-members.json') {
                        // 使用 TeamDataManager 中的資料
                        const teamDataManager = new window.TeamDataManager();
                        await teamDataManager.init();
                        const teamConfig = teamDataManager.teamConfig;
                        fileContent = JSON.stringify(teamConfig, null, 2);
                    } else if (fileName === 'project-assignments.json') {
                        // 使用 TeamDataManager 中的分配資料
                        const teamDataManager = new window.TeamDataManager();
                        await teamDataManager.init();
                        const assignments = teamDataManager.getAllAssignments();
                        const constraints = teamDataManager.constraints;
                        const assignmentData = {
                            assignments: assignments,
                            constraints: constraints,
                            statistics: {
                                totalAssignments: Object.values(assignments).reduce((sum, project) => sum + Object.keys(project.members || {}).length, 0),
                                activeProjects: Object.values(assignments).filter(p => p.status === 'active').length,
                                completedProjects: Object.values(assignments).filter(p => p.status === 'completed').length,
                                membersInUse: new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size,
                                availableMembers: Object.keys(teamDataManager.getAllMembers()).length - new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size
                            }
                        };
                        fileContent = JSON.stringify(assignmentData, null, 2);
                    } else if (fileName === 'task-templates.json') {
                        // 使用記憶體中的任務範本資料
                        if (window.taskTemplatesData) {
                            fileContent = JSON.stringify(window.taskTemplatesData, null, 2);
                        } else {
                            // 如果記憶體中沒有，讀取本地檔案
                            const response = await fetch(filePath + '?v=' + Date.now());
                            if (!response.ok) {
                                throw new Error(`無法讀取 ${filePath}: ${response.statusText}`);
                            }
                            fileContent = await response.text();
                        }
                    } else {
                        // 其他檔案直接讀取本地檔案
                        const response = await fetch(filePath + '?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`無法讀取 ${filePath}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    }

                    // 上傳到 Google Drive
                    await window.googleDriveAPI.saveFile(fileName, fileContent);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: '同步成功'
                    });

                    console.log(`✅ ${fileName} 同步完成`);

                } catch (error) {
                    console.error(`❌ ${filePath} 同步失敗:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 同步專案狀態檔案 (如果存在)
            await syncProjectStatusFiles();

            // 記錄同步結果
            logSyncResults(syncResults);

            return syncResults;
        }

        // 從 Google Drive 拉取檔案到本地
        async function pullFilesFromGoogleDrive() {
            const filesToPull = [
                'team-members.json',
                'project-assignments.json',
                'task-templates.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {
                    console.log(`🔄 從 Google Drive 拉取檔案: ${fileName}`);

                    // 從 Google Drive 下載檔案
                    const wrappedContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!wrappedContent) {
                        throw new Error(`Google Drive 中找不到 ${fileName}`);
                    }

                    // 提取實際資料
                    let actualData = wrappedContent.data || wrappedContent;

                    // 如果 data 是字串，需要解析成物件
                    if (typeof actualData === 'string') {
                        try {
                            actualData = JSON.parse(actualData);
                        } catch (parseError) {
                            throw new Error(`${fileName} JSON 解析失敗: ${parseError.message}`);
                        }
                    }

                    // 驗證資料格式
                    if (!actualData || typeof actualData !== 'object') {
                        throw new Error(`${fileName} 資料格式錯誤`);
                    }

                    // 儲存到 localStorage（模擬下載到本地）
                    let storageKey;
                    if (fileName === 'team-members.json') {
                        storageKey = 'cachedTeamMembers';
                    } else if (fileName === 'project-assignments.json') {
                        storageKey = 'cachedProjectAssignments';
                    } else if (fileName === 'task-templates.json') {
                        storageKey = 'cachedTaskTemplates';
                    }

                    if (storageKey) {
                        localStorage.setItem(storageKey, JSON.stringify(actualData));
                    }

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: '拉取成功'
                    });

                    console.log(`✅ ${fileName} 拉取完成`);

                } catch (error) {
                    console.error(`❌ ${fileName} 拉取失敗:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // 記錄拉取結果
            logPullResults(pullResults);

            return pullResults;
        }

        // 同步專案狀態檔案
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // 這裡可以讀取 project-status 資料夾中的檔案
                    // 由於瀏覽器安全限制，我們先記錄到 localStorage
                    console.log(`📊 檢查專案 ${project} 狀態檔案`);
                } catch (error) {
                    console.log(`⚠️ 專案 ${project} 無狀態檔案`);
                }
            }
        }

        // 顯示同步通知
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>剛才</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // 創建 toast 容器 (如果不存在)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // 添加並顯示 toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // 記錄推送結果
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('📝 推送記錄已保存:', syncLog);
        }

        // 記錄拉取結果
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // 儲存到 localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // 只保留最近 50 次記錄
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('📝 拉取記錄已保存:', pullLog);
        }

        // 團隊管理功能
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            if (window.teamManagement) {
                window.teamManagement.openTeamManagementDashboard();
            }
        });

        // 啟動 Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // 檢查是否已通過私鑰驗證
            if (!checkAuthentication()) {
                // 未驗證禁止初始化 Dashboard
                return;
            }
            // 僅在已驗證時初始化 Dashboard
            try {
                console.log('開始初始化 Markdown Dashboard...');

                // 初始化團隊資料管理器
                if (!window.teamDataManager) {
                    console.log('🔄 創建團隊資料管理器...');
                    window.teamDataManager = new TeamDataManager();

                    // 非阻塞式初始化，讓 Dashboard 自己等待
                    window.teamDataManager.init().then(() => {
                        console.log('✅ 團隊資料管理器初始化完成');
                    }).catch(error => {
                        console.log('⚠️ 團隊資料管理器初始化失敗 (可能未登入 Google Drive):', error.message);
                        // 確保標記為未初始化
                        window.teamDataManager.isInitialized = false;
                    });
                }

                // 立即初始化 Dashboard，讓它自己等待 teamDataManager
                console.log('🔄 創建 Markdown Dashboard...');
                if (typeof MarkdownProjectDashboard !== 'undefined') {
                    window.markdownDashboard = new MarkdownProjectDashboard();
                } else {
                    console.error('MarkdownProjectDashboard 類別未定義，等待載入...');
                    // 延遲重試
                    setTimeout(() => {
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Dashboard 初始化失敗:', error);
            }
        });
    </script>
</body>
</html>