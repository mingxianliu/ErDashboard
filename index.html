<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªªÂãôÁ∑®ÁµÑÁ≥ªÁµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="Âü∫Êñº Markdown Ê™îÊ°àÁöÑÂ∞àÊ°àÈÄ≤Â∫¶Áõ£ÊéßÂÑÄË°®Êùø">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                ‰ªªÂãôÁ∑®ÁµÑÁ≥ªÁµ±
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">ËºâÂÖ•‰∏≠...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="ÂêåÊ≠•Êú¨Âú∞Ê™îÊ°àÂà∞ Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="Âæû Google Drive ÊãâÂèñÊúÄÊñ∞Ë≥áÊñôÂà∞Êú¨Âú∞">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-warning btn-sm me-2" id="syncRoleNotesBtn" style="display: none;" title="ÊâãÂãïÂêåÊ≠•ËßíËâ≤ÂÇôË®ª">
                    <i class="fas fa-comment-dots"></i> ÂêåÊ≠•ÂÇôË®ª
                </button>
                <button class="btn btn-danger btn-sm me-2" id="fixRolesBtn" style="display: none;" title="‰øÆÂæ©ËßíËâ≤Ë≥áÊñô">
                    <i class="fas fa-tools"></i> ‰øÆÂæ©ËßíËâ≤
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> ÈáçÊñ∞ËºâÂÖ•
                </button>
                <button class="btn btn-secondary btn-sm me-2" id="gdriveSetupBtn" title="Ë®≠ÂÆö Google Drive Êï¥Âêà">
                    <i class="fab fa-google-drive"></i> Èõ≤Á´ØË®≠ÂÆö
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> ÂúòÈöäÁÆ°ÁêÜ
                </button>
                <button class="btn btn-info btn-sm me-2" id="devLogBtn" style="display: none;" title="Á†îÁôºË®òÈåÑÁ∞ø">
                    <i class="fas fa-clipboard-list"></i> Á†îÁôºË®òÈåÑÁ∞ø
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> ÁôªÂá∫
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- ÁßÅÈë∞È©óË≠â -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>ÁßÅÈë∞È©óË≠â
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Ê≠§ Dashboard ÈúÄË¶Å Google Drive Ë®≠ÂÆöÂíåÁßÅÈë∞ÊâçËÉΩ‰ΩøÁî®„ÄÇË´ã‰æùÂ∫èÂåØÂÖ•Ôºö</p>

                    <!-- Google Drive Ë®≠ÂÆöÂçÄÂüü -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive Ë®≠ÂÆö (JSON Ê†ºÂºè)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "ÊÇ®ÁöÑ-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "ÊÇ®ÁöÑ-google-drive-Ë≥áÊñôÂ§æ-id",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API Ë®≠ÂÆöÔºåÂÉÖÂú®ÁÄèË¶ΩÂô®‰∏≠‰ΩøÁî®</small>
                        <div class="mt-2">
                            <a href="setup-gdrive.html" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-google-drive me-1"></i>‰ΩøÁî®ÂúñÂΩ¢ÂåñË®≠ÂÆöÁïåÈù¢
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. ÂåØÂÖ•ÁßÅÈë∞ (PEM Ê†ºÂºè)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">ÁßÅÈë∞ÂÉÖÂú®ÁÄèË¶ΩÂô®‰∏≠‰ΩøÁî®Ôºå‰∏çÊúÉÂÇ≥ÈÄÅÂà∞‰ªª‰Ωï‰º∫ÊúçÂô®</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>È©óË≠â‰∏¶ÈÄ≤ÂÖ•
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>ÂæûÊ™îÊ°àÂåØÂÖ•
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">ÁßÅÈë∞È©óË≠âÂ§±Êïó</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        ÁßÅÈë∞È©óË≠âÊàêÂäüÔºÅÊ≠£Âú®ËºâÂÖ• Dashboard...
                    </div>
                </div>
            </div>
        </div>


        <!-- Áµ±Ë®àÂç°Áâá -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- ÂãïÊÖãËºâÂÖ•ÁöÑÁµ±Ë®àÂÖßÂÆπÊúÉÊèíÂÖ•ÈÄôË£° -->
        </div>

        <!-- Â∞àÊ°àÂàóË°® -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- ÂãïÊÖãËºâÂÖ•ÁöÑÂ∞àÊ°àÂÖßÂÆπÊúÉÊèíÂÖ•ÈÄôË£° -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // ÂòóË©¶ËºâÂÖ• config.js (Êú¨Âú∞ÁâàÊú¨)ÔºåÂ¶ÇÊûúÂ§±ÊïóÂâáÂøΩÁï• (Á∑ö‰∏äÁâàÊú¨)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('‚ö†Ô∏è config.js Êú™ÊâæÂà∞ÔºåÂ∞á‰ΩøÁî®ÊâãÂãïË®≠ÂÆöÊ®°Âºè');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250923b-1758618068"></script>
    <script src="js/team-data-manager.js?v=20250923d-1758618068" onerror="console.error('‚ùå ËºâÂÖ• team-data-manager.js Â§±Êïó')"></script>
    <script src="js/team-statistics.js?v=20250918u" onerror="console.error('‚ùå ËºâÂÖ• team-statistics.js Â§±Êïó')"></script>
    <script src="js/team-ui-components.js?v=20250920k" onerror="console.error('‚ùå ËºâÂÖ• team-ui-components.js Â§±Êïó')"></script>
    <script src="js/team-management-main.js?v=20250920e" onerror="console.error('‚ùå ËºâÂÖ• team-management-main.js Â§±Êïó')"></script>
    <script src="js/dev-log.js?v=20250923a" onerror="console.error('‚ùå ËºâÂÖ• dev-log.js Â§±Êïó')"></script>
    <script src="js/markdown-dashboard-simple.js?v=20250920b"></script>
    <script>
        // ‰ΩøÁî® TeamDataManager ËºâÂÖ•Ë≥áÊñô
        // Ë®≠ÁÇ∫ÂÖ®ÂüüÂáΩÊï∏‰ª•‰æøÂÖ∂‰ªñË¶ñÁ™óÂèØ‰ª•ÂëºÂè´
        window.loadDataDirectly = async function loadDataDirectly() {
            try {
                // Á≠âÂæÖ Google Drive API Ê∫ñÂÇôÂ•Ω
                if (window.googleDriveAPI) {
                    let waitCount = 0;
                    while (!window.googleDriveAPI.isReady() && waitCount < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        waitCount++;
                    }

                    // Ê™¢Êü•‰∏¶ÂòóË©¶ Google Drive Ëá™ÂãïÁôªÂÖ•
                    if (window.googleDriveAPI.isReady() && !window.googleDriveAPI.isSignedIn()) {
                        try {
                            const loginSuccess = await window.googleDriveAPI.signIn();
                            if (loginSuccess) {
                            } else {
                            }
                        } catch (loginError) {
                            console.log('‚ùå Google Drive Ëá™ÂãïÁôªÂÖ•ÈåØË™§:', loginError);
                        }
                    } else if (!window.googleDriveAPI.isReady()) {
                    }
                }

                // Á¢∫‰øù TeamDataManager Â≠òÂú®
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager Êú™ËºâÂÖ•');
                }

                // ‰ΩøÁî®ÊàñÂâµÂª∫ÂÖ®Âüü TeamDataManager
                let teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;
                } else {
                    // Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅÈáçÊñ∞ÂàùÂßãÂåñÔºàÈÅøÂÖçË¶ÜËìãÂâõÂêåÊ≠•ÁöÑË≥áÊñôÔºâ
                    if (!teamDataManager.isReady()) {
                        await teamDataManager.init();
                    } else {
                    }
                }

                // ËºâÂÖ•‰ªªÂãôÁØÑÊú¨Ë≥áÊñôÔºàÂ¶ÇÊûúÈÇÑÊ≤íËºâÂÖ•Ôºâ
                if (!window.taskTemplatesData) {
                    try {
                        // 1. ÂÑ™ÂÖàÂæûÊú¨Âú∞Âø´ÂèñËºâÂÖ•
                        const cachedTemplates = localStorage.getItem('cachedTaskTemplates');
                        if (cachedTemplates) {
                            window.taskTemplatesData = JSON.parse(cachedTemplates);
                        } else {
                            // 2. ÂæûÊú¨Âú∞Ê™îÊ°àËºâÂÖ•
                            const templateResponse = await fetch('config/task-templates.json?v=' + Date.now());
                            if (templateResponse.ok) {
                                window.taskTemplatesData = await templateResponse.json();
                                // ÂÑ≤Â≠òÂà∞Âø´Âèñ
                                localStorage.setItem('cachedTaskTemplates', JSON.stringify(window.taskTemplatesData));
                            }
                        }
                    } catch (templateError) {
                        console.warn('ËºâÂÖ•‰ªªÂãôÁØÑÊú¨Â§±Êïó:', templateError);
                        window.taskTemplatesData = { taskTemplates: {} };
                    }
                }

                // Âæû TeamDataManager Áç≤ÂèñË≥áÊñô
                let assignments = teamDataManager.getAllAssignments();

                // Â¶ÇÊûú teamDataManager Ê≤íÊúâË≥áÊñôÔºåÂòóË©¶Âæû localStorage Êàñ config ËºâÂÖ•
                if (!assignments || Object.keys(assignments).length === 0) {
                    console.log('üîÑ teamDataManager Ë≥áÊñôÁÇ∫Á©∫ÔºåÂòóË©¶ÂÖ∂‰ªñË≥áÊñô‰æÜÊ∫ê...');

                    // ÂòóË©¶Âæû localStorage
                    const localData = localStorage.getItem('project-assignments');
                    if (localData) {
                        try {
                            const parsed = JSON.parse(localData);
                            if (parsed.assignments) {
                                assignments = parsed.assignments;
                                console.log('‚úÖ Âæû localStorage ËºâÂÖ•Ë≥áÊñô');
                            }
                        } catch (e) {
                            console.error('‚ùå localStorage Ë≥áÊñôËß£ÊûêÂ§±Êïó:', e);
                        }
                    }

                    // Â¶ÇÊûúÈÇÑÊòØÊ≤íÊúâË≥áÊñôÔºåÂòóË©¶Âæû config ËºâÂÖ•
                    if (!assignments || Object.keys(assignments).length === 0) {
                        try {
                            const response = await fetch('config/project-assignments.json');
                            if (response.ok) {
                                const data = await response.json();
                                if (data.assignments) {
                                    assignments = data.assignments;
                                    console.log('‚úÖ Âæû config Ê™îÊ°àËºâÂÖ•Ë≥áÊñô');
                                }
                            }
                        } catch (e) {
                            console.error('‚ùå config Ê™îÊ°àËºâÂÖ•Â§±Êïó:', e);
                        }
                    }
                }

                // Â¶ÇÊûúÊ≤íÊúâË≥áÊñôÔºå‰ΩøÁî®Á©∫Áâ©‰ª∂
                if (!assignments) {
                    assignments = {};
                }

                // Á¢∫‰øùÊâÄÊúâÊàêÂì°ÈÉΩÊúâÂøÖË¶ÅÁöÑÊ¨Ñ‰Ωç
                Object.values(assignments).forEach(project => {
                    if (project.members) {
                        Object.values(project.members).forEach(member => {
                            if (member.isExecuting === undefined || member.isExecuting === null) {
                                member.isExecuting = false; // È†êË®≠ÁÇ∫Êú™Âü∑Ë°å
                            }
                            if (!member.personalNotes) {
                                member.personalNotes = []; // ÂàùÂßãÂåñÂÄã‰∫∫ÂÇôË®ªÈô£Âàó
                            }
                        });
                    }
                });

                // ÂâçÁ´ØÊ∏≤ÊüìË≥áÊñôÂ∑≤Ê∫ñÂÇôÂÆåÊàê

                const summaryCards = document.getElementById('summaryCards');
                const projectsList = document.getElementById('projectsList');

                if (assignments && Object.keys(assignments).length > 0) {
                    const projects = Object.keys(assignments).map(projectId => ({
                        ...assignments[projectId],
                        projectId: projectId
                    }));

                    // È°ØÁ§∫Áµ±Ë®à
                    if (summaryCards) {
                        summaryCards.innerHTML = `
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.length}</div>
                                                <div>Á∏ΩÂ∞àÊ°àÊï∏</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-project-diagram"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.filter(p => p.status === 'active').length}</div>
                                                <div>ÈÄ≤Ë°å‰∏≠Â∞àÊ°à</div>
                                                <small class="text-white-50">Êö´ÂÅú: <span class="badge bg-warning text-dark">${projects.filter(p => p.status === 'paused').length}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-rocket"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-info text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size}</div>
                                                <div>Á∏ΩÊàêÂì°Êï∏</div>
                                                <small class="text-white-50">Âü∑Ë°å‰∏≠: <span id="executingCount" class="badge bg-success">${Object.values(assignments).reduce((sum, p) => sum + Object.values(p.members || {}).filter(m => m.isExecuting === true).length, 0)}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-users"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-warning text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${Math.round(projects.reduce((sum, p) => sum + p.progress, 0) / projects.length)}%</div>
                                                <div>Âπ≥ÂùáÈÄ≤Â∫¶</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        summaryCards.style.display = 'flex';
                    }

                    // È°ØÁ§∫Â∞àÊ°àÂàóË°®
                    if (projectsList) {
                        let html = '';

                        projects.forEach(project => {
                            const memberCount = Object.keys(project.members || {}).length;

                            // ÁîüÊàêÊàêÂì°ÂàóË°®
                            let membersHtml = '';
                            if (project.members && Object.keys(project.members).length > 0) {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">ÂúòÈöäÊàêÂì°(${memberCount}):</h6>
                                            <span class="badge bg-${
                                                project.status === 'active' ? 'success' :
                                                project.status === 'paused' ? 'warning' :
                                                project.status === 'completed' ? 'secondary' : 'info'
                                            }">${
                                                project.status === 'active' ? 'ÈÄ≤Ë°å‰∏≠' :
                                                project.status === 'paused' ? 'Êö´ÂÅú' :
                                                project.status === 'completed' ? 'Â∑≤ÂÆåÊàê' :
                                                project.status || 'Êú™Áü•ÁãÄÊÖã'
                                            }</span>
                                        </div>
                                `;
                                Object.values(project.members).forEach(member => {
                                    // ÂæûÂØ¶ÈöõÊàêÂì°Ë≥áÊñôÂèñÂæóÂêçÁ®±
                                    const allMembers = teamDataManager.getAllMembers() || {};
                                    const memberName = allMembers[member.memberId]?.name || member.memberId;
                                    const roleColors = {
                                        'frontend': '#007bff',
                                        'backend': '#28a745',
                                        'fullstack': '#ffc107',
                                        'testing': '#dc3545',
                                        'ÂâçÁ´Ø': '#007bff',
                                        'ÂæåÁ´Ø': '#28a745',
                                        'ÂÖ®Á´Ø': '#ffc107',
                                        'Ê∏¨Ë©¶': '#dc3545'
                                    };
                                    const roleColor = roleColors[member.role] || '#6c757d';

                                    // ËßíËâ≤ÊñáÂ≠óËΩâÊèõ
                                    const roleTranslation = {
                                        'frontend': 'ÂâçÁ´Ø',
                                        'backend': 'ÂæåÁ´Ø',
                                        'fullstack': 'ÂÖ®Á´Ø',
                                        'testing': 'Ê∏¨Ë©¶'
                                    };
                                    const displayRole = roleTranslation[member.role] || member.role;

                                    // Ê†πÊìöÁµÑÂà•Ë®≠ÂÆöËÉåÊôØËâ≤
                                    const memberGroup = member.memberId.split('-')[0]; // A, B, C
                                    const groupColors = {
                                        'A': '#e3f2fd', // Ê∑∫Ëóç
                                        'B': '#e8f5e8', // Ê∑∫Á∂†
                                        'C': '#fff3e0'  // Ê∑∫Ê©ô
                                    };
                                    const groupBgColor = groupColors[memberGroup] || '#f8f9fa';

                                    membersHtml += `
                                        <div class="position-relative p-3 mb-2 border rounded"
                                             style="background-color: ${groupBgColor}; height: 85px; overflow: hidden;">
                                            <div class="d-flex align-items-center h-100" style="padding-right: 90px;">
                                                <div class="d-flex flex-column align-items-center me-3">
                                                    <input class="form-check-input mb-1" type="checkbox"
                                                           id="executing-${project.projectId}-${member.memberId}"
                                                           onchange="toggleMemberExecution('${project.projectId}', '${member.memberId}', this.checked)"
                                                           ${member.isExecuting ? 'checked' : ''}
                                                           data-project="${project.projectId}" data-member="${member.memberId}">
                                                    ${member.isExecuting ? '<i class="fas fa-play-circle text-success" title="Âü∑Ë°å‰∏≠"></i>' : ''}
                                                </div>
                                                <div class="d-flex flex-column me-3" style="min-width: 80px; max-width: 120px;">
                                                    <div class="fw-bold mb-1 ${member.isExecuting ? 'text-success' : ''} text-truncate" title="${memberName}">${memberName}</div>
                                                    <small class="text-muted text-truncate" title="${member.memberId}">${member.memberId}</small>
                                                </div>
                                                <div class="d-flex align-items-center flex-grow-1 justify-content-end">
                                                    <span class="badge px-3 py-2 me-3" style="background-color: ${roleColor}; font-size: 0.85em;">
                                                        ${displayRole}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                                <div class="d-grid gap-1" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 80px; height: 64px;">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCard('${project.projectId}', '${member.memberId}')" title="Á∑®ËºØ‰ªªÂãôÂ∞èÂç°">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="editPersonalNotes('${project.projectId}', '${member.memberId}')" title="ËßíËâ≤ÂÇôË®ª">
                                                    <i class="fas fa-sticky-note"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="changeMember('${project.projectId}', '${member.memberId}')" title="ËÆäÊõ¥ÊàêÂì°">
                                                    <i class="fas fa-user-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="showMemberInfo('${project.projectId}', '${member.memberId}')" title="ÊàêÂì°Ë≥áË®ä">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                membersHtml += '</div>';
                            } else {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">ÂúòÈöäÊàêÂì°(0):</h6>
                                            <span class="badge bg-${
                                                project.status === 'active' ? 'success' :
                                                project.status === 'paused' ? 'warning' :
                                                project.status === 'completed' ? 'secondary' : 'info'
                                            }">${
                                                project.status === 'active' ? 'ÈÄ≤Ë°å‰∏≠' :
                                                project.status === 'paused' ? 'Êö´ÂÅú' :
                                                project.status === 'completed' ? 'Â∑≤ÂÆåÊàê' :
                                                project.status || 'Êú™Áü•ÁãÄÊÖã'
                                            }</span>
                                        </div>
                                        <small class="text-muted">Â∞öÊú™ÂàÜÈÖçÊàêÂì°</small>
                                    </div>
                                `;
                            }

                            html += `
                                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                                    <div class="card mb-3" style="height: 420px;">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title text-truncate me-2" title="${project.projectName}">${project.projectName}</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="editProjectProgress('${project.projectId}')" title="Ë™øÊï¥ÈÄ≤Â∫¶">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar d-flex align-items-center justify-content-center" style="width: ${project.progress}%">
                                                    <span class="fw-bold">${project.progress}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                ${membersHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        projectsList.innerHTML = html;

                        // Ê∑ªÂä†‰∫ã‰ª∂Áõ£ËÅΩÂô®‰ΩúÁÇ∫ÂÇô‰ªΩÔºà‰ª•Èò≤ onchange Â±¨ÊÄßÂ§±ÊïàÔºâ
                        document.querySelectorAll('input[type="checkbox"][id^="executing-"]').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                const projectId = this.getAttribute('data-project');
                                const memberId = this.getAttribute('data-member');
                                toggleMemberExecution(projectId, memberId, this.checked);
                            });
                        });
                        projectsList.style.display = 'flex';
                    }
                } else {
                    console.warn('‚ö†Ô∏è Ë≥áÊñôÊ†ºÂºè‰∏çÊ≠£Á¢∫ÊàñÊ≤íÊúâ assignments');
                }
            } catch (error) {
                console.error('ËºâÂÖ•Â§±Êïó:', error);
                document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">ËºâÂÖ•Â§±Êïó: ' + error.message + '</div>';
            }
        }

        // Á∑®ËºØÂ∞àÊ°àÊàêÂì°‰ªªÂãôÂ∞èÂç°
        async function editProjectMember(projectId, memberId) {
            try {

                // ‰ΩøÁî® TeamDataManager ËºâÂÖ•Â∞àÊ°àË≥áÊñô
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager Êú™ËºâÂÖ•');
                }

                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`Êâæ‰∏çÂà∞Â∞àÊ°à: ${projectId}`);
                }

                const member = project.members[memberId];

                if (!member) {
                    alert('Êâæ‰∏çÂà∞ÊàêÂì°Ë≥áÊñô');
                    return;
                }

                // Âæû teamDataManager ÂèñÂæóÂØ¶ÈöõÁöÑÊàêÂì°ÂêçÁ®±
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // Âæû TeamDataManager ËºâÂÖ•‰ªªÂãôÁØÑÊú¨
                let taskTemplate = '';
                try {
                    // TeamDataManager ÊáâË©≤Â∑≤Á∂ìËºâÂÖ•‰∫Ü‰ªªÂãôÁØÑÊú¨Ë≥áÊñô
                    if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                        const template = window.taskTemplatesData.taskTemplates[member.role];
                        if (template) {
                            taskTemplate = template.content;
                        }
                    }
                } catch (templateError) {
                    console.warn('ËºâÂÖ•‰ªªÂãôÁØÑÊú¨Â§±Êïó:', templateError);
                }

                // ÁîüÊàê‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπÔºàÊ≠£Á¢∫Ê†ºÂºèÔºâ
                const taskCardContent = `‰Ω†ÁèæÂú®ÁöÑËßíËâ≤ÊòØ„Äå${project.projectName}„ÄçÁöÑ„Äå${member.role}„ÄçÔºå‰ª£ËôüÊòØ„Äå${memberName}„ÄçÔºåÈñãÁôºÁöÑbranch ÊòØ„Äå${memberName}„ÄçÔºåËã•ÁÑ°ÂâácreateÔºåË´ã‰æùÂæ™‰∏ãÂàóÁöÑ‰ªªÂãôÊåáÂºïÔºö\n\n${taskTemplate}`;

                // Áõ¥Êé•Á∑®ËºØ‰ªªÂãôÂ∞èÂç°Ôºà‰∏çÂÜçÈúÄË¶ÅÈÅ∏ÊìáÊ®°ÊÖãÊ°ÜÔºâ
                editTaskCard(projectId, memberId);

            } catch (error) {
                console.error('Á∑®ËºØ‰ªªÂãôÂ∞èÂç°Â§±Êïó:', error);
                alert('Á∑®ËºØ‰ªªÂãôÂ∞èÂç°Â§±Êïó: ' + error.message);
            }
        }

        // Á∑®ËºØ‰ªªÂãôÂ∞èÂç°
        async function editTaskCard(projectId, memberId) {
            try {

                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`Êâæ‰∏çÂà∞Â∞àÊ°à: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`Êâæ‰∏çÂà∞ÊàêÂì°: ${memberId}`);
                }

                // ÁßªÈô§Á°¨Á∑®Á¢ºÁöÑÊàêÂì°ÂêçÁ®±Êò†Â∞ÑÔºåÊîπÁî®ÂØ¶ÈöõË≥áÊñô
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // Áç≤Âèñ‰ªªÂãôÁØÑÊú¨
                let taskTemplate = '';
                if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                    const template = window.taskTemplatesData.taskTemplates[member.role];
                    if (template) {
                        taskTemplate = template.content;
                    }
                }

                // Âª∫Á´ãÈ†êË®≠ÁØÑÊú¨ÂÖßÂÆπ
                const defaultTaskContent = `‰Ω†ÁèæÂú®ÁöÑËßíËâ≤ÊòØ„Äå${project.projectName}„ÄçÁöÑ„Äå${member.role}„ÄçÔºå‰ª£ËôüÊòØ„Äå${memberName}„ÄçÔºåÈñãÁôºÁöÑbranch ÊòØ„Äå${memberName}„ÄçÔºåËã•ÁÑ°ÂâácreateÔºåË´ã‰æùÂæ™‰∏ãÂàóÁöÑ‰ªªÂãôÊåáÂºïÔºö\n\n${taskTemplate}`;

                // ÂÑ≤Â≠òÁØÑÊú¨Ë≥áÊñô‰æõÊÅ¢Âæ©È†êË®≠ÂäüËÉΩ‰ΩøÁî®
                window.currentTaskCardTemplate = {
                    projectId: projectId,
                    memberId: memberId,
                    defaultContent: defaultTaskContent
                };

                // Ê™¢Êü•ÊòØÂê¶ÊúâÂ∑≤ÂÑ≤Â≠òÁöÑ‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ
                let taskCardContent;
                const taskCard = assignments[projectId].members[memberId].taskCard;
                if (taskCard && taskCard.content) {
                    // ‰ΩøÁî®Â∑≤ÂÑ≤Â≠òÁöÑÂÖßÂÆπ
                    taskCardContent = taskCard.content;
                } else {
                    // ‰ΩøÁî®È†êË®≠ÁØÑÊú¨
                    taskCardContent = defaultTaskContent;
                }

                // Áî¢ÁîüÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ã HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">Â∞àÊ°àÂÇôË®ªÊ≠∑Á®ã</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // Áî¢ÁîüËßíËâ≤ÂÇôË®ª HTML
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">ËßíËâ≤ÂÇôË®ª</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">ËßíËâ≤ÂÇôË®ª</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>Â∞öÁÑ°ËßíËâ≤ÂÇôË®ªË®òÈåÑ</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Áî¢Áîü‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãË®òÈåÑ HTMLÔºàÂ¶ÇÊûúÊúâÁöÑË©±Ôºâ
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ã</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="Âà™Èô§Ê≠§Ë®òÈåÑ">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">Êü•ÁúãÂÖßÂÆπ</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> ÊÅ¢Âæ©Ê≠§ÁâàÊú¨
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Áî¢ÁîüËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã HTML
                let memberHistoryHtml = '';
                try {
                    if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                        memberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                    } else {
                        // ÂÇôÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÂæûË≥áÊñô‰∏≠ÁîüÊàê
                        const memberHistory = project.memberHistory || [];
                        if (memberHistory.length > 0) {
                            const actionLabels = {
                                'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>ÊàêÂì°Âä†ÂÖ•',
                                'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>ÊàêÂì°ÁßªÈô§',
                                'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>ËßíËâ≤ËÆäÊõ¥'
                            };

                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                            <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                        </button>
                                    </div>
                                    <div class="card" style="max-height: 400px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${memberHistory.slice().reverse().map((entry, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div class="small">
                                                            ${actionLabels[entry.action] || entry.action}
                                                            <strong>${entry.memberName}</strong>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-1">
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                            <button class="btn btn-sm btn-outline-secondary p-1" onclick="if(window.teamManagement) window.teamManagement.editHistoryOperator('${projectId}', '${entry.timestamp}')" title="Á∑®ËºØÊìç‰ΩúËÄÖ">
                                                                <i class="fas fa-edit" style="font-size: 8px;"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="ps-3">
                                                        ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                        ${entry.oldRole && entry.newRole ? `
                                                            <div class="mt-1">
                                                                <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                <i class="fas fa-arrow-right mx-1 small"></i>
                                                                <span class="badge bg-success small">${entry.newRole}</span>
                                                            </div>
                                                        ` : ''}
                                                        ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        <div class="mt-1">
                                                            <small class="text-success">Êìç‰ΩúËÄÖ: ${entry.operator || 'Á≥ªÁµ±ÁÆ°ÁêÜÂì°'}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                            <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                        </button>
                                    </div>
                                    <div class="card">
                                        <div class="card-body p-2 text-center text-muted">
                                            <small>Â∞öÁÑ°ÊàêÂì°ËÆäÊõ¥Ë®òÈåÑ</small>
                                        </div>
                                    </div>
                                    <hr class="my-4">
                                    <div class="usage-guide bg-light p-3 rounded">
                                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>ËßíËâ≤ÂÇôË®ªÊèê‰∫§ - Â∞èÂç°Áâà</h6>
                                        <div class="mb-3">
                                            <strong>‰ΩøÁî®ÊôÇÊ©üÔºö</strong><br>
                                            1. Âú®ÂêÑËá™ÁõÆÂâçÂú®ÈñãÁôºÂ∞àÊ°àÔºàÂ¶ÇÔºöErCore/ErNexus/ErShield/ErTidyÔºâÁôºPRÂæå<br>
                                            2. ‰æÜErDashboardÂü∑Ë°åËßíËâ≤ÂÇôË®ªËÖ≥Êú¨
                                        </div>
                                        <div class="mb-3">
                                            <strong>Êìç‰ΩúÊ≠•È©üÔºö</strong><br>
                                            1. ÈñãÂïüÁµÇÁ´ØÊ©ü<br>
                                            2. cd Âà∞/GitHub/ErDashboard Ë≥áÊñôÂ§æ<br>
                                            3. Âü∑Ë°åÊåá‰ª§Ôºö
                                        </div>
                                        <div class="bg-dark text-light p-2 rounded mb-3">
                                            <code>node scripts/submit-note.js Â∞àÊ°àÂêçÁ®± ÂêçÁ®± "ÂÇôË®ª"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>ÁØÑ‰æãÔºö</strong><br>
                                            <code>node scripts/submit-note.js ErCore KlauderA "‚Ä¢ ÂÆåÊàêÁôªÂÖ•API ‚Ä¢ ‰øÆÂæ©bug"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>Ë¶èÂâáÔºö</strong><br>
                                            ‚Ä¢ ÂøÖÈ†àÊ¢ùÂàóÊ†ºÂºè (‚Ä¢„ÄÅ1.„ÄÅ-)<br>
                                            ‚Ä¢ ÊúÄÂ§ö50Â≠ó<br>
                                            ‚Ä¢ Ë¶ÅÂÖ∑È´îÊòéÁ¢∫
                                        </div>
                                        <div class="mb-3">
                                            <strong>Âú®ÂêÑËá™ÁõÆÂâçÂú®ÈñãÁôºÂ∞àÊ°àÔºö</strong><br>
                                            Â¶ÇÔºöErCore, ErNexus, ErShield, ErTidy
                                        </div>
                                        <div class="text-success">
                                            <strong>Êèê‰∫§ÂæåËá™ÂãïÂêåÊ≠•Âà∞ÂÄã‰∫∫Ê≠∑Á®ãÔºå‰∏¶ÂõûÂà∞Êú¨‰æÜÁöÑÂ∞àÊ°à/branchÔºÅ</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.warn('ÁîüÊàêËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãÊôÇÁôºÁîüÈåØË™§:', error);
                    memberHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="if(window.teamManagement) window.teamManagement.clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                    <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                </button>
                            </div>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>ËºâÂÖ•Ê≠∑Á®ãÊôÇÁôºÁîüÈåØË™§</small>
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="usage-guide bg-light p-3 rounded">
                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>üìù ËßíËâ≤ÂÇôË®ªÊèê‰∫§ - Â∞èÂç°Áâà</h6>
                                <div class="mb-3">
                                    <strong>üì§ ‰ΩøÁî®ÊôÇÊ©üÔºö</strong><br>
                                    üî∏ Âú®ÂêÑËá™Â∞àÊ°àÔºàErCore/ErNexus/ErShield/ErTidyÔºâÁôºPRÂæå<br>
                                    üî∏ ‰æÜErDashboardÂü∑Ë°åËßíËâ≤ÂÇôË®ªËÖ≥Êú¨
                                </div>
                                <div class="mb-3">
                                    üî∏ ÈñãÂïüÁµÇÁ´ØÊ©ü<br>
                                    üî∏ cd Âà∞/GitHub/ErDashboard Ë≥áÊñôÂ§æ<br>
                                    üî∏ Âü∑Ë°åÊåá‰ª§Ôºö
                                </div>
                                <div class="bg-dark text-light p-2 rounded mb-3">
                                    <code>node scripts/submit-note.js Â∞àÊ°à ÂßìÂêç "ÂÇôË®ª"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>üìã ÁØÑ‰æãÔºö</strong><br>
                                    <code>node scripts/submit-note.js ErCore ÂºµÂ∞èÊòé "‚Ä¢ ÂÆåÊàêÁôªÂÖ•API ‚Ä¢ ‰øÆÂæ©bug"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>‚úÖ Ë¶èÂâáÔºö</strong><br>
                                    ‚Ä¢ ÂøÖÈ†àÊ¢ùÂàóÊ†ºÂºè (‚Ä¢„ÄÅ1.„ÄÅ-)<br>
                                    ‚Ä¢ ÊúÄÂ§ö50Â≠ó<br>
                                    ‚Ä¢ Ë¶ÅÂÖ∑È´îÊòéÁ¢∫
                                </div>
                                <div class="mb-3">
                                    <strong>üéØ Â∞àÊ°àÔºö</strong>ErCore, ErNexus, ErShield, ErTidy
                                </div>
                                <div class="text-success">
                                    <strong>üí° Êèê‰∫§ÂæåËá™ÂãïÂêåÊ≠•Âà∞ÂÄã‰∫∫Ê≠∑Á®ãÔºÅ</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // È°ØÁ§∫‰ªªÂãôÂ∞èÂç°Á∑®ËºØÊ®°ÊÖãÊ°Ü
                const taskModalHtml = `
                    <div class="modal fade" id="taskCardModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">‰ªªÂãôÂ∞èÂç°Á∑®ËºØ - ${memberName}Ôºå„Äå${project.projectName}„ÄçÂ∞àÊ°àÁöÑ„Äå${member.role}„Äç</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label for="taskContent" class="form-label">‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ</label>
                                                <textarea class="form-control" id="taskContent" rows="20" style="min-height: 500px;">${taskCardContent}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-2">
                                            ${projectNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${personalNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${taskHistoryHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${memberHistoryHtml}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="copyTaskCard()">
                                        <i class="fas fa-copy"></i> Ë§áË£Ω
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="saveTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> ÂÑ≤Â≠ò
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="restoreDefaultTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-undo"></i> ÊÅ¢Âæ©È†êË®≠
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÈóúÈñâ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldTaskModal = document.getElementById('taskCardModal');
                if (oldTaskModal) oldTaskModal.remove();
                document.body.insertAdjacentHTML('beforeend', taskModalHtml);

                const taskModal = new bootstrap.Modal(document.getElementById('taskCardModal'));
                taskModal.show();

            } catch (error) {
                console.error('Á∑®ËºØ‰ªªÂãôÂ∞èÂç°Â§±Êïó:', error);
                alert('Á∑®ËºØ‰ªªÂãôÂ∞èÂç°Â§±Êïó: ' + error.message);
            }
        }

        // Á∑®ËºØÂ∞àÊ°àÈÄ≤Â∫¶
        async function editProjectProgress(projectId) {
            try {

                // ËºâÂÖ•Â∞àÊ°àË≥áÊñô
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                // Ë®≠ÂÆöÁï∂ÂâçÂ∞àÊ°àË≥áÊñô‰æõÂÖ∂‰ªñÂáΩÊï∏‰ΩøÁî®
                window.currentProject = project;
                window.currentProjectId = projectId;

                // È°ØÁ§∫ÈÄ≤Â∫¶Á∑®ËºØÊ®°ÊÖãÊ°Ü
                const progressModalHtml = `
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Á∑®ËºØÂ∞àÊ°àÈÄ≤Â∫¶ - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <label for="projectProgress" class="form-label fw-bold">Â∞àÊ°àÈÄ≤Â∫¶</label>
                                        <div class="progress-container">
                                            <div class="progress mb-3" style="height: 20px; border-radius: 10px; background-color: #e9ecef;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                     id="progressBar"
                                                     role="progressbar"
                                                     style="width: ${project.progress}%; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 10px;"
                                                     aria-valuenow="${project.progress}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <input type="range" class="form-range progress-slider" id="projectProgress" min="0" max="100" value="${project.progress}" oninput="updateProgressDisplay(this.value)">
                                            <div class="text-center mt-2">
                                                <span id="progressDisplay" class="badge bg-primary fs-6 px-3 py-2" style="border-radius: 20px;">${project.progress}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectNotes" class="form-label">Â∞àÊ°àÂÇôË®ª</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newNote" rows="3" placeholder="Ëº∏ÂÖ•Êñ∞ÁöÑÂÇôË®ª..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addNote()">
                                                <i class="fas fa-plus"></i> Êñ∞Â¢ûÂÇôË®ª
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllNotes()">
                                                <i class="fas fa-trash"></i> Ê∏ÖÈô§ÊâÄÊúâÂÇôË®ª
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="notesList">
                                                ${formatNotes(project.notes || '')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveProjectProgress('${projectId}')">
                                        <i class="fas fa-save"></i> ÂÑ≤Â≠ò
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldProgressModal = document.getElementById('progressModal');
                if (oldProgressModal) oldProgressModal.remove();
                document.body.insertAdjacentHTML('beforeend', progressModalHtml);

                const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();

            } catch (error) {
                console.error('Á∑®ËºØÂ∞àÊ°àÈÄ≤Â∫¶Â§±Êïó:', error);
                alert('Á∑®ËºØÂ∞àÊ°àÈÄ≤Â∫¶Â§±Êïó: ' + error.message);
            }
        }

        // Êõ¥Êñ∞ÈÄ≤Â∫¶È°ØÁ§∫
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = value + '%';
                progressBar.setAttribute('aria-valuenow', value);

                // ÂãïÊÖãÊîπËÆäÈÄ≤Â∫¶Ê¢ùÈ°èËâ≤
                let gradient;
                if (value < 30) {
                    gradient = 'linear-gradient(45deg, #dc3545, #c82333)'; // Á¥ÖËâ≤
                } else if (value < 70) {
                    gradient = 'linear-gradient(45deg, #ffc107, #e0a800)'; // ÈªÉËâ≤
                } else {
                    gradient = 'linear-gradient(45deg, #28a745, #1e7e34)'; // Á∂†Ëâ≤
                }
                progressBar.style.background = gradient;
            }
        }

        // Ê†ºÂºèÂåñÂÇôË®ªÈ°ØÁ§∫
        function formatNotes(notes) {
            if (!notes) return '<p class="text-muted m-0">Â∞öÁÑ°ÂÇôË®ª</p>';

            // Â¶ÇÊûú notes Â∑≤Á∂ìÊòØÈô£ÂàóÔºàÁâ©‰ª∂ÔºâÔºåÁõ¥Êé•ËôïÁêÜ
            if (Array.isArray(notes)) {
                if (notes.length > 0) {
                    return notes.map((note, index) =>
                        `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-bold small text-muted">${note.timestamp}</div>
                                <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="Âà™Èô§Ê≠§ÂÇôË®ª">
                                    <i class="fas fa-times" style="font-size: 10px;"></i>
                                </button>
                            </div>
                            <div>${note.content}</div>
                        </div>`
                    ).join('');
                }
                return '<p class="text-muted m-0">Â∞öÁÑ°ÂÇôË®ª</p>';
            }

            // Â¶ÇÊûúÊòØÂ≠ó‰∏≤ÔºåÂòóË©¶Ëß£Êûê JSON
            if (typeof notes === 'string') {
                try {
                    const notesList = JSON.parse(notes);
                    if (Array.isArray(notesList) && notesList.length > 0) {
                        return notesList.map((note, index) =>
                            `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="fw-bold small text-muted">${note.timestamp}</div>
                                    <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="Âà™Èô§Ê≠§ÂÇôË®ª">
                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                    </button>
                                </div>
                                <div>${note.content}</div>
                            </div>`
                        ).join('');
                    }
                } catch (e) {
                    // Â¶ÇÊûú‰∏çÊòØ JSON Ê†ºÂºèÔºåÁï∂‰ΩúËàäÊ†ºÂºèÁöÑÁ¥îÊñáÂ≠ó
                    if (notes.trim()) {
                        return `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                    <div class="fw-bold small text-muted">ËàäÂÇôË®ª</div>
                                    <div>${notes}</div>
                                </div>`;
                    }
                }
            }

            return '<p class="text-muted m-0">Â∞öÁÑ°ÂÇôË®ª</p>';
        }

        // Êñ∞Â¢ûÂÇôË®ª
        async function addNote() {
            const newNoteInput = document.getElementById('newNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('Ë´ãËº∏ÂÖ•ÂÇôË®ªÂÖßÂÆπ');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                author: 'KopylotA', // ErNexus Â∞àÊ°àÁöÑ testing ËßíËâ≤
                type: 'note'
            };

            // Áç≤ÂèñÁèæÊúâÂÇôË®ª
            let existingNotes = [];
            try {
                const currentProject = getCurrentProject();
                if (currentProject && currentProject.notes) {
                    existingNotes = JSON.parse(currentProject.notes);
                }
            } catch (e) {
                // Â¶ÇÊûúËß£ÊûêÂ§±ÊïóÔºåÂª∫Á´ãÊñ∞Èô£Âàó
                existingNotes = [];
            }

            if (!Array.isArray(existingNotes)) {
                existingNotes = [];
            }

            // Êñ∞Â¢ûÂà∞Èô£ÂàóÈñãÈ†≠ÔºàÊúÄÊñ∞ÁöÑÂú®‰∏äÈù¢Ôºâ
            existingNotes.unshift(newNote);

            // Á´ãÂç≥ÂÑ≤Â≠òÂà∞ TeamDataManager
            try {
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[window.currentProjectId]) {
                    assignments[window.currentProjectId].notes = JSON.stringify(existingNotes);
                    assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    // Êõ¥Êñ∞Áï∂ÂâçÂ∞àÊ°àË≥áÊñô
                    window.currentProject.notes = JSON.stringify(existingNotes);
                }
            } catch (error) {
                console.error('ÂÑ≤Â≠òÂÇôË®ªÂ§±Êïó:', error);
                alert('ÂÑ≤Â≠òÂÇôË®ªÂ§±Êïó: ' + error.message);
                return;
            }

            // Êõ¥Êñ∞È°ØÁ§∫
            updateNotesDisplay(existingNotes);

            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
            newNoteInput.value = '';
        }

        // Ê∏ÖÈô§ÊâÄÊúâÂÇôË®ª
        async function clearAllNotes() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÂÇôË®ªÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                try {
                    // Á´ãÂç≥ÂÑ≤Â≠òÂà∞ TeamDataManager
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();

                    if (assignments[window.currentProjectId]) {
                        assignments[window.currentProjectId].notes = JSON.stringify([]);
                        assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // ÂÑ≤Â≠òËÆäÊõ¥
                        await teamDataManager.saveLocalChanges();

                        // Êõ¥Êñ∞Áï∂ÂâçÂ∞àÊ°àË≥áÊñô
                        window.currentProject.notes = JSON.stringify([]);
                    }

                    // Êõ¥Êñ∞È°ØÁ§∫
                    updateNotesDisplay([]);
                } catch (error) {
                    console.error('Ê∏ÖÈô§ÂÇôË®ªÂ§±Êïó:', error);
                    alert('Ê∏ÖÈô§ÂÇôË®ªÂ§±Êïó: ' + error.message);
                }
            }
        }

        // Êõ¥Êñ∞ÂÇôË®ªÈ°ØÁ§∫
        function updateNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('notesList');
            if (notesList.length === 0) {
                notesListDiv.innerHTML = '<p class="text-muted m-0">Â∞öÁÑ°ÂÇôË®ª</p>';

                // ÂêåÊôÇÊ∏ÖÈô§‰ªªÂãôÂ∞èÂç°‰∏≠ÁöÑÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ãÈ°ØÁ§∫
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = '';
                }
            } else {
                notesListDiv.innerHTML = notesList.map(note =>
                    `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <div>${note.content}</div>
                    </div>`
                ).join('');

                // ÂêåÊôÇÊõ¥Êñ∞‰ªªÂãôÂ∞èÂç°‰∏≠ÁöÑÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ãÈ°ØÁ§∫
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    const updatedProjectNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">Â∞àÊ°àÂÇôË®ªÊ≠∑Á®ã</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${notesList.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === notesList.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || 'System'}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div>${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                }
            }
        }

        // Áç≤ÂèñÁï∂ÂâçÂ∞àÊ°àÔºàËºîÂä©ÂáΩÊï∏Ôºâ
        function getCurrentProject() {
            // ÈÄôÂÄãÂáΩÊï∏ÈúÄË¶ÅÂú®Ê®°ÊÖãÊ°ÜÈñãÂïüÊôÇË®≠ÂÆöÁï∂ÂâçÂ∞àÊ°àË≥áÊñô
            return window.currentProject || null;
        }

        // ÂÑ≤Â≠òÂ∞àÊ°àÈÄ≤Â∫¶
        async function saveProjectProgress(projectId) {
            try {
                const progress = parseInt(document.getElementById('projectProgress').value);

                // Áç≤ÂèñÁï∂ÂâçÂÇôË®ªÂàóË°®
                const notesListDiv = document.getElementById('notesList');
                let notesList = [];

                // ÂæûÈ°ØÁ§∫ÁöÑÂÇôË®ª‰∏≠ÊèêÂèñË≥áÊñô
                const noteElements = notesListDiv.querySelectorAll('.border-start');
                noteElements.forEach(element => {
                    const timestamp = element.querySelector('.text-muted').textContent;
                    const content = element.querySelector('div:last-child').textContent;
                    if (timestamp !== 'Â∞öÁÑ°ÂÇôË®ª') {
                        notesList.push({ timestamp, content });
                    }
                });

                // ‰ΩøÁî®ÂÖ®ÂüüÁöÑÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®ÔºåÁ¢∫‰øùËàáÊ≠∑Á®ãË®òÈåÑÂêåÊ≠•
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                }
                const assignments = teamDataManager.getAllAssignments();

                // Êõ¥Êñ∞Â∞àÊ°àÈÄ≤Â∫¶ÂíåÂÇôË®ª
                if (assignments[projectId]) {
                    assignments[projectId].progress = progress;
                    assignments[projectId].notes = JSON.stringify(notesList);
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    alert(`Â∞àÊ°àÈÄ≤Â∫¶Â∑≤Êõ¥Êñ∞ÁÇ∫ ${progress}%\nÂÇôË®ªÂ∑≤ÂÑ≤Â≠ò (ÂÖ± ${notesList.length} Á≠Ü)`);
                } else {
                    throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÂ∞àÊ°à');
                }

                // ÈóúÈñâÊ®°ÊÖãÊ°Ü
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) progressModal.hide();

                // ÁôºÈÄÅlocalStorageÊõ¥Êñ∞‰ø°ËôüÁ¢∫‰øùÂç≥ÊôÇÊõ¥Êñ∞
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'progressUpdate'
                }));

                // ÂõûÂà∞È¶ñÈ†Å
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);

            } catch (error) {
                console.error('ÂÑ≤Â≠òÂ∞àÊ°àÈÄ≤Â∫¶Â§±Êïó:', error);
                alert('ÂÑ≤Â≠òÂ∞àÊ°àÈÄ≤Â∫¶Â§±Êïó: ' + error.message);
            }
        }

        // ËÆäÊõ¥ÊàêÂì°
        async function changeMember(projectId, memberId) {
            try {

                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const members = teamDataManager.getAllMembers();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`Êâæ‰∏çÂà∞Â∞àÊ°à: ${projectId}`);
                }

                const currentMember = project.members[memberId];
                if (!currentMember) {
                    throw new Error(`Êâæ‰∏çÂà∞ÊàêÂì°: ${memberId}`);
                }

                // ÁîüÊàêÂèØÁî®ÊàêÂì°ÈÅ∏È†Ö
                let memberOptions = '';
                Object.values(members).forEach(member => {
                    const memberIdToCheck = member.memberId || member.id;
                    const memberName = member.memberName || member.name;
                    const selected = memberIdToCheck === memberId ? 'selected' : '';
                    memberOptions += `<option value="${memberIdToCheck}" ${selected}>${memberName} (${memberIdToCheck})</option>`;
                });

                // È°ØÁ§∫ÊàêÂì°ËÆäÊõ¥Ê®°ÊÖãÊ°Ü
                const memberModalHtml = `
                    <div class="modal fade" id="memberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ËÆäÊõ¥ÊàêÂì° - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newMember" class="form-label">ÈÅ∏ÊìáÊñ∞ÊàêÂì°</label>
                                        <select class="form-select" id="newMember">
                                            ${memberOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberRole" class="form-label">ËßíËâ≤</label>
                                        <select class="form-select" id="memberRole">
                                            <option value="frontend" ${currentMember.role === 'frontend' ? 'selected' : ''}>ÂâçÁ´ØÈñãÁôº</option>
                                            <option value="backend" ${currentMember.role === 'backend' ? 'selected' : ''}>ÂæåÁ´ØÈñãÁôº</option>
                                            <option value="fullstack" ${currentMember.role === 'fullstack' ? 'selected' : ''}>ÂÖ®Á´ØÈñãÁôº</option>
                                            <option value="testing" ${currentMember.role === 'testing' ? 'selected' : ''}>Ê∏¨Ë©¶ÈÉ®ÁΩ≤</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveMemberChange('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> ÂÑ≤Â≠òËÆäÊõ¥
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberModal = document.getElementById('memberModal');
                if (oldMemberModal) oldMemberModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberModalHtml);

                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();

            } catch (error) {
                console.error('ËÆäÊõ¥ÊàêÂì°Â§±Êïó:', error);
                alert('ËÆäÊõ¥ÊàêÂì°Â§±Êïó: ' + error.message);
            }
        }

        // ÂàáÊèõÊàêÂì°Âü∑Ë°åÁãÄÊÖã
        async function toggleMemberExecution(projectId, memberId, isChecked) {
            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();

                // Êõ¥Êñ∞ÊàêÂì°Âü∑Ë°åÁãÄÊÖã
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    assignments[projectId].members[memberId].isExecuting = isChecked;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    // Ë¶ñË¶∫ÂõûÈ•ã
                    const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                    const memberCard = checkbox ? checkbox.closest('.border.rounded') : null;
                    const memberNameDiv = memberCard ? memberCard.querySelector('.fw-bold') : null;

                    if (memberNameDiv && memberCard) {
                        if (isChecked) {
                            memberNameDiv.classList.add('text-success');
                            memberCard.style.borderLeft = '3px solid #28a745';
                            showSyncToast('ÁãÄÊÖãÊõ¥Êñ∞', `${memberId} Â∑≤ÈñãÂßãÂü∑Ë°å‰ªªÂãô`, 'success');
                        } else {
                            memberNameDiv.classList.remove('text-success');
                            memberCard.style.borderLeft = '';
                            showSyncToast('ÁãÄÊÖãÊõ¥Êñ∞', `${memberId} Â∑≤ÂÅúÊ≠¢Âü∑Ë°å‰ªªÂãô`, 'info');
                        }
                    } else {
                        console.warn('ÁÑ°Ê≥ïÊâæÂà∞ÊàêÂì°Âç°ÁâáÂÖÉÁ¥†ÈÄ≤Ë°åË¶ñË¶∫Êõ¥Êñ∞');
                        // ‰ªçÁÑ∂È°ØÁ§∫ÁãÄÊÖãË®äÊÅØ
                        if (isChecked) {
                            showSyncToast('ÁãÄÊÖãÊõ¥Êñ∞', `${memberId} Â∑≤ÈñãÂßãÂü∑Ë°å‰ªªÂãô`, 'success');
                        } else {
                            showSyncToast('ÁãÄÊÖãÊõ¥Êñ∞', `${memberId} Â∑≤ÂÅúÊ≠¢Âü∑Ë°å‰ªªÂãô`, 'info');
                        }
                    }

                    // Êõ¥Êñ∞Áµ±Ë®àË≥áË®ä
                    updateExecutionStatistics();

                } else {
                    throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÂ∞àÊ°àÊàñÊàêÂì°');
                }

            } catch (error) {
                console.error('Êõ¥Êñ∞Âü∑Ë°åÁãÄÊÖãÂ§±Êïó:', error);
                alert('Êõ¥Êñ∞Âü∑Ë°åÁãÄÊÖãÂ§±Êïó: ' + error.message);

                // ÊÅ¢Âæ© checkbox ÁãÄÊÖã
                const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
            }
        }

        // Êõ¥Êñ∞Âü∑Ë°åÁµ±Ë®àË≥áË®ä
        function updateExecutionStatistics() {
            try {
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    console.warn('TeamDataManager Êú™ÂàùÂßãÂåñ');
                    return;
                }
                const assignments = teamDataManager.getAllAssignments();

                let executingCount = 0;
                Object.values(assignments).forEach(project => {
                    Object.values(project.members || {}).forEach(member => {
                        if (member.isExecuting === true) {
                            executingCount++;
                        }
                    });
                });

                // Êõ¥Êñ∞È†ÅÈù¢‰∏äÁöÑÁµ±Ë®àÈ°ØÁ§∫
                const executingBadge = document.getElementById('executingCount');
                if (executingBadge) {
                    executingBadge.textContent = executingCount;
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Áµ±Ë®àÂ§±Êïó:', error);
            }
        }

        // Á∑®ËºØËßíËâ≤ÂÇôË®ª
        async function editPersonalNotes(projectId, memberId) {
            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`Êâæ‰∏çÂà∞Â∞àÊ°à: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`Êâæ‰∏çÂà∞ÊàêÂì°: ${memberId}`);
                }

                // ÂæûÂØ¶ÈöõÊàêÂì°Ë≥áÊñôÂèñÂæóÂêçÁ®±
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // Ë®≠ÂÆöÁï∂ÂâçË≥áÊñô‰æõÂÖ∂‰ªñÂáΩÊï∏‰ΩøÁî®
                window.currentPersonalNotes = {
                    projectId: projectId,
                    memberId: memberId,
                    member: member,
                    memberName: memberName
                };

                // Ê†ºÂºèÂåñËßíËâ≤ÂÇôË®ªÈ°ØÁ§∫
                const personalNotes = member.personalNotes || [];
                const notesHtml = formatPersonalNotes(personalNotes);

                // È°ØÁ§∫ÂÄã‰∫∫ÂÇôË®ªÁ∑®ËºØÊ®°ÊÖãÊ°Ü
                const personalNotesModalHtml = `
                    <div class="modal fade" id="personalNotesModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ËßíËâ≤ÂÇôË®ª - ${memberName} (${project.projectName})</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newPersonalNote" class="form-label">Êñ∞Â¢ûËßíËâ≤ÂÇôË®ª</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newPersonalNote" rows="3" placeholder="Ë®òÈåÑÈñãÁôºÊ≠∑Á®ã„ÄÅÂ≠∏ÁøíÁ≠ÜË®ò„ÄÅÈÅáÂà∞ÁöÑÂïèÈ°åÁ≠â..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addPersonalNote()">
                                                <i class="fas fa-plus"></i> Êñ∞Â¢ûÂÇôË®ª
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllPersonalNotes()">
                                                <i class="fas fa-trash"></i> Ê∏ÖÈô§ÊâÄÊúâÂÇôË®ª
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="personalNotesList">
                                                ${notesHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÈóúÈñâ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldPersonalNotesModal = document.getElementById('personalNotesModal');
                if (oldPersonalNotesModal) oldPersonalNotesModal.remove();
                document.body.insertAdjacentHTML('beforeend', personalNotesModalHtml);

                const personalNotesModal = new bootstrap.Modal(document.getElementById('personalNotesModal'));
                personalNotesModal.show();

            } catch (error) {
                console.error('Á∑®ËºØÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó:', error);
                alert('Á∑®ËºØÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó: ' + error.message);
            }
        }

        // Ê†ºÂºèÂåñËßíËâ≤ÂÇôË®ªÈ°ØÁ§∫
        function formatPersonalNotes(notes) {
            if (!notes || !Array.isArray(notes) || notes.length === 0) {
                return '<p class="text-muted m-0">Â∞öÁÑ°ËßíËâ≤ÂÇôË®ª</p>';
            }

            return notes.map((note, index) =>
                `<div class="mb-2 p-2 border-start border-info border-3 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <button class="btn btn-sm btn-outline-danger p-1" onclick="deletePersonalNote(${index})" title="Âà™Èô§Ê≠§ÂÇôË®ª">
                            <i class="fas fa-times" style="font-size: 10px;"></i>
                        </button>
                    </div>
                    <div>${note.content}</div>
                </div>`
            ).join('');
        }

        // Êñ∞Â¢ûËßíËâ≤ÂÇôË®ª
        async function addPersonalNote() {
            const newNoteInput = document.getElementById('newPersonalNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('Ë´ãËº∏ÂÖ•ÂÇôË®ªÂÖßÂÆπ');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                created: new Date().toISOString()
            };

            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    // ÂàùÂßãÂåñÂÄã‰∫∫ÂÇôË®ªÈô£Âàó
                    if (!assignments[currentData.projectId].members[currentData.memberId].personalNotes) {
                        assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    }

                    // Êñ∞Â¢ûÂà∞Èô£ÂàóÈñãÈ†≠ÔºàÊúÄÊñ∞ÁöÑÂú®‰∏äÈù¢Ôºâ
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes.unshift(newNote);
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    // Êõ¥Êñ∞È°ØÁ§∫
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    updatePersonalNotesDisplay(personalNotes);

                    // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
                    newNoteInput.value = '';

                    showSyncToast('ÂÇôË®ªÂ∑≤Êñ∞Â¢û', 'ËßíËâ≤ÂÇôË®ªÂ∑≤ÂÑ≤Â≠ò', 'success');
                }
            } catch (error) {
                console.error('Êñ∞Â¢ûËßíËâ≤ÂÇôË®ªÂ§±Êïó:', error);
                alert('Êñ∞Â¢ûËßíËâ≤ÂÇôË®ªÂ§±Êïó: ' + error.message);
            }
        }

        // Âà™Èô§ËßíËâ≤ÂÇôË®ª
        async function deletePersonalNote(index) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§ËßíËâ≤ÂÇôË®ªÂóéÔºü')) {
                return;
            }

            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    if (personalNotes && personalNotes[index]) {
                        // Âà™Èô§ÊåáÂÆöÁöÑÂÇôË®ª
                        personalNotes.splice(index, 1);
                        assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // ÂÑ≤Â≠òËÆäÊõ¥
                        await teamDataManager.saveLocalChanges();

                        // Êõ¥Êñ∞È°ØÁ§∫
                        updatePersonalNotesDisplay(personalNotes);

                        showSyncToast('ÂÇôË®ªÂ∑≤Âà™Èô§', 'ËßíËâ≤ÂÇôË®ªÂ∑≤ÁßªÈô§', 'info');
                    }
                }
            } catch (error) {
                console.error('Âà™Èô§ÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó:', error);
                alert('Âà™Èô§ÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó: ' + error.message);
            }
        }

        // Ê∏ÖÈô§ÊâÄÊúâËßíËâ≤ÂÇôË®ª
        async function clearAllPersonalNotes() {
            if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâËßíËâ≤ÂÇôË®ªÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                return;
            }

            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    // Êõ¥Êñ∞È°ØÁ§∫
                    updatePersonalNotesDisplay([]);

                    showSyncToast('ÂÇôË®ªÂ∑≤Ê∏ÖÈô§', 'ÊâÄÊúâËßíËâ≤ÂÇôË®ªÂ∑≤Ê∏ÖÈô§', 'info');
                }
            } catch (error) {
                console.error('Ê∏ÖÈô§ÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó:', error);
                alert('Ê∏ÖÈô§ÂÄã‰∫∫ÂÇôË®ªÂ§±Êïó: ' + error.message);
            }
        }

        // Âà™Èô§Â∞àÊ°àÂÇôË®ª
        window.deleteProjectNote = async function(index) {
            if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Â∞àÊ°àÂÇôË®ªÂóéÔºü')) {
                return;
            }

            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentProjectId = window.currentProjectId;

                if (assignments[currentProjectId]) {
                    let notesList = [];
                    if (assignments[currentProjectId].notes) {
                        try {
                            notesList = JSON.parse(assignments[currentProjectId].notes);
                        } catch (e) {
                            // Â¶ÇÊûúËß£ÊûêÂ§±ÊïóÔºåÂ∞áËàäÊ†ºÂºèËΩâÊèõÁÇ∫Èô£ÂàóÊ†ºÂºè
                            notesList = [{
                                timestamp: 'ËàäÂÇôË®ª',
                                content: assignments[currentProjectId].notes,
                                author: 'System'
                            }];
                        }
                    }

                    if (notesList[index]) {
                        // Âà™Èô§ÊåáÂÆöÁöÑÂÇôË®ª
                        notesList.splice(index, 1);
                        assignments[currentProjectId].notes = JSON.stringify(notesList);
                        assignments[currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // ÂÑ≤Â≠òËÆäÊõ¥
                        await teamDataManager.saveLocalChanges();

                        // Êõ¥Êñ∞Â∞àÊ°àÈÄ≤Â∫¶ÂΩàÁ™ó‰∏≠ÁöÑÈ°ØÁ§∫
                        const notesListDiv = document.getElementById('notesList');
                        if (notesListDiv) {
                            notesListDiv.innerHTML = formatNotes(assignments[currentProjectId].notes);
                        }

                        // Êõ¥Êñ∞‰ªªÂãôÂ∞èÂç°‰∏≠ÁöÑÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ãÈ°ØÁ§∫
                        const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                        if (projectNotesColumn) {
                            let updatedProjectNotesHtml = '';
                            if (assignments[currentProjectId].notes) {
                                try {
                                    const projectNotes = JSON.parse(assignments[currentProjectId].notes);
                                    if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                                        updatedProjectNotesHtml = `
                                            <div class="mb-3">
                                                <label class="form-label">Â∞àÊ°àÂÇôË®ªÊ≠∑Á®ã</label>
                                                <div class="card" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="card-body p-2">
                                                        ${projectNotes.map((note, index) => `
                                                            <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                                    <small class="text-muted">${note.author || 'System'}</small>
                                                                    <small class="text-muted">${note.timestamp}</small>
                                                                </div>
                                                                <div>${note.content}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                } catch (e) {
                                    // Ëß£ÊûêÂ§±ÊïóÊôÇÈ°ØÁ§∫Á©∫ÁôΩ
                                    updatedProjectNotesHtml = '';
                                }
                            }
                            projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                        }

                        showSyncToast('ÂÇôË®ªÂ∑≤Âà™Èô§', 'Â∞àÊ°àÂÇôË®ªÂ∑≤ÁßªÈô§', 'info');
                    }
                }
            } catch (error) {
                console.error('Âà™Èô§Â∞àÊ°àÂÇôË®ªÂ§±Êïó:', error);
                alert('Âà™Èô§Â∞àÊ°àÂÇôË®ªÂ§±Êïó: ' + error.message);
            }
        }

        // Êõ¥Êñ∞ËßíËâ≤ÂÇôË®ªÈ°ØÁ§∫
        function updatePersonalNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('personalNotesList');
            if (notesListDiv) {
                notesListDiv.innerHTML = formatPersonalNotes(notesList);
            }
        }

        // È°ØÁ§∫ÊàêÂì°Ë≥áË®ä
        function showMemberInfo(projectId, memberId) {
            try {
                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }

                const assignments = teamDataManager.getAllAssignments();
                const allMembers = teamDataManager.getAllMembers();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const memberInfo = allMembers[memberId];

                if (!project || !member) {
                    throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÂ∞àÊ°àÊàñÊàêÂì°');
                }

                const memberName = memberInfo?.name || memberId;
                const personalNotesCount = (member.personalNotes || []).length;
                const taskCardCount = Object.keys(member.taskCard || {}).length;

                // È°ØÁ§∫ÊàêÂì°Ë≥áË®äÊ®°ÊÖãÊ°Ü
                const memberInfoModalHtml = `
                    <div class="modal fade" id="memberInfoModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ÊàêÂì°Ë≥áË®ä - ${memberName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-user me-2"></i>Âü∫Êú¨Ë≥áË®ä</h6>
                                            <p class="mb-1"><strong>ÊàêÂì° IDÔºö</strong>${memberId}</p>
                                            <p class="mb-1"><strong>ÊàêÂì°ÂêçÁ®±Ôºö</strong>${memberName}</p>
                                            <p class="mb-1"><strong>Â∞àÊ°àËßíËâ≤Ôºö</strong><span class="badge bg-primary">${member.role}</span></p>
                                            <p class="mb-0"><strong>Âü∑Ë°åÁãÄÊÖãÔºö</strong>
                                                ${member.isExecuting ?
                                                    '<span class="badge bg-success">Âü∑Ë°å‰∏≠</span>' :
                                                    '<span class="badge bg-secondary">Êú™Âü∑Ë°å</span>'
                                                }
                                            </p>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-chart-bar me-2"></i>Ê¥ªÂãïÁµ±Ë®à</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-primary">${personalNotesCount}</div>
                                                        <small class="text-muted">ËßíËâ≤ÂÇôË®ª</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-success">${taskCardCount}</div>
                                                        <small class="text-muted">‰ªªÂãôÂ∞èÂç°</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-project-diagram me-2"></i>Â∞àÊ°àË≥áË®ä</h6>
                                            <p class="mb-1"><strong>Â∞àÊ°àÂêçÁ®±Ôºö</strong>${project.projectName}</p>
                                            <p class="mb-1"><strong>Â∞àÊ°àÁãÄÊÖãÔºö</strong>
                                                <span class="badge bg-${
                                                    project.status === 'active' ? 'success' :
                                                    project.status === 'paused' ? 'warning' :
                                                    project.status === 'completed' ? 'secondary' : 'info'
                                                }">${
                                                    project.status === 'active' ? 'ÈÄ≤Ë°å‰∏≠' :
                                                    project.status === 'paused' ? 'Êö´ÂÅú' :
                                                    project.status === 'completed' ? 'Â∑≤ÂÆåÊàê' :
                                                    project.status || 'Êú™Áü•ÁãÄÊÖã'
                                                }</span>
                                            </p>
                                            <p class="mb-0"><strong>ÊúÄÂæåÊõ¥Êñ∞Ôºö</strong>${project.lastUpdated || 'Êú™Áü•'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÈóúÈñâ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberInfoModal = document.getElementById('memberInfoModal');
                if (oldMemberInfoModal) oldMemberInfoModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberInfoModalHtml);

                const memberInfoModal = new bootstrap.Modal(document.getElementById('memberInfoModal'));
                memberInfoModal.show();

            } catch (error) {
                console.error('È°ØÁ§∫ÊàêÂì°Ë≥áË®äÂ§±Êïó:', error);
                alert('È°ØÁ§∫ÊàêÂì°Ë≥áË®äÂ§±Êïó: ' + error.message);
            }
        }

        // ÂÑ≤Â≠òÊàêÂì°ËÆäÊõ¥
        async function saveMemberChange(projectId, oldMemberId) {
            try {
                const newMemberId = document.getElementById('newMember').value;
                const newRole = document.getElementById('memberRole').value;

                // ‰ΩøÁî®ÂÖ®ÂüüÁöÑÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®ÔºåÁ¢∫‰øùËàáÊ≠∑Á®ãË®òÈåÑÂêåÊ≠•
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                }
                const assignments = teamDataManager.getAllAssignments();

                // Ê™¢Êü•Êñ∞ÊàêÂì°ÊòØÂê¶Â∑≤Á∂ìÂú®Áï∂ÂâçÂ∞àÊ°à‰∏≠ÔºàÈÅøÂÖçÈáçË§áÔºâ
                if (assignments[projectId].members && assignments[projectId].members[newMemberId] && newMemberId !== oldMemberId) {
                    alert(`${newMemberId} Â∑≤Á∂ìÂú®Ê≠§Â∞àÊ°à‰∏≠ÔºÅ\n‰∏ÄÂÄãÂ∞àÊ°àÂÖß‰∏çËÉΩÊúâÈáçË§áÁöÑÊàêÂì°„ÄÇ`);
                    return;
                }

                // ÂèñÂæóËàäÊàêÂì°Ë≥áÊñô
                const oldMemberData = assignments[projectId].members[oldMemberId];
                const oldRole = oldMemberData?.role;

                if (newMemberId !== oldMemberId) {
                    // Ê™¢Êü•Êñ∞ÊàêÂì°ÊòØÂê¶ÁúüÁöÑ‰∏çÂêåÔºàÈÅøÂÖçÈáçË§áÂàáÊèõÁöÑÂïèÈ°åÔºâ
                    console.log('ÊàêÂì°ËÆäÊõ¥Ê™¢Êü•:', {
                        oldMemberId,
                        newMemberId,
                        currentMembers: Object.keys(assignments[projectId].members)
                    });

                    // Â¶ÇÊûúÊõ¥ÊèõÊàêÂì°ÔºåÂà™Èô§ËàäÊàêÂì°
                    delete assignments[projectId].members[oldMemberId];

                    // Êñ∞Â¢ûÊñ∞ÊàêÂì°Ôºå‰øùÁïô‰ªªÂãôÂ∞èÂç°ÂíåÂÄã‰∫∫ÂÇôË®ªÁ≠âË≥áÊñô
                    assignments[projectId].members[newMemberId] = {
                        memberId: newMemberId,
                        role: newRole,
                        taskCard: oldMemberData.taskCard || {},
                        personalNotes: oldMemberData.personalNotes || [], // Ë§áË£ΩÂÄã‰∫∫ÂÇôË®ª
                        isExecuting: false // Êñ∞ÊàêÂì°È†êË®≠ÁÇ∫Êú™Âü∑Ë°åÁãÄÊÖã
                    };

                    // Ë®òÈåÑËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã - ÊàêÂì°ÁßªÈô§
                    if (window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // ÂèñÂæóÁúüÂØ¶ÊàêÂì°ÂßìÂêç
                        const oldMemberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;
                        const newMemberName = window.teamDataManager.getAllMembers()[newMemberId]?.name || newMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_removed',
                            memberId: oldMemberId,
                            memberName: oldMemberName,
                            role: oldRole,
                            details: `ÊàêÂì°ÂæûÂ∞àÊ°à‰∏≠ÁßªÈô§`
                        });

                        // Ë®òÈåÑËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã - ÊàêÂì°Âä†ÂÖ•
                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_assigned',
                            memberId: newMemberId,
                            memberName: newMemberName,
                            role: newRole,
                            details: `Êñ∞ÊàêÂì°Âä†ÂÖ•Â∞àÊ°à`
                        });
                    }
                } else {
                    // Â¶ÇÊûúÂè™ÊòØÊõ¥ÊîπËßíËâ≤
                    assignments[projectId].members[oldMemberId].role = newRole;

                    // Ë®òÈåÑËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã
                    if (oldRole !== newRole && window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // ÂèñÂæóÁúüÂØ¶ÊàêÂì°ÂßìÂêç
                        const memberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'role_changed',
                            memberId: oldMemberId,
                            memberName: memberName,
                            oldRole: oldRole,
                            newRole: newRole,
                            details: `ËßíËâ≤Âæû ${oldRole} ËÆäÊõ¥ÁÇ∫ ${newRole}`
                        });
                    }
                }

                // Êõ¥Êñ∞Â∞àÊ°àÁöÑÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
                assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                // ÂÑ≤Â≠òËÆäÊõ¥
                await teamDataManager.saveLocalChanges();

                alert(`ÊàêÂì°Â∑≤Âæû ${oldMemberId} ËÆäÊõ¥ÁÇ∫ ${newMemberId}\nËßíËâ≤: ${newRole}`);

                // ÈóúÈñâÊ®°ÊÖãÊ°Ü
                const memberModal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                if (memberModal) memberModal.hide();

                // Á´ãÂç≥ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢Ë≥áÊñô
                await loadDataDirectly();

                // ÁôºÈÄÅlocalStorageÊõ¥Êñ∞‰ø°ËôüÁ¢∫‰øùÂç≥ÊôÇÊõ¥Êñ∞
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'memberChange'
                }));

            } catch (error) {
                console.error('ÂÑ≤Â≠òÊàêÂì°ËÆäÊõ¥Â§±Êïó:', error);
                alert('ÂÑ≤Â≠òÊàêÂì°ËÆäÊõ¥Â§±Êïó: ' + error.message);
            }
        }

        // ÂÑ≤Â≠ò‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ
        async function saveTaskCard(projectId, memberId) {
            try {
                const taskContent = document.getElementById('taskContent').value;

                if (!taskContent.trim()) {
                    alert('‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ‰∏çËÉΩÁÇ∫Á©∫');
                    return;
                }

                // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                }
                const assignments = teamDataManager.getAllAssignments();

                // Êõ¥Êñ∞‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    if (!assignments[projectId].members[memberId].taskCard) {
                        assignments[projectId].members[memberId].taskCard = {};
                    }

                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    const currentTime = new Date().toISOString();

                    // Â¶ÇÊûúÂÖßÂÆπÊúâËÆäÊõ¥Ôºå‰øùÂ≠òÂà∞Ê≠∑Á®ã‰∏≠
                    if (taskCard.content && taskCard.content !== taskContent) {
                        if (!taskCard.history) {
                            taskCard.history = [];
                        }

                        // Ê∑ªÂä†Ê≠∑Á®ãË®òÈåÑ
                        taskCard.history.push({
                            timestamp: taskCard.lastUpdated || currentTime,
                            content: taskCard.content,
                            note: 'ÂÖßÂÆπÊõ¥Êñ∞',
                            author: 'KopylotA', // ErNexus Â∞àÊ°àÁöÑ testing ËßíËâ≤
                            version: `v${(taskCard.history.length + 1).toString().padStart(2, '0')}`
                        });

                        // ‰øùÁïôÊúÄËøë20Á≠ÜÊ≠∑Á®ãË®òÈåÑ
                        if (taskCard.history.length > 20) {
                            taskCard.history = taskCard.history.slice(-20);
                        }
                    }

                    taskCard.content = taskContent;
                    taskCard.lastUpdated = currentTime;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();

                    alert('‰ªªÂãôÂ∞èÂç°Â∑≤ÊàêÂäüÂÑ≤Â≠òÔºÅ');

                    // ÈóúÈñâÊ®°ÊÖãÊ°Ü
                    const taskModal = bootstrap.Modal.getInstance(document.getElementById('taskCardModal'));
                    if (taskModal) {
                        taskModal.hide();
                    }

                    // ÈáçÊñ∞ËºâÂÖ•È¶ñÈ†ÅË≥áÊñô
                    loadDataDirectly();

                } else {
                    throw new Error('Êâæ‰∏çÂà∞ÊåáÂÆöÁöÑÂ∞àÊ°àÊàñÊàêÂì°');
                }

            } catch (error) {
                console.error('ÂÑ≤Â≠ò‰ªªÂãôÂ∞èÂç°Â§±Êïó:', error);
                alert('ÂÑ≤Â≠ò‰ªªÂãôÂ∞èÂç°Â§±Êïó: ' + error.message);
            }
        }

        // Ë§áË£Ω‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ
        async function copyTaskCard() {
            try {
                const taskContent = document.getElementById('taskContent').value;

                // Áç≤ÂèñÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ã
                let projectNotesText = '';
                try {
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();
                    const currentProject = assignments[window.currentTaskCardTemplate?.projectId];

                    if (currentProject && currentProject.notes) {
                        const projectNotes = JSON.parse(currentProject.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesText = '\n\n=== Â∞àÊ°àÂÇôË®ªÊ≠∑Á®ã ===\n' +
                                projectNotes.map(note =>
                                    `${note.timestamp} [${note.author || 'System'}]: ${note.content}`
                                ).join('\n') + '\n';
                        }
                    }
                } catch (e) {
                }

                const textToCopy = taskContent + projectNotesText;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // Ë¶ñË¶∫ÂõûÈ•ã
                    const buttons = document.querySelectorAll('button[onclick="copyTaskCard()"]');
                    const button = buttons[0]; // ÂèñÂæóË§áË£ΩÊåâÈàï
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> Â∑≤Ë§áË£Ω';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-success');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Ë§áË£ΩÂ§±Êïó:', err);
                    alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÂÖßÂÆπ');
                });
            } catch (error) {
                console.error('Ë§áË£Ω‰ªªÂãôÂ∞èÂç°Â§±Êïó:', error);
                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÂÖßÂÆπ');
            }
        }

        // ÊÅ¢Âæ©Ê≠∑Âè≤ÁâàÊú¨ÂÖßÂÆπ
        function restoreHistoryVersion(timestamp, content) {
            try {
                if (confirm('Á¢∫ÂÆöË¶ÅÊÅ¢Âæ©Ê≠§Ê≠∑Âè≤ÁâàÊú¨ÂóéÔºüÁõÆÂâçÁöÑÁ∑®ËºØÂÖßÂÆπÂ∞áË¢´Ë¶ÜËìã„ÄÇ')) {
                    // Â∞áÊ≠∑Âè≤ÂÖßÂÆπÂ°´ÂÖ•ÊñáÂ≠óÂçÄÂüü
                    document.getElementById('taskContent').value = content;


                    alert('Â∑≤ÊÅ¢Âæ©Ê≠∑Âè≤ÁâàÊú¨ÂÖßÂÆπÔºåË´ãË®òÂæóÂÑ≤Â≠òËÆäÊõ¥„ÄÇ');
                }
            } catch (error) {
                console.error('ÊÅ¢Âæ©Ê≠∑Âè≤ÁâàÊú¨Â§±Êïó:', error);
                alert('ÊÅ¢Âæ©Ê≠∑Âè≤ÁâàÊú¨Â§±Êïó: ' + error.message);
            }
        }

        // Êõ¥Êñ∞‰ªªÂãôÂ∞èÂç° modal ÂÖßÂÆπÔºà‰∏çÈáçÊñ∞ÂâµÂª∫ modalÔºâ
        async function updateTaskCardModal(projectId, memberId) {
            try {
                // ÈáçÊñ∞ËºâÂÖ•Â∞àÊ°àË≥áÊñô
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const taskCard = member.taskCard;

                // ÈáçÊñ∞ÁîüÊàêÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ã HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">Â∞àÊ°àÂÇôË®ªÊ≠∑Á®ã</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // ÈáçÊñ∞ÁîüÊàê‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãË®òÈåÑ HTML
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ã</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="Âà™Èô§Ê≠§Ë®òÈåÑ">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">Êü•ÁúãÂÖßÂÆπ</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> ÊÅ¢Âæ©Ê≠§ÁâàÊú¨
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <label class="form-label">‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ã</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>Â∞öÁÑ°Ê≠∑Á®ãË®òÈåÑ</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // ÈáçÊñ∞ÁîüÊàêËßíËâ≤ÂÇôË®ª HTML
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">ËßíËâ≤ÂÇôË®ª</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">ËßíËâ≤ÂÇôË®ª</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>Â∞öÁÑ°ËßíËâ≤ÂÇôË®ªË®òÈåÑ</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Êõ¥Êñ∞ÁèæÊúâ modal ‰∏≠ÁöÑÂ∞àÊ°àÂÇôË®ªÊ≠∑Á®ã„ÄÅËßíËâ≤ÂÇôË®ª„ÄÅ‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãÂíåËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãÊ¨Ñ‰Ωç
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                const personalNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(3)');
                const taskHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(4)');
                const memberHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(5)');

                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = projectNotesHtml;
                }
                if (personalNotesColumn) {
                    personalNotesColumn.innerHTML = personalNotesHtml;
                }
                if (taskHistoryColumn) {
                    taskHistoryColumn.innerHTML = taskHistoryHtml;
                }
                if (memberHistoryColumn) {
                    // ÈáçÊñ∞ÁîüÊàêËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã
                    let updatedMemberHistoryHtml = '';
                    try {
                        if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                            updatedMemberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                        } else {
                            const currentProject = teamDataManager.getAllAssignments()[projectId];
                            const memberHistory = currentProject?.memberHistory || [];
                            if (memberHistory.length > 0) {
                                const actionLabels = {
                                    'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>ÊàêÂì°Âä†ÂÖ•',
                                    'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>ÊàêÂì°ÁßªÈô§',
                                    'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>ËßíËâ≤ËÆäÊõ¥'
                                };

                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                                <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                            </button>
                                        </div>
                                        <div class="card" style="max-height: 400px; overflow-y: auto;">
                                            <div class="card-body p-2">
                                                ${memberHistory.slice().reverse().map((entry, index) => `
                                                    <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <div class="small">
                                                                ${actionLabels[entry.action] || entry.action}
                                                                <strong>${entry.memberName}</strong>
                                                            </div>
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                        </div>
                                                        <div class="ps-3">
                                                            ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                            ${entry.oldRole && entry.newRole ? `
                                                                <div class="mt-1">
                                                                    <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                    <i class="fas fa-arrow-right mx-1 small"></i>
                                                                    <span class="badge bg-success small">${entry.newRole}</span>
                                                                </div>
                                                            ` : ''}
                                                            ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                                <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                            </button>
                                        </div>
                                        <div class="card">
                                            <div class="card-body p-2 text-center text-muted">
                                                <small>Â∞öÁÑ°ÊàêÂì°ËÆäÊõ¥Ë®òÈåÑ</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.warn('Êõ¥Êñ∞ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãÊôÇÁôºÁîüÈåØË™§:', error);
                        updatedMemberHistoryHtml = `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ã</label>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="Ê∏ÖÁ©∫ÊâÄÊúâÊ≠∑Á®ã">
                                        <i class="fas fa-trash"></i> Ê∏ÖÁ©∫
                                    </button>
                                </div>
                                <div class="card">
                                    <div class="card-body p-2 text-center text-muted">
                                        <small>ËºâÂÖ•Ê≠∑Á®ãÊôÇÁôºÁîüÈåØË™§</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    memberHistoryColumn.innerHTML = updatedMemberHistoryHtml;
                }

            } catch (error) {
                console.error('Êõ¥Êñ∞‰ªªÂãôÂ∞èÂç° modal ÂÖßÂÆπÂ§±Êïó:', error);
            }
        }

        // Âà™Èô§ÂñÆÁ≠Ü‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãË®òÈåÑ
        async function deleteTaskHistoryItem(projectId, memberId, timestamp) {
            try {
                if (!confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Ê≠∑Á®ãË®òÈåÑÂóéÔºü')) {
                    return;
                }

                // ËºâÂÖ•ÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard && taskCard.history) {
                        // ÁßªÈô§ÊåáÂÆöÊôÇÈñìÊà≥ÁöÑÊ≠∑Á®ãË®òÈåÑ
                        taskCard.history = taskCard.history.filter(record => record.timestamp !== timestamp);

                        // ÈáçÊñ∞Á∑®ËôüÁâàÊú¨
                        taskCard.history.forEach((record, index) => {
                            record.version = `v${(index + 1).toString().padStart(2, '0')}`;
                        });

                        // ÂÑ≤Â≠òËÆäÊõ¥
                        await teamDataManager.saveLocalChanges();

                        alert('Ê≠∑Á®ãË®òÈåÑÂ∑≤Âà™Èô§');

                        // Êõ¥Êñ∞ÁèæÊúâ modal ÁöÑÂÖßÂÆπËÄå‰∏çÈáçÊñ∞ÂâµÂª∫
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('Âà™Èô§Ê≠∑Á®ãË®òÈåÑÂ§±Êïó:', error);
                alert('Âà™Èô§Ê≠∑Á®ãË®òÈåÑÂ§±Êïó: ' + error.message);
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâ‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãË®òÈåÑ
        async function clearTaskHistory(projectId, memberId) {
            try {
                if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ‰ªªÂãôÂ∞èÂç°Ê≠∑Á®ãË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    return;
                }

                // ËºâÂÖ•ÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard) {
                        // Ê∏ÖÁ©∫Ê≠∑Á®ãË®òÈåÑ
                        taskCard.history = [];

                        // ÂÑ≤Â≠òËÆäÊõ¥
                        await teamDataManager.saveLocalChanges();

                        alert('ÊâÄÊúâÊ≠∑Á®ãË®òÈåÑÂ∑≤Ê∏ÖÁ©∫');

                        // Êõ¥Êñ∞ÁèæÊúâ modal ÁöÑÂÖßÂÆπËÄå‰∏çÈáçÊñ∞ÂâµÂª∫
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('Ê∏ÖÁ©∫Ê≠∑Á®ãË®òÈåÑÂ§±Êïó:', error);
                alert('Ê∏ÖÁ©∫Ê≠∑Á®ãË®òÈåÑÂ§±Êïó: ' + error.message);
            }
        }

        // Ê∏ÖÁ©∫ÊâÄÊúâËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãË®òÈåÑ
        async function clearMemberHistory(projectId) {
            try {
                if (!confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãË®òÈåÑÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                    return;
                }
                // ËºâÂÖ•ÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                if (teamDataManager.assignments[projectId]) {
                    // Áõ¥Êé•‰øÆÊîπ assignments ÂÖßÈÉ®Ë≥áÊñô
                    teamDataManager.assignments[projectId].memberHistory = [];
                    teamDataManager.assignments[projectId].lastUpdated = new Date().toISOString();

                    // ÂÑ≤Â≠òËÆäÊõ¥
                    await teamDataManager.saveLocalChanges();
                    alert('ÊâÄÊúâËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãË®òÈåÑÂ∑≤Ê∏ÖÁ©∫');

                    // Â¶ÇÊûú‰ªªÂãôÂ∞èÂç°Ê®°ÊÖãÊ°ÜÂ∑≤ÈñãÂïüÔºåÈúÄË¶ÅÈáçÊñ∞ËºâÂÖ•ÂÖßÂÆπ
                    const taskCardModal = document.getElementById('taskCardModal');
                    if (taskCardModal && taskCardModal.classList.contains('show')) {
                        // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢‰ª•Êõ¥Êñ∞ÊâÄÊúâÈ°ØÁ§∫
                        window.location.reload();
                    }
                }
            } catch (error) {
                console.error('Ê∏ÖÁ©∫ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãÂ§±Êïó:', error);
                alert('Ê∏ÖÁ©∫ËßíËâ≤ËÆäÊõ¥Ê≠∑Á®ãÂ§±Êïó: ' + error.message);
            }
        }

        // ÊÅ¢Âæ©È†êË®≠‰ªªÂãôÂ∞èÂç°ÂÖßÂÆπ
        function restoreDefaultTaskCard(projectId, memberId) {
            try {
                if (!window.currentTaskCardTemplate ||
                    window.currentTaskCardTemplate.projectId !== projectId ||
                    window.currentTaskCardTemplate.memberId !== memberId) {
                    alert('ÁÑ°Ê≥ïÂèñÂæóÈ†êË®≠ÁØÑÊú¨Ë≥áÊñô');
                    return;
                }

                // Á¢∫Ë™çÊòØÂê¶Ë¶ÅÊÅ¢Âæ©È†êË®≠
                if (confirm('Á¢∫ÂÆöË¶ÅÊÅ¢Âæ©È†êË®≠ÁØÑÊú¨ÂóéÔºüÊ≠§Êìç‰ΩúÂ∞áÊ∏ÖÈô§ÁõÆÂâçÁöÑÁ∑®ËºØÂÖßÂÆπ„ÄÇ')) {
                    // Â∞áÈ†êË®≠ÂÖßÂÆπÂ°´ÂÖ•ÊñáÂ≠óÂçÄÂüü
                    document.getElementById('taskContent').value = window.currentTaskCardTemplate.defaultContent;


                    // Ë¶ñË¶∫ÂõûÈ•ã
                    const buttons = document.querySelectorAll(`button[onclick*="restoreDefaultTaskCard"]`);
                    const button = buttons[0]; // ÂèñÂæóÊÅ¢Âæ©È†êË®≠ÊåâÈàï
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> Â∑≤ÊÅ¢Âæ©';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-warning');
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('ÊÅ¢Âæ©È†êË®≠‰ªªÂãôÂ∞èÂç°Â§±Êïó:', error);
                alert('ÊÅ¢Âæ©È†êË®≠Â§±Êïó: ' + error.message);
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÁõ¥Êé•Âü∑Ë°åÔºàÂª∂ÈÅ≤‰∏Ä‰∏ãÁ≠âË™çË≠âÈÄöÈÅéÔºâ
        window.addEventListener('DOMContentLoaded', () => {
            // Ê∑ªÂä†Â∞àÊ°àÂÇôË®ªÂà™Èô§ÊåâÈàïÁöÑ‰∫ã‰ª∂ÂßîË®ó
            document.addEventListener('click', function(event) {
                if (event.target.closest('.delete-project-note-btn')) {
                    const button = event.target.closest('.delete-project-note-btn');
                    const index = parseInt(button.getAttribute('data-index'));
                    if (!isNaN(index)) {
                        window.deleteProjectNote(index);
                    }
                }
            });

            // Á≠âÂæÖÊõ¥Èï∑ÊôÇÈñìÁ¢∫‰øù Google Drive API ÂÆåÂÖ®ÂàùÂßãÂåñ
            setTimeout(() => {
                // Âè™ÊúâÂú®Ë™çË≠âÈÄöÈÅéÂæåÊâçËºâÂÖ•
                const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
                if (isAuthenticated) {
                    loadDataDirectly();
                }
            }, 2000);
        });

        // Âö¥Ê†ºÁöÑË™çË≠âÊ™¢Êü• - ÁÑ°ÁπûÈÅéÊ©üÂà∂
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // Á¢∫‰øùÊú™Ë™çË≠âÊôÇÂÆåÂÖ®Èö±ËóèÊâÄÊúâË≥áÊñô
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner Â∑≤ÁßªÈô§
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // Á¶ÅÊ≠¢ÂàùÂßãÂåñ Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // Â¶ÇÊûúÂ∑≤Ë™çË≠âÔºåÈ°ØÁ§∫ÁôªÂá∫ÊåâÈàï
            showMainDashboard();
            // Ê™¢Êü• session ÊòØÂê¶ÈÅéÊúü
            checkSessionTimeout();
            return true;
        }
        
        // ÁßÅÈë∞È©óË≠âÂäüËÉΩ
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // È©óË≠â Google Drive Ë®≠ÂÆö
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = 'Ë´ãËº∏ÂÖ• Google Drive Ë®≠ÂÆö';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('Ë®≠ÂÆöÊ†ºÂºè‰∏çÂÆåÊï¥');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive Ë®≠ÂÆöÊ†ºÂºèÈåØË™§Ôºö${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = 'Ë´ãËº∏ÂÖ•ÁßÅÈë∞';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>È©óË≠â‰∏≠...';
            
            try {
                // ‰ΩøÁî® Web Crypto API È©óË≠âÁßÅÈë∞
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // ÂÑ≤Â≠ò Google Drive Ë®≠ÂÆöÂà∞ sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // Ë®≠ÂÆöÁôªÂÖ•ÁãÄÊÖãÂíåÊôÇÈñìÊà≥
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();

                        // Áõ¥Êé•ËºâÂÖ•Ë≥áÊñô
                        loadDataDirectly();

                        // ÂïüÂãïÊñ∞ÁöÑ Markdown Dashboard
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        } else {
                            console.error('MarkdownProjectDashboard È°ûÂà•Êú™ÂÆöÁæ©');
                        }
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = 'ÁßÅÈë∞È©óË≠âÂ§±ÊïóÔºåË´ãÁ¢∫Ë™çÁßÅÈë∞Ê≠£Á¢∫';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `È©óË≠âÈåØË™§Ôºö${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>È©óË≠â‰∏¶ÈÄ≤ÂÖ•';
            }
        });
        
        // ÂæûÊ™îÊ°àÂåØÂÖ•ÁßÅÈë∞
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // È°ØÁ§∫‰∏ª Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('devLogBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';
            // ÂêåÊ≠•ÂÇôË®ªÂäüËÉΩÂ∑≤Êï¥ÂêàÂà∞ÈáçÊñ∞ËºâÂÖ•ÊåâÈàï
            // document.getElementById('syncRoleNotesBtn').style.display = 'inline-block';
            document.getElementById('fixRolesBtn').style.display = 'inline-block';

            // Áõ¥Êé•ËºâÂÖ•Ë≥áÊñô
            setTimeout(loadDataDirectly, 500);
        }
        
        // ÁôªÂá∫ÂäüËÉΩ
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºüÁôªÂá∫ÂæåÈúÄË¶ÅÈáçÊñ∞ÂåØÂÖ•ÁßÅÈë∞„ÄÇ')) {
                // Ê∏ÖÈô§Ë™çË≠âÁãÄÊÖã
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // Èö±ËóèÁôªÂá∫ÊåâÈàïÂíåÂúòÈöäÁÆ°ÁêÜÊåâÈàï
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('devLogBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';
                document.getElementById('fixRolesBtn').style.display = 'none';

                // È°ØÁ§∫Ë™çË≠â‰ªãÈù¢
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner Â∑≤ÁßªÈô§
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // Ê∏ÖÁ©∫ÁßÅÈë∞Ëº∏ÂÖ•Ê¨Ñ
                document.getElementById('privateKeyInput').value = '';
                
                // Èö±ËóèÊàêÂäü/ÈåØË™§Ë®äÊÅØ
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('Áî®Êà∂Â∑≤ÁôªÂá∫ÔºåÈúÄË¶ÅÈáçÊñ∞Ë™çË≠â');
            }
        });
        
        // Ê™¢Êü• Session Ë∂ÖÊôÇÔºà30ÂàÜÈêòÔºâ
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';

            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30ÂàÜÈêò

                if (sessionAge > timeout) {
                    alert('ÊúÉË©±Â∑≤ÈÅéÊúüÔºåË´ãÈáçÊñ∞ÁôªÂÖ•');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // ÊØèÂàÜÈêòÊ™¢Êü•‰∏ÄÊ¨° session
        setInterval(checkSessionTimeout, 60000);

        // ÈáçÊñ∞ËºâÂÖ•ÂäüËÉΩÔºàÊï¥ÂêàÂêåÊ≠•Ôºâ
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            const refreshBtn = this;
            const originalText = refreshBtn.innerHTML;

            try {
                // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂêåÊ≠•‰∏≠...';

                // Âü∑Ë°åÂêåÊ≠•‰ªªÂãô
                if (window.googleDriveAPI) {
                    // 1. ÂêåÊ≠•ËßíËâ≤ÂÇôË®ª
                    try {
                        await window.googleDriveAPI.syncRoleNotesFromGitHub();
                        console.log('‚úÖ ËßíËâ≤ÂÇôË®ªÂêåÊ≠•ÂÆåÊàê');
                    } catch (error) {
                        console.error('ËßíËâ≤ÂÇôË®ªÂêåÊ≠•Â§±Êïó:', error);
                    }

                    // 2. Âæû Google Drive ÊãâÂèñË≥áÊñô
                    if (window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn()) {
                        try {
                            await pullFilesFromGoogleDrive();
                            console.log('‚úÖ Google Drive Ë≥áÊñôÂêåÊ≠•ÂÆåÊàê');
                        } catch (error) {
                            console.error('Google Drive ÂêåÊ≠•Â§±Êïó:', error);
                        }
                    }
                }

                // Á®çÁ≠â‰∏Ä‰∏ãËÆìÂêåÊ≠•ÂÆåÊàê
                setTimeout(() => {
                    location.reload();
                }, 500);

            } catch (error) {
                console.error('ÂêåÊ≠•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', error);
                // Âç≥‰ΩøÂ§±Êïó‰πüÈáçÊñ∞ËºâÂÖ•
                location.reload();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        });

        // ‰øÆÂæ©ËßíËâ≤ÊåâÈàï
        document.getElementById('fixRolesBtn').addEventListener('click', async function() {
            const fixBtn = this;
            const originalText = fixBtn.innerHTML;

            try {
                fixBtn.disabled = true;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰øÆÂæ©‰∏≠...';

                // Á¢∫‰øù Google Drive API Â∑≤ÁôªÂÖ•
                if (!window.googleDriveAPI || !window.googleDriveAPI.isAuthenticated) {
                    alert('‚ùå ÈúÄË¶ÅÂÖàÁôªÂÖ• Google Drive');
                    return;
                }

                // ËºâÂÖ•Ê≠£Á¢∫ÁöÑÊú¨Âú∞Ë≥áÊñô
                console.log('üìÅ ËºâÂÖ•Êú¨Âú∞Ê≠£Á¢∫Ë≥áÊñô...');
                const response = await fetch('config/project-assignments.json');
                const correctData = await response.json();

                console.log('‚úÖ Êú¨Âú∞Ë≥áÊñôËºâÂÖ•ÊàêÂäü');
                console.log('üìä Â∞àÊ°àÊï∏Èáè: ' + Object.keys(correctData.assignments).length);

                // Ê™¢Êü•ËßíËâ≤
                for (const [projectId, project] of Object.entries(correctData.assignments)) {
                    if (project.members) {
                        for (const [memberId, member] of Object.entries(project.members)) {
                            console.log(`${projectId} -> ${member.memberName}: ${member.role}`);
                        }
                    }
                }

                // Âº∑Âà∂‰∏äÂÇ≥Âà∞ Google Drive
                console.log('‚òÅÔ∏è ‰∏äÂÇ≥Âà∞ Google Drive...');
                await window.googleDriveAPI.saveFile('project-assignments.json', correctData, 'assignments');

                // Ê∏ÖÈô§ÁÄèË¶ΩÂô®Âø´Âèñ
                localStorage.removeItem('teamAssignments');
                localStorage.removeItem('cachedTeamMembers');
                localStorage.removeItem('teamMemberChanges');
                localStorage.removeItem('teamGroupChanges');

                console.log('üßπ Â∑≤Ê∏ÖÈô§Âø´Âèñ');
                alert('‚úÖ ‰øÆÂæ©ÂÆåÊàêÔºÅÈ†ÅÈù¢Â∞áÈáçÊñ∞ËºâÂÖ•');

                // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                setTimeout(() => window.location.reload(), 1000);

            } catch (error) {
                console.error('‚ùå ‰øÆÂæ©Â§±Êïó:', error);
                alert('‚ùå ‰øÆÂæ©Â§±Êïó: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = originalText;
            }
        });

        // Google Drive Ë®≠ÂÆöÊåâÈàï
        document.getElementById('gdriveSetupBtn').addEventListener('click', function() {
            window.open('setup-gdrive.html', '_blank');
        });

        // Push ÂäüËÉΩ (‰∏äÂÇ≥Âà∞Èõ≤Á´Ø)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰∏äÂÇ≥‰∏≠...';

                // Ê™¢Êü• Google Drive ÈÄ£Á∑ö
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API Êú™ËºâÂÖ•');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // Ëá™ÂãïËß∏ÁôºÁôªÂÖ•
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÁôªÂÖ•‰∏≠...';
                    showSyncToast('ÈúÄË¶ÅÁôªÂÖ•', 'Ê≠£Âú®ÈñãÂïü Google Drive ÁôªÂÖ•...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive ÁôªÂÖ•Â§±ÊïóÊàñË¢´ÂèñÊ∂à');
                        }
                        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰∏äÂÇ≥‰∏≠...';
                    } catch (loginError) {
                        console.error('‚ùå ÁôªÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', loginError);
                        throw new Error('Google Drive ÁôªÂÖ•Â§±Êïó: ' + loginError.message);
                    }
                }

                await pushLocalFilesToGoogleDrive();

                // ÊàêÂäüË®äÊÅØ
                showSyncToast('Êé®ÈÄÅÊàêÂäü', 'Êú¨Âú∞Ê™îÊ°àÂ∑≤Êé®ÈÄÅÂà∞ Google Drive', 'success');

            } catch (error) {
                console.error('ÂêåÊ≠•Â§±Êïó:', error);
                showSyncToast('ÂêåÊ≠•Â§±Êïó', error.message, 'error');
            } finally {
                // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull ÂäüËÉΩ (ÂæûÈõ≤Á´Ø‰∏ãËºâ)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰∏ãËºâ‰∏≠...';

                // Ê™¢Êü• Google Drive ÈÄ£Á∑ö
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API Êú™ËºâÂÖ•');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // Ëá™ÂãïËß∏ÁôºÁôªÂÖ•
                    pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÁôªÂÖ•‰∏≠...';
                    showSyncToast('ÈúÄË¶ÅÁôªÂÖ•', 'Ê≠£Âú®ÈñãÂïü Google Drive ÁôªÂÖ•...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive ÁôªÂÖ•Â§±ÊïóÊàñË¢´ÂèñÊ∂à');
                        }
                        pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ‰∏ãËºâ‰∏≠...';
                    } catch (loginError) {
                        console.error('‚ùå ÁôªÂÖ•ÈÅéÁ®ãÁôºÁîüÈåØË™§:', loginError);
                        throw new Error('Google Drive ÁôªÂÖ•Â§±Êïó: ' + loginError.message);
                    }
                }

                await pullFilesFromGoogleDrive();

                // Ê∏ÖÈô§Ë®òÊÜ∂È´î‰∏≠ÁöÑË≥áÊñô‰ª•Âº∑Âà∂ÈáçÊñ∞ËºâÂÖ•
                window.taskTemplatesData = null;

                // ‰øùÂ≠òÁï∂ÂâçÊú¨Âú∞ËÆäÊõ¥ÔºåÁÑ∂ÂæåÈáçÊñ∞ÂàùÂßãÂåñ TeamDataManager
                if (window.globalTeamDataManager) {

                    // ÂÖà‰øùÂ≠òÁï∂ÂâçÁöÑassignmentsÂà∞localStorage‰ΩúÁÇ∫ÂÇô‰ªΩ
                    const currentAssignments = window.globalTeamDataManager.getAllAssignments();
                    if (currentAssignments && Object.keys(currentAssignments).length > 0) {
                        localStorage.setItem('teamAssignments_backup', JSON.stringify(currentAssignments));
                        console.log('üíæ Áï∂ÂâçÁãÄÊÖãÂ∑≤ÂÇô‰ªΩ');
                    }

                    // Ê∏ÖÈô§ÁèæÊúâË≥áÊñô
                    window.globalTeamDataManager = null;
                    window.teamDataManager = null;

                    // ÈáçÊñ∞ÂâµÂª∫‰∏¶ÂàùÂßãÂåñ
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;

                    // Ê∏ÖÈô§ÂÇô‰ªΩÔºåÈÅøÂÖçÂπ≤Êìæ
                    localStorage.removeItem('teamAssignments_backup');
                    console.log('üßπ Â∑≤Ê∏ÖÈô§ÂÇô‰ªΩË≥áÊñô');
                }

                // ÊàêÂäüË®äÊÅØ
                showSyncToast('ÊãâÂèñÊàêÂäü', 'Â∑≤Âæû Google Drive ÊãâÂèñÊúÄÊñ∞Ë≥áÊñô', 'success');

                // Ëá™ÂãïÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÔºà‰∏çÈúÄË¶ÅÈáçÊñ∞Êï¥ÁêÜÈ†ÅÈù¢Ôºâ
                setTimeout(async () => {
                    try {
                        await loadDataDirectly();
                        showSyncToast('Êõ¥Êñ∞ÂÆåÊàê', 'È†ÅÈù¢Ë≥áÊñôÂ∑≤Êõ¥Êñ∞', 'success');
                    } catch (error) {
                        console.error('ÈáçÊñ∞ËºâÂÖ•Ë≥áÊñôÂ§±Êïó:', error);
                        if (confirm('Ëá™ÂãïÊõ¥Êñ∞Â§±ÊïóÔºåÊòØÂê¶ÊâãÂãïÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢Ôºü')) {
                            location.reload();
                        }
                    }
                }, 500);

            } catch (error) {
                console.error('ÊãâÂèñÂ§±Êïó:', error);
                showSyncToast('ÊãâÂèñÂ§±Êïó', error.message, 'error');
            } finally {
                // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // ÊâãÂãïÂêåÊ≠•ËßíËâ≤ÂÇôË®ª
        document.getElementById('syncRoleNotesBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ÂêåÊ≠•‰∏≠...';

                showSyncToast('ÈñãÂßãÂêåÊ≠•', 'Ê≠£Âú®Âæû GitHub ÂêåÊ≠•ËßíËâ≤ÂÇôË®ª...', 'info');

                // Ê™¢Êü• Google Drive API
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API Êú™ËºâÂÖ•');
                }

                // Âü∑Ë°åËßíËâ≤ÂÇôË®ªÂêåÊ≠•
                await window.googleDriveAPI.syncRoleNotesFromGitHub();

                showSyncToast('ÂêåÊ≠•ÂÆåÊàê', 'ËßíËâ≤ÂÇôË®ªÂ∑≤ÊàêÂäüÂêåÊ≠•ÔºÅ', 'success');

                // 1ÁßíÂæåËá™ÂãïÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('ËßíËâ≤ÂÇôË®ªÂêåÊ≠•Â§±Êïó:', error);
                showSyncToast('ÂêåÊ≠•Â§±Êïó', error.message, 'error');
            } finally {
                // ÊÅ¢Âæ©ÊåâÈàïÁãÄÊÖã
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Êé®ÈÄÅÊú¨Âú∞Ê™îÊ°àÂà∞ Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json',
                'config/task-templates.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    const fileName = filePath.split('/').pop();
                    let fileContent;

                    // Ê†πÊìöÊ™îÊ°àÈ°ûÂûãÈÅ∏ÊìáË≥áÊñô‰æÜÊ∫ê
                    if (fileName === 'team-members.json') {
                        // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager ‰∏≠ÁöÑË≥áÊñô
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                        }
                        const teamConfig = teamDataManager.teamConfig;
                        fileContent = JSON.stringify(teamConfig, null, 2);
                    } else if (fileName === 'project-assignments.json') {
                        // ‰ΩøÁî®ÂÖ®Âüü TeamDataManager ‰∏≠ÁöÑÂàÜÈÖçË≥áÊñô
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager Êú™ÂàùÂßãÂåñ');
                        }
                        const assignments = teamDataManager.getAllAssignments();
                        const constraints = teamDataManager.constraints;
                        const assignmentData = {
                            assignments: assignments,
                            constraints: constraints,
                            statistics: {
                                totalAssignments: Object.values(assignments).reduce((sum, project) => sum + Object.keys(project.members || {}).length, 0),
                                activeProjects: Object.values(assignments).filter(p => p.status === 'active').length,
                                completedProjects: Object.values(assignments).filter(p => p.status === 'completed').length,
                                membersInUse: new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size,
                                availableMembers: Object.keys(teamDataManager.getAllMembers()).length - new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size
                            }
                        };
                        fileContent = JSON.stringify(assignmentData, null, 2);
                    } else if (fileName === 'task-templates.json') {
                        // ‰ΩøÁî®Ë®òÊÜ∂È´î‰∏≠ÁöÑ‰ªªÂãôÁØÑÊú¨Ë≥áÊñô
                        if (window.taskTemplatesData) {
                            fileContent = JSON.stringify(window.taskTemplatesData, null, 2);
                        } else {
                            // Â¶ÇÊûúË®òÊÜ∂È´î‰∏≠Ê≤íÊúâÔºåËÆÄÂèñÊú¨Âú∞Ê™îÊ°à
                            const response = await fetch(filePath + '?v=' + Date.now());
                            if (!response.ok) {
                                throw new Error(`ÁÑ°Ê≥ïËÆÄÂèñ ${filePath}: ${response.statusText}`);
                            }
                            fileContent = await response.text();
                        }
                    } else {
                        // ÂÖ∂‰ªñÊ™îÊ°àÁõ¥Êé•ËÆÄÂèñÊú¨Âú∞Ê™îÊ°à
                        const response = await fetch(filePath + '?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`ÁÑ°Ê≥ïËÆÄÂèñ ${filePath}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    }

                    // Ëß£Êûê JSON Â≠ó‰∏≤ÁÇ∫Áâ©‰ª∂Âæå‰∏äÂÇ≥Âà∞ Google Drive
                    let dataToSave;
                    try {
                        dataToSave = JSON.parse(fileContent);
                    } catch (parseError) {
                        throw new Error(`${fileName} JSON Ëß£ÊûêÂ§±Êïó: ${parseError.message}`);
                    }

                    await window.googleDriveAPI.saveFile(fileName, dataToSave);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'ÂêåÊ≠•ÊàêÂäü'
                    });


                } catch (error) {
                    console.error(`‚ùå ${filePath} ÂêåÊ≠•Â§±Êïó:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // ÂêåÊ≠•Â∞àÊ°àÁãÄÊÖãÊ™îÊ°à (Â¶ÇÊûúÂ≠òÂú®)
            await syncProjectStatusFiles();

            // Ë®òÈåÑÂêåÊ≠•ÁµêÊûú
            logSyncResults(syncResults);

            return syncResults;
        }

        // Âæû Google Drive ÊãâÂèñÊ™îÊ°àÂà∞Êú¨Âú∞
        async function pullFilesFromGoogleDrive() {
            // Pull ÂâçÂÖàÂÇô‰ªΩÊú¨Âú∞ÁöÑ memberHistory
            const backupMemberHistory = {};
            try {
                const currentAssignments = window.teamDataManager.getAllAssignments();
                Object.keys(currentAssignments).forEach(projectId => {
                    if (currentAssignments[projectId].memberHistory) {
                        backupMemberHistory[projectId] = [...currentAssignments[projectId].memberHistory];
                    }
                });
            } catch (e) {
            }

            const filesToPull = [
                'team-members.json',
                'project-assignments.json',
                'task-templates.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {

                    // Âæû Google Drive ‰∏ãËºâÊ™îÊ°à
                    const wrappedContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!wrappedContent) {
                        console.log(`‚ö†Ô∏è ${fileName} ÁÑ°Ê≥ïÂæû Google Drive ËºâÂÖ•ÔºàÂèØËÉΩÊòØ API Êú™Ê∫ñÂÇôÊàñÊ™îÊ°à‰∏çÂ≠òÂú®Ôºâ`);
                        pullResults.push({
                            fileName: fileName,
                            success: false,
                            error: 'Google Drive API Êú™Ê∫ñÂÇôÊàñÊ™îÊ°à‰∏çÂ≠òÂú®'
                        });
                        continue;
                    }

                    // ÊèêÂèñÂØ¶ÈöõË≥áÊñô
                    let actualData = wrappedContent.data || wrappedContent;

                    // Â¶ÇÊûú data ÊòØÂ≠ó‰∏≤ÔºåÈúÄË¶ÅËß£ÊûêÊàêÁâ©‰ª∂
                    if (typeof actualData === 'string') {
                        try {
                            actualData = JSON.parse(actualData);
                        } catch (parseError) {
                            throw new Error(`${fileName} JSON Ëß£ÊûêÂ§±Êïó: ${parseError.message}`);
                        }
                    }

                    // È©óË≠âË≥áÊñôÊ†ºÂºè
                    if (!actualData || typeof actualData !== 'object') {
                        throw new Error(`${fileName} Ë≥áÊñôÊ†ºÂºèÈåØË™§`);
                    }

                    // ÂÑ≤Â≠òÂà∞ localStorageÔºàÊ®°Êì¨‰∏ãËºâÂà∞Êú¨Âú∞Ôºâ
                    let storageKey;
                    if (fileName === 'team-members.json') {
                        storageKey = 'cachedTeamMembers';
                    } else if (fileName === 'project-assignments.json') {
                        storageKey = 'cachedProjectAssignments';
                    } else if (fileName === 'task-templates.json') {
                        storageKey = 'cachedTaskTemplates';
                    }

                    if (storageKey) {
                        localStorage.setItem(storageKey, JSON.stringify(actualData));

                        // ÁâπÂà•ËôïÁêÜ project-assignments.jsonÔºöÊ∑±Â∫¶Âêà‰ΩµÂà∞ teamAssignments
                        if (fileName === 'project-assignments.json' && actualData.assignments) {
                            // È°ØÁ§∫Âæû Google Drive ÊãâÂèñÂà∞ÁöÑ ErShield Ë≥áÊñô
                            const erShieldFromCloud = actualData.assignments.ErShield;
                            if (erShieldFromCloud) {
                                const cloudMemberHistoryCount = erShieldFromCloud.memberHistory?.length || 0;
                                if (cloudMemberHistoryCount > 0) {
                                    console.log('üîç Google Drive ‰∏≠ÁöÑ ErShield memberHistory:', erShieldFromCloud.memberHistory);
                                }
                            }
                            // ÂèñÂæóÁï∂ÂâçÊú¨Âú∞ÁãÄÊÖã‰ΩúÁÇ∫ÂÇô‰ªΩ
                            const currentLocalState = localStorage.getItem('teamAssignments');
                            let mergedAssignments = actualData.assignments;

                            if (currentLocalState) {
                                try {
                                    const localAssignments = JSON.parse(currentLocalState);

                                    // Ê∑±Â∫¶Âêà‰ΩµÔºöÈõ≤Á´ØË≥áÊñôÂÑ™ÂÖàÔºåPull Âæå‰ª•Èõ≤Á´ØÁÇ∫Ê∫ñ
                                    Object.keys(mergedAssignments).forEach(projectId => {
                                        const localProject = localAssignments[projectId];

                                        // Pull Êìç‰Ωú‰ª•Èõ≤Á´ØË≥áÊñôÁÇ∫Ê∫ñÔºå‰∏çÊÅ¢Âæ©Êú¨Âú∞ memberHistory
                                        // (memberHistory Â∑≤Á∂ìÂæûÈõ≤Á´ØÊ≠£Á¢∫ËºâÂÖ•)

                                        if (mergedAssignments[projectId].members) {
                                            Object.keys(mergedAssignments[projectId].members).forEach(memberId => {
                                                const cloudMember = mergedAssignments[projectId].members[memberId];
                                                const localMember = localAssignments[projectId]?.members?.[memberId];

                                                // ‰ª•Èõ≤Á´ØË≥áÊñôÁÇ∫Ê∫ñÔºåÂêà‰Ωµ personalNotes
                                                if (localMember && localMember.personalNotes && localMember.personalNotes.length > 0) {
                                                    // ‰øùÁïôÊú¨Âú∞ÁöÑËßíËâ≤ÂÇôË®ª
                                                    cloudMember.personalNotes = localMember.personalNotes;
                                                }
                                            });
                                        }
                                    });
                                } catch (parseError) {
                                    console.warn('‚ö†Ô∏è Êú¨Âú∞ÁãÄÊÖãËß£ÊûêÂ§±ÊïóÔºå‰ΩøÁî®Èõ≤Á´ØË≥áÊñô:', parseError);
                                }
                            }

                            localStorage.setItem('teamAssignments', JSON.stringify(mergedAssignments));
                        }
                    }

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'ÊãâÂèñÊàêÂäü'
                    });


                } catch (error) {
                    console.error(`‚ùå ${fileName} ÊãâÂèñÂ§±Êïó:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // Ë®òÈåÑÊãâÂèñÁµêÊûú
            logPullResults(pullResults);

            // È°ØÁ§∫ÊãâÂèñÂæåÁöÑ memberHistory Êï∏Èáè
            try {
                const assignments = window.teamDataManager.getAllAssignments();
                Object.keys(assignments).forEach(projectId => {
                    const memberHistoryCount = assignments[projectId].memberHistory?.length || 0;
                });
            } catch (e) {
                console.warn('‚ö†Ô∏è ÁÑ°Ê≥ïÈ°ØÁ§∫ memberHistory Êï∏Èáè:', e);
            }

            // Âè™ÊúâÊàêÂäüÊãâÂèñÂà∞Ê™îÊ°àÊôÇÊâçÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
            const successfulPulls = pullResults.filter(result => result.success);
            if (successfulPulls.length > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }

            return pullResults;
        }

        // ÂêåÊ≠•Â∞àÊ°àÁãÄÊÖãÊ™îÊ°à
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // ÈÄôË£°ÂèØ‰ª•ËÆÄÂèñ project-status Ë≥áÊñôÂ§æ‰∏≠ÁöÑÊ™îÊ°à
                    // Áî±ÊñºÁÄèË¶ΩÂô®ÂÆâÂÖ®ÈôêÂà∂ÔºåÊàëÂÄëÂÖàË®òÈåÑÂà∞ localStorage
                } catch (error) {
                }
            }
        }

        // È°ØÁ§∫ÂêåÊ≠•ÈÄöÁü•
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>ÂâõÊâç</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // ÂâµÂª∫ toast ÂÆπÂô® (Â¶ÇÊûú‰∏çÂ≠òÂú®)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // Ê∑ªÂä†‰∏¶È°ØÁ§∫ toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // Ë®òÈåÑÊé®ÈÄÅÁµêÊûú
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // ÂÑ≤Â≠òÂà∞ localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // Âè™‰øùÁïôÊúÄËøë 50 Ê¨°Ë®òÈåÑ
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // Ë®òÈåÑÊãâÂèñÁµêÊûú
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // ÂÑ≤Â≠òÂà∞ localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // Âè™‰øùÁïôÊúÄËøë 50 Ê¨°Ë®òÈåÑ
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // Á∞°ÂåñÁâàÂúòÈöäÁÆ°ÁêÜ
        function showSimpleTeamManagement() {
            console.log('üìã È°ØÁ§∫Á∞°ÂåñÁâàÂúòÈöäÁÆ°ÁêÜÁïåÈù¢');

            const modalHtml = `
                <div class="modal fade" id="simpleTeamModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">ÂúòÈöäÁÆ°ÁêÜ (Á∞°ÂåñÁâà)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <h6>‚ö†Ô∏è ÂúòÈöäÁÆ°ÁêÜÁ≥ªÁµ±ËºâÂÖ•ÂïèÈ°å</h6>
                                    <p>ÂÆåÊï¥ÁöÑÂúòÈöäÁÆ°ÁêÜÁ≥ªÁµ±Êú™ËÉΩÊ≠£Á¢∫ËºâÂÖ•„ÄÇÈÄôÂèØËÉΩÊòØÁî±Êñº‰ª•‰∏ãÂéüÂõ†‰πã‰∏ÄÔºö</p>
                                    <ul>
                                        <li>JavaScript Ê™îÊ°àËºâÂÖ•Â§±Êïó</li>
                                        <li>ÁÄèË¶ΩÂô®Âø´ÂèñÂïèÈ°å</li>
                                        <li>Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å</li>
                                    </ul>
                                </div>

                                <h6>Ëß£Ê±∫ÊñπÊ°àÔºö</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="fas fa-sync-alt me-2"></i>ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.open('setup-gdrive.html', '_blank')">
                                        <i class="fab fa-google-drive me-2"></i>Ë®≠ÂÆö Google Drive
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearBrowserCache()">
                                        <i class="fas fa-trash me-2"></i>Ê∏ÖÈô§ÁÄèË¶ΩÂô®Âø´Âèñ
                                    </button>
                                </div>

                                <hr>

                                <h6>Áï∂ÂâçË≥áÊñôÁãÄÊÖãÔºö</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">Â∞àÊ°àË≥áÊñô</h6>
                                                <p class="card-text">
                                                    Â∑≤ËºâÂÖ•Â∞àÊ°à: <span id="simpleProjectCount">-</span><br>
                                                    Ë≥áÊñôÁÆ°ÁêÜÂô®ÁãÄÊÖã: <span id="simpleDataManagerStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">Á≥ªÁµ±ÁãÄÊÖã</h6>
                                                <p class="card-text">
                                                    TeamDataManager: <span id="simpleTDMStatus">-</span><br>
                                                    TeamManagement: <span id="simpleTMStatus">-</span><br>
                                                    Google Drive: <span id="simpleGDStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÈóúÈñâ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ÁßªÈô§ËàäÁöÑÊ®°ÊÖãÊ°Ü
            const existingModal = document.getElementById('simpleTeamModal');
            if (existingModal) {
                existingModal.remove();
            }

            // Ê∑ªÂä†Êñ∞ÁöÑÊ®°ÊÖãÊ°Ü
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Êõ¥Êñ∞ÁãÄÊÖã‰ø°ÊÅØ
            updateSimpleTeamModalStatus();

            // È°ØÁ§∫Ê®°ÊÖãÊ°Ü
            const modal = new bootstrap.Modal(document.getElementById('simpleTeamModal'));
            modal.show();
        }

        function updateSimpleTeamModalStatus() {
            // Êõ¥Êñ∞Â∞àÊ°àÊï∏Èáè
            const projectCount = window.teamDataManager ?
                Object.keys(window.teamDataManager.getAllAssignments()).length :
                'N/A';
            document.getElementById('simpleProjectCount').textContent = projectCount;

            // Êõ¥Êñ∞Ë≥áÊñôÁÆ°ÁêÜÂô®ÁãÄÊÖã
            const dataManagerStatus = window.teamDataManager ?
                (window.teamDataManager.isInitialized ? 'Â∑≤ÂàùÂßãÂåñ' : 'Êú™ÂàùÂßãÂåñ') :
                '‰∏çÂ≠òÂú®';
            document.getElementById('simpleDataManagerStatus').textContent = dataManagerStatus;

            // Êõ¥Êñ∞Á≥ªÁµ±ÁãÄÊÖã
            document.getElementById('simpleTDMStatus').textContent =
                window.TeamDataManager ? '‚úÖ Â∑≤ËºâÂÖ•' : '‚ùå Êú™ËºâÂÖ•';
            document.getElementById('simpleTMStatus').textContent =
                window.TeamManagement ? '‚úÖ Â∑≤ËºâÂÖ•' : '‚ùå Êú™ËºâÂÖ•';

            // Êõ¥Êñ∞ Google Drive ÁãÄÊÖã
            const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
            const googleDriveStatus = googleDriveConfig ?
                (window.googleDriveAPI && window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn() ?
                    '‚úÖ Â∑≤ÁôªÂÖ•' : '‚ö†Ô∏è Â∑≤Ë®≠ÂÆöÊú™ÁôªÂÖ•') :
                '‚ùå Êú™Ë®≠ÂÆö';
            document.getElementById('simpleGDStatus').textContent = googleDriveStatus;
        }

        function clearBrowserCache() {
            if (confirm('ÈÄôÂ∞áÊ∏ÖÈô§ÁÄèË¶ΩÂô®Âø´Âèñ‰∏¶ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢„ÄÇÁ¢∫ÂÆöË¶ÅÁπºÁ∫åÂóéÔºü')) {
                // Ê∏ÖÈô§ localStorage
                localStorage.clear();
                // Ê∏ÖÈô§ sessionStorageÔºà‰ΩÜ‰øùÁïôË™çË≠âÁãÄÊÖãÂíå Google Drive Ë®≠ÂÆöÔºâ
                const auth = sessionStorage.getItem('KEY_AUTHENTICATED');
                const loginTime = sessionStorage.getItem('LOGIN_TIME');
                const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
                sessionStorage.clear();
                if (auth) sessionStorage.setItem('KEY_AUTHENTICATED', auth);
                if (loginTime) sessionStorage.setItem('LOGIN_TIME', loginTime);
                if (googleDriveConfig) sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', googleDriveConfig);

                // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢ÔºåÊ∑ªÂä†ÊôÇÈñìÊà≥ÈÅøÂÖçÂø´Âèñ
                window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
            }
        }

        // ÂúòÈöäÁÆ°ÁêÜÂäüËÉΩ
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            console.log('üéØ ÂúòÈöäÁÆ°ÁêÜÊåâÈàïË¢´ÈªûÊìä');
            console.log('üîç Ê™¢Êü•Áõ∏ÈóúÁâ©‰ª∂Â≠òÂú®ÁãÄÊÖã:');
            console.log('- window.teamManagement:', !!window.teamManagement);
            console.log('- window.TeamDataManager:', !!window.TeamDataManager);
            console.log('- window.TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- bootstrap.Modal:', !!window.bootstrap?.Modal);

            // Â¶ÇÊûú teamManagement ‰∏çÂ≠òÂú®ÔºåÂòóË©¶ÂâµÂª∫ÂÇôÁî®ÂØ¶‰æã
            if (!window.teamManagement) {
                console.log('‚ö†Ô∏è teamManagement ÂØ¶‰æã‰∏çÂ≠òÂú®ÔºåÂòóË©¶ÂâµÂª∫ÂÇôÁî®ÂØ¶‰æã...');

                if (!window.TeamManagement) {
                    console.error('‚ùå TeamManagement È°ûÂà•‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®Á∞°ÂåñÁâàÂúòÈöäÁÆ°ÁêÜ');
                    // ÂâµÂª∫Á∞°ÂåñÁâàÂúòÈöäÁÆ°ÁêÜ
                    showSimpleTeamManagement();
                    return;
                }

                try {
                    window.teamManagement = new window.TeamManagement();
                } catch (error) {
                    console.error('‚ùå ÂâµÂª∫ÂÇôÁî®ÂØ¶‰æãÂ§±Êïó:', error);
                    alert('ÁÑ°Ê≥ïÂâµÂª∫ÂúòÈöäÁÆ°ÁêÜÁ≥ªÁµ±: ' + error.message);
                    return;
                }
            }

            console.log('‚úÖ teamManagement ÂØ¶‰æãÂ≠òÂú®');
            console.log('- dataManager:', !!window.teamManagement.dataManager);
            console.log('- uiComponents:', !!window.teamManagement.uiComponents);

            try {
                // Ê™¢Êü• dataManager ÊòØÂê¶Â∑≤ÂàùÂßãÂåñ
                if (window.teamManagement.dataManager && !window.teamManagement.dataManager.isInitialized) {
                    console.log('‚ö†Ô∏è dataManager Êú™ÂàùÂßãÂåñÔºåÂòóË©¶ÂàùÂßãÂåñ...');
                    window.teamManagement.dataManager.init().then(() => {
                        window.teamManagement.openTeamManagementDashboard();
                    }).catch(error => {
                        console.error('‚ùå dataManager ÂàùÂßãÂåñÂ§±Êïó:', error);
                        alert('Ë≥áÊñôÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂ§±Êïó: ' + error.message);
                    });
                } else {
                    console.log('‚úÖ dataManager Â∑≤Ê∫ñÂÇôÔºåÁõ¥Êé•ÈñãÂïüÂúòÈöäÁÆ°ÁêÜ');
                    window.teamManagement.openTeamManagementDashboard();
                }
            } catch (error) {
                console.error('‚ùå ÈñãÂïüÂúòÈöäÁÆ°ÁêÜÂ§±Êïó:', error);
                console.error('ÈåØË™§Â†ÜÁñä:', error.stack);
                alert('ÈñãÂïüÂúòÈöäÁÆ°ÁêÜÂ§±Êïó: ' + error.message);
            }
        });

        // Á†îÁôºË®òÈåÑÁ∞øÂäüËÉΩ
        document.getElementById('devLogBtn').addEventListener('click', function() {
            console.log('üìã Á†îÁôºË®òÈåÑÁ∞øÊåâÈàïË¢´ÈªûÊìä');
            window.location.href = 'dev-log.html';
        });

        // ÂïüÂãï Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìã DOMContentLoaded Ëß∏ÁôºÔºåÊ™¢Êü•È°ûÂà•ËºâÂÖ•ÁãÄÊÖã:');
            console.log('- TeamDataManager:', !!window.TeamDataManager);
            console.log('- TeamStatistics:', !!window.TeamStatistics);
            console.log('- TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- TeamManagement:', !!window.TeamManagement);
            console.log('- teamManagement ÂØ¶‰æã:', !!window.teamManagement);

            // Ê™¢Êü•ÊòØÂê¶Â∑≤ÈÄöÈÅéÁßÅÈë∞È©óË≠â
            if (!checkAuthentication()) {
                // Êú™È©óË≠âÁ¶ÅÊ≠¢ÂàùÂßãÂåñ Dashboard
                return;
            }
            // ÂÉÖÂú®Â∑≤È©óË≠âÊôÇÂàùÂßãÂåñ Dashboard
            try {

                // ÂàùÂßãÂåñÂúòÈöäË≥áÊñôÁÆ°ÁêÜÂô®
                if (!window.teamDataManager) {
                    // Âª∫Á´ãÂÖ®ÂüüÂñÆ‰æã
                    if (!window.globalTeamDataManager) {
                        window.globalTeamDataManager = new TeamDataManager();
                        await window.globalTeamDataManager.init();
                    }
                    window.teamDataManager = window.globalTeamDataManager;
                }

                // Ëá™ÂãïÂü∑Ë°å Pull Êìç‰ΩúÔºàÁôªÂÖ•ÂæåËá™ÂãïÂêåÊ≠•ÊúÄÊñ∞Ë≥áÊñôÔºâ
                if (window.googleDriveAPI && window.googleDriveAPI.isAuthenticated) {
                    try {
                        await pullFilesFromGoogleDrive();

                        // Ë®≠ÂÆöÂÆöÊôÇËá™Âãï PushÔºàÊØè5ÂàÜÈêòÔºâ
                        if (!window.autoPushInterval) {
                            window.autoPushInterval = setInterval(async () => {
                                try {
                                    if (window.teamDataManager) {
                                        await window.teamDataManager.saveLocalChanges();
                                    }
                                } catch (error) {
                                    console.warn('‚ö†Ô∏è ÂÆöÊôÇ Push Â§±Êïó:', error);
                                }
                            }, 5 * 60 * 1000); // ÊØè5ÂàÜÈêò
                        }

                        // Áï∂È†ÅÈù¢Âç≥Â∞áÈóúÈñâÊôÇÔºåËá™Âãï Push
                        if (!window.beforeUnloadListener) {
                            window.beforeUnloadListener = true;
                            window.addEventListener('beforeunload', (event) => {
                                if (window.teamDataManager) {
                                    // ÂêåÊ≠•ÂÑ≤Â≠òÔºàÊ≥®ÊÑèÔºöbeforeunload ‰∏≠ async ÂèØËÉΩ‰∏çÂèØÈù†Ôºâ
                                    try {
                                        const data = JSON.stringify({
                                            assignments: window.teamDataManager.getAllAssignments(),
                                            constraints: {}
                                        });
                                        localStorage.setItem('pendingPush', data);
                                        console.log('üíæ È†ÅÈù¢ÈóúÈñâÂâçÂ∑≤ÂÑ≤Â≠òÂæÖÂêåÊ≠•Ë≥áÊñô');
                                    } catch (e) {
                                        console.error('ÂÑ≤Â≠òÂ§±Êïó:', e);
                                    }
                                }
                            });
                        }

                        // È†ÅÈù¢ËºâÂÖ•ÊôÇÊ™¢Êü•ÊòØÂê¶ÊúâÂæÖÂêåÊ≠•ÁöÑË≥áÊñô
                        const pendingPush = localStorage.getItem('pendingPush');
                        if (pendingPush) {
                            try {
                                const data = JSON.parse(pendingPush);
                                await window.googleDriveAPI.saveFile('project-assignments.json', data);
                                localStorage.removeItem('pendingPush');
                            } catch (e) {
                                console.error('ÂêåÊ≠•ÂæÖËôïÁêÜË≥áÊñôÂ§±Êïó:', e);
                            }
                        }

                    } catch (error) {
                        console.warn('‚ö†Ô∏è Ëá™ÂãïÂêåÊ≠•Â§±ÊïóÔºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô:', error);
                    }
                } else {
                    console.log('‚ÑπÔ∏è Google Drive Êú™ÁôªÂÖ•Ôºå‰ΩøÁî®Êú¨Âú∞Ë≥áÊñô');
                }

                // Á´ãÂç≥ÂàùÂßãÂåñ DashboardÔºåËÆìÂÆÉËá™Â∑±Á≠âÂæÖ teamDataManager
                if (typeof MarkdownProjectDashboard !== 'undefined') {
                    window.markdownDashboard = new MarkdownProjectDashboard();
                } else {
                    console.error('MarkdownProjectDashboard È°ûÂà•Êú™ÂÆöÁæ©ÔºåÁ≠âÂæÖËºâÂÖ•...');
                    // Âª∂ÈÅ≤ÈáçË©¶
                    setTimeout(() => {
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        }
                    }, 500);
                }

                // Áõ£ËÅΩÂúòÈöäË≥áÊñôËÆäÊõ¥‰∫ã‰ª∂
                document.addEventListener('teamDataChanged', async (event) => {
                    console.log('üîÑ Êî∂Âà∞ÂúòÈöäË≥áÊñôËÆäÊõ¥‰∫ã‰ª∂:', event.detail);
                    try {
                        if (typeof loadDataDirectly === 'function') {
                            await loadDataDirectly();
                            console.log('‚úÖ È¶ñÈ†ÅË≥áÊñôÂ∑≤ÈáçÊñ∞ËºâÂÖ•');
                        } else {
                            console.warn('‚ö†Ô∏è loadDataDirectly ÂáΩÊï∏‰∏çÂ≠òÂú®');
                        }
                    } catch (error) {
                        console.error('‚ùå ÈáçÊñ∞ËºâÂÖ•È¶ñÈ†ÅË≥áÊñôÂ§±Êïó:', error);
                    }
                });

                // Áõ£ËÅΩ localStorage ËÆäÊõ¥ (Ë∑®Ë¶ñÁ™óÈÄö‰ø°)
                window.addEventListener('storage', async (event) => {
                    if (event.key === 'teamUpdateSignal' && event.newValue) {
                        try {
                            const signal = JSON.parse(event.newValue);
                            console.log('üîÑ Êî∂Âà∞ localStorage Êõ¥Êñ∞‰ø°Ëôü:', signal);

                            if (signal.action === 'teamDataUpdate') {
                                console.log('üîÑ Âü∑Ë°åÈ¶ñÈ†ÅË≥áÊñôÈáçÊñ∞ËºâÂÖ•...');
                                await window.loadDataDirectly();
                                console.log('‚úÖ È¶ñÈ†ÅË≥áÊñôÂ∑≤ÈÄöÈÅé localStorage ÈáçÊñ∞ËºâÂÖ•');
                            }
                        } catch (error) {
                            console.error('‚ùå localStorage Êõ¥Êñ∞‰ø°ËôüËôïÁêÜÂ§±Êïó:', error);
                        }
                    }
                });

                // Áõ£ËÅΩ localStorage ËÆäÊõ¥ (ÂêåË¶ñÁ™óÂÖßÁöÑÊâãÂãïÊ™¢Êü•)
                setInterval(() => {
                    try {
                        const signal = localStorage.getItem('teamUpdateSignal');
                        if (signal) {
                            const updateData = JSON.parse(signal);
                            const now = Date.now();
                            // Â¶ÇÊûú‰ø°ËôüÊòØÊúÄËøë1ÁßíÂÖßÁöÑÔºåÂü∑Ë°åÊõ¥Êñ∞
                            if (now - updateData.timestamp < 1000) {
                                console.log('üîÑ Ê™¢Ê∏¨Âà∞Êõ¥Êñ∞‰ø°ËôüÔºåÂü∑Ë°åÈáçÊñ∞ËºâÂÖ•...');
                                window.loadDataDirectly();
                                localStorage.removeItem('teamUpdateSignal');
                            }
                        }
                    } catch (e) {
                        // ÂøΩÁï•Ëß£ÊûêÈåØË™§
                    }
                }, 500);

            } catch (error) {
                console.error('Dashboard ÂàùÂßãÂåñÂ§±Êïó:', error);
            }
        });
    </script>
</body>
</html>