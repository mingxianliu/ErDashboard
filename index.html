<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™ç·¨çµ„ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="åŸºæ–¼ Markdown æª”æ¡ˆçš„å°ˆæ¡ˆé€²åº¦ç›£æ§å„€è¡¨æ¿">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                ä»»å‹™ç·¨çµ„ç³»çµ±
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">è¼‰å…¥ä¸­...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="åŒæ­¥æœ¬åœ°æª”æ¡ˆåˆ° Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="å¾ Google Drive æ‹‰å–æœ€æ–°è³‡æ–™åˆ°æœ¬åœ°">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> åœ˜éšŠç®¡ç†
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- ç§é‘°é©—è­‰ -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>ç§é‘°é©—è­‰
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">æ­¤ Dashboard éœ€è¦ Google Drive è¨­å®šå’Œç§é‘°æ‰èƒ½ä½¿ç”¨ã€‚è«‹ä¾åºåŒ¯å…¥ï¼š</p>

                    <!-- Google Drive è¨­å®šå€åŸŸ -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive è¨­å®š (JSON æ ¼å¼)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "æ‚¨çš„-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "YOUR_FOLDER_ID_HERE",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API è¨­å®šï¼Œåƒ…åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. åŒ¯å…¥ç§é‘° (PEM æ ¼å¼)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">ç§é‘°åƒ…åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ï¼Œä¸æœƒå‚³é€åˆ°ä»»ä½•ä¼ºæœå™¨</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>é©—è­‰ä¸¦é€²å…¥
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>å¾æª”æ¡ˆåŒ¯å…¥
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">ç§é‘°é©—è­‰å¤±æ•—</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        ç§é‘°é©—è­‰æˆåŠŸï¼æ­£åœ¨è¼‰å…¥ Dashboard...
                    </div>
                </div>
            </div>
        </div>


        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- å‹•æ…‹è¼‰å…¥çš„çµ±è¨ˆå…§å®¹æœƒæ’å…¥é€™è£¡ -->
        </div>

        <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- å‹•æ…‹è¼‰å…¥çš„å°ˆæ¡ˆå…§å®¹æœƒæ’å…¥é€™è£¡ -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // å˜—è©¦è¼‰å…¥ config.js (æœ¬åœ°ç‰ˆæœ¬)ï¼Œå¦‚æœå¤±æ•—å‰‡å¿½ç•¥ (ç·šä¸Šç‰ˆæœ¬)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250918t';
        configScript.onerror = () => {
            console.log('âš ï¸ config.js æœªæ‰¾åˆ°ï¼Œå°‡ä½¿ç”¨æ‰‹å‹•è¨­å®šæ¨¡å¼');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250918t"></script>
    <script src="js/team-data-manager.js?v=20250918u"></script>
    <script src="js/team-statistics.js?v=20250918u"></script>
    <script src="js/team-ui-components.js?v=20250920k"></script>
    <script src="js/team-management-main.js?v=20250920e"></script>
    <script src="js/markdown-dashboard-simple.js?v=20250920b"></script>
    <script>
        // ä½¿ç”¨ TeamDataManager è¼‰å…¥è³‡æ–™
        async function loadDataDirectly() {
            console.log('ğŸš€ ä½¿ç”¨ TeamDataManager è¼‰å…¥è³‡æ–™...');
            try {
                // ç¢ºä¿ TeamDataManager å­˜åœ¨
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager æœªè¼‰å…¥');
                }

                // åˆå§‹åŒ– TeamDataManager
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                // è¼‰å…¥ä»»å‹™ç¯„æœ¬è³‡æ–™ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥ï¼‰
                if (!window.taskTemplatesData) {
                    try {
                        // 1. å„ªå…ˆå¾æœ¬åœ°å¿«å–è¼‰å…¥
                        const cachedTemplates = localStorage.getItem('cachedTaskTemplates');
                        if (cachedTemplates) {
                            window.taskTemplatesData = JSON.parse(cachedTemplates);
                            console.log('âœ… å¾å¿«å–è¼‰å…¥ä»»å‹™ç¯„æœ¬:', Object.keys(window.taskTemplatesData.taskTemplates || {}));
                        } else {
                            // 2. å¾æœ¬åœ°æª”æ¡ˆè¼‰å…¥
                            const templateResponse = await fetch('config/task-templates.json?v=' + Date.now());
                            if (templateResponse.ok) {
                                window.taskTemplatesData = await templateResponse.json();
                                console.log('âœ… å¾æœ¬åœ°æª”æ¡ˆè¼‰å…¥ä»»å‹™ç¯„æœ¬:', Object.keys(window.taskTemplatesData.taskTemplates || {}));
                                // å„²å­˜åˆ°å¿«å–
                                localStorage.setItem('cachedTaskTemplates', JSON.stringify(window.taskTemplatesData));
                            }
                        }
                    } catch (templateError) {
                        console.warn('è¼‰å…¥ä»»å‹™ç¯„æœ¬å¤±æ•—:', templateError);
                        window.taskTemplatesData = { taskTemplates: {} };
                    }
                }

                // å¾ TeamDataManager ç²å–è³‡æ–™
                const assignments = teamDataManager.getAllAssignments();
                console.log('ğŸ“Š å¾ TeamDataManager è¼‰å…¥çš„è³‡æ–™:', assignments);

                const summaryCards = document.getElementById('summaryCards');
                const projectsList = document.getElementById('projectsList');

                if (assignments && Object.keys(assignments).length > 0) {
                    const projects = Object.values(assignments);
                    console.log('âœ… å°ˆæ¡ˆæ•¸é‡:', projects.length);

                    // é¡¯ç¤ºçµ±è¨ˆ
                    if (summaryCards) {
                        summaryCards.innerHTML = `
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">ç¸½å°ˆæ¡ˆæ•¸</h5>
                                        <h2>${projects.length}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">é€²è¡Œä¸­</h5>
                                        <h2>${projects.filter(p => p.status === 'active').length}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">ç¸½åƒèˆ‡æˆå“¡æ•¸</h5>
                                        <h2>${new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size}</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h5 class="card-title">å¹³å‡é€²åº¦</h5>
                                        <h2>${Math.round(projects.reduce((sum, p) => sum + p.progress, 0) / projects.length)}%</h2>
                                    </div>
                                </div>
                            </div>
                        `;
                        summaryCards.style.display = 'flex';
                    }

                    // é¡¯ç¤ºå°ˆæ¡ˆåˆ—è¡¨
                    if (projectsList) {
                        console.log('ğŸ“ é–‹å§‹ç”Ÿæˆå°ˆæ¡ˆåˆ—è¡¨ HTML...');
                        let html = '';

                        projects.forEach(project => {
                            console.log('å°ˆæ¡ˆ:', project.projectName);
                            const memberCount = Object.keys(project.members || {}).length;

                            // ç”Ÿæˆæˆå“¡åˆ—è¡¨
                            let membersHtml = '';
                            if (project.members && Object.keys(project.members).length > 0) {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">åœ˜éšŠæˆå“¡(${memberCount}):</h6>
                                            <span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status === 'active' ? 'é€²è¡Œä¸­' : 'å·²å®Œæˆ'}</span>
                                        </div>
                                `;
                                Object.values(project.members).forEach(member => {
                                    const memberNames = {
                                        'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                                        'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                                        'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                                        'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                                        'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                                        'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                                    };
                                    const memberName = memberNames[member.memberId] || member.memberId;
                                    const roleColors = {
                                        'frontend': '#007bff',
                                        'backend': '#28a745',
                                        'fullstack': '#ffc107',
                                        'testing': '#dc3545'
                                    };
                                    const roleColor = roleColors[member.role] || '#6c757d';

                                    // æ ¹æ“šçµ„åˆ¥è¨­å®šèƒŒæ™¯è‰²
                                    const memberGroup = member.memberId.split('-')[0]; // A, B, C
                                    const groupColors = {
                                        'A': '#e3f2fd', // æ·ºè—
                                        'B': '#e8f5e8', // æ·ºç¶ 
                                        'C': '#fff3e0'  // æ·ºæ©™
                                    };
                                    const groupBgColor = groupColors[memberGroup] || '#f8f9fa';

                                    membersHtml += `
                                        <div class="d-flex justify-content-between align-items-center p-3 mb-2 border rounded"
                                             style="background-color: ${groupBgColor};">
                                            <div class="d-flex align-items-center flex-grow-1">
                                                <div class="d-flex flex-column me-3" style="min-width: 80px;">
                                                    <div class="fw-bold mb-1">${memberName}</div>
                                                    <small class="text-muted">${member.memberId}</small>
                                                </div>
                                                <div class="d-flex align-items-center justify-content-end flex-grow-1 me-3">
                                                    <span class="badge px-3 py-2" style="background-color: ${roleColor}; font-size: 0.85em;">
                                                        ${member.role}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="d-flex gap-1">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCard('${project.projectId}', '${member.memberId}')" title="ç·¨è¼¯ä»»å‹™å°å¡">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="changeMember('${project.projectId}', '${member.memberId}')" title="è®Šæ›´æˆå“¡">
                                                    <i class="fas fa-user-edit"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                });
                                membersHtml += '</div>';
                            } else {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">åœ˜éšŠæˆå“¡(0):</h6>
                                            <span class="badge bg-${project.status === 'active' ? 'success' : 'secondary'}">${project.status === 'active' ? 'é€²è¡Œä¸­' : 'å·²å®Œæˆ'}</span>
                                        </div>
                                        <small class="text-muted">å°šæœªåˆ†é…æˆå“¡</small>
                                    </div>
                                `;
                            }

                            html += `
                                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                                    <div class="card mb-3" style="height: 420px;">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title text-truncate me-2" title="${project.projectName}">${project.projectName}</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="editProjectProgress('${project.projectId}')" title="èª¿æ•´é€²åº¦">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar d-flex align-items-center justify-content-center" style="width: ${project.progress}%">
                                                    <span class="fw-bold">${project.progress}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                ${membersHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        console.log('ğŸ¨ è¨­ç½®å°ˆæ¡ˆåˆ—è¡¨ HTML...');
                        projectsList.innerHTML = html;
                        projectsList.style.display = 'flex';
                        console.log('âœ… å°ˆæ¡ˆåˆ—è¡¨è¨­ç½®å®Œæˆä¸¦é¡¯ç¤º');
                    }
                } else {
                    console.warn('âš ï¸ è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–æ²’æœ‰ assignments');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // ç·¨è¼¯å°ˆæ¡ˆæˆå“¡ä»»å‹™å°å¡
        async function editProjectMember(projectId, memberId) {
            try {
                console.log('ğŸ”§ é–‹å§‹ç·¨è¼¯ä»»å‹™å°å¡:', projectId, memberId);

                // ä½¿ç”¨ TeamDataManager è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager æœªè¼‰å…¥');
                }

                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();

                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ: ${projectId}`);
                }

                const member = project.members[memberId];

                if (!member) {
                    alert('æ‰¾ä¸åˆ°æˆå“¡è³‡æ–™');
                    return;
                }

                // æˆå“¡åç¨±æ˜ å°„
                const memberNames = {
                    'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                    'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                    'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                    'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                    'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                    'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                };
                const memberName = memberNames[memberId] || memberId;

                // å¾ TeamDataManager è¼‰å…¥ä»»å‹™ç¯„æœ¬
                let taskTemplate = '';
                try {
                    // TeamDataManager æ‡‰è©²å·²ç¶“è¼‰å…¥äº†ä»»å‹™ç¯„æœ¬è³‡æ–™
                    if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                        const template = window.taskTemplatesData.taskTemplates[member.role];
                        if (template) {
                            taskTemplate = template.content;
                        }
                    }
                } catch (templateError) {
                    console.warn('è¼‰å…¥ä»»å‹™ç¯„æœ¬å¤±æ•—:', templateError);
                }

                // ç”Ÿæˆä»»å‹™å°å¡å…§å®¹ï¼ˆæ­£ç¢ºæ ¼å¼ï¼‰
                const taskCardContent = `ä½ ç¾åœ¨çš„è§’è‰²æ˜¯ã€Œ${project.projectName}ã€çš„ã€Œ${member.role}ã€ï¼Œä»£è™Ÿæ˜¯ã€Œ${memberName}ã€ï¼Œé–‹ç™¼çš„branch æ˜¯ã€Œ${memberName}ã€ï¼Œè‹¥ç„¡å‰‡createï¼Œè«‹ä¾å¾ªä¸‹åˆ—çš„ä»»å‹™æŒ‡å¼•ï¼š\n\n${taskTemplate}`;

                // ç›´æ¥ç·¨è¼¯ä»»å‹™å°å¡ï¼ˆä¸å†éœ€è¦é¸æ“‡æ¨¡æ…‹æ¡†ï¼‰
                editTaskCard(projectId, memberId);

            } catch (error) {
                console.error('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—: ' + error.message);
            }
        }

        // ç·¨è¼¯ä»»å‹™å°å¡
        async function editTaskCard(projectId, memberId) {
            try {

                // é‡æ–°è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];
                const member = project.members[memberId];

                const memberNames = {
                    'A-CC': 'Klauder', 'B-CC': 'Klauder', 'C-CC': 'Klauder',
                    'A-CA': 'KersirAjen', 'B-CA': 'KersirAjen', 'C-CA': 'KersirAjen',
                    'A-GI': 'Jaymenight', 'B-GI': 'Jaymenight', 'C-GI': 'Jaymenight',
                    'A-CI': 'Kodes', 'B-CI': 'Kodes', 'C-CI': 'Kodes',
                    'A-CS': 'Kersir', 'B-CS': 'Kersir', 'C-CS': 'Kersir',
                    'A-VC': 'Kopylot', 'B-VC': 'Kopylot', 'C-VC': 'Kopylot'
                };
                const memberName = memberNames[memberId] || memberId;

                // ç²å–ä»»å‹™ç¯„æœ¬
                let taskTemplate = '';
                if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                    const template = window.taskTemplatesData.taskTemplates[member.role];
                    if (template) {
                        taskTemplate = template.content;
                    }
                }

                const taskCardContent = `ä½ ç¾åœ¨çš„è§’è‰²æ˜¯ã€Œ${project.projectName}ã€çš„ã€Œ${member.role}ã€ï¼Œä»£è™Ÿæ˜¯ã€Œ${memberName}ã€ï¼Œé–‹ç™¼çš„branch æ˜¯ã€Œ${memberName}ã€ï¼Œè‹¥ç„¡å‰‡createï¼Œè«‹ä¾å¾ªä¸‹åˆ—çš„ä»»å‹™æŒ‡å¼•ï¼š\n\n${taskTemplate}`;

                // é¡¯ç¤ºä»»å‹™å°å¡ç·¨è¼¯æ¨¡æ…‹æ¡†
                const taskModalHtml = `
                    <div class="modal fade" id="taskCardModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ä»»å‹™å°å¡ç·¨è¼¯ - ${memberName}ï¼Œã€Œ${project.projectName}ã€å°ˆæ¡ˆçš„ã€Œ${member.role}ã€</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="taskContent" class="form-label">ä»»å‹™å°å¡å…§å®¹</label>
                                        <textarea class="form-control" id="taskContent" rows="20" style="min-height: 500px;">${taskCardContent}</textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="copyTaskCard()">
                                        <i class="fas fa-copy"></i> è¤‡è£½
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldTaskModal = document.getElementById('taskCardModal');
                if (oldTaskModal) oldTaskModal.remove();
                document.body.insertAdjacentHTML('beforeend', taskModalHtml);

                const taskModal = new bootstrap.Modal(document.getElementById('taskCardModal'));
                taskModal.show();

            } catch (error) {
                console.error('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—: ' + error.message);
            }
        }

        // ç·¨è¼¯å°ˆæ¡ˆé€²åº¦
        async function editProjectProgress(projectId) {
            try {

                // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                // è¨­å®šç•¶å‰å°ˆæ¡ˆè³‡æ–™ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
                window.currentProject = project;
                window.currentProjectId = projectId;

                // é¡¯ç¤ºé€²åº¦ç·¨è¼¯æ¨¡æ…‹æ¡†
                const progressModalHtml = `
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ç·¨è¼¯å°ˆæ¡ˆé€²åº¦ - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="projectProgress" class="form-label">å°ˆæ¡ˆé€²åº¦ (%)</label>
                                        <input type="range" class="form-range" id="projectProgress" min="0" max="100" value="${project.progress}" oninput="updateProgressDisplay(this.value)">
                                        <div class="text-center">
                                            <span id="progressDisplay" class="badge bg-primary">${project.progress}%</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectNotes" class="form-label">å°ˆæ¡ˆå‚™è¨»</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newNote" rows="3" placeholder="è¼¸å…¥æ–°çš„å‚™è¨»..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addNote()">
                                                <i class="fas fa-plus"></i> æ–°å¢å‚™è¨»
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllNotes()">
                                                <i class="fas fa-trash"></i> æ¸…é™¤æ‰€æœ‰å‚™è¨»
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="notesList">
                                                ${formatNotes(project.notes || '')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveProjectProgress('${projectId}')">
                                        <i class="fas fa-save"></i> å„²å­˜
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldProgressModal = document.getElementById('progressModal');
                if (oldProgressModal) oldProgressModal.remove();
                document.body.insertAdjacentHTML('beforeend', progressModalHtml);

                const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();

            } catch (error) {
                console.error('ç·¨è¼¯å°ˆæ¡ˆé€²åº¦å¤±æ•—:', error);
                alert('ç·¨è¼¯å°ˆæ¡ˆé€²åº¦å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°é€²åº¦é¡¯ç¤º
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
        }

        // æ ¼å¼åŒ–å‚™è¨»é¡¯ç¤º
        function formatNotes(notes) {
            if (!notes) return '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';

            try {
                const notesList = JSON.parse(notes);
                if (Array.isArray(notesList) && notesList.length > 0) {
                    return notesList.map(note =>
                        `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                            <div class="fw-bold small text-muted">${note.timestamp}</div>
                            <div>${note.content}</div>
                        </div>`
                    ).join('');
                }
            } catch (e) {
                // å¦‚æœä¸æ˜¯ JSON æ ¼å¼ï¼Œç•¶ä½œèˆŠæ ¼å¼çš„ç´”æ–‡å­—
                if (notes.trim()) {
                    return `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                <div class="fw-bold small text-muted">èˆŠå‚™è¨»</div>
                                <div>${notes}</div>
                            </div>`;
                }
            }
            return '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';
        }

        // æ–°å¢å‚™è¨»
        async function addNote() {
            const newNoteInput = document.getElementById('newNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('è«‹è¼¸å…¥å‚™è¨»å…§å®¹');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent
            };

            // ç²å–ç¾æœ‰å‚™è¨»
            let existingNotes = [];
            try {
                const currentProject = getCurrentProject();
                if (currentProject && currentProject.notes) {
                    existingNotes = JSON.parse(currentProject.notes);
                }
            } catch (e) {
                // å¦‚æœè§£æå¤±æ•—ï¼Œå»ºç«‹æ–°é™£åˆ—
                existingNotes = [];
            }

            if (!Array.isArray(existingNotes)) {
                existingNotes = [];
            }

            // æ–°å¢åˆ°é™£åˆ—é–‹é ­ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            existingNotes.unshift(newNote);

            // ç«‹å³å„²å­˜åˆ° TeamDataManager
            try {
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[window.currentProjectId]) {
                    assignments[window.currentProjectId].notes = JSON.stringify(existingNotes);
                    assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    // æ›´æ–°ç•¶å‰å°ˆæ¡ˆè³‡æ–™
                    window.currentProject.notes = JSON.stringify(existingNotes);
                }
            } catch (error) {
                console.error('å„²å­˜å‚™è¨»å¤±æ•—:', error);
                alert('å„²å­˜å‚™è¨»å¤±æ•—: ' + error.message);
                return;
            }

            // æ›´æ–°é¡¯ç¤º
            updateNotesDisplay(existingNotes);

            // æ¸…ç©ºè¼¸å…¥æ¡†
            newNoteInput.value = '';
        }

        // æ¸…é™¤æ‰€æœ‰å‚™è¨»
        async function clearAllNotes() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å‚™è¨»å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    // ç«‹å³å„²å­˜åˆ° TeamDataManager
                    const teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    const assignments = teamDataManager.getAllAssignments();

                    if (assignments[window.currentProjectId]) {
                        assignments[window.currentProjectId].notes = JSON.stringify([]);
                        assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        // æ›´æ–°ç•¶å‰å°ˆæ¡ˆè³‡æ–™
                        window.currentProject.notes = JSON.stringify([]);
                    }

                    // æ›´æ–°é¡¯ç¤º
                    updateNotesDisplay([]);
                } catch (error) {
                    console.error('æ¸…é™¤å‚™è¨»å¤±æ•—:', error);
                    alert('æ¸…é™¤å‚™è¨»å¤±æ•—: ' + error.message);
                }
            }
        }

        // æ›´æ–°å‚™è¨»é¡¯ç¤º
        function updateNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('notesList');
            if (notesList.length === 0) {
                notesListDiv.innerHTML = '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';
            } else {
                notesListDiv.innerHTML = notesList.map(note =>
                    `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <div>${note.content}</div>
                    </div>`
                ).join('');
            }
        }

        // ç²å–ç•¶å‰å°ˆæ¡ˆï¼ˆè¼”åŠ©å‡½æ•¸ï¼‰
        function getCurrentProject() {
            // é€™å€‹å‡½æ•¸éœ€è¦åœ¨æ¨¡æ…‹æ¡†é–‹å•Ÿæ™‚è¨­å®šç•¶å‰å°ˆæ¡ˆè³‡æ–™
            return window.currentProject || null;
        }

        // å„²å­˜å°ˆæ¡ˆé€²åº¦
        async function saveProjectProgress(projectId) {
            try {
                const progress = parseInt(document.getElementById('projectProgress').value);

                // ç²å–ç•¶å‰å‚™è¨»åˆ—è¡¨
                const notesListDiv = document.getElementById('notesList');
                let notesList = [];

                // å¾é¡¯ç¤ºçš„å‚™è¨»ä¸­æå–è³‡æ–™
                const noteElements = notesListDiv.querySelectorAll('.border-start');
                noteElements.forEach(element => {
                    const timestamp = element.querySelector('.text-muted').textContent;
                    const content = element.querySelector('div:last-child').textContent;
                    if (timestamp !== 'å°šç„¡å‚™è¨»') {
                        notesList.push({ timestamp, content });
                    }
                });

                // ä½¿ç”¨ TeamDataManager æ›´æ–°è³‡æ–™
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();

                // æ›´æ–°å°ˆæ¡ˆé€²åº¦å’Œå‚™è¨»
                if (assignments[projectId]) {
                    assignments[projectId].progress = progress;
                    assignments[projectId].notes = JSON.stringify(notesList);
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    alert(`å°ˆæ¡ˆé€²åº¦å·²æ›´æ–°ç‚º ${progress}%\nå‚™è¨»å·²å„²å­˜ (å…± ${notesList.length} ç­†)`);
                } else {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆ');
                }

                // é—œé–‰æ¨¡æ…‹æ¡†
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) progressModal.hide();

                // é‡æ–°è¼‰å…¥é é¢è³‡æ–™
                setTimeout(() => {
                    loadDataDirectly();
                }, 500);

            } catch (error) {
                console.error('å„²å­˜å°ˆæ¡ˆé€²åº¦å¤±æ•—:', error);
                alert('å„²å­˜å°ˆæ¡ˆé€²åº¦å¤±æ•—: ' + error.message);
            }
        }

        // è®Šæ›´æˆå“¡
        async function changeMember(projectId, memberId) {
            try {

                // è¼‰å…¥åœ˜éšŠæˆå“¡è³‡æ–™
                const teamDataManager = new window.TeamDataManager();
                await teamDataManager.init();
                const assignments = teamDataManager.getAllAssignments();
                const members = teamDataManager.getAllMembers();
                const project = assignments[projectId];
                const currentMember = project.members[memberId];

                // ç”Ÿæˆå¯ç”¨æˆå“¡é¸é …
                let memberOptions = '';
                Object.values(members).forEach(member => {
                    const selected = member.id === memberId ? 'selected' : '';
                    memberOptions += `<option value="${member.id}" ${selected}>${member.name} (${member.id})</option>`;
                });

                // é¡¯ç¤ºæˆå“¡è®Šæ›´æ¨¡æ…‹æ¡†
                const memberModalHtml = `
                    <div class="modal fade" id="memberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">è®Šæ›´æˆå“¡ - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newMember" class="form-label">é¸æ“‡æ–°æˆå“¡</label>
                                        <select class="form-select" id="newMember">
                                            ${memberOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberRole" class="form-label">è§’è‰²</label>
                                        <select class="form-select" id="memberRole">
                                            <option value="frontend" ${currentMember.role === 'frontend' ? 'selected' : ''}>å‰ç«¯é–‹ç™¼</option>
                                            <option value="backend" ${currentMember.role === 'backend' ? 'selected' : ''}>å¾Œç«¯é–‹ç™¼</option>
                                            <option value="fullstack" ${currentMember.role === 'fullstack' ? 'selected' : ''}>å…¨ç«¯é–‹ç™¼</option>
                                            <option value="testing" ${currentMember.role === 'testing' ? 'selected' : ''}>æ¸¬è©¦éƒ¨ç½²</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveMemberChange('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> å„²å­˜è®Šæ›´
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberModal = document.getElementById('memberModal');
                if (oldMemberModal) oldMemberModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberModalHtml);

                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();

            } catch (error) {
                console.error('è®Šæ›´æˆå“¡å¤±æ•—:', error);
                alert('è®Šæ›´æˆå“¡å¤±æ•—: ' + error.message);
            }
        }

        // å„²å­˜æˆå“¡è®Šæ›´
        async function saveMemberChange(projectId, oldMemberId) {
            try {
                const newMemberId = document.getElementById('newMember').value;
                const newRole = document.getElementById('memberRole').value;

                // é€™è£¡æ‡‰è©²è¦å‘¼å« TeamDataManager çš„æ–¹æ³•ä¾†å„²å­˜è®Šæ›´
                // æš«æ™‚å…ˆé¡¯ç¤ºæˆåŠŸè¨Šæ¯
                alert(`æˆå“¡å·²å¾ ${oldMemberId} è®Šæ›´ç‚º ${newMemberId}\nè§’è‰²: ${newRole}`);

                // é—œé–‰æ¨¡æ…‹æ¡†
                const memberModal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                if (memberModal) memberModal.hide();

                // é‡æ–°è¼‰å…¥é é¢è³‡æ–™
                loadDataDirectly();

            } catch (error) {
                console.error('å„²å­˜æˆå“¡è®Šæ›´å¤±æ•—:', error);
                alert('å„²å­˜æˆå“¡è®Šæ›´å¤±æ•—: ' + error.message);
            }
        }

        // è¤‡è£½ä»»å‹™å°å¡å…§å®¹
        function copyTaskCard() {
            try {
                const taskContent = document.getElementById('taskContent').value;
                const textToCopy = taskContent;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // è¦–è¦ºå›é¥‹
                    const button = event.target.closest('button');
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check"></i> å·²è¤‡è£½';
                    button.classList.remove('btn-success');
                    button.classList.add('btn-info');

                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('btn-info');
                        button.classList.add('btn-success');
                    }, 2000);
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹');
                });
            } catch (error) {
                console.error('è¤‡è£½ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹');
            }
        }

        // é é¢è¼‰å…¥æ™‚ç›´æ¥åŸ·è¡Œï¼ˆå»¶é²ä¸€ä¸‹ç­‰èªè­‰é€šéï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // åªæœ‰åœ¨èªè­‰é€šéå¾Œæ‰è¼‰å…¥
                const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
                if (isAuthenticated) {
                    loadDataDirectly();
                }
            }, 1000);
        });

        // åš´æ ¼çš„èªè­‰æª¢æŸ¥ - ç„¡ç¹éæ©Ÿåˆ¶
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // ç¢ºä¿æœªèªè­‰æ™‚å®Œå…¨éš±è—æ‰€æœ‰è³‡æ–™
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner å·²ç§»é™¤
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // ç¦æ­¢åˆå§‹åŒ– Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // å¦‚æœå·²èªè­‰ï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
            showMainDashboard();
            // æª¢æŸ¥ session æ˜¯å¦éæœŸ
            checkSessionTimeout();
            return true;
        }
        
        // ç§é‘°é©—è­‰åŠŸèƒ½
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // é©—è­‰ Google Drive è¨­å®š
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = 'è«‹è¼¸å…¥ Google Drive è¨­å®š';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('è¨­å®šæ ¼å¼ä¸å®Œæ•´');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive è¨­å®šæ ¼å¼éŒ¯èª¤ï¼š${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = 'è«‹è¼¸å…¥ç§é‘°';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é©—è­‰ä¸­...';
            
            try {
                // ä½¿ç”¨ Web Crypto API é©—è­‰ç§é‘°
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // å„²å­˜ Google Drive è¨­å®šåˆ° sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // è¨­å®šç™»å…¥ç‹€æ…‹å’Œæ™‚é–“æˆ³
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(() => {
                        document.getElementById('keyAuthentication').style.display = 'none';
                        showMainDashboard();

                        // ç›´æ¥è¼‰å…¥è³‡æ–™
                        loadDataDirectly();

                        // å•Ÿå‹•æ–°çš„ Markdown Dashboard
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        } else {
                            console.error('MarkdownProjectDashboard é¡åˆ¥æœªå®šç¾©');
                        }
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = 'ç§é‘°é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèªç§é‘°æ­£ç¢º';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `é©—è­‰éŒ¯èª¤ï¼š${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>é©—è­‰ä¸¦é€²å…¥';
            }
        });
        
        // å¾æª”æ¡ˆåŒ¯å…¥ç§é‘°
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // é¡¯ç¤ºä¸» Dashboard
        function showMainDashboard() {
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';

            // ç›´æ¥è¼‰å…¥è³‡æ–™
            setTimeout(loadDataDirectly, 500);
        }
        
        // ç™»å‡ºåŠŸèƒ½
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿç™»å‡ºå¾Œéœ€è¦é‡æ–°åŒ¯å…¥ç§é‘°ã€‚')) {
                // æ¸…é™¤èªè­‰ç‹€æ…‹
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // éš±è—ç™»å‡ºæŒ‰éˆ•å’Œåœ˜éšŠç®¡ç†æŒ‰éˆ•
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';

                // é¡¯ç¤ºèªè­‰ä»‹é¢
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner å·²ç§»é™¤
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // æ¸…ç©ºç§é‘°è¼¸å…¥æ¬„
                document.getElementById('privateKeyInput').value = '';
                
                // éš±è—æˆåŠŸ/éŒ¯èª¤è¨Šæ¯
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('ç”¨æˆ¶å·²ç™»å‡ºï¼Œéœ€è¦é‡æ–°èªè­‰');
            }
        });
        
        // æª¢æŸ¥ Session è¶…æ™‚ï¼ˆ30åˆ†é˜ï¼‰
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            
            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30åˆ†é˜
                
                if (sessionAge > timeout) {
                    alert('æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ session
        setInterval(checkSessionTimeout, 60000);

        // é‡æ–°è¼‰å…¥åŠŸèƒ½
        document.getElementById('refreshBtn').addEventListener('click', function() {
            location.reload();
        });

        // Push åŠŸèƒ½ (ä¸Šå‚³åˆ°é›²ç«¯)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';

                // æª¢æŸ¥ Google Drive é€£ç·š
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API æœªè¼‰å…¥');
                }

                if (!window.googleDriveAPI.isAuthenticated) {
                    console.log('ğŸ” Google Drive æœªç™»å…¥ï¼Œé–‹å§‹è‡ªå‹•ç™»å…¥æµç¨‹...');
                    // è‡ªå‹•è§¸ç™¼ç™»å…¥
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å…¥ä¸­...';
                    showSyncToast('éœ€è¦ç™»å…¥', 'æ­£åœ¨é–‹å•Ÿ Google Drive ç™»å…¥...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        console.log('ğŸ” ç™»å…¥çµæœ:', loginSuccess);
                        if (!loginSuccess) {
                            throw new Error('Google Drive ç™»å…¥å¤±æ•—æˆ–è¢«å–æ¶ˆ');
                        }
                        console.log('âœ… Google Drive ç™»å…¥æˆåŠŸï¼Œç¹¼çºŒæ¨é€æ“ä½œ');
                        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
                    } catch (loginError) {
                        console.error('âŒ ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤:', loginError);
                        throw new Error('Google Drive ç™»å…¥å¤±æ•—: ' + loginError.message);
                    }
                }

                await pushLocalFilesToGoogleDrive();

                // æˆåŠŸè¨Šæ¯
                showSyncToast('æ¨é€æˆåŠŸ', 'æœ¬åœ°æª”æ¡ˆå·²æ¨é€åˆ° Google Drive', 'success');

            } catch (error) {
                console.error('åŒæ­¥å¤±æ•—:', error);
                showSyncToast('åŒæ­¥å¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull åŠŸèƒ½ (å¾é›²ç«¯ä¸‹è¼‰)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';

                // æª¢æŸ¥ Google Drive é€£ç·š
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API æœªè¼‰å…¥');
                }

                if (!window.googleDriveAPI.isAuthenticated) {
                    console.log('ğŸ” Google Drive æœªç™»å…¥ï¼Œé–‹å§‹è‡ªå‹•ç™»å…¥æµç¨‹...');
                    // è‡ªå‹•è§¸ç™¼ç™»å…¥
                    pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å…¥ä¸­...';
                    showSyncToast('éœ€è¦ç™»å…¥', 'æ­£åœ¨é–‹å•Ÿ Google Drive ç™»å…¥...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        console.log('ğŸ” ç™»å…¥çµæœ:', loginSuccess);
                        if (!loginSuccess) {
                            throw new Error('Google Drive ç™»å…¥å¤±æ•—æˆ–è¢«å–æ¶ˆ');
                        }
                        console.log('âœ… Google Drive ç™»å…¥æˆåŠŸï¼Œç¹¼çºŒæ‹‰å–æ“ä½œ');
                        pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';
                    } catch (loginError) {
                        console.error('âŒ ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤:', loginError);
                        throw new Error('Google Drive ç™»å…¥å¤±æ•—: ' + loginError.message);
                    }
                }

                await pullFilesFromGoogleDrive();

                // æ¸…é™¤è¨˜æ†¶é«”ä¸­çš„è³‡æ–™ä»¥å¼·åˆ¶é‡æ–°è¼‰å…¥
                window.taskTemplatesData = null;

                // æˆåŠŸè¨Šæ¯
                showSyncToast('æ‹‰å–æˆåŠŸ', 'å·²å¾ Google Drive æ‹‰å–æœ€æ–°è³‡æ–™', 'success');

                // å»ºè­°é‡æ–°è¼‰å…¥é é¢
                setTimeout(() => {
                    if (confirm('è³‡æ–™å·²æ›´æ–°ï¼Œæ˜¯å¦é‡æ–°è¼‰å…¥é é¢ä»¥é¡¯ç¤ºæœ€æ–°å…§å®¹ï¼Ÿ')) {
                        location.reload();
                    }
                }, 1000);

            } catch (error) {
                console.error('æ‹‰å–å¤±æ•—:', error);
                showSyncToast('æ‹‰å–å¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // æ¨é€æœ¬åœ°æª”æ¡ˆåˆ° Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json',
                'config/task-templates.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    console.log(`ğŸ”„ åŒæ­¥æª”æ¡ˆ: ${filePath}`);
                    const fileName = filePath.split('/').pop();
                    let fileContent;

                    // æ ¹æ“šæª”æ¡ˆé¡å‹é¸æ“‡è³‡æ–™ä¾†æº
                    if (fileName === 'team-members.json') {
                        // ä½¿ç”¨ TeamDataManager ä¸­çš„è³‡æ–™
                        const teamDataManager = new window.TeamDataManager();
                        await teamDataManager.init();
                        const teamConfig = teamDataManager.teamConfig;
                        fileContent = JSON.stringify(teamConfig, null, 2);
                    } else if (fileName === 'project-assignments.json') {
                        // ä½¿ç”¨ TeamDataManager ä¸­çš„åˆ†é…è³‡æ–™
                        const teamDataManager = new window.TeamDataManager();
                        await teamDataManager.init();
                        const assignments = teamDataManager.getAllAssignments();
                        const constraints = teamDataManager.constraints;
                        const assignmentData = {
                            assignments: assignments,
                            constraints: constraints,
                            statistics: {
                                totalAssignments: Object.values(assignments).reduce((sum, project) => sum + Object.keys(project.members || {}).length, 0),
                                activeProjects: Object.values(assignments).filter(p => p.status === 'active').length,
                                completedProjects: Object.values(assignments).filter(p => p.status === 'completed').length,
                                membersInUse: new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size,
                                availableMembers: Object.keys(teamDataManager.getAllMembers()).length - new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size
                            }
                        };
                        fileContent = JSON.stringify(assignmentData, null, 2);
                    } else if (fileName === 'task-templates.json') {
                        // ä½¿ç”¨è¨˜æ†¶é«”ä¸­çš„ä»»å‹™ç¯„æœ¬è³‡æ–™
                        if (window.taskTemplatesData) {
                            fileContent = JSON.stringify(window.taskTemplatesData, null, 2);
                        } else {
                            // å¦‚æœè¨˜æ†¶é«”ä¸­æ²’æœ‰ï¼Œè®€å–æœ¬åœ°æª”æ¡ˆ
                            const response = await fetch(filePath + '?v=' + Date.now());
                            if (!response.ok) {
                                throw new Error(`ç„¡æ³•è®€å– ${filePath}: ${response.statusText}`);
                            }
                            fileContent = await response.text();
                        }
                    } else {
                        // å…¶ä»–æª”æ¡ˆç›´æ¥è®€å–æœ¬åœ°æª”æ¡ˆ
                        const response = await fetch(filePath + '?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`ç„¡æ³•è®€å– ${filePath}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    }

                    // ä¸Šå‚³åˆ° Google Drive
                    await window.googleDriveAPI.saveFile(fileName, fileContent);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'åŒæ­¥æˆåŠŸ'
                    });

                    console.log(`âœ… ${fileName} åŒæ­¥å®Œæˆ`);

                } catch (error) {
                    console.error(`âŒ ${filePath} åŒæ­¥å¤±æ•—:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // åŒæ­¥å°ˆæ¡ˆç‹€æ…‹æª”æ¡ˆ (å¦‚æœå­˜åœ¨)
            await syncProjectStatusFiles();

            // è¨˜éŒ„åŒæ­¥çµæœ
            logSyncResults(syncResults);

            return syncResults;
        }

        // å¾ Google Drive æ‹‰å–æª”æ¡ˆåˆ°æœ¬åœ°
        async function pullFilesFromGoogleDrive() {
            const filesToPull = [
                'team-members.json',
                'project-assignments.json',
                'task-templates.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {
                    console.log(`ğŸ”„ å¾ Google Drive æ‹‰å–æª”æ¡ˆ: ${fileName}`);

                    // å¾ Google Drive ä¸‹è¼‰æª”æ¡ˆ
                    const wrappedContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!wrappedContent) {
                        throw new Error(`Google Drive ä¸­æ‰¾ä¸åˆ° ${fileName}`);
                    }

                    // æå–å¯¦éš›è³‡æ–™
                    let actualData = wrappedContent.data || wrappedContent;

                    // å¦‚æœ data æ˜¯å­—ä¸²ï¼Œéœ€è¦è§£ææˆç‰©ä»¶
                    if (typeof actualData === 'string') {
                        try {
                            actualData = JSON.parse(actualData);
                        } catch (parseError) {
                            throw new Error(`${fileName} JSON è§£æå¤±æ•—: ${parseError.message}`);
                        }
                    }

                    // é©—è­‰è³‡æ–™æ ¼å¼
                    if (!actualData || typeof actualData !== 'object') {
                        throw new Error(`${fileName} è³‡æ–™æ ¼å¼éŒ¯èª¤`);
                    }

                    // å„²å­˜åˆ° localStorageï¼ˆæ¨¡æ“¬ä¸‹è¼‰åˆ°æœ¬åœ°ï¼‰
                    let storageKey;
                    if (fileName === 'team-members.json') {
                        storageKey = 'cachedTeamMembers';
                    } else if (fileName === 'project-assignments.json') {
                        storageKey = 'cachedProjectAssignments';
                    } else if (fileName === 'task-templates.json') {
                        storageKey = 'cachedTaskTemplates';
                    }

                    if (storageKey) {
                        localStorage.setItem(storageKey, JSON.stringify(actualData));
                    }

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'æ‹‰å–æˆåŠŸ'
                    });

                    console.log(`âœ… ${fileName} æ‹‰å–å®Œæˆ`);

                } catch (error) {
                    console.error(`âŒ ${fileName} æ‹‰å–å¤±æ•—:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // è¨˜éŒ„æ‹‰å–çµæœ
            logPullResults(pullResults);

            return pullResults;
        }

        // åŒæ­¥å°ˆæ¡ˆç‹€æ…‹æª”æ¡ˆ
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // é€™è£¡å¯ä»¥è®€å– project-status è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
                    // ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘å€‘å…ˆè¨˜éŒ„åˆ° localStorage
                    console.log(`ğŸ“Š æª¢æŸ¥å°ˆæ¡ˆ ${project} ç‹€æ…‹æª”æ¡ˆ`);
                } catch (error) {
                    console.log(`âš ï¸ å°ˆæ¡ˆ ${project} ç„¡ç‹€æ…‹æª”æ¡ˆ`);
                }
            }
        }

        // é¡¯ç¤ºåŒæ­¥é€šçŸ¥
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>å‰›æ‰</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // å‰µå»º toast å®¹å™¨ (å¦‚æœä¸å­˜åœ¨)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // æ·»åŠ ä¸¦é¡¯ç¤º toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // è¨˜éŒ„æ¨é€çµæœ
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // å„²å­˜åˆ° localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // åªä¿ç•™æœ€è¿‘ 50 æ¬¡è¨˜éŒ„
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('ğŸ“ æ¨é€è¨˜éŒ„å·²ä¿å­˜:', syncLog);
        }

        // è¨˜éŒ„æ‹‰å–çµæœ
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // å„²å­˜åˆ° localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // åªä¿ç•™æœ€è¿‘ 50 æ¬¡è¨˜éŒ„
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
            console.log('ğŸ“ æ‹‰å–è¨˜éŒ„å·²ä¿å­˜:', pullLog);
        }

        // åœ˜éšŠç®¡ç†åŠŸèƒ½
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            if (window.teamManagement) {
                window.teamManagement.openTeamManagementDashboard();
            }
        });

        // å•Ÿå‹• Dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // æª¢æŸ¥æ˜¯å¦å·²é€šéç§é‘°é©—è­‰
            if (!checkAuthentication()) {
                // æœªé©—è­‰ç¦æ­¢åˆå§‹åŒ– Dashboard
                return;
            }
            // åƒ…åœ¨å·²é©—è­‰æ™‚åˆå§‹åŒ– Dashboard
            try {
                console.log('é–‹å§‹åˆå§‹åŒ– Markdown Dashboard...');

                // åˆå§‹åŒ–åœ˜éšŠè³‡æ–™ç®¡ç†å™¨
                if (!window.teamDataManager) {
                    console.log('ğŸ”„ å‰µå»ºåœ˜éšŠè³‡æ–™ç®¡ç†å™¨...');
                    window.teamDataManager = new TeamDataManager();

                    // éé˜»å¡å¼åˆå§‹åŒ–ï¼Œè®“ Dashboard è‡ªå·±ç­‰å¾…
                    window.teamDataManager.init().then(() => {
                        console.log('âœ… åœ˜éšŠè³‡æ–™ç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                    }).catch(error => {
                        console.log('âš ï¸ åœ˜éšŠè³‡æ–™ç®¡ç†å™¨åˆå§‹åŒ–å¤±æ•— (å¯èƒ½æœªç™»å…¥ Google Drive):', error.message);
                        // ç¢ºä¿æ¨™è¨˜ç‚ºæœªåˆå§‹åŒ–
                        window.teamDataManager.isInitialized = false;
                    });
                }

                // ç«‹å³åˆå§‹åŒ– Dashboardï¼Œè®“å®ƒè‡ªå·±ç­‰å¾… teamDataManager
                console.log('ğŸ”„ å‰µå»º Markdown Dashboard...');
                if (typeof MarkdownProjectDashboard !== 'undefined') {
                    window.markdownDashboard = new MarkdownProjectDashboard();
                } else {
                    console.error('MarkdownProjectDashboard é¡åˆ¥æœªå®šç¾©ï¼Œç­‰å¾…è¼‰å…¥...');
                    // å»¶é²é‡è©¦
                    setTimeout(() => {
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        }
                    }, 500);
                }
            } catch (error) {
                console.error('Dashboard åˆå§‹åŒ–å¤±æ•—:', error);
            }
        });
    </script>
</body>
</html>