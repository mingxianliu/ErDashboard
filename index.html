<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»å‹™ç·¨çµ„ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="css/dashboard.css?v=20250918x" rel="stylesheet">
    <meta name="description" content="åŸºæ–¼ Markdown æª”æ¡ˆçš„å°ˆæ¡ˆé€²åº¦ç›£æ§å„€è¡¨æ¿">
    <meta name="robots" content="noindex,nofollow">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-tachometer-alt me-2"></i>
                ä»»å‹™ç·¨çµ„ç³»çµ±
            </span>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2" id="lastUpdate">è¼‰å…¥ä¸­...</span>
                <button class="btn btn-success btn-sm me-2" id="syncBtn" style="display: none;" title="åŒæ­¥æœ¬åœ°æª”æ¡ˆåˆ° Google Drive">
                    <i class="fas fa-cloud-upload-alt"></i> Push
                </button>
                <button class="btn btn-info btn-sm me-2" id="pullBtn" style="display: none;" title="å¾ Google Drive æ‹‰å–æœ€æ–°è³‡æ–™åˆ°æœ¬åœ°">
                    <i class="fas fa-cloud-download-alt"></i> Pull
                </button>
                <button class="btn btn-warning btn-sm me-2" id="syncRoleNotesBtn" style="display: none;" title="æ‰‹å‹•åŒæ­¥è§’è‰²å‚™è¨»">
                    <i class="fas fa-comment-dots"></i> åŒæ­¥å‚™è¨»
                </button>
                <button class="btn btn-danger btn-sm me-2" id="fixRolesBtn" style="display: none;" title="ä¿®å¾©è§’è‰²è³‡æ–™">
                    <i class="fas fa-tools"></i> ä¿®å¾©è§’è‰²
                </button>
                <button class="btn btn-outline-light btn-sm me-2" id="refreshBtn">
                    <i class="fas fa-sync-alt"></i> é‡æ–°è¼‰å…¥
                </button>
                <button class="btn btn-info btn-sm me-2" id="testPushBtn" style="display: none;" title="æ¸¬è©¦æ¨é€æç¤ºåŠŸèƒ½">
                    <i class="fas fa-vial"></i> æ¸¬è©¦æ¨é€
                </button>
                <button class="btn btn-secondary btn-sm me-2" id="gdriveSetupBtn" title="è¨­å®š Google Drive æ•´åˆ">
                    <i class="fab fa-google-drive"></i> é›²ç«¯è¨­å®š
                </button>
                <button class="btn btn-warning btn-sm me-2" id="teamManagementBtn" style="display: none;">
                    <i class="fas fa-users-cog"></i> åœ˜éšŠç®¡ç†
                </button>
                <button class="btn btn-info btn-sm me-2" id="devLogBtn" style="display: none;" title="ç ”ç™¼è¨˜éŒ„ç°¿">
                    <i class="fas fa-clipboard-list"></i> ç ”ç™¼è¨˜éŒ„ç°¿
                </button>
                <button class="btn btn-danger btn-sm" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> ç™»å‡º
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">

        <!-- ç§é‘°é©—è­‰ -->
        <div id="keyAuthentication" class="text-center py-5" style="display: none;">
            <div class="card mx-auto" style="max-width: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2"></i>ç§é‘°é©—è­‰
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">æ­¤ Dashboard éœ€è¦ Google Drive è¨­å®šå’Œç§é‘°æ‰èƒ½ä½¿ç”¨ã€‚è«‹ä¾åºåŒ¯å…¥ï¼š</p>

                    <!-- Google Drive è¨­å®šå€åŸŸ -->
                    <div class="mb-4">
                        <label class="form-label">1. Google Drive è¨­å®š (JSON æ ¼å¼)</label>
                        <textarea class="form-control" id="googleConfigInput" rows="5"
                                  placeholder='{
  "CLIENT_ID": "æ‚¨çš„-client-id.apps.googleusercontent.com",
  "FOLDER_ID": "æ‚¨çš„-google-drive-è³‡æ–™å¤¾-id",
  "SCOPES": "https://www.googleapis.com/auth/drive.file"
}'></textarea>
                        <small class="text-muted">Google Drive API è¨­å®šï¼Œåƒ…åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨</small>
                        <div class="mt-2">
                            <a href="setup-gdrive.html" target="_blank" class="btn btn-outline-primary btn-sm">
                                <i class="fab fa-google-drive me-1"></i>ä½¿ç”¨åœ–å½¢åŒ–è¨­å®šç•Œé¢
                            </a>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">2. åŒ¯å…¥ç§é‘° (PEM æ ¼å¼)</label>
                        <textarea class="form-control" id="privateKeyInput" rows="6"
                                  placeholder="-----BEGIN PRIVATE KEY-----
...
-----END PRIVATE KEY-----"></textarea>
                        <small class="text-muted">ç§é‘°åƒ…åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ï¼Œä¸æœƒå‚³é€åˆ°ä»»ä½•ä¼ºæœå™¨</small>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" id="verifyKeyBtn">
                                <i class="fas fa-shield-alt me-2"></i>é©—è­‰ä¸¦é€²å…¥
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" id="uploadKeyBtn">
                                <i class="fas fa-upload me-2"></i>å¾æª”æ¡ˆåŒ¯å…¥
                            </button>
                        </div>
                        <input type="file" id="keyFileInput" accept=".pem,.key" style="display: none;">
                    </div>
                    
                    <div class="alert alert-danger mt-3 d-none" id="keyError">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="keyErrorText">ç§é‘°é©—è­‰å¤±æ•—</span>
                    </div>
                    
                    <div class="alert alert-success mt-3 d-none" id="keySuccess">
                        <i class="fas fa-check-circle me-2"></i>
                        ç§é‘°é©—è­‰æˆåŠŸï¼æ­£åœ¨è¼‰å…¥ Dashboard...
                    </div>
                </div>
            </div>
        </div>


        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="row" id="summaryCards" style="display: none;">
            <!-- å‹•æ…‹è¼‰å…¥çš„çµ±è¨ˆå…§å®¹æœƒæ’å…¥é€™è£¡ -->
        </div>

        <!-- å°ˆæ¡ˆåˆ—è¡¨ -->
        <div class="row mt-4" id="projectsList" style="display: none;">
            <!-- å‹•æ…‹è¼‰å…¥çš„å°ˆæ¡ˆå…§å®¹æœƒæ’å…¥é€™è£¡ -->
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/crypto-auth.js?v=20250918p"></script>
    <script src="js/markdown-reader.js?v=20250919d"></script>
    <script>
        // å˜—è©¦è¼‰å…¥ config.js (æœ¬åœ°ç‰ˆæœ¬)ï¼Œå¦‚æœå¤±æ•—å‰‡å¿½ç•¥ (ç·šä¸Šç‰ˆæœ¬)
        const configScript = document.createElement('script');
        configScript.src = 'js/config.js?v=20250923';
        configScript.onerror = () => {
            console.log('âš ï¸ config.js æœªæ‰¾åˆ°ï¼Œå°‡ä½¿ç”¨æ‰‹å‹•è¨­å®šæ¨¡å¼');
        };
        document.head.appendChild(configScript);
    </script>
    <script src="js/google-drive-api.js?v=20250923b-1758618068"></script>
    <script src="protect-project-assignments.js?v=20250924" onerror="console.error('âŒ è¼‰å…¥ä¿è­·è…³æœ¬å¤±æ•—')"></script>
    <script src="js/team-data-manager.js?v=20250927-force-temp" onerror="console.error('âŒ è¼‰å…¥ team-data-manager.js å¤±æ•—')"></script>
    <script src="js/team-statistics.js?v=20250918u" onerror="console.error('âŒ è¼‰å…¥ team-statistics.js å¤±æ•—')"></script>
    <script src="js/team-ui-components.js?v=20250920k" onerror="console.error('âŒ è¼‰å…¥ team-ui-components.js å¤±æ•—')"></script>
    <script src="js/team-management-main.js?v=20250927-fixed" onerror="console.error('âŒ è¼‰å…¥ team-management-main.js å¤±æ•—')"></script>
    <script src="js/dev-log.js?v=20250923a" onerror="console.error('âŒ è¼‰å…¥ dev-log.js å¤±æ•—')"></script>
    <script src="js/markdown-dashboard-simple.js?v=20250923"></script>
    <script>
        // å®‰å…¨å–å¾— TeamDataManager å¯¦ä¾‹çš„è¼”åŠ©å‡½æ•¸
        async function getTeamDataManager() {
            // å„ªå…ˆä½¿ç”¨ç¾æœ‰çš„å…¨åŸŸå¯¦ä¾‹
            if (window.globalTeamDataManager && window.globalTeamDataManager.isReady()) {
                return window.globalTeamDataManager;
            }
            if (window.teamDataManager && window.teamDataManager.isReady()) {
                return window.teamDataManager;
            }

            // å¦‚æœæ²’æœ‰å¯ç”¨å¯¦ä¾‹ï¼Œå‰µå»ºæ–°çš„
            console.log('âš ï¸ å‰µå»ºæ–°çš„ TeamDataManager å¯¦ä¾‹');
            const teamDataManager = new window.TeamDataManager();
            await teamDataManager.init();

            // è¨­ç‚ºå…¨åŸŸå¯¦ä¾‹
            window.globalTeamDataManager = teamDataManager;
            window.teamDataManager = teamDataManager;

            return teamDataManager;
        }

        // ä½¿ç”¨ TeamDataManager è¼‰å…¥è³‡æ–™
        // è¨­ç‚ºå…¨åŸŸå‡½æ•¸ä»¥ä¾¿å…¶ä»–è¦–çª—å¯ä»¥å‘¼å«
        window.loadDataDirectly = async function loadDataDirectly() {
            try {
                // ç­‰å¾… Google Drive API æº–å‚™å¥½
                if (window.googleDriveAPI) {
                    let waitCount = 0;
                    while (!window.googleDriveAPI.isReady() && waitCount < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        waitCount++;
                    }

                    // æª¢æŸ¥ä¸¦å˜—è©¦ Google Drive è‡ªå‹•ç™»å…¥
                    if (window.googleDriveAPI.isReady() && !window.googleDriveAPI.isSignedIn()) {
                        try {
                            const loginSuccess = await window.googleDriveAPI.signIn();
                            if (loginSuccess) {
                            } else {
                            }
                        } catch (loginError) {
                            console.log('âŒ Google Drive è‡ªå‹•ç™»å…¥éŒ¯èª¤:', loginError);
                        }
                    } else if (!window.googleDriveAPI.isReady()) {
                    }
                }

                // ç¢ºä¿ TeamDataManager å­˜åœ¨
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager æœªè¼‰å…¥');
                }

                // ä½¿ç”¨æˆ–å‰µå»ºå…¨åŸŸ TeamDataManager
                let teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    teamDataManager = new window.TeamDataManager();
                    await teamDataManager.init();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;
                } else {
                    // æª¢æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–ï¼ˆé¿å…è¦†è“‹å‰›åŒæ­¥çš„è³‡æ–™ï¼‰
                    if (!teamDataManager.isReady()) {
                        await teamDataManager.init();
                    } else {
                    }
                }

                // è¼‰å…¥ä»»å‹™ç¯„æœ¬è³‡æ–™ï¼ˆå¦‚æœé‚„æ²’è¼‰å…¥ï¼‰
                if (!window.taskTemplatesData) {
                    try {
                        // 1. å„ªå…ˆå¾æœ¬åœ°å¿«å–è¼‰å…¥
                        const cachedTemplates = localStorage.getItem('cachedTaskTemplates');
                        if (cachedTemplates) {
                            window.taskTemplatesData = JSON.parse(cachedTemplates);
                        } else {
                            // 2. å¾æœ¬åœ°æª”æ¡ˆè¼‰å…¥
                            const templateResponse = await fetch('config/task-templates.json?v=' + Date.now());
                            if (templateResponse.ok) {
                                window.taskTemplatesData = await templateResponse.json();
                                // å„²å­˜åˆ°å¿«å–
                                localStorage.setItem('cachedTaskTemplates', JSON.stringify(window.taskTemplatesData));
                            }
                        }
                    } catch (templateError) {
                        console.warn('è¼‰å…¥ä»»å‹™ç¯„æœ¬å¤±æ•—:', templateError);
                        window.taskTemplatesData = { taskTemplates: {} };
                    }
                }

                // å¾ TeamDataManager ç²å–è³‡æ–™
                let assignments = teamDataManager.getAllAssignments();
                // console.log('ğŸ“Š å¾ TeamDataManager è¼‰å…¥çš„å°ˆæ¡ˆæ•¸é‡:', assignments ? Object.keys(assignments).length : 0);

                // å¦‚æœ teamDataManager æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦å¾ localStorage æˆ– config è¼‰å…¥
                if (!assignments || Object.keys(assignments).length === 0) {
                    console.log('ğŸ”„ teamDataManager è³‡æ–™ç‚ºç©ºï¼Œå˜—è©¦å…¶ä»–è³‡æ–™ä¾†æº...');

                    // å˜—è©¦å¾ localStorage
                    const localData = localStorage.getItem('project-assignments');
                    if (localData) {
                        try {
                            const parsed = JSON.parse(localData);
                            if (parsed.assignments) {
                                assignments = parsed.assignments;
                                console.log('âœ… å¾ localStorage è¼‰å…¥è³‡æ–™');
                            }
                        } catch (e) {
                            console.error('âŒ localStorage è³‡æ–™è§£æå¤±æ•—:', e);
                        }
                    }

                    // å¦‚æœé‚„æ˜¯æ²’æœ‰è³‡æ–™ï¼Œå˜—è©¦å¾ config è¼‰å…¥
                    if (!assignments || Object.keys(assignments).length === 0) {
                        try {
                            const response = await fetch('config/project-assignments.json');
                            if (response.ok) {
                                const data = await response.json();
                                if (data.assignments) {
                                    assignments = data.assignments;
                                    console.log('âœ… å¾ config æª”æ¡ˆè¼‰å…¥è³‡æ–™');
                                }
                            }
                        } catch (e) {
                            console.error('âŒ config æª”æ¡ˆè¼‰å…¥å¤±æ•—:', e);
                        }
                    }
                }

                // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œä½¿ç”¨ç©ºç‰©ä»¶
                if (!assignments) {
                    assignments = {};
                }

                // ç¢ºä¿æ‰€æœ‰æˆå“¡éƒ½æœ‰å¿…è¦çš„æ¬„ä½
                Object.values(assignments).forEach(project => {
                    if (project.members) {
                        Object.values(project.members).forEach(member => {
                            if (member.isExecuting === undefined || member.isExecuting === null) {
                                member.isExecuting = false; // é è¨­ç‚ºæœªåŸ·è¡Œ
                            }
                            if (!member.personalNotes) {
                                member.personalNotes = []; // åˆå§‹åŒ–å€‹äººå‚™è¨»é™£åˆ—
                            }
                        });
                    }
                });

                // å‰ç«¯æ¸²æŸ“è³‡æ–™å·²æº–å‚™å®Œæˆ

                const summaryCards = document.getElementById('summaryCards');
                const projectsList = document.getElementById('projectsList');

                if (assignments && Object.keys(assignments).length > 0) {
                    const projects = Object.keys(assignments).map(projectId => ({
                        ...assignments[projectId],
                        projectId: projectId
                    }));

                    // é¡¯ç¤ºçµ±è¨ˆ
                    if (summaryCards) {
                        summaryCards.innerHTML = `
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-primary text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.length}</div>
                                                <div>ç¸½å°ˆæ¡ˆæ•¸</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-project-diagram"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-success text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${projects.filter(p => p.status === 'active').length}</div>
                                                <div>é€²è¡Œä¸­å°ˆæ¡ˆ</div>
                                                <small class="text-white-50">æš«åœ: <span class="badge bg-warning text-dark">${projects.filter(p => p.status === 'paused').length}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-rocket"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-info text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size}</div>
                                                <div>ç¸½æˆå“¡æ•¸</div>
                                                <small class="text-white-50">åŸ·è¡Œä¸­: <span id="executingCount" class="badge bg-success">${Object.values(assignments).reduce((sum, p) => sum + Object.values(p.members || {}).filter(m => m.isExecuting === true).length, 0)}</span></small>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-users"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-4">
                                <div class="card bg-warning text-white h-100">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <div class="h4 mb-0">${Math.round(projects.reduce((sum, p) => sum + p.progress, 0) / projects.length)}%</div>
                                                <div>å¹³å‡é€²åº¦</div>
                                            </div>
                                            <div class="h1 opacity-50">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        summaryCards.style.display = 'flex';
                    }

                    // é¡¯ç¤ºå°ˆæ¡ˆåˆ—è¡¨
                    if (projectsList) {
                        let html = '';

                        projects.forEach(project => {
                            const memberCount = Object.keys(project.members || {}).length;

                            // ç”Ÿæˆæˆå“¡åˆ—è¡¨
                            let membersHtml = '';
                            if (project.members && Object.keys(project.members).length > 0) {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">åœ˜éšŠæˆå“¡(${memberCount}):</h6>
                                            <div>
                                                <span class="badge bg-warning text-dark me-2"
                                                      id="project-test-${project.projectId}"
                                                      style="display: none;"
                                                      title="æœ‰æ–°æ¨é€ï¼Œå¾…æ¸¬è©¦">
                                                    <i class="fas fa-exclamation-triangle"></i> å¾…æ¸¬è©¦
                                                </span>
                                                <span class="badge bg-${
                                                    project.status === 'active' ? 'success' :
                                                    project.status === 'paused' ? 'warning' :
                                                    project.status === 'completed' ? 'secondary' : 'info'
                                                }">${
                                                    project.status === 'active' ? 'é€²è¡Œä¸­' :
                                                    project.status === 'paused' ? 'æš«åœ' :
                                                    project.status === 'completed' ? 'å·²å®Œæˆ' :
                                                    project.status || 'æœªçŸ¥ç‹€æ…‹'
                                                }</span>
                                            </div>
                                        </div>
                                `;
                                Object.values(project.members).forEach(member => {
                                    // å¾å¯¦éš›æˆå“¡è³‡æ–™å–å¾—åç¨±
                                    const allMembers = teamDataManager.getAllMembers() || {};
                                    const memberName = allMembers[member.memberId]?.name || member.memberId;
                                    const roleColors = {
                                        'frontend': '#007bff',
                                        'backend': '#28a745',
                                        'fullstack': '#ffc107',
                                        'testing': '#dc3545',
                                        'å‰ç«¯': '#007bff',
                                        'å¾Œç«¯': '#28a745',
                                        'å…¨ç«¯': '#ffc107',
                                        'æ¸¬è©¦': '#dc3545'
                                    };
                                    const roleColor = roleColors[member.role] || '#6c757d';

                                    // è§’è‰²æ–‡å­—è½‰æ›
                                    const roleTranslation = {
                                        'frontend': 'å‰ç«¯',
                                        'backend': 'å¾Œç«¯',
                                        'fullstack': 'å…¨ç«¯',
                                        'testing': 'æ¸¬è©¦'
                                    };
                                    const displayRole = roleTranslation[member.role] || member.role;

                                    // æ ¹æ“šçµ„åˆ¥è¨­å®šèƒŒæ™¯è‰²
                                    const memberGroup = member.memberId.split('-')[0]; // A, B, C
                                    const groupColors = {
                                        'A': '#e3f2fd', // æ·ºè—
                                        'B': '#e8f5e8', // æ·ºç¶ 
                                        'C': '#fff3e0'  // æ·ºæ©™
                                    };
                                    const groupBgColor = groupColors[memberGroup] || '#f8f9fa';

                                    membersHtml += `
                                        <div class="position-relative p-3 mb-2 border rounded"
                                             style="background-color: ${groupBgColor}; height: 85px; overflow: hidden;">
                                            <div class="d-flex align-items-center h-100" style="padding-right: 90px;">
                                                <div class="d-flex flex-column align-items-center me-3">
                                                    <input class="form-check-input mb-1" type="checkbox"
                                                           id="executing-${project.projectId}-${member.memberId}"
                                                           onchange="toggleMemberExecution('${project.projectId}', '${member.memberId}', this.checked)"
                                                           ${member.isExecuting ? 'checked' : ''}
                                                           data-project="${project.projectId}" data-member="${member.memberId}">
                                                    ${member.isExecuting ? '<i class="fas fa-play-circle text-success" title="åŸ·è¡Œä¸­"></i>' : ''}
                                                </div>
                                                <div class="d-flex flex-column me-3" style="min-width: 80px; max-width: 120px;">
                                                    <div class="fw-bold mb-1 ${member.isExecuting ? 'text-success' : ''} text-truncate" title="${memberName}">${memberName}</div>
                                                    <small class="text-muted text-truncate" title="${member.memberId}">${member.memberId}</small>
                                                </div>
                                                <div class="d-flex align-items-center flex-grow-1 justify-content-end">
                                                    <span class="badge px-3 py-2 me-3" style="background-color: ${roleColor}; font-size: 0.85em;">
                                                        ${displayRole}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="position-absolute top-50 end-0 translate-middle-y me-3">
                                                <div class="d-grid gap-1" style="grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; width: 80px; height: 64px;">
                                                <button class="btn btn-sm btn-outline-primary" onclick="editTaskCard('${project.projectId}', '${member.memberId}')" title="ç·¨è¼¯ä»»å‹™å°å¡">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="editPersonalNotes('${project.projectId}', '${member.memberId}')" title="è§’è‰²å‚™è¨»">
                                                    <i class="fas fa-sticky-note"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-warning" onclick="changeMember('${project.projectId}', '${member.memberId}')" title="è®Šæ›´æˆå“¡">
                                                    <i class="fas fa-user-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="showMemberInfo('${project.projectId}', '${member.memberId}')" title="æˆå“¡è³‡è¨Š">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                });
                                membersHtml += '</div>';
                            } else {
                                membersHtml = `
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <h6 class="mb-0">åœ˜éšŠæˆå“¡(0):</h6>
                                            <span class="badge bg-${
                                                project.status === 'active' ? 'success' :
                                                project.status === 'paused' ? 'warning' :
                                                project.status === 'completed' ? 'secondary' : 'info'
                                            }">${
                                                project.status === 'active' ? 'é€²è¡Œä¸­' :
                                                project.status === 'paused' ? 'æš«åœ' :
                                                project.status === 'completed' ? 'å·²å®Œæˆ' :
                                                project.status || 'æœªçŸ¥ç‹€æ…‹'
                                            }</span>
                                        </div>
                                        <small class="text-muted">å°šæœªåˆ†é…æˆå“¡</small>
                                    </div>
                                `;
                            }

                            html += `
                                <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12">
                                    <div class="card mb-3" style="height: 420px;">
                                        <div class="card-body d-flex flex-column">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <h5 class="card-title text-truncate me-2" title="${project.projectName}">${project.projectName}</h5>
                                                <button class="btn btn-sm btn-outline-info" onclick="editProjectProgress('${project.projectId}')" title="èª¿æ•´é€²åº¦">
                                                    <i class="fas fa-chart-line"></i>
                                                </button>
                                            </div>
                                            <div class="progress mb-3" style="height: 25px;">
                                                <div class="progress-bar d-flex align-items-center justify-content-center" style="width: ${project.progress}%">
                                                    <span class="fw-bold">${project.progress}%</span>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                ${membersHtml}
                                            </div>
                                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        projectsList.innerHTML = html;

                        // æ·»åŠ äº‹ä»¶ç›£è½å™¨ä½œç‚ºå‚™ä»½ï¼ˆä»¥é˜² onchange å±¬æ€§å¤±æ•ˆï¼‰
                        document.querySelectorAll('input[type="checkbox"][id^="executing-"]').forEach(checkbox => {
                            checkbox.addEventListener('change', function() {
                                const projectId = this.getAttribute('data-project');
                                const memberId = this.getAttribute('data-member');
                                toggleMemberExecution(projectId, memberId, this.checked);
                            });
                        });
                        projectsList.style.display = 'flex';
                    }
                } else {
                    console.warn('âš ï¸ è³‡æ–™æ ¼å¼ä¸æ­£ç¢ºæˆ–æ²’æœ‰ assignments');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('projectsList').innerHTML = '<div class="alert alert-danger">è¼‰å…¥å¤±æ•—: ' + error.message + '</div>';
            }
        }

        // ç·¨è¼¯å°ˆæ¡ˆæˆå“¡ä»»å‹™å°å¡
        async function editProjectMember(projectId, memberId) {
            try {

                // ä½¿ç”¨ TeamDataManager è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                if (!window.TeamDataManager) {
                    throw new Error('TeamDataManager æœªè¼‰å…¥');
                }

                const teamDataManager = await getTeamDataManager();

                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ: ${projectId}`);
                }

                const member = project.members[memberId];

                if (!member) {
                    alert('æ‰¾ä¸åˆ°æˆå“¡è³‡æ–™');
                    return;
                }

                // å¾ teamDataManager å–å¾—å¯¦éš›çš„æˆå“¡åç¨±
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // å¾ TeamDataManager è¼‰å…¥ä»»å‹™ç¯„æœ¬
                let taskTemplate = '';
                try {
                    // TeamDataManager æ‡‰è©²å·²ç¶“è¼‰å…¥äº†ä»»å‹™ç¯„æœ¬è³‡æ–™
                    if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                        const template = window.taskTemplatesData.taskTemplates[member.role];
                        if (template) {
                            taskTemplate = template.content;
                        }
                    }
                } catch (templateError) {
                    console.warn('è¼‰å…¥ä»»å‹™ç¯„æœ¬å¤±æ•—:', templateError);
                }

                // ç”Ÿæˆä»»å‹™å°å¡å…§å®¹ï¼ˆæ­£ç¢ºæ ¼å¼ï¼‰
                const taskCardContent = `ä½ ç¾åœ¨çš„è§’è‰²æ˜¯ã€Œ${project.projectName}ã€çš„ã€Œ${member.role}ã€ï¼Œä»£è™Ÿæ˜¯ã€Œ${memberName}ã€ï¼Œé–‹ç™¼çš„branch æ˜¯ã€Œ${memberName}ã€ï¼Œè‹¥ç„¡å‰‡createï¼Œè«‹ä¾å¾ªä¸‹åˆ—çš„ä»»å‹™æŒ‡å¼•ï¼š\n\n${taskTemplate}`;

                // ç›´æ¥ç·¨è¼¯ä»»å‹™å°å¡ï¼ˆä¸å†éœ€è¦é¸æ“‡æ¨¡æ…‹æ¡†ï¼‰
                editTaskCard(projectId, memberId);

            } catch (error) {
                console.error('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—: ' + error.message);
            }
        }

        // ç·¨è¼¯ä»»å‹™å°å¡
        async function editTaskCard(projectId, memberId) {
            try {

                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`æ‰¾ä¸åˆ°æˆå“¡: ${memberId}`);
                }

                // ç§»é™¤ç¡¬ç·¨ç¢¼çš„æˆå“¡åç¨±æ˜ å°„ï¼Œæ”¹ç”¨å¯¦éš›è³‡æ–™
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // ç²å–ä»»å‹™ç¯„æœ¬
                let taskTemplate = '';
                if (window.taskTemplatesData && window.taskTemplatesData.taskTemplates) {
                    const template = window.taskTemplatesData.taskTemplates[member.role];
                    if (template) {
                        taskTemplate = template.content;
                    }
                }

                // å»ºç«‹é è¨­ç¯„æœ¬å…§å®¹
                const defaultTaskContent = `ä½ ç¾åœ¨çš„è§’è‰²æ˜¯ã€Œ${project.projectName}ã€çš„ã€Œ${member.role}ã€ï¼Œä»£è™Ÿæ˜¯ã€Œ${memberName}ã€ï¼Œé–‹ç™¼çš„branch æ˜¯ã€Œ${memberName}ã€ï¼Œè‹¥ç„¡å‰‡createï¼Œè«‹ä¾å¾ªä¸‹åˆ—çš„ä»»å‹™æŒ‡å¼•ï¼š\n\n${taskTemplate}`;

                // å„²å­˜ç¯„æœ¬è³‡æ–™ä¾›æ¢å¾©é è¨­åŠŸèƒ½ä½¿ç”¨
                window.currentTaskCardTemplate = {
                    projectId: projectId,
                    memberId: memberId,
                    defaultContent: defaultTaskContent
                };

                // æª¢æŸ¥æ˜¯å¦æœ‰å·²å„²å­˜çš„ä»»å‹™å°å¡å…§å®¹
                let taskCardContent;
                const taskCard = assignments[projectId].members[memberId].taskCard;
                if (taskCard && taskCard.content) {
                    // ä½¿ç”¨å·²å„²å­˜çš„å…§å®¹
                    taskCardContent = taskCard.content;
                } else {
                    // ä½¿ç”¨é è¨­ç¯„æœ¬
                    taskCardContent = defaultTaskContent;
                }

                // ç”¢ç”Ÿå°ˆæ¡ˆå‚™è¨»æ­·ç¨‹ HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // ç”¢ç”Ÿè§’è‰²å‚™è¨» HTML
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²å‚™è¨»</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²å‚™è¨»</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>å°šç„¡è§’è‰²å‚™è¨»è¨˜éŒ„</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // ç”¢ç”Ÿä»»å‹™å°å¡æ­·ç¨‹è¨˜éŒ„ HTMLï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">ä»»å‹™å°å¡æ­·ç¨‹</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="åˆªé™¤æ­¤è¨˜éŒ„">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">æŸ¥çœ‹å…§å®¹</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> æ¢å¾©æ­¤ç‰ˆæœ¬
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

                // ç”¢ç”Ÿè§’è‰²è®Šæ›´æ­·ç¨‹ HTML
                let memberHistoryHtml = '';
                try {
                    if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                        memberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                    } else {
                        // å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥å¾è³‡æ–™ä¸­ç”Ÿæˆ
                        const memberHistory = project.memberHistory || [];
                        if (memberHistory.length > 0) {
                            const actionLabels = {
                                'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>æˆå“¡åŠ å…¥',
                                'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>æˆå“¡ç§»é™¤',
                                'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>è§’è‰²è®Šæ›´'
                            };

                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                            <i class="fas fa-trash"></i> æ¸…ç©º
                                        </button>
                                    </div>
                                    <div class="card" style="max-height: 400px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${memberHistory.slice().reverse().map((entry, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                                        <div class="small">
                                                            ${actionLabels[entry.action] || entry.action}
                                                            <strong>${entry.memberName}</strong>
                                                        </div>
                                                        <div class="d-flex align-items-center gap-1">
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                            <button class="btn btn-sm btn-outline-secondary p-1" onclick="if(window.teamManagement) window.teamManagement.editHistoryOperator('${projectId}', '${entry.timestamp}')" title="ç·¨è¼¯æ“ä½œè€…">
                                                                <i class="fas fa-edit" style="font-size: 8px;"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="ps-3">
                                                        ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                        ${entry.oldRole && entry.newRole ? `
                                                            <div class="mt-1">
                                                                <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                <i class="fas fa-arrow-right mx-1 small"></i>
                                                                <span class="badge bg-success small">${entry.newRole}</span>
                                                            </div>
                                                        ` : ''}
                                                        ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        <div class="mt-1">
                                                            <small class="text-success">æ“ä½œè€…: ${entry.operator || 'ç³»çµ±ç®¡ç†å“¡'}</small>
                                                        </div>
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            memberHistoryHtml = `
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                        <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                            <i class="fas fa-trash"></i> æ¸…ç©º
                                        </button>
                                    </div>
                                    <div class="card">
                                        <div class="card-body p-2 text-center text-muted">
                                            <small>å°šç„¡æˆå“¡è®Šæ›´è¨˜éŒ„</small>
                                        </div>
                                    </div>
                                    <hr class="my-4">
                                    <div class="usage-guide bg-light p-3 rounded">
                                        <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>è§’è‰²å‚™è¨»æäº¤ - å°å¡ç‰ˆ</h6>
                                        <div class="mb-3">
                                            <strong>ä½¿ç”¨æ™‚æ©Ÿï¼š</strong><br>
                                            1. åœ¨å„è‡ªç›®å‰åœ¨é–‹ç™¼å°ˆæ¡ˆï¼ˆå¦‚ï¼šErCore/ErNexus/ErShield/ErTidyï¼‰ç™¼PRå¾Œ<br>
                                            2. ä¾†ErDashboardåŸ·è¡Œè§’è‰²å‚™è¨»è…³æœ¬
                                        </div>
                                        <div class="mb-3">
                                            <strong>æ“ä½œæ­¥é©Ÿï¼š</strong><br>
                                            1. é–‹å•Ÿçµ‚ç«¯æ©Ÿ<br>
                                            2. cd åˆ°/GitHub/ErDashboard è³‡æ–™å¤¾<br>
                                            3. åŸ·è¡ŒæŒ‡ä»¤ï¼š
                                        </div>
                                        <div class="bg-dark text-light p-2 rounded mb-3">
                                            <code>node scripts/submit-note.js å°ˆæ¡ˆåç¨± åç¨± "å‚™è¨»"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>ç¯„ä¾‹ï¼š</strong><br>
                                            <code>node scripts/submit-note.js ErCore KlauderA "â€¢ å®Œæˆç™»å…¥API â€¢ ä¿®å¾©bug"</code>
                                        </div>
                                        <div class="mb-3">
                                            <strong>è¦å‰‡ï¼š</strong><br>
                                            â€¢ å¿…é ˆæ¢åˆ—æ ¼å¼ (â€¢ã€1.ã€-)<br>
                                            â€¢ æœ€å¤š50å­—<br>
                                            â€¢ è¦å…·é«”æ˜ç¢º
                                        </div>
                                        <div class="mb-3">
                                            <strong>åœ¨å„è‡ªç›®å‰åœ¨é–‹ç™¼å°ˆæ¡ˆï¼š</strong><br>
                                            å¦‚ï¼šErCore, ErNexus, ErShield, ErTidy
                                        </div>
                                        <div class="text-success">
                                            <strong>æäº¤å¾Œè‡ªå‹•åŒæ­¥åˆ°å€‹äººæ­·ç¨‹ï¼Œä¸¦å›åˆ°æœ¬ä¾†çš„å°ˆæ¡ˆ/branchï¼</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                } catch (error) {
                    console.warn('ç”Ÿæˆè§’è‰²è®Šæ›´æ­·ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                    memberHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="if(window.teamManagement) window.teamManagement.clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                    <i class="fas fa-trash"></i> æ¸…ç©º
                                </button>
                            </div>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>è¼‰å…¥æ­·ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤</small>
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="usage-guide bg-light p-3 rounded">
                                <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>ğŸ“ è§’è‰²å‚™è¨»æäº¤ - å°å¡ç‰ˆ</h6>
                                <div class="mb-3">
                                    <strong>ğŸ“¤ ä½¿ç”¨æ™‚æ©Ÿï¼š</strong><br>
                                    ğŸ”¸ åœ¨å„è‡ªå°ˆæ¡ˆï¼ˆErCore/ErNexus/ErShield/ErTidyï¼‰ç™¼PRå¾Œ<br>
                                    ğŸ”¸ ä¾†ErDashboardåŸ·è¡Œè§’è‰²å‚™è¨»è…³æœ¬
                                </div>
                                <div class="mb-3">
                                    ğŸ”¸ é–‹å•Ÿçµ‚ç«¯æ©Ÿ<br>
                                    ğŸ”¸ cd åˆ°/GitHub/ErDashboard è³‡æ–™å¤¾<br>
                                    ğŸ”¸ åŸ·è¡ŒæŒ‡ä»¤ï¼š
                                </div>
                                <div class="bg-dark text-light p-2 rounded mb-3">
                                    <code>node scripts/submit-note.js å°ˆæ¡ˆ å§“å "å‚™è¨»"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>ğŸ“‹ ç¯„ä¾‹ï¼š</strong><br>
                                    <code>node scripts/submit-note.js ErCore å¼µå°æ˜ "â€¢ å®Œæˆç™»å…¥API â€¢ ä¿®å¾©bug"</code>
                                </div>
                                <div class="mb-3">
                                    <strong>âœ… è¦å‰‡ï¼š</strong><br>
                                    â€¢ å¿…é ˆæ¢åˆ—æ ¼å¼ (â€¢ã€1.ã€-)<br>
                                    â€¢ æœ€å¤š50å­—<br>
                                    â€¢ è¦å…·é«”æ˜ç¢º
                                </div>
                                <div class="mb-3">
                                    <strong>ğŸ¯ å°ˆæ¡ˆï¼š</strong>ErCore, ErNexus, ErShield, ErTidy
                                </div>
                                <div class="text-success">
                                    <strong>ğŸ’¡ æäº¤å¾Œè‡ªå‹•åŒæ­¥åˆ°å€‹äººæ­·ç¨‹ï¼</strong>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // é¡¯ç¤ºä»»å‹™å°å¡ç·¨è¼¯æ¨¡æ…‹æ¡†
                const taskModalHtml = `
                    <div class="modal fade" id="taskCardModal" tabindex="-1">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ä»»å‹™å°å¡ç·¨è¼¯ - ${memberName}ï¼Œã€Œ${project.projectName}ã€å°ˆæ¡ˆçš„ã€Œ${member.role}ã€</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-lg-4">
                                            <div class="mb-3">
                                                <label for="taskContent" class="form-label">ä»»å‹™å°å¡å…§å®¹</label>
                                                <textarea class="form-control" id="taskContent" rows="20" style="min-height: 500px;">${taskCardContent}</textarea>
                                            </div>
                                        </div>
                                        <div class="col-lg-2">
                                            ${projectNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${personalNotesHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${taskHistoryHtml}
                                        </div>
                                        <div class="col-lg-2">
                                            ${memberHistoryHtml}
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="copyTaskCard()">
                                        <i class="fas fa-copy"></i> è¤‡è£½
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="saveTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> å„²å­˜
                                    </button>
                                    <button type="button" class="btn btn-warning" onclick="restoreDefaultTaskCard('${projectId}', '${memberId}')">
                                        <i class="fas fa-undo"></i> æ¢å¾©é è¨­
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldTaskModal = document.getElementById('taskCardModal');
                if (oldTaskModal) oldTaskModal.remove();
                document.body.insertAdjacentHTML('beforeend', taskModalHtml);

                const taskModal = new bootstrap.Modal(document.getElementById('taskCardModal'));
                taskModal.show();

            } catch (error) {
                console.error('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('ç·¨è¼¯ä»»å‹™å°å¡å¤±æ•—: ' + error.message);
            }
        }

        // ç·¨è¼¯å°ˆæ¡ˆé€²åº¦
        async function editProjectProgress(projectId) {
            try {

                // è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                const teamDataManager = await getTeamDataManager();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                // è¨­å®šç•¶å‰å°ˆæ¡ˆè³‡æ–™ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
                window.currentProject = project;
                window.currentProjectId = projectId;

                // é¡¯ç¤ºé€²åº¦ç·¨è¼¯æ¨¡æ…‹æ¡†
                const progressModalHtml = `
                    <div class="modal fade" id="progressModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">ç·¨è¼¯å°ˆæ¡ˆé€²åº¦ - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-4">
                                        <label for="projectProgress" class="form-label fw-bold">å°ˆæ¡ˆé€²åº¦</label>
                                        <div class="progress-container">
                                            <div class="progress mb-3" style="height: 20px; border-radius: 10px; background-color: #e9ecef;">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                                     id="progressBar"
                                                     role="progressbar"
                                                     style="width: ${project.progress}%; background: linear-gradient(45deg, #007bff, #0056b3); border-radius: 10px;"
                                                     aria-valuenow="${project.progress}"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <input type="range" class="form-range progress-slider" id="projectProgress" min="0" max="100" value="${project.progress}" oninput="updateProgressDisplay(this.value)">
                                            <div class="text-center mt-2">
                                                <span id="progressDisplay" class="badge bg-primary fs-6 px-3 py-2" style="border-radius: 20px;">${project.progress}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="projectNotes" class="form-label">å°ˆæ¡ˆå‚™è¨»</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newNote" rows="3" placeholder="è¼¸å…¥æ–°çš„å‚™è¨»..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addNote()">
                                                <i class="fas fa-plus"></i> æ–°å¢å‚™è¨»
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllNotes()">
                                                <i class="fas fa-trash"></i> æ¸…é™¤æ‰€æœ‰å‚™è¨»
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="notesList">
                                                ${formatNotes(project.notes || '')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveProjectProgress('${projectId}')">
                                        <i class="fas fa-save"></i> å„²å­˜
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldProgressModal = document.getElementById('progressModal');
                if (oldProgressModal) oldProgressModal.remove();
                document.body.insertAdjacentHTML('beforeend', progressModalHtml);

                const progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
                progressModal.show();

            } catch (error) {
                console.error('ç·¨è¼¯å°ˆæ¡ˆé€²åº¦å¤±æ•—:', error);
                alert('ç·¨è¼¯å°ˆæ¡ˆé€²åº¦å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°é€²åº¦é¡¯ç¤º
        function updateProgressDisplay(value) {
            document.getElementById('progressDisplay').textContent = value + '%';
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = value + '%';
                progressBar.setAttribute('aria-valuenow', value);

                // å‹•æ…‹æ”¹è®Šé€²åº¦æ¢é¡è‰²
                let gradient;
                if (value < 30) {
                    gradient = 'linear-gradient(45deg, #dc3545, #c82333)'; // ç´…è‰²
                } else if (value < 70) {
                    gradient = 'linear-gradient(45deg, #ffc107, #e0a800)'; // é»ƒè‰²
                } else {
                    gradient = 'linear-gradient(45deg, #28a745, #1e7e34)'; // ç¶ è‰²
                }
                progressBar.style.background = gradient;
            }
        }

        // æ ¼å¼åŒ–å‚™è¨»é¡¯ç¤º
        function formatNotes(notes) {
            if (!notes) return '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';

            // å¦‚æœ notes å·²ç¶“æ˜¯é™£åˆ—ï¼ˆç‰©ä»¶ï¼‰ï¼Œç›´æ¥è™•ç†
            if (Array.isArray(notes)) {
                if (notes.length > 0) {
                    return notes.map((note, index) =>
                        `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <div class="fw-bold small text-muted">${note.timestamp}</div>
                                <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="åˆªé™¤æ­¤å‚™è¨»">
                                    <i class="fas fa-times" style="font-size: 10px;"></i>
                                </button>
                            </div>
                            <div>${note.content}</div>
                        </div>`
                    ).join('');
                }
                return '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';
            }

            // å¦‚æœæ˜¯å­—ä¸²ï¼Œå˜—è©¦è§£æ JSON
            if (typeof notes === 'string') {
                try {
                    const notesList = JSON.parse(notes);
                    if (Array.isArray(notesList) && notesList.length > 0) {
                        return notesList.map((note, index) =>
                            `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="fw-bold small text-muted">${note.timestamp}</div>
                                    <button class="btn btn-sm btn-outline-danger p-1 delete-project-note-btn" data-index="${index}" title="åˆªé™¤æ­¤å‚™è¨»">
                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                    </button>
                                </div>
                                <div>${note.content}</div>
                            </div>`
                        ).join('');
                    }
                } catch (e) {
                    // å¦‚æœä¸æ˜¯ JSON æ ¼å¼ï¼Œç•¶ä½œèˆŠæ ¼å¼çš„ç´”æ–‡å­—
                    if (notes.trim()) {
                        return `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                                    <div class="fw-bold small text-muted">èˆŠå‚™è¨»</div>
                                    <div>${notes}</div>
                                </div>`;
                    }
                }
            }

            return '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';
        }

        // æ–°å¢å‚™è¨»
        async function addNote() {
            const newNoteInput = document.getElementById('newNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('è«‹è¼¸å…¥å‚™è¨»å…§å®¹');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                author: 'KopylotA', // ErNexus å°ˆæ¡ˆçš„ testing è§’è‰²
                type: 'note'
            };

            // ç²å–ç¾æœ‰å‚™è¨»
            let existingNotes = [];
            try {
                const currentProject = getCurrentProject();
                if (currentProject && currentProject.notes) {
                    existingNotes = JSON.parse(currentProject.notes);
                }
            } catch (e) {
                // å¦‚æœè§£æå¤±æ•—ï¼Œå»ºç«‹æ–°é™£åˆ—
                existingNotes = [];
            }

            if (!Array.isArray(existingNotes)) {
                existingNotes = [];
            }

            // æ–°å¢åˆ°é™£åˆ—é–‹é ­ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
            existingNotes.unshift(newNote);

            // ç«‹å³å„²å­˜åˆ° TeamDataManager
            try {
                const teamDataManager = await getTeamDataManager();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[window.currentProjectId]) {
                    assignments[window.currentProjectId].notes = JSON.stringify(existingNotes);
                    assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    // æ›´æ–°ç•¶å‰å°ˆæ¡ˆè³‡æ–™
                    window.currentProject.notes = JSON.stringify(existingNotes);
                }
            } catch (error) {
                console.error('å„²å­˜å‚™è¨»å¤±æ•—:', error);
                alert('å„²å­˜å‚™è¨»å¤±æ•—: ' + error.message);
                return;
            }

            // æ›´æ–°é¡¯ç¤º
            updateNotesDisplay(existingNotes);

            // æ¸…ç©ºè¼¸å…¥æ¡†
            newNoteInput.value = '';
        }

        // æ¸…é™¤æ‰€æœ‰å‚™è¨»
        async function clearAllNotes() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å‚™è¨»å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                try {
                    // ç«‹å³å„²å­˜åˆ° TeamDataManager
                    const teamDataManager = await getTeamDataManager();
                    const assignments = teamDataManager.getAllAssignments();

                    if (assignments[window.currentProjectId]) {
                        assignments[window.currentProjectId].notes = JSON.stringify([]);
                        assignments[window.currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        // æ›´æ–°ç•¶å‰å°ˆæ¡ˆè³‡æ–™
                        window.currentProject.notes = JSON.stringify([]);
                    }

                    // æ›´æ–°é¡¯ç¤º
                    updateNotesDisplay([]);
                } catch (error) {
                    console.error('æ¸…é™¤å‚™è¨»å¤±æ•—:', error);
                    alert('æ¸…é™¤å‚™è¨»å¤±æ•—: ' + error.message);
                }
            }
        }

        // æ›´æ–°å‚™è¨»é¡¯ç¤º
        function updateNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('notesList');
            if (notesList.length === 0) {
                notesListDiv.innerHTML = '<p class="text-muted m-0">å°šç„¡å‚™è¨»</p>';

                // åŒæ™‚æ¸…é™¤ä»»å‹™å°å¡ä¸­çš„å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹é¡¯ç¤º
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = '';
                }
            } else {
                notesListDiv.innerHTML = notesList.map(note =>
                    `<div class="mb-2 p-2 border-start border-primary border-3 bg-white">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <div>${note.content}</div>
                    </div>`
                ).join('');

                // åŒæ™‚æ›´æ–°ä»»å‹™å°å¡ä¸­çš„å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹é¡¯ç¤º
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                if (projectNotesColumn) {
                    const updatedProjectNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${notesList.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === notesList.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || 'System'}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div>${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                    projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                }
            }
        }

        // ç²å–ç•¶å‰å°ˆæ¡ˆï¼ˆè¼”åŠ©å‡½æ•¸ï¼‰
        function getCurrentProject() {
            // é€™å€‹å‡½æ•¸éœ€è¦åœ¨æ¨¡æ…‹æ¡†é–‹å•Ÿæ™‚è¨­å®šç•¶å‰å°ˆæ¡ˆè³‡æ–™
            return window.currentProject || null;
        }

        // å„²å­˜å°ˆæ¡ˆé€²åº¦
        async function saveProjectProgress(projectId) {
            try {
                const progress = parseInt(document.getElementById('projectProgress').value);

                // ç²å–ç•¶å‰å‚™è¨»åˆ—è¡¨
                const notesListDiv = document.getElementById('notesList');
                let notesList = [];

                // å¾é¡¯ç¤ºçš„å‚™è¨»ä¸­æå–è³‡æ–™
                const noteElements = notesListDiv.querySelectorAll('.border-start');
                noteElements.forEach(element => {
                    const timestamp = element.querySelector('.text-muted').textContent;
                    const content = element.querySelector('div:last-child').textContent;
                    if (timestamp !== 'å°šç„¡å‚™è¨»') {
                        notesList.push({ timestamp, content });
                    }
                });

                // ä½¿ç”¨å…¨åŸŸçš„åœ˜éšŠè³‡æ–™ç®¡ç†å™¨ï¼Œç¢ºä¿èˆ‡æ­·ç¨‹è¨˜éŒ„åŒæ­¥
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = await getTeamDataManager();
                }
                const assignments = teamDataManager.getAllAssignments();

                // æ›´æ–°å°ˆæ¡ˆé€²åº¦å’Œå‚™è¨»
                if (assignments[projectId]) {
                    assignments[projectId].progress = progress;
                    assignments[projectId].notes = JSON.stringify(notesList);
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0]; // YYYY-MM-DD format

                    // å„²å­˜è®Šæ›´åˆ° localStorage
                    localStorage.setItem('teamAssignments', JSON.stringify(assignments));
                    console.log('âœ… å°ˆæ¡ˆé€²åº¦å·²å„²å­˜åˆ° localStorage');

                    // ç›´æ¥åŒæ­¥åˆ° Google Driveï¼ˆç¹é TeamDataManager çš„ç¦ç”¨é™åˆ¶ï¼‰
                    let syncStatus = '';
                    if (window.googleDriveAPI && window.googleDriveAPI.isAuthenticated) {
                        try {
                            window._progressUpdate = true; // è¨­ç½®æ¨™è¨˜ï¼Œå‘ŠçŸ¥ä¿è­·è…³æœ¬é€™æ˜¯é€²åº¦æ›´æ–°

                            const assignmentData = {
                                assignments: assignments,
                                constraints: {},
                                lastSync: new Date().toISOString()
                            };

                            console.log('ğŸ“Š å°ˆæ¡ˆé€²åº¦æ›´æ–°ï¼šé–‹å§‹åŒæ­¥åˆ° Google Drive...');
                            await window.googleDriveAPI.saveFile('project-assignments.json', assignmentData);
                            console.log('âœ… å°ˆæ¡ˆé€²åº¦å·²æˆåŠŸåŒæ­¥åˆ° Google Drive');
                            syncStatus = '\nâœ… å·²åŒæ­¥åˆ° Google Drive';
                        } catch (error) {
                            console.error('âŒ åŒæ­¥å°ˆæ¡ˆé€²åº¦å¤±æ•—:', error);
                            syncStatus = `\nâŒ åŒæ­¥å¤±æ•—: ${error.message}`;
                        } finally {
                            window._progressUpdate = false;
                        }
                    } else {
                        syncStatus = '\nâš ï¸ Google Drive æœªç™»å…¥ï¼Œåƒ…å„²å­˜åˆ°æœ¬åœ°';
                    }

                    alert(`å°ˆæ¡ˆé€²åº¦å·²æ›´æ–°ç‚º ${progress}%\nå‚™è¨»å·²å„²å­˜ (å…± ${notesList.length} ç­†)${syncStatus}`);
                } else {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆ');
                }

                // é—œé–‰æ¨¡æ…‹æ¡†
                const progressModal = bootstrap.Modal.getInstance(document.getElementById('progressModal'));
                if (progressModal) progressModal.hide();

                // ç™¼é€localStorageæ›´æ–°ä¿¡è™Ÿç¢ºä¿å³æ™‚æ›´æ–°
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'progressUpdate'
                }));

                // å›åˆ°é¦–é 
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);

            } catch (error) {
                console.error('å„²å­˜å°ˆæ¡ˆé€²åº¦å¤±æ•—:', error);
                alert('å„²å­˜å°ˆæ¡ˆé€²åº¦å¤±æ•—: ' + error.message);
            }
        }

        // è®Šæ›´æˆå“¡
        async function changeMember(projectId, memberId) {
            try {

                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const members = teamDataManager.getAllMembers();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ: ${projectId}`);
                }

                const currentMember = project.members[memberId];
                if (!currentMember) {
                    throw new Error(`æ‰¾ä¸åˆ°æˆå“¡: ${memberId}`);
                }

                // ç”Ÿæˆå¯ç”¨æˆå“¡é¸é …
                let memberOptions = '';
                Object.values(members).forEach(member => {
                    const memberIdToCheck = member.memberId || member.id;
                    const memberName = member.memberName || member.name;
                    const selected = memberIdToCheck === memberId ? 'selected' : '';
                    memberOptions += `<option value="${memberIdToCheck}" ${selected}>${memberName} (${memberIdToCheck})</option>`;
                });

                // é¡¯ç¤ºæˆå“¡è®Šæ›´æ¨¡æ…‹æ¡†
                const memberModalHtml = `
                    <div class="modal fade" id="memberModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">è®Šæ›´æˆå“¡ - ${project.projectName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newMember" class="form-label">é¸æ“‡æ–°æˆå“¡</label>
                                        <select class="form-select" id="newMember">
                                            ${memberOptions}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="memberRole" class="form-label">è§’è‰²</label>
                                        <select class="form-select" id="memberRole">
                                            <option value="frontend" ${currentMember.role === 'frontend' ? 'selected' : ''}>å‰ç«¯é–‹ç™¼</option>
                                            <option value="backend" ${currentMember.role === 'backend' ? 'selected' : ''}>å¾Œç«¯é–‹ç™¼</option>
                                            <option value="fullstack" ${currentMember.role === 'fullstack' ? 'selected' : ''}>å…¨ç«¯é–‹ç™¼</option>
                                            <option value="testing" ${currentMember.role === 'testing' ? 'selected' : ''}>æ¸¬è©¦éƒ¨ç½²</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-success" onclick="saveMemberChange('${projectId}', '${memberId}')">
                                        <i class="fas fa-save"></i> å„²å­˜è®Šæ›´
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberModal = document.getElementById('memberModal');
                if (oldMemberModal) oldMemberModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberModalHtml);

                const memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
                memberModal.show();

            } catch (error) {
                console.error('è®Šæ›´æˆå“¡å¤±æ•—:', error);
                alert('è®Šæ›´æˆå“¡å¤±æ•—: ' + error.message);
            }
        }

        // åˆ‡æ›æˆå“¡åŸ·è¡Œç‹€æ…‹
        async function toggleMemberExecution(projectId, memberId, isChecked) {
            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();

                // æ›´æ–°æˆå“¡åŸ·è¡Œç‹€æ…‹
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    assignments[projectId].members[memberId].isExecuting = isChecked;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    // è¦–è¦ºå›é¥‹
                    const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                    const memberCard = checkbox ? checkbox.closest('.border.rounded') : null;
                    const memberNameDiv = memberCard ? memberCard.querySelector('.fw-bold') : null;

                    if (memberNameDiv && memberCard) {
                        if (isChecked) {
                            memberNameDiv.classList.add('text-success');
                            memberCard.style.borderLeft = '3px solid #28a745';
                            showSyncToast('ç‹€æ…‹æ›´æ–°', `${memberId} å·²é–‹å§‹åŸ·è¡Œä»»å‹™`, 'success');
                        } else {
                            memberNameDiv.classList.remove('text-success');
                            memberCard.style.borderLeft = '';
                            showSyncToast('ç‹€æ…‹æ›´æ–°', `${memberId} å·²åœæ­¢åŸ·è¡Œä»»å‹™`, 'info');
                        }
                    } else {
                        console.warn('ç„¡æ³•æ‰¾åˆ°æˆå“¡å¡ç‰‡å…ƒç´ é€²è¡Œè¦–è¦ºæ›´æ–°');
                        // ä»ç„¶é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
                        if (isChecked) {
                            showSyncToast('ç‹€æ…‹æ›´æ–°', `${memberId} å·²é–‹å§‹åŸ·è¡Œä»»å‹™`, 'success');
                        } else {
                            showSyncToast('ç‹€æ…‹æ›´æ–°', `${memberId} å·²åœæ­¢åŸ·è¡Œä»»å‹™`, 'info');
                        }
                    }

                    // æ›´æ–°çµ±è¨ˆè³‡è¨Š
                    updateExecutionStatistics();

                } else {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆæˆ–æˆå“¡');
                }

            } catch (error) {
                console.error('æ›´æ–°åŸ·è¡Œç‹€æ…‹å¤±æ•—:', error);
                alert('æ›´æ–°åŸ·è¡Œç‹€æ…‹å¤±æ•—: ' + error.message);

                // æ¢å¾© checkbox ç‹€æ…‹
                const checkbox = document.getElementById(`executing-${projectId}-${memberId}`);
                if (checkbox) {
                    checkbox.checked = !isChecked;
                }
            }
        }

        // æ›´æ–°åŸ·è¡Œçµ±è¨ˆè³‡è¨Š
        function updateExecutionStatistics() {
            try {
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    console.warn('TeamDataManager æœªåˆå§‹åŒ–');
                    return;
                }
                const assignments = teamDataManager.getAllAssignments();

                let executingCount = 0;
                Object.values(assignments).forEach(project => {
                    Object.values(project.members || {}).forEach(member => {
                        if (member.isExecuting === true) {
                            executingCount++;
                        }
                    });
                });

                // æ›´æ–°é é¢ä¸Šçš„çµ±è¨ˆé¡¯ç¤º
                const executingBadge = document.getElementById('executingCount');
                if (executingBadge) {
                    executingBadge.textContent = executingCount;
                }
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // ç·¨è¼¯è§’è‰²å‚™è¨»
        async function editPersonalNotes(projectId, memberId) {
            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];

                if (!project) {
                    throw new Error(`æ‰¾ä¸åˆ°å°ˆæ¡ˆ: ${projectId}`);
                }

                const member = project.members[memberId];
                if (!member) {
                    throw new Error(`æ‰¾ä¸åˆ°æˆå“¡: ${memberId}`);
                }

                // å¾å¯¦éš›æˆå“¡è³‡æ–™å–å¾—åç¨±
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;

                // è¨­å®šç•¶å‰è³‡æ–™ä¾›å…¶ä»–å‡½æ•¸ä½¿ç”¨
                window.currentPersonalNotes = {
                    projectId: projectId,
                    memberId: memberId,
                    member: member,
                    memberName: memberName
                };

                // æ ¼å¼åŒ–è§’è‰²å‚™è¨»é¡¯ç¤º
                const personalNotes = member.personalNotes || [];
                const notesHtml = formatPersonalNotes(personalNotes);

                // é¡¯ç¤ºå€‹äººå‚™è¨»ç·¨è¼¯æ¨¡æ…‹æ¡†
                const personalNotesModalHtml = `
                    <div class="modal fade" id="personalNotesModal" tabindex="-1">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">è§’è‰²å‚™è¨» - ${memberName} (${project.projectName})</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="mb-3">
                                        <label for="newPersonalNote" class="form-label">æ–°å¢è§’è‰²å‚™è¨»</label>
                                        <div class="mb-2">
                                            <textarea class="form-control" id="newPersonalNote" rows="3" placeholder="è¨˜éŒ„é–‹ç™¼æ­·ç¨‹ã€å­¸ç¿’ç­†è¨˜ã€é‡åˆ°çš„å•é¡Œç­‰..."></textarea>
                                        </div>
                                        <div class="mb-2">
                                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addPersonalNote()">
                                                <i class="fas fa-plus"></i> æ–°å¢å‚™è¨»
                                            </button>
                                            <button type="button" class="btn btn-sm btn-danger" onclick="clearAllPersonalNotes()">
                                                <i class="fas fa-trash"></i> æ¸…é™¤æ‰€æœ‰å‚™è¨»
                                            </button>
                                        </div>
                                        <div class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                            <div id="personalNotesList">
                                                ${notesHtml}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldPersonalNotesModal = document.getElementById('personalNotesModal');
                if (oldPersonalNotesModal) oldPersonalNotesModal.remove();
                document.body.insertAdjacentHTML('beforeend', personalNotesModalHtml);

                const personalNotesModal = new bootstrap.Modal(document.getElementById('personalNotesModal'));
                personalNotesModal.show();

            } catch (error) {
                console.error('ç·¨è¼¯å€‹äººå‚™è¨»å¤±æ•—:', error);
                alert('ç·¨è¼¯å€‹äººå‚™è¨»å¤±æ•—: ' + error.message);
            }
        }

        // æ ¼å¼åŒ–è§’è‰²å‚™è¨»é¡¯ç¤º
        function formatPersonalNotes(notes) {
            if (!notes || !Array.isArray(notes) || notes.length === 0) {
                return '<p class="text-muted m-0">å°šç„¡è§’è‰²å‚™è¨»</p>';
            }

            return notes.map((note, index) =>
                `<div class="mb-2 p-2 border-start border-info border-3 bg-white">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="fw-bold small text-muted">${note.timestamp}</div>
                        <button class="btn btn-sm btn-outline-danger p-1" onclick="deletePersonalNote(${index})" title="åˆªé™¤æ­¤å‚™è¨»">
                            <i class="fas fa-times" style="font-size: 10px;"></i>
                        </button>
                    </div>
                    <div>${note.content}</div>
                </div>`
            ).join('');
        }

        // æ–°å¢è§’è‰²å‚™è¨»
        async function addPersonalNote() {
            const newNoteInput = document.getElementById('newPersonalNote');
            const noteContent = newNoteInput.value.trim();

            if (!noteContent) {
                alert('è«‹è¼¸å…¥å‚™è¨»å…§å®¹');
                return;
            }

            const timestamp = new Date().toLocaleString('zh-TW');
            const newNote = {
                timestamp: timestamp,
                content: noteContent,
                created: new Date().toISOString()
            };

            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    // åˆå§‹åŒ–å€‹äººå‚™è¨»é™£åˆ—
                    if (!assignments[currentData.projectId].members[currentData.memberId].personalNotes) {
                        assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    }

                    // æ–°å¢åˆ°é™£åˆ—é–‹é ­ï¼ˆæœ€æ–°çš„åœ¨ä¸Šé¢ï¼‰
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes.unshift(newNote);
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    // æ›´æ–°é¡¯ç¤º
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    updatePersonalNotesDisplay(personalNotes);

                    // æ¸…ç©ºè¼¸å…¥æ¡†
                    newNoteInput.value = '';

                    showSyncToast('å‚™è¨»å·²æ–°å¢', 'è§’è‰²å‚™è¨»å·²å„²å­˜', 'success');
                }
            } catch (error) {
                console.error('æ–°å¢è§’è‰²å‚™è¨»å¤±æ•—:', error);
                alert('æ–°å¢è§’è‰²å‚™è¨»å¤±æ•—: ' + error.message);
            }
        }

        // åˆªé™¤è§’è‰²å‚™è¨»
        async function deletePersonalNote(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è§’è‰²å‚™è¨»å—ï¼Ÿ')) {
                return;
            }

            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    const personalNotes = assignments[currentData.projectId].members[currentData.memberId].personalNotes;
                    if (personalNotes && personalNotes[index]) {
                        // åˆªé™¤æŒ‡å®šçš„å‚™è¨»
                        personalNotes.splice(index, 1);
                        assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        // æ›´æ–°é¡¯ç¤º
                        updatePersonalNotesDisplay(personalNotes);

                        showSyncToast('å‚™è¨»å·²åˆªé™¤', 'è§’è‰²å‚™è¨»å·²ç§»é™¤', 'info');
                    }
                }
            } catch (error) {
                console.error('åˆªé™¤å€‹äººå‚™è¨»å¤±æ•—:', error);
                alert('åˆªé™¤å€‹äººå‚™è¨»å¤±æ•—: ' + error.message);
            }
        }

        // æ¸…é™¤æ‰€æœ‰è§’è‰²å‚™è¨»
        async function clearAllPersonalNotes() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è§’è‰²å‚™è¨»å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentData = window.currentPersonalNotes;

                if (assignments[currentData.projectId] && assignments[currentData.projectId].members[currentData.memberId]) {
                    assignments[currentData.projectId].members[currentData.memberId].personalNotes = [];
                    assignments[currentData.projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    // æ›´æ–°é¡¯ç¤º
                    updatePersonalNotesDisplay([]);

                    showSyncToast('å‚™è¨»å·²æ¸…é™¤', 'æ‰€æœ‰è§’è‰²å‚™è¨»å·²æ¸…é™¤', 'info');
                }
            } catch (error) {
                console.error('æ¸…é™¤å€‹äººå‚™è¨»å¤±æ•—:', error);
                alert('æ¸…é™¤å€‹äººå‚™è¨»å¤±æ•—: ' + error.message);
            }
        }

        // åˆªé™¤å°ˆæ¡ˆå‚™è¨»
        window.deleteProjectNote = async function(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå‚™è¨»å—ï¼Ÿ')) {
                return;
            }

            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();
                const currentProjectId = window.currentProjectId;

                if (assignments[currentProjectId]) {
                    let notesList = [];
                    if (assignments[currentProjectId].notes) {
                        try {
                            notesList = JSON.parse(assignments[currentProjectId].notes);
                        } catch (e) {
                            // å¦‚æœè§£æå¤±æ•—ï¼Œå°‡èˆŠæ ¼å¼è½‰æ›ç‚ºé™£åˆ—æ ¼å¼
                            notesList = [{
                                timestamp: 'èˆŠå‚™è¨»',
                                content: assignments[currentProjectId].notes,
                                author: 'System'
                            }];
                        }
                    }

                    if (notesList[index]) {
                        // åˆªé™¤æŒ‡å®šçš„å‚™è¨»
                        notesList.splice(index, 1);
                        assignments[currentProjectId].notes = JSON.stringify(notesList);
                        assignments[currentProjectId].lastUpdated = new Date().toISOString().split('T')[0];

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        // æ›´æ–°å°ˆæ¡ˆé€²åº¦å½ˆçª—ä¸­çš„é¡¯ç¤º
                        const notesListDiv = document.getElementById('notesList');
                        if (notesListDiv) {
                            notesListDiv.innerHTML = formatNotes(assignments[currentProjectId].notes);
                        }

                        // æ›´æ–°ä»»å‹™å°å¡ä¸­çš„å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹é¡¯ç¤º
                        const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                        if (projectNotesColumn) {
                            let updatedProjectNotesHtml = '';
                            if (assignments[currentProjectId].notes) {
                                try {
                                    const projectNotes = JSON.parse(assignments[currentProjectId].notes);
                                    if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                                        updatedProjectNotesHtml = `
                                            <div class="mb-3">
                                                <label class="form-label">å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹</label>
                                                <div class="card" style="max-height: 300px; overflow-y: auto;">
                                                    <div class="card-body p-2">
                                                        ${projectNotes.map((note, index) => `
                                                            <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                                <div class="d-flex justify-content-between align-items-center mb-1">
                                                                    <small class="text-muted">${note.author || 'System'}</small>
                                                                    <small class="text-muted">${note.timestamp}</small>
                                                                </div>
                                                                <div>${note.content}</div>
                                                            </div>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }
                                } catch (e) {
                                    // è§£æå¤±æ•—æ™‚é¡¯ç¤ºç©ºç™½
                                    updatedProjectNotesHtml = '';
                                }
                            }
                            projectNotesColumn.innerHTML = updatedProjectNotesHtml;
                        }

                        showSyncToast('å‚™è¨»å·²åˆªé™¤', 'å°ˆæ¡ˆå‚™è¨»å·²ç§»é™¤', 'info');
                    }
                }
            } catch (error) {
                console.error('åˆªé™¤å°ˆæ¡ˆå‚™è¨»å¤±æ•—:', error);
                alert('åˆªé™¤å°ˆæ¡ˆå‚™è¨»å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°è§’è‰²å‚™è¨»é¡¯ç¤º
        function updatePersonalNotesDisplay(notesList) {
            const notesListDiv = document.getElementById('personalNotesList');
            if (notesListDiv) {
                notesListDiv.innerHTML = formatPersonalNotes(notesList);
            }
        }

        // é¡¯ç¤ºæˆå“¡è³‡è¨Š
        function showMemberInfo(projectId, memberId) {
            try {
                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }

                const assignments = teamDataManager.getAllAssignments();
                const allMembers = teamDataManager.getAllMembers();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const memberInfo = allMembers[memberId];

                if (!project || !member) {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆæˆ–æˆå“¡');
                }

                const memberName = memberInfo?.name || memberId;
                const personalNotesCount = (member.personalNotes || []).length;
                const taskCardCount = Object.keys(member.taskCard || {}).length;

                // é¡¯ç¤ºæˆå“¡è³‡è¨Šæ¨¡æ…‹æ¡†
                const memberInfoModalHtml = `
                    <div class="modal fade" id="memberInfoModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">æˆå“¡è³‡è¨Š - ${memberName}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-user me-2"></i>åŸºæœ¬è³‡è¨Š</h6>
                                            <p class="mb-1"><strong>æˆå“¡ IDï¼š</strong>${memberId}</p>
                                            <p class="mb-1"><strong>æˆå“¡åç¨±ï¼š</strong>${memberName}</p>
                                            <p class="mb-1"><strong>å°ˆæ¡ˆè§’è‰²ï¼š</strong><span class="badge bg-primary">${member.role}</span></p>
                                            <p class="mb-0"><strong>åŸ·è¡Œç‹€æ…‹ï¼š</strong>
                                                ${member.isExecuting ?
                                                    '<span class="badge bg-success">åŸ·è¡Œä¸­</span>' :
                                                    '<span class="badge bg-secondary">æœªåŸ·è¡Œ</span>'
                                                }
                                            </p>
                                        </div>
                                    </div>

                                    <div class="card mb-3">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-chart-bar me-2"></i>æ´»å‹•çµ±è¨ˆ</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-primary">${personalNotesCount}</div>
                                                        <small class="text-muted">è§’è‰²å‚™è¨»</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="fs-4 fw-bold text-success">${taskCardCount}</div>
                                                        <small class="text-muted">ä»»å‹™å°å¡</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title"><i class="fas fa-project-diagram me-2"></i>å°ˆæ¡ˆè³‡è¨Š</h6>
                                            <p class="mb-1"><strong>å°ˆæ¡ˆåç¨±ï¼š</strong>${project.projectName}</p>
                                            <p class="mb-1"><strong>å°ˆæ¡ˆç‹€æ…‹ï¼š</strong>
                                                <span class="badge bg-${
                                                    project.status === 'active' ? 'success' :
                                                    project.status === 'paused' ? 'warning' :
                                                    project.status === 'completed' ? 'secondary' : 'info'
                                                }">${
                                                    project.status === 'active' ? 'é€²è¡Œä¸­' :
                                                    project.status === 'paused' ? 'æš«åœ' :
                                                    project.status === 'completed' ? 'å·²å®Œæˆ' :
                                                    project.status || 'æœªçŸ¥ç‹€æ…‹'
                                                }</span>
                                            </p>
                                            <p class="mb-0"><strong>æœ€å¾Œæ›´æ–°ï¼š</strong>${project.lastUpdated || 'æœªçŸ¥'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const oldMemberInfoModal = document.getElementById('memberInfoModal');
                if (oldMemberInfoModal) oldMemberInfoModal.remove();
                document.body.insertAdjacentHTML('beforeend', memberInfoModalHtml);

                const memberInfoModal = new bootstrap.Modal(document.getElementById('memberInfoModal'));
                memberInfoModal.show();

            } catch (error) {
                console.error('é¡¯ç¤ºæˆå“¡è³‡è¨Šå¤±æ•—:', error);
                alert('é¡¯ç¤ºæˆå“¡è³‡è¨Šå¤±æ•—: ' + error.message);
            }
        }

        // å„²å­˜æˆå“¡è®Šæ›´
        async function saveMemberChange(projectId, oldMemberId) {
            try {
                const newMemberId = document.getElementById('newMember').value;
                const newRole = document.getElementById('memberRole').value;

                // ä½¿ç”¨å…¨åŸŸçš„åœ˜éšŠè³‡æ–™ç®¡ç†å™¨ï¼Œç¢ºä¿èˆ‡æ­·ç¨‹è¨˜éŒ„åŒæ­¥
                let teamDataManager;
                if (window.teamManagement && window.teamManagement.dataManager) {
                    teamDataManager = window.teamManagement.dataManager;
                } else {
                    teamDataManager = await getTeamDataManager();
                }
                const assignments = teamDataManager.getAllAssignments();

                // æª¢æŸ¥æ–°æˆå“¡æ˜¯å¦å·²ç¶“åœ¨ç•¶å‰å°ˆæ¡ˆä¸­ï¼ˆé¿å…é‡è¤‡ï¼‰
                if (assignments[projectId].members && assignments[projectId].members[newMemberId] && newMemberId !== oldMemberId) {
                    alert(`${newMemberId} å·²ç¶“åœ¨æ­¤å°ˆæ¡ˆä¸­ï¼\nä¸€å€‹å°ˆæ¡ˆå…§ä¸èƒ½æœ‰é‡è¤‡çš„æˆå“¡ã€‚`);
                    return;
                }

                // å–å¾—èˆŠæˆå“¡è³‡æ–™
                const oldMemberData = assignments[projectId].members[oldMemberId];
                const oldRole = oldMemberData?.role;

                if (newMemberId !== oldMemberId) {
                    // æª¢æŸ¥æ–°æˆå“¡æ˜¯å¦çœŸçš„ä¸åŒï¼ˆé¿å…é‡è¤‡åˆ‡æ›çš„å•é¡Œï¼‰
                    console.log('æˆå“¡è®Šæ›´æª¢æŸ¥:', {
                        oldMemberId,
                        newMemberId,
                        currentMembers: Object.keys(assignments[projectId].members)
                    });

                    // å¦‚æœæ›´æ›æˆå“¡ï¼Œåˆªé™¤èˆŠæˆå“¡
                    delete assignments[projectId].members[oldMemberId];

                    // æ–°å¢æ–°æˆå“¡ï¼Œä¿ç•™ä»»å‹™å°å¡å’Œå€‹äººå‚™è¨»ç­‰è³‡æ–™
                    assignments[projectId].members[newMemberId] = {
                        memberId: newMemberId,
                        role: newRole,
                        taskCard: oldMemberData.taskCard || {},
                        personalNotes: oldMemberData.personalNotes || [], // è¤‡è£½å€‹äººå‚™è¨»
                        isExecuting: false // æ–°æˆå“¡é è¨­ç‚ºæœªåŸ·è¡Œç‹€æ…‹
                    };

                    // è¨˜éŒ„è§’è‰²è®Šæ›´æ­·ç¨‹ - æˆå“¡ç§»é™¤
                    if (window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // å–å¾—çœŸå¯¦æˆå“¡å§“å
                        const oldMemberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;
                        const newMemberName = window.teamDataManager.getAllMembers()[newMemberId]?.name || newMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_removed',
                            memberId: oldMemberId,
                            memberName: oldMemberName,
                            role: oldRole,
                            details: `æˆå“¡å¾å°ˆæ¡ˆä¸­ç§»é™¤`
                        });

                        // è¨˜éŒ„è§’è‰²è®Šæ›´æ­·ç¨‹ - æˆå“¡åŠ å…¥
                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'member_assigned',
                            memberId: newMemberId,
                            memberName: newMemberName,
                            role: newRole,
                            details: `æ–°æˆå“¡åŠ å…¥å°ˆæ¡ˆ`
                        });
                    }
                } else {
                    // å¦‚æœåªæ˜¯æ›´æ”¹è§’è‰²
                    assignments[projectId].members[oldMemberId].role = newRole;

                    // è¨˜éŒ„è§’è‰²è®Šæ›´æ­·ç¨‹
                    if (oldRole !== newRole && window.teamManagement && typeof window.teamManagement.addMemberChangeHistory === 'function') {
                        // å–å¾—çœŸå¯¦æˆå“¡å§“å
                        const memberName = window.teamDataManager.getAllMembers()[oldMemberId]?.name || oldMemberId;

                        window.teamManagement.addMemberChangeHistory(projectId, {
                            action: 'role_changed',
                            memberId: oldMemberId,
                            memberName: memberName,
                            oldRole: oldRole,
                            newRole: newRole,
                            details: `è§’è‰²å¾ ${oldRole} è®Šæ›´ç‚º ${newRole}`
                        });
                    }
                }

                // æ›´æ–°å°ˆæ¡ˆçš„æœ€å¾Œæ›´æ–°æ™‚é–“
                assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                // å„²å­˜è®Šæ›´
                await teamDataManager.saveLocalChanges();

                alert(`æˆå“¡å·²å¾ ${oldMemberId} è®Šæ›´ç‚º ${newMemberId}\nè§’è‰²: ${newRole}`);

                // é—œé–‰æ¨¡æ…‹æ¡†
                const memberModal = bootstrap.Modal.getInstance(document.getElementById('memberModal'));
                if (memberModal) memberModal.hide();

                // ç«‹å³é‡æ–°è¼‰å…¥é é¢è³‡æ–™
                await loadDataDirectly();

                // ç™¼é€localStorageæ›´æ–°ä¿¡è™Ÿç¢ºä¿å³æ™‚æ›´æ–°
                localStorage.setItem('teamUpdateSignal', JSON.stringify({
                    action: 'teamDataUpdate',
                    timestamp: Date.now(),
                    source: 'memberChange'
                }));

            } catch (error) {
                console.error('å„²å­˜æˆå“¡è®Šæ›´å¤±æ•—:', error);
                alert('å„²å­˜æˆå“¡è®Šæ›´å¤±æ•—: ' + error.message);
            }
        }

        // å„²å­˜ä»»å‹™å°å¡å…§å®¹
        async function saveTaskCard(projectId, memberId) {
            try {
                const taskContent = document.getElementById('taskContent').value;

                if (!taskContent.trim()) {
                    alert('ä»»å‹™å°å¡å…§å®¹ä¸èƒ½ç‚ºç©º');
                    return;
                }

                // ä½¿ç”¨å…¨åŸŸ TeamDataManager
                const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                if (!teamDataManager) {
                    throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                }
                const assignments = teamDataManager.getAllAssignments();

                // æ›´æ–°ä»»å‹™å°å¡å…§å®¹
                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    if (!assignments[projectId].members[memberId].taskCard) {
                        assignments[projectId].members[memberId].taskCard = {};
                    }

                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    const currentTime = new Date().toISOString();

                    // å¦‚æœå…§å®¹æœ‰è®Šæ›´ï¼Œä¿å­˜åˆ°æ­·ç¨‹ä¸­
                    if (taskCard.content && taskCard.content !== taskContent) {
                        if (!taskCard.history) {
                            taskCard.history = [];
                        }

                        // æ·»åŠ æ­·ç¨‹è¨˜éŒ„
                        taskCard.history.push({
                            timestamp: taskCard.lastUpdated || currentTime,
                            content: taskCard.content,
                            note: 'å…§å®¹æ›´æ–°',
                            author: 'KopylotA', // ErNexus å°ˆæ¡ˆçš„ testing è§’è‰²
                            version: `v${(taskCard.history.length + 1).toString().padStart(2, '0')}`
                        });

                        // ä¿ç•™æœ€è¿‘20ç­†æ­·ç¨‹è¨˜éŒ„
                        if (taskCard.history.length > 20) {
                            taskCard.history = taskCard.history.slice(-20);
                        }
                    }

                    taskCard.content = taskContent;
                    taskCard.lastUpdated = currentTime;
                    assignments[projectId].lastUpdated = new Date().toISOString().split('T')[0];

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();

                    alert('ä»»å‹™å°å¡å·²æˆåŠŸå„²å­˜ï¼');

                    // é—œé–‰æ¨¡æ…‹æ¡†
                    const taskModal = bootstrap.Modal.getInstance(document.getElementById('taskCardModal'));
                    if (taskModal) {
                        taskModal.hide();
                    }

                    // é‡æ–°è¼‰å…¥é¦–é è³‡æ–™
                    loadDataDirectly();

                } else {
                    throw new Error('æ‰¾ä¸åˆ°æŒ‡å®šçš„å°ˆæ¡ˆæˆ–æˆå“¡');
                }

            } catch (error) {
                console.error('å„²å­˜ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('å„²å­˜ä»»å‹™å°å¡å¤±æ•—: ' + error.message);
            }
        }

        // è¤‡è£½ä»»å‹™å°å¡å…§å®¹
        async function copyTaskCard() {
            try {
                const taskContent = document.getElementById('taskContent').value;

                // ç²å–å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹å’Œè§’è‰²å‚™è¨»
                let projectNotesText = '';
                let personalNotesText = '';
                try {
                    const teamDataManager = await getTeamDataManager();
                    const assignments = teamDataManager.getAllAssignments();
                    const currentProject = assignments[window.currentTaskCardTemplate?.projectId];

                    // è™•ç†å°ˆæ¡ˆå‚™è¨»
                    if (currentProject && currentProject.notes) {
                        const projectNotes = JSON.parse(currentProject.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesText = '\n\n=== å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹ ===\n' +
                                projectNotes.map(note =>
                                    `${note.timestamp} [${note.author || 'System'}]: ${note.content}`
                                ).join('\n') + '\n';
                        }
                    }

                    // è™•ç†è§’è‰²å‚™è¨»
                    const currentMember = currentProject?.members?.[window.currentTaskCardTemplate?.memberId];
                    console.log('è¤‡è£½è§’è‰²å‚™è¨»èª¿è©¦:', {
                        projectId: window.currentTaskCardTemplate?.projectId,
                        memberId: window.currentTaskCardTemplate?.memberId,
                        currentMember: currentMember,
                        personalNotes: currentMember?.personalNotes
                    });

                    if (currentMember && currentMember.personalNotes && currentMember.personalNotes.length > 0) {
                        personalNotesText = '\n\n=== è§’è‰²å‚™è¨» ===\n' +
                            currentMember.personalNotes.map(note =>
                                `${note.timestamp} [${note.author || 'System'}]: ${note.content}`
                            ).join('\n') + '\n';
                        console.log('è§’è‰²å‚™è¨»è¤‡è£½å…§å®¹:', personalNotesText);
                    } else {
                        console.log('æ²’æœ‰æ‰¾åˆ°è§’è‰²å‚™è¨»');
                    }
                } catch (e) {
                    console.error('ç²å–å‚™è¨»æ™‚ç™¼ç”ŸéŒ¯èª¤:', e);
                }

                const textToCopy = taskContent + projectNotesText + personalNotesText;

                navigator.clipboard.writeText(textToCopy).then(() => {
                    // è¦–è¦ºå›é¥‹
                    const buttons = document.querySelectorAll('button[onclick="copyTaskCard()"]');
                    const button = buttons[0]; // å–å¾—è¤‡è£½æŒ‰éˆ•
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> å·²è¤‡è£½';
                        button.classList.remove('btn-success');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-success');
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('è¤‡è£½å¤±æ•—:', err);
                    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹');
                });
            } catch (error) {
                console.error('è¤‡è£½ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½å…§å®¹');
            }
        }

        // æ¢å¾©æ­·å²ç‰ˆæœ¬å…§å®¹
        function restoreHistoryVersion(timestamp, content) {
            try {
                if (confirm('ç¢ºå®šè¦æ¢å¾©æ­¤æ­·å²ç‰ˆæœ¬å—ï¼Ÿç›®å‰çš„ç·¨è¼¯å…§å®¹å°‡è¢«è¦†è“‹ã€‚')) {
                    // å°‡æ­·å²å…§å®¹å¡«å…¥æ–‡å­—å€åŸŸ
                    document.getElementById('taskContent').value = content;


                    alert('å·²æ¢å¾©æ­·å²ç‰ˆæœ¬å…§å®¹ï¼Œè«‹è¨˜å¾—å„²å­˜è®Šæ›´ã€‚');
                }
            } catch (error) {
                console.error('æ¢å¾©æ­·å²ç‰ˆæœ¬å¤±æ•—:', error);
                alert('æ¢å¾©æ­·å²ç‰ˆæœ¬å¤±æ•—: ' + error.message);
            }
        }

        // æ›´æ–°ä»»å‹™å°å¡ modal å…§å®¹ï¼ˆä¸é‡æ–°å‰µå»º modalï¼‰
        async function updateTaskCardModal(projectId, memberId) {
            try {
                // é‡æ–°è¼‰å…¥å°ˆæ¡ˆè³‡æ–™
                const teamDataManager = await getTeamDataManager();
                const assignments = teamDataManager.getAllAssignments();
                const project = assignments[projectId];
                const member = project.members[memberId];
                const taskCard = member.taskCard;

                // é‡æ–°ç”Ÿæˆå°ˆæ¡ˆå‚™è¨»æ­·ç¨‹ HTML
                let projectNotesHtml = '';
                if (project.notes) {
                    try {
                        const projectNotes = JSON.parse(project.notes);
                        if (Array.isArray(projectNotes) && projectNotes.length > 0) {
                            projectNotesHtml = `
                                <div class="mb-3">
                                    <label class="form-label">å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹</label>
                                    <div class="card" style="max-height: 300px; overflow-y: auto;">
                                        <div class="card-body p-2">
                                            ${projectNotes.map((note, index) => `
                                                <div class="border-bottom mb-2 pb-2 ${index === projectNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                                        <small class="text-muted">${note.author || 'System'}</small>
                                                        <small class="text-muted">${note.timestamp}</small>
                                                    </div>
                                                    <div class="small">${note.content}</div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } catch (e) {
                    }
                }

                // é‡æ–°ç”Ÿæˆä»»å‹™å°å¡æ­·ç¨‹è¨˜éŒ„ HTML
                let taskHistoryHtml = '';
                if (taskCard && taskCard.history && taskCard.history.length > 0) {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label mb-0">ä»»å‹™å°å¡æ­·ç¨‹</label>
                                <button class="btn btn-sm btn-outline-danger" onclick="clearTaskHistory('${projectId}', '${memberId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${taskCard.history.slice().reverse().map((record, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === taskCard.history.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${record.version} - ${record.author}</small>
                                                <div class="d-flex align-items-center gap-1">
                                                    <small class="text-muted">${new Date(record.timestamp).toLocaleString('zh-TW')}</small>
                                                    <button class="btn btn-sm btn-outline-danger p-1" onclick="deleteTaskHistoryItem('${projectId}', '${memberId}', '${record.timestamp}')" title="åˆªé™¤æ­¤è¨˜éŒ„">
                                                        <i class="fas fa-times" style="font-size: 10px;"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="small text-info">${record.note}</div>
                                            <details class="mt-1">
                                                <summary class="small text-secondary" style="cursor: pointer;">æŸ¥çœ‹å…§å®¹</summary>
                                                <div class="mt-1">
                                                    <pre class="small mb-2" style="max-height: 100px; overflow-y: auto; white-space: pre-wrap;">${record.content}</pre>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="restoreHistoryVersion('${record.timestamp}', \`${record.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                                                        <i class="fas fa-history"></i> æ¢å¾©æ­¤ç‰ˆæœ¬
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    taskHistoryHtml = `
                        <div class="mb-3">
                            <label class="form-label">ä»»å‹™å°å¡æ­·ç¨‹</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>å°šç„¡æ­·ç¨‹è¨˜éŒ„</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // é‡æ–°ç”Ÿæˆè§’è‰²å‚™è¨» HTML
                const allMembers = teamDataManager.getAllMembers() || {};
                const memberName = allMembers[memberId]?.name || memberId;
                let personalNotesHtml = '';
                const personalNotes = member.personalNotes || [];
                if (personalNotes.length > 0) {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²å‚™è¨»</label>
                            <div class="card" style="max-height: 300px; overflow-y: auto;">
                                <div class="card-body p-2">
                                    ${personalNotes.map((note, index) => `
                                        <div class="border-bottom mb-2 pb-2 ${index === personalNotes.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <small class="text-muted">${note.author || memberName}</small>
                                                <small class="text-muted">${note.timestamp}</small>
                                            </div>
                                            <div class="small">${note.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    personalNotesHtml = `
                        <div class="mb-3">
                            <label class="form-label">è§’è‰²å‚™è¨»</label>
                            <div class="card">
                                <div class="card-body p-2 text-center text-muted">
                                    <small>å°šç„¡è§’è‰²å‚™è¨»è¨˜éŒ„</small>
                                </div>
                            </div>
                        </div>
                    `;
                }

                // æ›´æ–°ç¾æœ‰ modal ä¸­çš„å°ˆæ¡ˆå‚™è¨»æ­·ç¨‹ã€è§’è‰²å‚™è¨»ã€ä»»å‹™å°å¡æ­·ç¨‹å’Œè§’è‰²è®Šæ›´æ­·ç¨‹æ¬„ä½
                const projectNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(2)');
                const personalNotesColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(3)');
                const taskHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(4)');
                const memberHistoryColumn = document.querySelector('#taskCardModal .col-lg-2:nth-child(5)');

                if (projectNotesColumn) {
                    projectNotesColumn.innerHTML = projectNotesHtml;
                }
                if (personalNotesColumn) {
                    personalNotesColumn.innerHTML = personalNotesHtml;
                }
                if (taskHistoryColumn) {
                    taskHistoryColumn.innerHTML = taskHistoryHtml;
                }
                if (memberHistoryColumn) {
                    // é‡æ–°ç”Ÿæˆè§’è‰²è®Šæ›´æ­·ç¨‹
                    let updatedMemberHistoryHtml = '';
                    try {
                        if (window.generateMemberHistoryHTML && typeof window.generateMemberHistoryHTML === 'function') {
                            updatedMemberHistoryHtml = window.generateMemberHistoryHTML(projectId);
                        } else {
                            const currentProject = teamDataManager.getAllAssignments()[projectId];
                            const memberHistory = currentProject?.memberHistory || [];
                            if (memberHistory.length > 0) {
                                const actionLabels = {
                                    'member_assigned': '<i class="fas fa-user-plus text-success me-2"></i>æˆå“¡åŠ å…¥',
                                    'member_removed': '<i class="fas fa-user-minus text-danger me-2"></i>æˆå“¡ç§»é™¤',
                                    'role_changed': '<i class="fas fa-exchange-alt text-warning me-2"></i>è§’è‰²è®Šæ›´'
                                };

                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                                <i class="fas fa-trash"></i> æ¸…ç©º
                                            </button>
                                        </div>
                                        <div class="card" style="max-height: 400px; overflow-y: auto;">
                                            <div class="card-body p-2">
                                                ${memberHistory.slice().reverse().map((entry, index) => `
                                                    <div class="border-bottom mb-2 pb-2 ${index === memberHistory.length - 1 ? 'border-0 mb-0 pb-0' : ''}">
                                                        <div class="d-flex justify-content-between align-items-start mb-1">
                                                            <div class="small">
                                                                ${actionLabels[entry.action] || entry.action}
                                                                <strong>${entry.memberName}</strong>
                                                            </div>
                                                            <small class="text-muted">${new Date(entry.timestamp).toLocaleString('zh-TW')}</small>
                                                        </div>
                                                        <div class="ps-3">
                                                            ${entry.role ? `<span class="badge bg-info small">${entry.role}</span>` : ''}
                                                            ${entry.oldRole && entry.newRole ? `
                                                                <div class="mt-1">
                                                                    <span class="badge bg-secondary small">${entry.oldRole}</span>
                                                                    <i class="fas fa-arrow-right mx-1 small"></i>
                                                                    <span class="badge bg-success small">${entry.newRole}</span>
                                                                </div>
                                                            ` : ''}
                                                            ${entry.details ? `<div class="text-muted mt-1 small">${entry.details}</div>` : ''}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            } else {
                                updatedMemberHistoryHtml = `
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                            <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                                <i class="fas fa-trash"></i> æ¸…ç©º
                                            </button>
                                        </div>
                                        <div class="card">
                                            <div class="card-body p-2 text-center text-muted">
                                                <small>å°šç„¡æˆå“¡è®Šæ›´è¨˜éŒ„</small>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }
                        }
                    } catch (error) {
                        console.warn('æ›´æ–°è§’è‰²è®Šæ›´æ­·ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        updatedMemberHistoryHtml = `
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label mb-0">è§’è‰²è®Šæ›´æ­·ç¨‹</label>
                                    <button class="btn btn-sm btn-outline-danger" onclick="clearMemberHistory('${projectId}')" title="æ¸…ç©ºæ‰€æœ‰æ­·ç¨‹">
                                        <i class="fas fa-trash"></i> æ¸…ç©º
                                    </button>
                                </div>
                                <div class="card">
                                    <div class="card-body p-2 text-center text-muted">
                                        <small>è¼‰å…¥æ­·ç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤</small>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    memberHistoryColumn.innerHTML = updatedMemberHistoryHtml;
                }

            } catch (error) {
                console.error('æ›´æ–°ä»»å‹™å°å¡ modal å…§å®¹å¤±æ•—:', error);
            }
        }

        // åˆªé™¤å–®ç­†ä»»å‹™å°å¡æ­·ç¨‹è¨˜éŒ„
        async function deleteTaskHistoryItem(projectId, memberId, timestamp) {
            try {
                if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ­·ç¨‹è¨˜éŒ„å—ï¼Ÿ')) {
                    return;
                }

                // è¼‰å…¥åœ˜éšŠè³‡æ–™ç®¡ç†å™¨
                const teamDataManager = await getTeamDataManager();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard && taskCard.history) {
                        // ç§»é™¤æŒ‡å®šæ™‚é–“æˆ³çš„æ­·ç¨‹è¨˜éŒ„
                        taskCard.history = taskCard.history.filter(record => record.timestamp !== timestamp);

                        // é‡æ–°ç·¨è™Ÿç‰ˆæœ¬
                        taskCard.history.forEach((record, index) => {
                            record.version = `v${(index + 1).toString().padStart(2, '0')}`;
                        });

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        alert('æ­·ç¨‹è¨˜éŒ„å·²åˆªé™¤');

                        // æ›´æ–°ç¾æœ‰ modal çš„å…§å®¹è€Œä¸é‡æ–°å‰µå»º
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('åˆªé™¤æ­·ç¨‹è¨˜éŒ„å¤±æ•—:', error);
                alert('åˆªé™¤æ­·ç¨‹è¨˜éŒ„å¤±æ•—: ' + error.message);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰ä»»å‹™å°å¡æ­·ç¨‹è¨˜éŒ„
        async function clearTaskHistory(projectId, memberId) {
            try {
                if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰ä»»å‹™å°å¡æ­·ç¨‹è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }

                // è¼‰å…¥åœ˜éšŠè³‡æ–™ç®¡ç†å™¨
                const teamDataManager = await getTeamDataManager();
                const assignments = teamDataManager.getAllAssignments();

                if (assignments[projectId] && assignments[projectId].members[memberId]) {
                    const taskCard = assignments[projectId].members[memberId].taskCard;
                    if (taskCard) {
                        // æ¸…ç©ºæ­·ç¨‹è¨˜éŒ„
                        taskCard.history = [];

                        // å„²å­˜è®Šæ›´
                        await teamDataManager.saveLocalChanges();

                        alert('æ‰€æœ‰æ­·ç¨‹è¨˜éŒ„å·²æ¸…ç©º');

                        // æ›´æ–°ç¾æœ‰ modal çš„å…§å®¹è€Œä¸é‡æ–°å‰µå»º
                        await updateTaskCardModal(projectId, memberId);
                    }
                }
            } catch (error) {
                console.error('æ¸…ç©ºæ­·ç¨‹è¨˜éŒ„å¤±æ•—:', error);
                alert('æ¸…ç©ºæ­·ç¨‹è¨˜éŒ„å¤±æ•—: ' + error.message);
            }
        }

        // æ¸…ç©ºæ‰€æœ‰è§’è‰²è®Šæ›´æ­·ç¨‹è¨˜éŒ„
        async function clearMemberHistory(projectId) {
            try {
                if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è§’è‰²è®Šæ›´æ­·ç¨‹è¨˜éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }
                // è¼‰å…¥åœ˜éšŠè³‡æ–™ç®¡ç†å™¨
                const teamDataManager = await getTeamDataManager();

                if (teamDataManager.assignments[projectId]) {
                    // ç›´æ¥ä¿®æ”¹ assignments å…§éƒ¨è³‡æ–™
                    teamDataManager.assignments[projectId].memberHistory = [];
                    teamDataManager.assignments[projectId].lastUpdated = new Date().toISOString();

                    // å„²å­˜è®Šæ›´
                    await teamDataManager.saveLocalChanges();
                    alert('æ‰€æœ‰è§’è‰²è®Šæ›´æ­·ç¨‹è¨˜éŒ„å·²æ¸…ç©º');

                    // å¦‚æœä»»å‹™å°å¡æ¨¡æ…‹æ¡†å·²é–‹å•Ÿï¼Œéœ€è¦é‡æ–°è¼‰å…¥å…§å®¹
                    const taskCardModal = document.getElementById('taskCardModal');
                    if (taskCardModal && taskCardModal.classList.contains('show')) {
                        // é‡æ–°è¼‰å…¥é é¢ä»¥æ›´æ–°æ‰€æœ‰é¡¯ç¤º
                        window.location.reload();
                    }
                }
            } catch (error) {
                console.error('æ¸…ç©ºè§’è‰²è®Šæ›´æ­·ç¨‹å¤±æ•—:', error);
                alert('æ¸…ç©ºè§’è‰²è®Šæ›´æ­·ç¨‹å¤±æ•—: ' + error.message);
            }
        }

        // æ¢å¾©é è¨­ä»»å‹™å°å¡å…§å®¹
        function restoreDefaultTaskCard(projectId, memberId) {
            try {
                if (!window.currentTaskCardTemplate ||
                    window.currentTaskCardTemplate.projectId !== projectId ||
                    window.currentTaskCardTemplate.memberId !== memberId) {
                    alert('ç„¡æ³•å–å¾—é è¨­ç¯„æœ¬è³‡æ–™');
                    return;
                }

                // ç¢ºèªæ˜¯å¦è¦æ¢å¾©é è¨­
                if (confirm('ç¢ºå®šè¦æ¢å¾©é è¨­ç¯„æœ¬å—ï¼Ÿæ­¤æ“ä½œå°‡æ¸…é™¤ç›®å‰çš„ç·¨è¼¯å…§å®¹ã€‚')) {
                    // å°‡é è¨­å…§å®¹å¡«å…¥æ–‡å­—å€åŸŸ
                    document.getElementById('taskContent').value = window.currentTaskCardTemplate.defaultContent;


                    // è¦–è¦ºå›é¥‹
                    const buttons = document.querySelectorAll(`button[onclick*="restoreDefaultTaskCard"]`);
                    const button = buttons[0]; // å–å¾—æ¢å¾©é è¨­æŒ‰éˆ•
                    if (button) {
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check"></i> å·²æ¢å¾©';
                        button.classList.remove('btn-warning');
                        button.classList.add('btn-info');

                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('btn-info');
                            button.classList.add('btn-warning');
                        }, 2000);
                    }
                }
            } catch (error) {
                console.error('æ¢å¾©é è¨­ä»»å‹™å°å¡å¤±æ•—:', error);
                alert('æ¢å¾©é è¨­å¤±æ•—: ' + error.message);
            }
        }

        // é é¢è¼‰å…¥æ™‚ç›´æ¥åŸ·è¡Œï¼ˆå»¶é²ä¸€ä¸‹ç­‰èªè­‰é€šéï¼‰
        window.addEventListener('DOMContentLoaded', () => {
            // æ·»åŠ å°ˆæ¡ˆå‚™è¨»åˆªé™¤æŒ‰éˆ•çš„äº‹ä»¶å§”è¨—
            document.addEventListener('click', function(event) {
                if (event.target.closest('.delete-project-note-btn')) {
                    const button = event.target.closest('.delete-project-note-btn');
                    const index = parseInt(button.getAttribute('data-index'));
                    if (!isNaN(index)) {
                        window.deleteProjectNote(index);
                    }
                }
            });

            // ç­‰å¾…æ›´é•·æ™‚é–“ç¢ºä¿ Google Drive API å®Œå…¨åˆå§‹åŒ–
            setTimeout(() => {
                // åªæœ‰åœ¨èªè­‰é€šéå¾Œæ‰è¼‰å…¥
                const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
                if (isAuthenticated) {
                    loadDataDirectly();
                }
            }, 2000);
        });

        // åš´æ ¼çš„èªè­‰æª¢æŸ¥ - ç„¡ç¹éæ©Ÿåˆ¶
        function checkAuthentication() {
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';
            if (!isAuthenticated) {
                // ç¢ºä¿æœªèªè­‰æ™‚å®Œå…¨éš±è—æ‰€æœ‰è³‡æ–™
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner å·²ç§»é™¤
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                // ç¦æ­¢åˆå§‹åŒ– Dashboard
                window.markdownDashboard = null;
                return false;
            }
            // å¦‚æœå·²èªè­‰ï¼Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
            showMainDashboard();
            // æª¢æŸ¥ session æ˜¯å¦éæœŸ
            checkSessionTimeout();
            return true;
        }
        
        // ç§é‘°é©—è­‰åŠŸèƒ½
        document.getElementById('verifyKeyBtn').addEventListener('click', async function() {
            const googleConfigJSON = document.getElementById('googleConfigInput').value.trim();
            const privateKeyPEM = document.getElementById('privateKeyInput').value.trim();
            const errorDiv = document.getElementById('keyError');
            const successDiv = document.getElementById('keySuccess');

            // é©—è­‰ Google Drive è¨­å®š
            if (!googleConfigJSON) {
                document.getElementById('keyErrorText').textContent = 'è«‹è¼¸å…¥ Google Drive è¨­å®š';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            let googleConfig;
            try {
                googleConfig = JSON.parse(googleConfigJSON);
                if (!googleConfig.CLIENT_ID || !googleConfig.FOLDER_ID || !googleConfig.SCOPES) {
                    throw new Error('è¨­å®šæ ¼å¼ä¸å®Œæ•´');
                }
            } catch (error) {
                document.getElementById('keyErrorText').textContent = `Google Drive è¨­å®šæ ¼å¼éŒ¯èª¤ï¼š${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }

            if (!privateKeyPEM) {
                document.getElementById('keyErrorText').textContent = 'è«‹è¼¸å…¥ç§é‘°';
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
                return;
            }
            
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>é©—è­‰ä¸­...';
            
            try {
                // ä½¿ç”¨ Web Crypto API é©—è­‰ç§é‘°
                const isValid = await verifyPrivateKeyWebCrypto(privateKeyPEM);
                
                if (isValid) {
                    // å„²å­˜ Google Drive è¨­å®šåˆ° sessionStorage
                    sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', JSON.stringify(googleConfig));

                    // è¨­å®šç™»å…¥ç‹€æ…‹å’Œæ™‚é–“æˆ³
                    const loginTime = Date.now();
                    sessionStorage.setItem('KEY_AUTHENTICATED', 'true');
                    sessionStorage.setItem('LOGIN_TIME', loginTime.toString());

                    successDiv.classList.remove('d-none');
                    errorDiv.classList.add('d-none');
                    
                    setTimeout(async () => {
                        document.getElementById('keyAuthentication').style.display = 'none';

                        // ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•è¼‰å…¥è³‡æ–™ï¼ˆèˆ‡é‡æ–°è¼‰å…¥æŒ‰éˆ•ç›¸åŒçš„æµç¨‹ï¼‰
                        console.log('ğŸš€ ç™»å…¥æˆåŠŸï¼Œè¼‰å…¥è³‡æ–™...');
                        showMainDashboard();

                        // èˆ‡é‡æ–°è¼‰å…¥æŒ‰éˆ•ç›¸åŒçš„æµç¨‹
                        await loadDataDirectly();
                    }, 1000);
                } else {
                    document.getElementById('keyErrorText').textContent = 'ç§é‘°é©—è­‰å¤±æ•—ï¼Œè«‹ç¢ºèªç§é‘°æ­£ç¢º';
                    errorDiv.classList.remove('d-none');
                    successDiv.classList.add('d-none');
                }
            } catch (error) {
                console.error('Key verification error:', error);
                document.getElementById('keyErrorText').textContent = `é©—è­‰éŒ¯èª¤ï¼š${error.message}`;
                errorDiv.classList.remove('d-none');
                successDiv.classList.add('d-none');
            } finally {
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-shield-alt me-2"></i>é©—è­‰ä¸¦é€²å…¥';
            }
        });
        
        // å¾æª”æ¡ˆåŒ¯å…¥ç§é‘°
        document.getElementById('uploadKeyBtn').addEventListener('click', function() {
            document.getElementById('keyFileInput').click();
        });
        
        document.getElementById('keyFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('privateKeyInput').value = event.target.result;
                };
                reader.readAsText(file);
            }
        });
        
        // é¡¯ç¤ºä¸» Dashboard
        function showMainDashboard() {
            // éš±è—ç™»å…¥ä»‹é¢
            const keyAuth = document.getElementById('keyAuthentication');
            if (keyAuth) {
                keyAuth.style.display = 'none';
                console.log('âœ… ç™»å…¥ä»‹é¢å·²éš±è—');
            }

            // é¡¯ç¤ºå·¥å…·åˆ—æŒ‰éˆ•
            document.getElementById('logoutBtn').style.display = 'inline-block';
            document.getElementById('teamManagementBtn').style.display = 'inline-block';
            document.getElementById('devLogBtn').style.display = 'inline-block';
            document.getElementById('syncBtn').style.display = 'inline-block';
            document.getElementById('pullBtn').style.display = 'inline-block';
            document.getElementById('syncRoleNotesBtn').style.display = 'inline-block';
            document.getElementById('fixRolesBtn').style.display = 'inline-block';
            document.getElementById('testPushBtn').style.display = 'inline-block';

            // é¡¯ç¤ºä¸»è¦å…§å®¹å€åŸŸ
            const summaryCards = document.getElementById('summaryCards');
            const projectsList = document.getElementById('projectsList');

            if (summaryCards) {
                summaryCards.style.display = 'flex';
                summaryCards.style.visibility = 'visible';
                summaryCards.style.opacity = '1';
                console.log('âœ… summaryCards å·²é¡¯ç¤ºï¼Œç•¶å‰ display:', summaryCards.style.display);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ° summaryCards å…ƒç´ ');
            }

            if (projectsList) {
                projectsList.style.display = 'block';
                projectsList.style.visibility = 'visible';
                projectsList.style.opacity = '1';
                console.log('âœ… projectsList å·²é¡¯ç¤ºï¼Œç•¶å‰ display:', projectsList.style.display);
            } else {
                console.error('âŒ æ‰¾ä¸åˆ° projectsList å…ƒç´ ');
            }

            console.log('âœ… ä¸» Dashboard ä»‹é¢å·²é¡¯ç¤º');
        }
        
        // ç™»å‡ºåŠŸèƒ½
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿç™»å‡ºå¾Œéœ€è¦é‡æ–°åŒ¯å…¥ç§é‘°ã€‚')) {
                // æ¸…é™¤èªè­‰ç‹€æ…‹
                sessionStorage.removeItem('KEY_AUTHENTICATED');
                sessionStorage.removeItem('LOGIN_TIME');
                
                // éš±è—ç™»å‡ºæŒ‰éˆ•å’Œåœ˜éšŠç®¡ç†æŒ‰éˆ•
                this.style.display = 'none';
                document.getElementById('teamManagementBtn').style.display = 'none';
                document.getElementById('devLogBtn').style.display = 'none';
                document.getElementById('syncBtn').style.display = 'none';
                document.getElementById('pullBtn').style.display = 'none';
                document.getElementById('fixRolesBtn').style.display = 'none';

                // é¡¯ç¤ºèªè­‰ä»‹é¢
                document.getElementById('keyAuthentication').style.display = 'block';
                // loadingSpinner å·²ç§»é™¤
                document.getElementById('summaryCards').style.display = 'none';
                document.getElementById('projectsList').style.display = 'none';
                
                // æ¸…ç©ºæ‰€æœ‰è¼¸å…¥æ¬„ä½
                document.getElementById('privateKeyInput').value = '';
                document.getElementById('googleConfigInput').value = '';

                // éš±è—æˆåŠŸ/éŒ¯èª¤è¨Šæ¯
                document.getElementById('keyError').classList.add('d-none');
                document.getElementById('keySuccess').classList.add('d-none');
                
                console.log('ç”¨æˆ¶å·²ç™»å‡ºï¼Œéœ€è¦é‡æ–°èªè­‰');
            }
        });
        
        // æª¢æŸ¥ Session è¶…æ™‚ï¼ˆ30åˆ†é˜ï¼‰
        function checkSessionTimeout() {
            const loginTime = sessionStorage.getItem('LOGIN_TIME');
            const isAuthenticated = sessionStorage.getItem('KEY_AUTHENTICATED') === 'true';

            if (isAuthenticated && loginTime) {
                const now = Date.now();
                const sessionAge = now - parseInt(loginTime);
                const timeout = 30 * 60 * 1000; // 30åˆ†é˜

                if (sessionAge > timeout) {
                    alert('æœƒè©±å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥');
                    document.getElementById('logoutBtn').click();
                }
            }
        }
        
        // æ¯åˆ†é˜æª¢æŸ¥ä¸€æ¬¡ session
        setInterval(checkSessionTimeout, 60000);

        // é‡æ–°è¼‰å…¥åŠŸèƒ½ï¼ˆæ•´åˆåŒæ­¥ï¼‰
        document.getElementById('refreshBtn').addEventListener('click', async function() {
            const refreshBtn = this;
            const originalText = refreshBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                refreshBtn.disabled = true;
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';

                // åŸ·è¡ŒåŒæ­¥ä»»å‹™
                if (window.googleDriveAPI) {
                    // 1. åŒæ­¥è§’è‰²å‚™è¨»
                    try {
                        await window.googleDriveAPI.syncRoleNotesFromGitHub();
                        console.log('âœ… è§’è‰²å‚™è¨»åŒæ­¥å®Œæˆ');
                    } catch (error) {
                        console.error('è§’è‰²å‚™è¨»åŒæ­¥å¤±æ•—:', error);
                    }

                    // 2. å¾ Google Drive æ‹‰å–è³‡æ–™
                    if (window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn()) {
                        try {
                            await pullFilesFromGoogleDrive();
                            console.log('âœ… Google Drive è³‡æ–™åŒæ­¥å®Œæˆ');
                        } catch (error) {
                            console.error('Google Drive åŒæ­¥å¤±æ•—:', error);
                        }
                    }
                }

                // ç¨ç­‰ä¸€ä¸‹è®“åŒæ­¥å®Œæˆ
                setTimeout(() => {
                    location.reload();
                }, 500);

            } catch (error) {
                console.error('åŒæ­¥éç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
                // å³ä½¿å¤±æ•—ä¹Ÿé‡æ–°è¼‰å…¥
                location.reload();
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = originalText;
            }
        });

        // å°ˆæ¡ˆæ¸¬è©¦æ¨™è¨˜æ§åˆ¶å‡½æ•¸
        window.showProjectTestPending = function(projectId) {
            const indicator = document.getElementById(`project-test-${projectId}`);
            if (indicator) {
                indicator.style.display = 'inline-block';
                console.log(`å°ˆæ¡ˆ ${projectId} æ¨™è¨˜ç‚ºå¾…æ¸¬è©¦`);
            }
        };

        window.hideProjectTestPending = function(projectId) {
            const indicator = document.getElementById(`project-test-${projectId}`);
            if (indicator) {
                indicator.style.display = 'none';
                console.log(`å°ˆæ¡ˆ ${projectId} æ¸¬è©¦å®Œæˆ`);
            }
        };

        window.hideAllProjectTestPending = function() {
            const indicators = document.querySelectorAll('[id^="project-test-"]');
            indicators.forEach(indicator => {
                indicator.style.display = 'none';
            });
            console.log('æ¸…é™¤æ‰€æœ‰å°ˆæ¡ˆæ¸¬è©¦æ¨™è¨˜');
        };

        // ç›£è½ GitHub webhook äº‹ä»¶ï¼ˆè·¨é é¢é€šè¨Šï¼‰
        window.addEventListener('storage', function(e) {
            if (e.key === 'github-webhook-event' && e.newValue) {
                try {
                    const event = JSON.parse(e.newValue);
                    console.log('æ”¶åˆ° GitHub webhook äº‹ä»¶:', event);

                    if (event.action === 'push' && event.project) {
                        console.log(`æ¨™è¨˜ ${event.project} ç‚ºå¾…æ¸¬è©¦`);
                        window.showProjectTestPending(event.project);
                    } else if (event.action === 'merge') {
                        console.log('æ¸…é™¤æ‰€æœ‰å¾…æ¸¬è©¦æ¨™è¨˜');
                        window.hideAllProjectTestPending();
                    }

                    // æ¸…é™¤äº‹ä»¶ï¼Œé¿å…é‡è¤‡è™•ç†
                    localStorage.removeItem('github-webhook-event');
                } catch (error) {
                    console.error('è™•ç† webhook äº‹ä»¶å¤±æ•—:', error);
                }
            }
        });

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥å¾…æ¸¬è©¦ç‹€æ…‹
        const checkAndRestorePendingTests = () => {
            const pendingTests = JSON.parse(localStorage.getItem('pending-tests') || '{}');
            Object.keys(pendingTests).forEach(projectId => {
                if (pendingTests[projectId] && pendingTests[projectId].status) {
                    console.log(`æ¢å¾©å¾…æ¸¬è©¦æ¨™è¨˜: ${projectId}`);
                    window.showProjectTestPending(projectId);
                }
            });
        };

        // åˆå§‹æª¢æŸ¥ - å¿«é€Ÿæ¢å¾©å¾½ç« 
        setTimeout(checkAndRestorePendingTests, 500);

        // å†æ¬¡æª¢æŸ¥ - ç¢ºä¿åœ¨ Google Drive åŒæ­¥å¾Œæ¢å¾©
        setTimeout(checkAndRestorePendingTests, 3000);

        // å®šæœŸæª¢æŸ¥ (æ¯ 30 ç§’)
        setInterval(checkAndRestorePendingTests, 30000);

        // æ¸¬è©¦æ¨é€æŒ‰éˆ•
        document.getElementById('testPushBtn').addEventListener('click', function() {
            const choice = prompt('é¸æ“‡æ¸¬è©¦åŠŸèƒ½:\n1 - æ¨¡æ“¬æ¨é€äº‹ä»¶\n2 - æ¨¡æ“¬åˆä½µäº‹ä»¶', '1');

            if (choice === '1') {
                // æ¨¡æ“¬æ¨é€äº‹ä»¶ - éš¨æ©Ÿé¸æ“‡ä¸€å€‹å°ˆæ¡ˆ
                const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy', 'SyncBC-Monorepo', 'iFMS-Frontend'];
                const randomProject = projects[Math.floor(Math.random() * projects.length)];

                window.showProjectTestPending(randomProject);
                alert(`æ¨¡æ“¬æ¨é€åˆ° ${randomProject}`);

            } else if (choice === '2') {
                // æ¨¡æ“¬åˆä½µäº‹ä»¶
                window.hideAllProjectTestPending();
                alert('æ¨¡æ“¬åˆä½µåˆ° main/developï¼Œæ‰€æœ‰æ¸¬è©¦æ¨™è¨˜å·²æ¸…é™¤');
            }
        });

        // ä¿®å¾©è§’è‰²æŒ‰éˆ•
        document.getElementById('fixRolesBtn').addEventListener('click', async function() {
            const fixBtn = this;
            const originalText = fixBtn.innerHTML;

            try {
                fixBtn.disabled = true;
                fixBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿®å¾©ä¸­...';

                // ç¢ºä¿ Google Drive API å·²ç™»å…¥
                if (!window.googleDriveAPI || !window.googleDriveAPI.isAuthenticated) {
                    alert('âŒ éœ€è¦å…ˆç™»å…¥ Google Drive');
                    return;
                }

                // è¼‰å…¥æ­£ç¢ºçš„æœ¬åœ°è³‡æ–™
                console.log('ğŸ“ è¼‰å…¥æœ¬åœ°æ­£ç¢ºè³‡æ–™...');
                const response = await fetch('config/project-assignments.json');
                const correctData = await response.json();

                console.log('âœ… æœ¬åœ°è³‡æ–™è¼‰å…¥æˆåŠŸ');
                console.log('ğŸ“Š å°ˆæ¡ˆæ•¸é‡: ' + Object.keys(correctData.assignments).length);

                // æª¢æŸ¥è§’è‰²
                for (const [projectId, project] of Object.entries(correctData.assignments)) {
                    if (project.members) {
                        for (const [memberId, member] of Object.entries(project.members)) {
                            console.log(`${projectId} -> ${member.memberName}: ${member.role}`);
                        }
                    }
                }

                // ğŸš« å¼·åˆ¶ä¸Šå‚³å·²ç¦ç”¨ä»¥é˜²æ­¢å°ˆæ¡ˆå‚™è¨»éºå¤±
                console.error('ğŸš« è‡ªå‹•ä¿®å¾©ä¸Šå‚³å·²ç¦ç”¨ä»¥é˜²æ­¢å°ˆæ¡ˆå‚™è¨»éºå¤±');
                console.log('ğŸ“‹ è«‹æ‰‹å‹•æª¢æŸ¥è³‡æ–™å¾Œä½¿ç”¨æ‰‹å‹•åŒæ­¥åŠŸèƒ½');
                // await window.googleDriveAPI.saveFile('project-assignments.json', correctData, 'assignments');

                // æ¸…é™¤ç€è¦½å™¨å¿«å–
                localStorage.removeItem('teamAssignments');
                localStorage.removeItem('cachedTeamMembers');
                localStorage.removeItem('teamMemberChanges');
                localStorage.removeItem('teamGroupChanges');

                console.log('ğŸ§¹ å·²æ¸…é™¤å¿«å–');
                alert('âœ… ä¿®å¾©å®Œæˆï¼é é¢å°‡é‡æ–°è¼‰å…¥');

                // é‡æ–°è¼‰å…¥é é¢
                setTimeout(() => window.location.reload(), 1000);

            } catch (error) {
                console.error('âŒ ä¿®å¾©å¤±æ•—:', error);
                alert('âŒ ä¿®å¾©å¤±æ•—: ' + error.message);
            } finally {
                fixBtn.disabled = false;
                fixBtn.innerHTML = originalText;
            }
        });

        // Google Drive è¨­å®šæŒ‰éˆ•
        document.getElementById('gdriveSetupBtn').addEventListener('click', function() {
            window.open('setup-gdrive.html', '_blank');
        });

        // Push åŠŸèƒ½ (ä¸Šå‚³åˆ°é›²ç«¯)
        document.getElementById('syncBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';

                // æª¢æŸ¥ Google Drive é€£ç·š
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API æœªè¼‰å…¥');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // è‡ªå‹•è§¸ç™¼ç™»å…¥
                    syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å…¥ä¸­...';
                    showSyncToast('éœ€è¦ç™»å…¥', 'æ­£åœ¨é–‹å•Ÿ Google Drive ç™»å…¥...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive ç™»å…¥å¤±æ•—æˆ–è¢«å–æ¶ˆ');
                        }
                        syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...';
                    } catch (loginError) {
                        console.error('âŒ ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤:', loginError);
                        throw new Error('Google Drive ç™»å…¥å¤±æ•—: ' + loginError.message);
                    }
                }

                await pushLocalFilesToGoogleDrive();

                // æˆåŠŸè¨Šæ¯
                showSyncToast('æ¨é€æˆåŠŸ', 'æœ¬åœ°æª”æ¡ˆå·²æ¨é€åˆ° Google Drive', 'success');

            } catch (error) {
                console.error('åŒæ­¥å¤±æ•—:', error);
                showSyncToast('åŒæ­¥å¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // Pull åŠŸèƒ½ (å¾é›²ç«¯ä¸‹è¼‰)
        document.getElementById('pullBtn').addEventListener('click', async function() {
            const pullBtn = this;
            const originalText = pullBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                pullBtn.disabled = true;
                pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';

                // æª¢æŸ¥ Google Drive é€£ç·š
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API æœªè¼‰å…¥');
                }

                if (!window.googleDriveAPI.isSignedIn()) {
                    // è‡ªå‹•è§¸ç™¼ç™»å…¥
                    pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç™»å…¥ä¸­...';
                    showSyncToast('éœ€è¦ç™»å…¥', 'æ­£åœ¨é–‹å•Ÿ Google Drive ç™»å…¥...', 'info');

                    try {
                        const loginSuccess = await window.googleDriveAPI.signIn();
                        if (!loginSuccess) {
                            throw new Error('Google Drive ç™»å…¥å¤±æ•—æˆ–è¢«å–æ¶ˆ');
                        }
                        pullBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¸‹è¼‰ä¸­...';
                    } catch (loginError) {
                        console.error('âŒ ç™»å…¥éç¨‹ç™¼ç”ŸéŒ¯èª¤:', loginError);
                        throw new Error('Google Drive ç™»å…¥å¤±æ•—: ' + loginError.message);
                    }
                }

                await pullFilesFromGoogleDrive();

                // æ¸…é™¤è¨˜æ†¶é«”ä¸­çš„è³‡æ–™ä»¥å¼·åˆ¶é‡æ–°è¼‰å…¥
                window.taskTemplatesData = null;

                // ä¿å­˜ç•¶å‰æœ¬åœ°è®Šæ›´ï¼Œç„¶å¾Œé‡æ–°åˆå§‹åŒ– TeamDataManager
                if (window.globalTeamDataManager) {

                    // å…ˆä¿å­˜ç•¶å‰çš„assignmentsåˆ°localStorageä½œç‚ºå‚™ä»½
                    const currentAssignments = window.globalTeamDataManager.getAllAssignments();
                    if (currentAssignments && Object.keys(currentAssignments).length > 0) {
                        localStorage.setItem('teamAssignments_backup', JSON.stringify(currentAssignments));
                        console.log('ğŸ’¾ ç•¶å‰ç‹€æ…‹å·²å‚™ä»½');
                    }

                    // æ¸…é™¤ç¾æœ‰è³‡æ–™
                    window.globalTeamDataManager = null;
                    window.teamDataManager = null;

                    // é‡æ–°å‰µå»ºä¸¦åˆå§‹åŒ–
                    const teamDataManager = await getTeamDataManager();
                    window.globalTeamDataManager = teamDataManager;
                    window.teamDataManager = teamDataManager;

                    // æ¸…é™¤å‚™ä»½ï¼Œé¿å…å¹²æ“¾
                    localStorage.removeItem('teamAssignments_backup');
                    console.log('ğŸ§¹ å·²æ¸…é™¤å‚™ä»½è³‡æ–™');
                }

                // æˆåŠŸè¨Šæ¯
                showSyncToast('æ‹‰å–æˆåŠŸ', 'å·²å¾ Google Drive æ‹‰å–æœ€æ–°è³‡æ–™', 'success');

                // è‡ªå‹•é‡æ–°è¼‰å…¥è³‡æ–™ï¼ˆä¸éœ€è¦é‡æ–°æ•´ç†é é¢ï¼‰
                setTimeout(async () => {
                    try {
                        await loadDataDirectly();
                        showSyncToast('æ›´æ–°å®Œæˆ', 'é é¢è³‡æ–™å·²æ›´æ–°', 'success');
                    } catch (error) {
                        console.error('é‡æ–°è¼‰å…¥è³‡æ–™å¤±æ•—:', error);
                        if (confirm('è‡ªå‹•æ›´æ–°å¤±æ•—ï¼Œæ˜¯å¦æ‰‹å‹•é‡æ–°è¼‰å…¥é é¢ï¼Ÿ')) {
                            location.reload();
                        }
                    }
                }, 500);

            } catch (error) {
                console.error('æ‹‰å–å¤±æ•—:', error);
                showSyncToast('æ‹‰å–å¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                pullBtn.disabled = false;
                pullBtn.innerHTML = originalText;
            }
        });

        // æ‰‹å‹•åŒæ­¥è§’è‰²å‚™è¨»
        document.getElementById('syncRoleNotesBtn').addEventListener('click', async function() {
            const syncBtn = this;
            const originalText = syncBtn.innerHTML;

            try {
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = true;
                syncBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŒæ­¥ä¸­...';

                showSyncToast('é–‹å§‹åŒæ­¥', 'æ­£åœ¨å¾ GitHub åŒæ­¥è§’è‰²å‚™è¨»...', 'info');

                // æª¢æŸ¥ Google Drive API
                if (!window.googleDriveAPI) {
                    throw new Error('Google Drive API æœªè¼‰å…¥');
                }

                // åŸ·è¡Œè§’è‰²å‚™è¨»åŒæ­¥
                await window.googleDriveAPI.syncRoleNotesFromGitHub();

                showSyncToast('åŒæ­¥å®Œæˆ', 'è§’è‰²å‚™è¨»å·²æˆåŠŸåŒæ­¥ï¼', 'success');

                // 1ç§’å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥é é¢
                setTimeout(() => {
                    window.location.reload();
                }, 1000);

            } catch (error) {
                console.error('è§’è‰²å‚™è¨»åŒæ­¥å¤±æ•—:', error);
                showSyncToast('åŒæ­¥å¤±æ•—', error.message, 'error');
            } finally {
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                syncBtn.disabled = false;
                syncBtn.innerHTML = originalText;
            }
        });

        // æ¨é€æœ¬åœ°æª”æ¡ˆåˆ° Google Drive
        async function pushLocalFilesToGoogleDrive() {
            const filesToSync = [
                'config/team-members.json',
                'config/project-assignments.json',
                'config/task-templates.json'
            ];

            const syncResults = [];

            for (const filePath of filesToSync) {
                try {
                    const fileName = filePath.split('/').pop();
                    let fileContent;

                    // æ ¹æ“šæª”æ¡ˆé¡å‹é¸æ“‡è³‡æ–™ä¾†æº
                    if (fileName === 'team-members.json') {
                        // ä½¿ç”¨å…¨åŸŸ TeamDataManager ä¸­çš„è³‡æ–™
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                        }
                        const teamConfig = teamDataManager.teamConfig;
                        fileContent = JSON.stringify(teamConfig, null, 2);
                    } else if (fileName === 'project-assignments.json') {
                        // ä½¿ç”¨å…¨åŸŸ TeamDataManager ä¸­çš„åˆ†é…è³‡æ–™
                        const teamDataManager = window.globalTeamDataManager || window.teamDataManager;
                        if (!teamDataManager) {
                            throw new Error('TeamDataManager æœªåˆå§‹åŒ–');
                        }
                        const assignments = teamDataManager.getAllAssignments();
                        const constraints = teamDataManager.constraints;
                        const assignmentData = {
                            assignments: assignments,
                            constraints: constraints,
                            statistics: {
                                totalAssignments: Object.values(assignments).reduce((sum, project) => sum + Object.keys(project.members || {}).length, 0),
                                activeProjects: Object.values(assignments).filter(p => p.status === 'active').length,
                                completedProjects: Object.values(assignments).filter(p => p.status === 'completed').length,
                                membersInUse: new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size,
                                availableMembers: Object.keys(teamDataManager.getAllMembers()).length - new Set(Object.values(assignments).flatMap(p => Object.keys(p.members || {}))).size
                            }
                        };
                        fileContent = JSON.stringify(assignmentData, null, 2);
                    } else if (fileName === 'task-templates.json') {
                        // ä½¿ç”¨è¨˜æ†¶é«”ä¸­çš„ä»»å‹™ç¯„æœ¬è³‡æ–™
                        if (window.taskTemplatesData) {
                            fileContent = JSON.stringify(window.taskTemplatesData, null, 2);
                        } else {
                            // å¦‚æœè¨˜æ†¶é«”ä¸­æ²’æœ‰ï¼Œè®€å–æœ¬åœ°æª”æ¡ˆ
                            const response = await fetch(filePath + '?v=' + Date.now());
                            if (!response.ok) {
                                throw new Error(`ç„¡æ³•è®€å– ${filePath}: ${response.statusText}`);
                            }
                            fileContent = await response.text();
                        }
                    } else {
                        // å…¶ä»–æª”æ¡ˆç›´æ¥è®€å–æœ¬åœ°æª”æ¡ˆ
                        const response = await fetch(filePath + '?v=' + Date.now());
                        if (!response.ok) {
                            throw new Error(`ç„¡æ³•è®€å– ${filePath}: ${response.statusText}`);
                        }
                        fileContent = await response.text();
                    }

                    // è§£æ JSON å­—ä¸²ç‚ºç‰©ä»¶å¾Œä¸Šå‚³åˆ° Google Drive
                    let dataToSave;
                    try {
                        dataToSave = JSON.parse(fileContent);
                    } catch (parseError) {
                        throw new Error(`${fileName} JSON è§£æå¤±æ•—: ${parseError.message}`);
                    }

                    await window.googleDriveAPI.saveFile(fileName, dataToSave);

                    syncResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'åŒæ­¥æˆåŠŸ'
                    });


                } catch (error) {
                    console.error(`âŒ ${filePath} åŒæ­¥å¤±æ•—:`, error);
                    syncResults.push({
                        file: filePath.split('/').pop(),
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // åŒæ­¥å°ˆæ¡ˆç‹€æ…‹æª”æ¡ˆ (å¦‚æœå­˜åœ¨)
            await syncProjectStatusFiles();

            // è¨˜éŒ„åŒæ­¥çµæœ
            logSyncResults(syncResults);

            return syncResults;
        }

        // å¾ Google Drive æ‹‰å–æª”æ¡ˆåˆ°æœ¬åœ°
        async function pullFilesFromGoogleDrive() {
            // Pull å‰å…ˆå‚™ä»½æœ¬åœ°çš„ memberHistory
            const backupMemberHistory = {};
            try {
                if (window.teamDataManager && typeof window.teamDataManager.getAllAssignments === 'function') {
                    const currentAssignments = window.teamDataManager.getAllAssignments();
                    if (currentAssignments) {
                        Object.keys(currentAssignments).forEach(projectId => {
                            if (currentAssignments[projectId].memberHistory) {
                                backupMemberHistory[projectId] = [...currentAssignments[projectId].memberHistory];
                            }
                        });
                    }
                } else {
                    console.log('âš ï¸ TeamDataManager å°šæœªåˆå§‹åŒ–ï¼Œè·³é memberHistory å‚™ä»½');
                }
            } catch (e) {
                console.warn('âš ï¸ å‚™ä»½ memberHistory å¤±æ•—:', e.message);
            }

            const filesToPull = [
                'team-members.json',
                'project-assignments.json',
                'task-templates.json'
            ];

            const pullResults = [];

            for (const fileName of filesToPull) {
                try {

                    // å¾ Google Drive ä¸‹è¼‰æª”æ¡ˆ
                    const wrappedContent = await window.googleDriveAPI.loadFile(fileName);

                    if (!wrappedContent) {
                        console.log(`âš ï¸ ${fileName} ç„¡æ³•å¾ Google Drive è¼‰å…¥ï¼ˆå¯èƒ½æ˜¯ API æœªæº–å‚™æˆ–æª”æ¡ˆä¸å­˜åœ¨ï¼‰`);
                        pullResults.push({
                            fileName: fileName,
                            success: false,
                            error: 'Google Drive API æœªæº–å‚™æˆ–æª”æ¡ˆä¸å­˜åœ¨'
                        });
                        continue;
                    }

                    // æå–å¯¦éš›è³‡æ–™
                    let actualData = wrappedContent.data || wrappedContent;

                    // å¦‚æœ data æ˜¯å­—ä¸²ï¼Œéœ€è¦è§£ææˆç‰©ä»¶
                    if (typeof actualData === 'string') {
                        try {
                            actualData = JSON.parse(actualData);
                        } catch (parseError) {
                            throw new Error(`${fileName} JSON è§£æå¤±æ•—: ${parseError.message}`);
                        }
                    }

                    // é©—è­‰è³‡æ–™æ ¼å¼
                    if (!actualData || typeof actualData !== 'object') {
                        throw new Error(`${fileName} è³‡æ–™æ ¼å¼éŒ¯èª¤`);
                    }

                    // å„²å­˜åˆ° localStorageï¼ˆæ¨¡æ“¬ä¸‹è¼‰åˆ°æœ¬åœ°ï¼‰
                    let storageKey;
                    if (fileName === 'team-members.json') {
                        storageKey = 'cachedTeamMembers';
                    } else if (fileName === 'project-assignments.json') {
                        storageKey = 'cachedProjectAssignments';
                    } else if (fileName === 'task-templates.json') {
                        storageKey = 'cachedTaskTemplates';
                    }

                    if (storageKey) {
                        localStorage.setItem(storageKey, JSON.stringify(actualData));

                        // ç‰¹åˆ¥è™•ç† project-assignments.jsonï¼šæ·±åº¦åˆä½µåˆ° teamAssignments
                        if (fileName === 'project-assignments.json' && actualData.assignments) {
                            // é¡¯ç¤ºå¾ Google Drive æ‹‰å–åˆ°çš„ ErShield è³‡æ–™
                            const erShieldFromCloud = actualData.assignments.ErShield;
                            if (erShieldFromCloud) {
                                const cloudMemberHistoryCount = erShieldFromCloud.memberHistory?.length || 0;
                                if (cloudMemberHistoryCount > 0) {
                                    console.log('ğŸ” Google Drive ä¸­çš„ ErShield memberHistory:', erShieldFromCloud.memberHistory);
                                }
                            }
                            // å–å¾—ç•¶å‰æœ¬åœ°ç‹€æ…‹ä½œç‚ºå‚™ä»½
                            const currentLocalState = localStorage.getItem('teamAssignments');
                            let mergedAssignments = actualData.assignments;

                            if (currentLocalState) {
                                try {
                                    const localAssignments = JSON.parse(currentLocalState);

                                    // æ·±åº¦åˆä½µï¼šé›²ç«¯è³‡æ–™å„ªå…ˆï¼Œä½†ä¿ç•™æœ¬åœ°çš„å‚™è¨»è³‡æ–™
                                    Object.keys(mergedAssignments).forEach(projectId => {
                                        const localProject = localAssignments[projectId];

                                        // Pull æ“ä½œï¼šå„ªå…ˆä½¿ç”¨é›²ç«¯å°ˆæ¡ˆå‚™è¨»ï¼ˆé›²ç«¯å·²ç¶“æ˜¯æœ€æ–°çš„ï¼‰
                                        if (mergedAssignments[projectId].notes) {
                                            console.log(`ğŸ“ ä½¿ç”¨é›²ç«¯å°ˆæ¡ˆå‚™è¨» (Pull å„ªå…ˆ): ${projectId}`);
                                            // é›²ç«¯å‚™è¨»å·²ç¶“åœ¨ mergedAssignments ä¸­ï¼Œä¸éœ€è¦é¡å¤–è™•ç†
                                        } else if (localProject && localProject.notes) {
                                            console.log(`ğŸ“ é›²ç«¯ç„¡å‚™è¨»ï¼Œä¿ç•™æœ¬åœ°å‚™è¨»: ${projectId}`);
                                            mergedAssignments[projectId].notes = localProject.notes;
                                        }

                                        // Pull æ“ä½œä»¥é›²ç«¯è³‡æ–™ç‚ºæº–ï¼Œä¸æ¢å¾©æœ¬åœ° memberHistory
                                        // (memberHistory å·²ç¶“å¾é›²ç«¯æ­£ç¢ºè¼‰å…¥)

                                        if (mergedAssignments[projectId].members) {
                                            Object.keys(mergedAssignments[projectId].members).forEach(memberId => {
                                                const cloudMember = mergedAssignments[projectId].members[memberId];
                                                const localMember = localAssignments[projectId]?.members?.[memberId];

                                                // ä»¥é›²ç«¯è³‡æ–™ç‚ºæº–ï¼Œåˆä½µ personalNotes
                                                if (localMember && localMember.personalNotes && localMember.personalNotes.length > 0) {
                                                    // ä¿ç•™æœ¬åœ°çš„è§’è‰²å‚™è¨»
                                                    cloudMember.personalNotes = localMember.personalNotes;
                                                }
                                            });
                                        }
                                    });
                                } catch (parseError) {
                                    console.warn('âš ï¸ æœ¬åœ°ç‹€æ…‹è§£æå¤±æ•—ï¼Œä½¿ç”¨é›²ç«¯è³‡æ–™:', parseError);
                                }
                            }

                            localStorage.setItem('teamAssignments', JSON.stringify(mergedAssignments));
                        }
                    }

                    pullResults.push({
                        file: fileName,
                        status: 'success',
                        message: 'æ‹‰å–æˆåŠŸ'
                    });


                } catch (error) {
                    console.error(`âŒ ${fileName} æ‹‰å–å¤±æ•—:`, error);
                    pullResults.push({
                        file: fileName,
                        status: 'error',
                        message: error.message
                    });
                }
            }

            // è¨˜éŒ„æ‹‰å–çµæœ
            logPullResults(pullResults);

            // é¡¯ç¤ºæ‹‰å–å¾Œçš„ memberHistory æ•¸é‡
            try {
                if (window.teamDataManager && typeof window.teamDataManager.getAllAssignments === 'function') {
                    const assignments = window.teamDataManager.getAllAssignments();
                    if (assignments) {
                        Object.keys(assignments).forEach(projectId => {
                            const memberHistoryCount = assignments[projectId].memberHistory?.length || 0;
                            console.log(`ğŸ“Š ${projectId} memberHistory æ•¸é‡: ${memberHistoryCount}`);
                        });
                    }
                } else {
                    console.log('âš ï¸ TeamDataManager å°šæœªåˆå§‹åŒ–ï¼Œç„¡æ³•é¡¯ç¤º memberHistory æ•¸é‡');
                }
            } catch (e) {
                console.warn('âš ï¸ ç„¡æ³•é¡¯ç¤º memberHistory æ•¸é‡:', e.message);
            }

            // åªæœ‰æˆåŠŸæ‹‰å–åˆ°æª”æ¡ˆæ™‚æ‰é‡æ–°è¼‰å…¥é é¢
            const successfulPulls = pullResults.filter(result => result.success);
            if (successfulPulls.length > 0) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }

            return pullResults;
        }

        // åŒæ­¥å°ˆæ¡ˆç‹€æ…‹æª”æ¡ˆ
        async function syncProjectStatusFiles() {
            const projects = ['ErCore', 'ErNexus', 'ErShield', 'ErTidy'];

            for (const project of projects) {
                try {
                    // é€™è£¡å¯ä»¥è®€å– project-status è³‡æ–™å¤¾ä¸­çš„æª”æ¡ˆ
                    // ç”±æ–¼ç€è¦½å™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘å€‘å…ˆè¨˜éŒ„åˆ° localStorage
                } catch (error) {
                }
            }
        }

        // é¡¯ç¤ºåŒæ­¥é€šçŸ¥
        function showSyncToast(title, message, type) {
            const toastColor = type === 'success' ? 'text-bg-success' : 'text-bg-danger';
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';

            const toastHtml = `
                <div class="toast ${toastColor}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <i class="fas fa-${icon} me-2"></i>
                        <strong class="me-auto">${title}</strong>
                        <small>å‰›æ‰</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">${message}</div>
                </div>
            `;

            // å‰µå»º toast å®¹å™¨ (å¦‚æœä¸å­˜åœ¨)
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }

            // æ·»åŠ ä¸¦é¡¯ç¤º toast
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastContainer.lastElementChild);
            toast.show();
        }

        // è¨˜éŒ„æ¨é€çµæœ
        function logSyncResults(results) {
            const timestamp = new Date().toISOString();
            const syncLog = {
                type: 'push',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // å„²å­˜åˆ° localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(syncLog);

            // åªä¿ç•™æœ€è¿‘ 50 æ¬¡è¨˜éŒ„
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // è¨˜éŒ„æ‹‰å–çµæœ
        function logPullResults(results) {
            const timestamp = new Date().toISOString();
            const pullLog = {
                type: 'pull',
                timestamp,
                results,
                totalFiles: results.length,
                successCount: results.filter(r => r.status === 'success').length,
                errorCount: results.filter(r => r.status === 'error').length
            };

            // å„²å­˜åˆ° localStorage
            const existingLogs = JSON.parse(localStorage.getItem('syncLogs') || '[]');
            existingLogs.unshift(pullLog);

            // åªä¿ç•™æœ€è¿‘ 50 æ¬¡è¨˜éŒ„
            if (existingLogs.length > 50) {
                existingLogs.splice(50);
            }

            localStorage.setItem('syncLogs', JSON.stringify(existingLogs));
        }

        // ç°¡åŒ–ç‰ˆåœ˜éšŠç®¡ç†
        function showSimpleTeamManagement() {
            console.log('ğŸ“‹ é¡¯ç¤ºç°¡åŒ–ç‰ˆåœ˜éšŠç®¡ç†ç•Œé¢');

            const modalHtml = `
                <div class="modal fade" id="simpleTeamModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">åœ˜éšŠç®¡ç† (ç°¡åŒ–ç‰ˆ)</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning">
                                    <h6>âš ï¸ åœ˜éšŠç®¡ç†ç³»çµ±è¼‰å…¥å•é¡Œ</h6>
                                    <p>å®Œæ•´çš„åœ˜éšŠç®¡ç†ç³»çµ±æœªèƒ½æ­£ç¢ºè¼‰å…¥ã€‚é€™å¯èƒ½æ˜¯ç”±æ–¼ä»¥ä¸‹åŸå› ä¹‹ä¸€ï¼š</p>
                                    <ul>
                                        <li>JavaScript æª”æ¡ˆè¼‰å…¥å¤±æ•—</li>
                                        <li>ç€è¦½å™¨å¿«å–å•é¡Œ</li>
                                        <li>ç¶²è·¯é€£ç·šå•é¡Œ</li>
                                    </ul>
                                </div>

                                <h6>è§£æ±ºæ–¹æ¡ˆï¼š</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="fas fa-sync-alt me-2"></i>é‡æ–°è¼‰å…¥é é¢
                                    </button>
                                    <button class="btn btn-outline-info" onclick="window.open('setup-gdrive.html', '_blank')">
                                        <i class="fab fa-google-drive me-2"></i>è¨­å®š Google Drive
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="clearBrowserCache()">
                                        <i class="fas fa-trash me-2"></i>æ¸…é™¤ç€è¦½å™¨å¿«å–
                                    </button>
                                </div>

                                <hr>

                                <h6>ç•¶å‰è³‡æ–™ç‹€æ…‹ï¼š</h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">å°ˆæ¡ˆè³‡æ–™</h6>
                                                <p class="card-text">
                                                    å·²è¼‰å…¥å°ˆæ¡ˆ: <span id="simpleProjectCount">-</span><br>
                                                    è³‡æ–™ç®¡ç†å™¨ç‹€æ…‹: <span id="simpleDataManagerStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-body">
                                                <h6 class="card-title">ç³»çµ±ç‹€æ…‹</h6>
                                                <p class="card-text">
                                                    TeamDataManager: <span id="simpleTDMStatus">-</span><br>
                                                    TeamManagement: <span id="simpleTMStatus">-</span><br>
                                                    Google Drive: <span id="simpleGDStatus">-</span>
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // ç§»é™¤èˆŠçš„æ¨¡æ…‹æ¡†
            const existingModal = document.getElementById('simpleTeamModal');
            if (existingModal) {
                existingModal.remove();
            }

            // æ·»åŠ æ–°çš„æ¨¡æ…‹æ¡†
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // æ›´æ–°ç‹€æ…‹ä¿¡æ¯
            updateSimpleTeamModalStatus();

            // é¡¯ç¤ºæ¨¡æ…‹æ¡†
            const modal = new bootstrap.Modal(document.getElementById('simpleTeamModal'));
            modal.show();
        }

        function updateSimpleTeamModalStatus() {
            // æ›´æ–°å°ˆæ¡ˆæ•¸é‡
            const projectCount = window.teamDataManager ?
                Object.keys(window.teamDataManager.getAllAssignments()).length :
                'N/A';
            document.getElementById('simpleProjectCount').textContent = projectCount;

            // æ›´æ–°è³‡æ–™ç®¡ç†å™¨ç‹€æ…‹
            const dataManagerStatus = window.teamDataManager ?
                (window.teamDataManager.isInitialized ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–') :
                'ä¸å­˜åœ¨';
            document.getElementById('simpleDataManagerStatus').textContent = dataManagerStatus;

            // æ›´æ–°ç³»çµ±ç‹€æ…‹
            document.getElementById('simpleTDMStatus').textContent =
                window.TeamDataManager ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥';
            document.getElementById('simpleTMStatus').textContent =
                window.TeamManagement ? 'âœ… å·²è¼‰å…¥' : 'âŒ æœªè¼‰å…¥';

            // æ›´æ–° Google Drive ç‹€æ…‹
            const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
            const googleDriveStatus = googleDriveConfig ?
                (window.googleDriveAPI && window.googleDriveAPI.isSignedIn && window.googleDriveAPI.isSignedIn() ?
                    'âœ… å·²ç™»å…¥' : 'âš ï¸ å·²è¨­å®šæœªç™»å…¥') :
                'âŒ æœªè¨­å®š';
            document.getElementById('simpleGDStatus').textContent = googleDriveStatus;
        }

        function clearBrowserCache() {
            if (confirm('é€™å°‡æ¸…é™¤ç€è¦½å™¨å¿«å–ä¸¦é‡æ–°è¼‰å…¥é é¢ã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ')) {
                // æ¸…é™¤ localStorage
                localStorage.clear();
                // æ¸…é™¤ sessionStorageï¼ˆä½†ä¿ç•™èªè­‰ç‹€æ…‹å’Œ Google Drive è¨­å®šï¼‰
                const auth = sessionStorage.getItem('KEY_AUTHENTICATED');
                const loginTime = sessionStorage.getItem('LOGIN_TIME');
                const googleDriveConfig = sessionStorage.getItem('GOOGLE_DRIVE_CONFIG');
                sessionStorage.clear();
                if (auth) sessionStorage.setItem('KEY_AUTHENTICATED', auth);
                if (loginTime) sessionStorage.setItem('LOGIN_TIME', loginTime);
                if (googleDriveConfig) sessionStorage.setItem('GOOGLE_DRIVE_CONFIG', googleDriveConfig);

                // é‡æ–°è¼‰å…¥é é¢ï¼Œæ·»åŠ æ™‚é–“æˆ³é¿å…å¿«å–
                window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
            }
        }

        // åœ˜éšŠç®¡ç†åŠŸèƒ½
        document.getElementById('teamManagementBtn').addEventListener('click', function() {
            console.log('ğŸ¯ åœ˜éšŠç®¡ç†æŒ‰éˆ•è¢«é»æ“Š');
            console.log('ğŸ” æª¢æŸ¥ç›¸é—œç‰©ä»¶å­˜åœ¨ç‹€æ…‹:');
            console.log('- window.teamManagement:', !!window.teamManagement);
            console.log('- window.TeamDataManager:', !!window.TeamDataManager);
            console.log('- window.TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- bootstrap.Modal:', !!window.bootstrap?.Modal);

            // å¦‚æœ teamManagement ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºå‚™ç”¨å¯¦ä¾‹
            if (!window.teamManagement) {
                console.log('âš ï¸ teamManagement å¯¦ä¾‹ä¸å­˜åœ¨ï¼Œå˜—è©¦å‰µå»ºå‚™ç”¨å¯¦ä¾‹...');

                if (!window.TeamManagement) {
                    console.error('âŒ TeamManagement é¡åˆ¥ä¸å­˜åœ¨ï¼Œä½¿ç”¨ç°¡åŒ–ç‰ˆåœ˜éšŠç®¡ç†');
                    // å‰µå»ºç°¡åŒ–ç‰ˆåœ˜éšŠç®¡ç†
                    showSimpleTeamManagement();
                    return;
                }

                try {
                    window.teamManagement = new window.TeamManagement();
                } catch (error) {
                    console.error('âŒ å‰µå»ºå‚™ç”¨å¯¦ä¾‹å¤±æ•—:', error);
                    alert('ç„¡æ³•å‰µå»ºåœ˜éšŠç®¡ç†ç³»çµ±: ' + error.message);
                    return;
                }
            }

            console.log('âœ… teamManagement å¯¦ä¾‹å­˜åœ¨');
            console.log('- dataManager:', !!window.teamManagement.dataManager);
            console.log('- uiComponents:', !!window.teamManagement.uiComponents);

            try {
                // æª¢æŸ¥ dataManager æ˜¯å¦å·²åˆå§‹åŒ–
                if (window.teamManagement.dataManager && !window.teamManagement.dataManager.isInitialized) {
                    console.log('âš ï¸ dataManager æœªåˆå§‹åŒ–ï¼Œå˜—è©¦åˆå§‹åŒ–...');
                    window.teamManagement.dataManager.init().then(() => {
                        window.teamManagement.openTeamManagementDashboard();
                    }).catch(error => {
                        console.error('âŒ dataManager åˆå§‹åŒ–å¤±æ•—:', error);
                        alert('è³‡æ–™ç®¡ç†å™¨åˆå§‹åŒ–å¤±æ•—: ' + error.message);
                    });
                } else {
                    console.log('âœ… dataManager å·²æº–å‚™ï¼Œç›´æ¥é–‹å•Ÿåœ˜éšŠç®¡ç†');
                    window.teamManagement.openTeamManagementDashboard();
                }
            } catch (error) {
                console.error('âŒ é–‹å•Ÿåœ˜éšŠç®¡ç†å¤±æ•—:', error);
                console.error('éŒ¯èª¤å †ç–Š:', error.stack);
                alert('é–‹å•Ÿåœ˜éšŠç®¡ç†å¤±æ•—: ' + error.message);
            }
        });

        // ç ”ç™¼è¨˜éŒ„ç°¿åŠŸèƒ½
        document.getElementById('devLogBtn').addEventListener('click', function() {
            console.log('ğŸ“‹ ç ”ç™¼è¨˜éŒ„ç°¿æŒ‰éˆ•è¢«é»æ“Š');
            window.location.href = 'dev-log.html';
        });

        // å•Ÿå‹• Dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“‹ DOMContentLoaded è§¸ç™¼ï¼Œæª¢æŸ¥é¡åˆ¥è¼‰å…¥ç‹€æ…‹:');
            console.log('- TeamDataManager:', !!window.TeamDataManager);
            console.log('- TeamStatistics:', !!window.TeamStatistics);
            console.log('- TeamUIComponents:', !!window.TeamUIComponents);
            console.log('- TeamManagement:', !!window.TeamManagement);
            console.log('- teamManagement å¯¦ä¾‹:', !!window.teamManagement);

            // æª¢æŸ¥æ˜¯å¦å·²é€šéç§é‘°é©—è­‰
            if (!checkAuthentication()) {
                // æœªé©—è­‰ç¦æ­¢åˆå§‹åŒ– Dashboard
                return;
            }
            // åƒ…åœ¨å·²é©—è­‰æ™‚åˆå§‹åŒ– Dashboard
            try {

                // åˆå§‹åŒ–åœ˜éšŠè³‡æ–™ç®¡ç†å™¨
                if (!window.teamDataManager) {
                    // å»ºç«‹å…¨åŸŸå–®ä¾‹
                    if (!window.globalTeamDataManager) {
                        window.globalTeamDataManager = new TeamDataManager();
                        await window.globalTeamDataManager.init();
                    }
                    window.teamDataManager = window.globalTeamDataManager;
                }

                // è‡ªå‹•åŸ·è¡Œ Pull æ“ä½œï¼ˆç™»å…¥å¾Œè‡ªå‹•åŒæ­¥æœ€æ–°è³‡æ–™ï¼‰
                if (window.googleDriveAPI && window.googleDriveAPI.isAuthenticated) {
                    try {
                        console.log('ğŸ”„ è‡ªå‹•å¾ Google Drive æ‹‰å–æœ€æ–°è³‡æ–™...');
                        await pullFilesFromGoogleDrive();

                        // æš«æ™‚ç¦ç”¨å®šæ™‚è‡ªå‹• Push ä»¥é˜²æ­¢è³‡æ–™éºå¤±
                        console.log('ğŸš« å®šæ™‚è‡ªå‹• Push å·²ç¦ç”¨ä»¥é˜²æ­¢è³‡æ–™éºå¤±');
                        if (false && !window.autoPushInterval) {
                            window.autoPushInterval = setInterval(async () => {
                                try {
                                    if (window.teamDataManager) {
                                        await window.teamDataManager.saveLocalChanges();
                                    }
                                } catch (error) {
                                    console.warn('âš ï¸ å®šæ™‚ Push å¤±æ•—:', error);
                                }
                            }, 5 * 60 * 1000); // æ¯5åˆ†é˜
                        }

                        // æš«æ™‚ç¦ç”¨é é¢é—œé–‰æ™‚çš„è‡ªå‹• Push ä»¥é˜²æ­¢è³‡æ–™éºå¤±
                        console.log('ğŸš« beforeunload è‡ªå‹•åŒæ­¥å·²ç¦ç”¨ä»¥é˜²æ­¢è³‡æ–™éºå¤±');
                        if (false && !window.beforeUnloadListener) {
                            window.beforeUnloadListener = true;
                            window.addEventListener('beforeunload', (event) => {
                                if (window.teamDataManager) {
                                    // åŒæ­¥å„²å­˜ï¼ˆæ³¨æ„ï¼šbeforeunload ä¸­ async å¯èƒ½ä¸å¯é ï¼‰
                                    try {
                                        // åªåœ¨ TeamDataManager æœ‰æ•ˆä¸”è³‡æ–™å®Œæ•´æ™‚æ‰å„²å­˜
                                        if (window.teamDataManager && window.teamDataManager.isReady()) {
                                            const assignments = window.teamDataManager.getAllAssignments();
                                            // æª¢æŸ¥è³‡æ–™å®Œæ•´æ€§ - ç¢ºä¿æœ‰å°ˆæ¡ˆä¸”ä¸æ˜¯ç©ºçš„
                                            if (assignments && Object.keys(assignments).length > 0) {
                                                // é€²ä¸€æ­¥æª¢æŸ¥æ˜¯å¦æœ‰é‡è¦å°ˆæ¡ˆçš„å°ˆæ¡ˆå‚™è¨»
                                                const hasImportantData = Object.values(assignments).some(project =>
                                                    project.members && Object.keys(project.members).length > 0
                                                );

                                                if (hasImportantData) {
                                                    const data = JSON.stringify({
                                                        assignments: assignments,
                                                        constraints: {}
                                                    });
                                                    localStorage.setItem('pendingPush', data);
                                                    console.log('ğŸ’¾ é é¢é—œé–‰å‰å·²å„²å­˜å¾…åŒæ­¥è³‡æ–™');
                                                } else {
                                                    console.log('âš ï¸ è³‡æ–™ä¼¼ä¹ä¸å®Œæ•´ï¼Œè·³é pendingPush');
                                                }
                                            } else {
                                                console.log('âš ï¸ assignments ç‚ºç©ºï¼Œè·³é pendingPush');
                                            }
                                        } else {
                                            console.log('âš ï¸ TeamDataManager ç„¡æ•ˆï¼Œè·³é pendingPush');
                                        }
                                    } catch (e) {
                                        console.error('å„²å­˜å¤±æ•—:', e);
                                    }
                                }
                            });
                        }

                        // æš«æ™‚ç¦ç”¨ pendingPush æ©Ÿåˆ¶ä»¥é˜²æ­¢è³‡æ–™éºå¤±
                        console.log('ğŸš« pendingPush è‡ªå‹•ä¸Šå‚³å·²ç¦ç”¨ä»¥é˜²æ­¢è³‡æ–™éºå¤±');
                        localStorage.removeItem('pendingPush'); // æ¸…é™¤ç¾æœ‰çš„ pendingPush
                        const pendingPush = null; // localStorage.getItem('pendingPush');
                        if (pendingPush) {
                            try {
                                const data = JSON.parse(pendingPush);

                                // é©—è­‰è³‡æ–™å®Œæ•´æ€§ï¼Œé˜²æ­¢ä¸Šå‚³ä¸å®Œæ•´çš„è³‡æ–™
                                if (data && data.assignments && Object.keys(data.assignments).length > 0) {
                                    // æª¢æŸ¥æ˜¯å¦åŒ…å«é‡è¦çš„å°ˆæ¡ˆè³‡æ–™
                                    const hasValidData = Object.values(data.assignments).some(project =>
                                        project.members && Object.keys(project.members).length > 0
                                    );

                                    console.error('ğŸš« pendingPush ä¸Šå‚³å·²å®Œå…¨ç¦ç”¨ä»¥é˜²æ­¢å°ˆæ¡ˆå‚™è¨»éºå¤±');
                                    console.log('ğŸ“‹ å¾…åŒæ­¥è³‡æ–™å·²è·³éä¸Šå‚³');
                                    // if (hasValidData) {
                                    //     console.log('ğŸ“¤ ä¸Šå‚³å¾…åŒæ­¥è³‡æ–™åˆ° Google Drive...');
                                    //     await window.googleDriveAPI.saveFile('project-assignments.json', data);
                                    //     console.log('âœ… å¾…åŒæ­¥è³‡æ–™å·²ä¸Šå‚³');
                                    // } else {
                                    //     console.log('âš ï¸ å¾…åŒæ­¥è³‡æ–™ä¸å®Œæ•´ï¼Œè·³éä¸Šå‚³');
                                    // }
                                } else {
                                    console.log('âš ï¸ å¾…åŒæ­¥è³‡æ–™æ ¼å¼éŒ¯èª¤ï¼Œè·³éä¸Šå‚³');
                                }

                                // ç„¡è«–å¦‚ä½•éƒ½æ¸…é™¤ pendingPush
                                localStorage.removeItem('pendingPush');
                            } catch (e) {
                                console.error('åŒæ­¥å¾…è™•ç†è³‡æ–™å¤±æ•—:', e);
                                // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¹Ÿè¦æ¸…é™¤ pendingPush é¿å…é‡è¤‡éŒ¯èª¤
                                localStorage.removeItem('pendingPush');
                            }
                        }

                    } catch (error) {
                        console.warn('âš ï¸ è‡ªå‹•åŒæ­¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', error);
                    }
                } else {
                    console.log('â„¹ï¸ Google Drive æœªç™»å…¥ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™');
                }

                // ç«‹å³åˆå§‹åŒ– Dashboardï¼Œè®“å®ƒè‡ªå·±ç­‰å¾… teamDataManager
                if (typeof MarkdownProjectDashboard !== 'undefined') {
                    window.markdownDashboard = new MarkdownProjectDashboard();
                } else {
                    console.error('MarkdownProjectDashboard é¡åˆ¥æœªå®šç¾©ï¼Œç­‰å¾…è¼‰å…¥...');
                    // å»¶é²é‡è©¦
                    setTimeout(() => {
                        if (typeof MarkdownProjectDashboard !== 'undefined') {
                            window.markdownDashboard = new MarkdownProjectDashboard();
                        }
                    }, 500);
                }

                // ç›£è½åœ˜éšŠè³‡æ–™è®Šæ›´äº‹ä»¶
                document.addEventListener('teamDataChanged', async (event) => {
                    console.log('ğŸ”„ æ”¶åˆ°åœ˜éšŠè³‡æ–™è®Šæ›´äº‹ä»¶:', event.detail);
                    try {
                        if (typeof loadDataDirectly === 'function') {
                            await loadDataDirectly();
                            console.log('âœ… é¦–é è³‡æ–™å·²é‡æ–°è¼‰å…¥');
                        } else {
                            console.warn('âš ï¸ loadDataDirectly å‡½æ•¸ä¸å­˜åœ¨');
                        }
                    } catch (error) {
                        console.error('âŒ é‡æ–°è¼‰å…¥é¦–é è³‡æ–™å¤±æ•—:', error);
                    }
                });

                // ç›£è½ localStorage è®Šæ›´ (è·¨è¦–çª—é€šä¿¡)
                window.addEventListener('storage', async (event) => {
                    if (event.key === 'teamUpdateSignal' && event.newValue) {
                        try {
                            const signal = JSON.parse(event.newValue);
                            console.log('ğŸ”„ æ”¶åˆ° localStorage æ›´æ–°ä¿¡è™Ÿ:', signal);

                            if (signal.action === 'teamDataUpdate') {
                                console.log('ğŸ”„ åŸ·è¡Œé¦–é è³‡æ–™é‡æ–°è¼‰å…¥...');
                                await window.loadDataDirectly();
                                console.log('âœ… é¦–é è³‡æ–™å·²é€šé localStorage é‡æ–°è¼‰å…¥');
                            }
                        } catch (error) {
                            console.error('âŒ localStorage æ›´æ–°ä¿¡è™Ÿè™•ç†å¤±æ•—:', error);
                        }
                    }
                });

                // ç›£è½ localStorage è®Šæ›´ (åŒè¦–çª—å…§çš„æ‰‹å‹•æª¢æŸ¥)
                setInterval(() => {
                    try {
                        const signal = localStorage.getItem('teamUpdateSignal');
                        if (signal) {
                            const updateData = JSON.parse(signal);
                            const now = Date.now();
                            // å¦‚æœä¿¡è™Ÿæ˜¯æœ€è¿‘1ç§’å…§çš„ï¼ŒåŸ·è¡Œæ›´æ–°
                            if (now - updateData.timestamp < 1000) {
                                console.log('ğŸ”„ æª¢æ¸¬åˆ°æ›´æ–°ä¿¡è™Ÿï¼ŒåŸ·è¡Œé‡æ–°è¼‰å…¥...');
                                window.loadDataDirectly();
                                localStorage.removeItem('teamUpdateSignal');
                            }
                        }
                    } catch (e) {
                        // å¿½ç•¥è§£æéŒ¯èª¤
                    }
                }, 500);

            } catch (error) {
                console.error('Dashboard åˆå§‹åŒ–å¤±æ•—:', error);
            }
        });
    </script>
</body>
</html>